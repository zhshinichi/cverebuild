# CVE Report for CVE-2024-11165

## Summary
CVE-2024-11165 is an information disclosure vulnerability identified in the backup configuration process of YugabyteDB Anywhere. The vulnerability is classified under CWE-532, which pertains to Information Exposure Through Log Files. The affected versions of the software include YugabyteDB Anywhere from 2.20.0.0 before 2.20.7.0, from 2.23.0.0 before 2.23.1.0, and from 2024.1.0.0 before 2024.1.3.0. The vulnerability allows sensitive information, specifically the SAS token, to be logged in plaintext within the yb_backup log files during the backup procedure, potentially leading to unauthorized access to resources associated with the SAS token.

## Root Cause
The root cause of the vulnerability lies in the logging mechanism of the backup configuration process. The SAS token, which is a critical piece of information used for authentication and authorization, was being logged without any redaction. This oversight meant that the token was exposed in its entirety, including sensitive query parameters, in the log files.

The provided patch addresses this issue by implementing a redaction mechanism for the SAS token. The patch modifies the `RedactingService` class to include a list of sensitive query parameters, specifically the "sig" parameter of the SAS token, which is crucial for its security. The `redactQueryParams` method is introduced to replace the sensitive information with a placeholder, ensuring that the SAS token is not logged in plaintext.

### Code Analysis
The patch includes the following key changes:

1. **RedactingService.java**:
   - A new list `SECRET_QUERY_PARAMS_FOR_LOGS` is created to include the "sig" parameter.
   - The `redactQueryParams` method is implemented to search for the SAS token in the log output and replace it with a placeholder.

2. **ShellProcessHandler.java**:
   - The logging of output lines is modified to use the `redactQueryParams` method, ensuring that any logged output containing the SAS token is redacted.

3. **CommonUtils.java**:
   - The list of sensitive field substrings is updated to include "SAS_TOKEN", further reinforcing the need to treat this information as sensitive.

These changes collectively mitigate the risk of sensitive information exposure by ensuring that the SAS token is masked in logs.

## Exploitation Details
To exploit this vulnerability, an attacker would need to access the log files generated during the backup process. The attacker could potentially trigger a backup operation that logs the SAS token in plaintext. If the attacker has access to the log files, they could extract the SAS token and use it to gain unauthorized access to the resources associated with it.

### Overview of Exploit Steps
1. Trigger a backup operation in YugabyteDB Anywhere.
2. Access the yb_backup log files where the backup configuration response is logged.
3. Extract the SAS token from the logs, which is not masked in the affected versions.
4. Use the SAS token to access resources, leading to unauthorized actions.

## Environment Setup Requirements
- Port: 5433 (default port for YugabyteDB)
- Target Endpoint: `/api/v1/backups`
- Explicit Configuration: None explicitly mentioned in the advisory.

## Complete PoC Code
The advisory does not provide a specific proof-of-concept code snippet. However, the following code snippets from the patch illustrate the changes made to address the vulnerability:

```java
public static final List<String> SECRET_QUERY_PARAMS_FOR_LOGS =
    ImmutableList.of(/* SAS Token */ "sig");

public static String redactQueryParams(String input) {
    String output = input;
    for (String param : SECRET_QUERY_PARAMS_FOR_LOGS) {
        String regex = "([?&]" + param + "=)([^&]+)";
        String replacement = "$1" + SECRET_REPLACEMENT;
        output = output.replaceAll(regex, replacement);
    }
    return output;
}
```

```java
private String getOutputLines(BufferedReader reader, boolean logOutput) {
    .peek(
        line -> {
            if (logOutput) {
                log.debug(fileMarker, RedactingService.redactQueryParams(line));
            }
        })
    .collect(Collectors.joining("\n"))
    .trim();
}
```

This report outlines the critical aspects of CVE-2024-11165, including the nature of the vulnerability, its root cause, and the necessary steps to exploit it, along with the environment setup requirements.