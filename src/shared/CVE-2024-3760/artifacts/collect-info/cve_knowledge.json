"# CVE-2024-3760 Detailed Report\n\n## Summary of the CVE\nCVE-2024-3760 is a high-severity vulnerability identified in version 1.2.7 of the lunary-ai/lunary software. The vulnerability is categorized under CWE-770, which refers to the \"Allocation of Resources Without Limits or Throttling.\" The issue arises from the absence of rate limiting on the forgot password page, allowing attackers to exploit this weakness by automating password reset requests. This can lead to an email bombing scenario, where targeted user accounts are inundated with a large volume of password reset emails, overwhelming the victim's mailbox and potentially degrading the performance of mail servers.\n\n## Root Cause of the Vulnerability\nThe root cause of CVE-2024-3760 lies in the lack of rate limiting on the password reset functionality. In the affected version (1.2.7), the application does not impose any restrictions on how frequently a user can request a password reset. This oversight allows an attacker to send multiple requests in a short period, leading to email flooding.\n\nAnalyzing the provided patch, we can see that the developers have introduced a mechanism to check if a password reset request has been made within the last hour. The relevant code changes include:\n\n```typescript\nif (recoveryToken) {\n    if (await isJWTExpired(recoveryToken)) {\n        // Edge case 1: User has made a password reset request more than one hour ago, but has not completed the flow\n        await requestPasswordReset(email)\n        ctx.body = { ok: true }\n        return\n    } else {\n        // Edge case 2: User has already made a password request less than one hour ago\n        throw new Error(\n            \"Password reset request already initiated less than one hour ago\",\n        )\n    }\n}\n```\n\nThis code checks if a recovery token exists and whether it has expired. If the token is still valid (i.e., the user has made a request within the last hour), the system throws an error, preventing further requests. This change effectively mitigates the email bombing vulnerability by limiting the frequency of password reset requests.\n\n## Exploitation Details\nTo exploit this vulnerability, an attacker would typically follow these steps:\n\n1. Navigate to the password reset page of the application.\n2. Enter a target email address and intercept the request using a tool like Burp Suite.\n3. Use the Intruder feature in Burp Suite to automate the sending of password reset requests, potentially varying the User-Agent header to bypass any basic security measures.\n4. Monitor the target email account to confirm that it is being flooded with password reset emails.\n\nThe advisory does not provide explicit details on the exact payloads or configurations used in the PoC, but the general approach involves sending repeated requests to the password reset endpoint without any rate limiting.\n\n## Environment Setup Requirements\n- **Port**: 8080 (assumed default for web applications; please adjust based on actual application configuration)\n- **Target Endpoint**: `/auth/request-password-reset`\n- **Explicit Configuration**: None explicitly mentioned in the advisory.\n\n## Complete PoC Code\nThe advisory does not provide a complete proof-of-concept code snippet, but it describes the steps to reproduce the vulnerability. Here is the relevant part of the advisory that outlines the exploitation process:\n\n```plaintext\nGo to reset password page, enter email and intercept the request in burp.\nNow send that request to Intruder and select payloads for user-agent.\nStart the attack\nNow check the email address is been flooded with mail\n```\n\nThis description serves as a guideline for creating a PoC to exploit the vulnerability. The actual implementation would depend on the attacker's tools and methods. \n\nIn summary, CVE-2024-3760 represents a significant risk due to its potential to disrupt user accounts and mail server performance, necessitating the implementation of rate limiting to mitigate such vulnerabilities effectively.\n\n## üöÄ DEPLOYMENT STRATEGY (USE THIS - DO NOT GUESS!)\n\n**Repository URL**: https://github.com/lunary-ai/lunary\n**Platform**: N/A\n**Language**: None\n**Build Tool**: None\n\n### Build Commands:\n```bash\n\n```\n\n### Start Commands:\n```bash\n\n```\n\n### Deployment Notes:\n‰ªé GitHub Ê∫êÁ†ÅÈÉ®ÁΩ≤„ÄÇËØ≠Ë®Ä: Êú™Áü•, ÊûÑÂª∫Â∑•ÂÖ∑: Êú™Áü•\n\n‚ö†Ô∏è **CRITICAL INSTRUCTIONS**:\n1. DO NOT try to find Docker images or guess repository URLs\n2. USE THE REPOSITORY URL PROVIDED ABOVE\n3. Clone from the specified repository and follow build/start commands\n4. If build commands fail, analyze error and adapt (but keep using the same repo)\n"