{
    "published_date": "2025-03-20T10:11:05.749Z",
    "patch_commits": [
        {
            "url": "https://github.com/significant-gravitas/autogpt/commit/6dba31e0215549604bdcc1aed24e3a1714e75ee2",
            "content": "fix(backend): Enable Jinja SandboxedEnvironment for TextFormatter (#8891)\n\nWe still use plain Jinja objects for text formatting in our block codes.\n\n### Changes \ud83c\udfd7\ufe0f\n\nIntroduced a `TextFormatter` utility class that uses jina\nSandboxedEnvironment for safer text formatting.\n\n### Checklist \ud83d\udccb\n\n#### For code changes:\n- [ ] I have clearly listed my changes in the PR description\n- [ ] I have made a test plan\n- [ ] I have tested my changes according to the test plan:\n  <!-- Put your test plan here: -->\n  - [ ] ...\n\n<details>\n  <summary>Example test plan</summary>\n  \n  - [ ] Create from scratch and execute an agent with at least 3 blocks\n- [ ] Import an agent from file upload, and confirm it executes\ncorrectly\n  - [ ] Upload agent to marketplace\n- [ ] Import an agent from marketplace and confirm it executes correctly\n  - [ ] Edit an agent from monitor, and confirm it executes correctly\n</details>\n\n#### For configuration changes:\n- [ ] `.env.example` is updated or already compatible with my changes\n- [ ] `docker-compose.yml` is updated or already compatible with my\nchanges\n- [ ] I have included a list of my configuration changes in the PR\ndescription (under **Changes**)\n\n<details>\n  <summary>Examples of configuration changes</summary>\n\n  - Changing ports\n  - Adding new services that need to communicate with each other\n  - Secrets or environment variable changes\n  - New or infrastructure changes such as databases\n</details>\n\nFilename: autogpt_platform/backend/backend/blocks/basic.py:\n```\n@@ -1,13 +1,11 @@\n-import re\n from typing import Any, List\n \n-from jinja2 import BaseLoader, Environment\n-\n from backend.data.block import Block, BlockCategory, BlockOutput, BlockSchema, BlockType\n from backend.data.model import SchemaField\n from backend.util.mock import MockObject\n+from backend.util.text import TextFormatter\n \n-jinja = Environment(loader=BaseLoader())\n+formatter = TextFormatter()\n \n \n class StoreValueBlock(Block):\n\n@@ -304,9 +302,9 @@\ndef run(self, input_data: Input, **kwargs) -> BlockOutput:\n         \"\"\"\n         if input_data.format:\n             try:\n-                fmt = re.sub(r\"(?<!{){[ a-zA-Z0-9_]+}\", r\"{\\g<0>}\", input_data.format)\n-                template = jinja.from_string(fmt)\n-                yield \"output\", template.render({input_data.name: input_data.value})\n+                yield \"output\", formatter.format_string(\n+                    input_data.format, {input_data.name: input_data.value}\n+                )\n             except Exception as e:\n                 yield \"output\", f\"Error: {e}, {input_data.value}\"\n         else:\n```\n\nFilename: autogpt_platform/backend/backend/blocks/text.py:\n```\n@@ -1,13 +1,11 @@\nimport re\n from typing import Any\n \n-from jinja2 import BaseLoader, Environment\n-\n from backend.data.block import Block, BlockCategory, BlockOutput, BlockSchema\n from backend.data.model import SchemaField\n-from backend.util import json\n+from backend.util import json, text\n \n-jinja = Environment(loader=BaseLoader())\n+formatter = text.TextFormatter()\n \n \n class MatchTextPatternBlock(Block):\n\n@@ -146,19 +144,20 @@\ndef __init__(self):\n                     \"values\": {\"list\": [\"Hello\", \" World!\"]},\n                     \"format\": \"{% for item in list %}{{ item }}{% endfor %}\",\n                 },\n+                {\n+                    \"values\": {},\n+                    \"format\": \"{% set name = 'Alice' %}Hello, World! {{ name }}\",\n+                },\n             ],\n             test_output=[\n                 (\"output\", \"Hello, World! Alice\"),\n                 (\"output\", \"Hello World!\"),\n+                (\"output\", \"Hello, World! Alice\"),\n             ],\n         )\n \n     def run(self, input_data: Input, **kwargs) -> BlockOutput:\n-        # For python.format compatibility: replace all {...} with {{..}}.\n-        # But avoid replacing {{...}} to {{{...}}}.\n-        fmt = re.sub(r\"(?<!{){[ a-zA-Z0-9_]+}\", r\"{\\g<0>}\", input_data.format)\n-        template = jinja.from_string(fmt)\n-        yield \"output\", template.render(**input_data.values)\n+        yield \"output\", formatter.format_string(input_data.format, input_data.values)\n \n \n class CombineTextsBlock(Block):\n```\n\nFilename: autogpt_platform/backend/backend/util/text.py:\n```\n@@ -0,0 +1,22 @@\n+import re\n+\n+from jinja2 import BaseLoader\n+from jinja2.sandbox import SandboxedEnvironment\n+\n+\n+class TextFormatter:\n+    def __init__(self):\n+        # Create a sandboxed environment\n+        self.env = SandboxedEnvironment(loader=BaseLoader(), autoescape=True)\n+\n+        # Clear any registered filters, tests, and globals to minimize attack surface\n+        self.env.filters.clear()\n+        self.env.tests.clear()\n+        self.env.globals.clear()\n+\n+    def format_string(self, template_str: str, values=None, **kwargs) -> str:\n+        # For python.format compatibility: replace all {...} with {{..}}.\n+        # But avoid replacing {{...}} to {{{...}}}.\n+        template_str = re.sub(r\"(?<!{){[ a-zA-Z0-9_]+}\", r\"{\\g<0>}\", template_str)\n+        template = self.env.from_string(template_str)\n+        return template.render(values or {}, **kwargs)\n```"
        }
    ],
    "sw_version": "v0.3.1",
    "sw_version_wget": "https://github.com/significant-gravitas/autogpt/archive/refs/tags/v0.3.1.zip",
    "description": "AutoGPT versions 0.3.4 and earlier are vulnerable to a Server-Side Template Injection (SSTI) that could lead to Remote Code Execution (RCE). The vulnerability arises from the improper handling of user-supplied format strings in the `AgentOutputBlock` implementation, where malicious input is passed to the Jinja2 templating engine without adequate security measures. Attackers can exploit this flaw to execute arbitrary commands on the host system. The issue is fixed in version 0.4.0.",
    "sec_adv": [
        {
            "url": "https://huntr.com/bounties/b74ef75f-61d5-4422-ab15-9550c8b4f185",
            "content": "Bounties\nPartners\nCommunity\nInfo\nSUBMIT REPORT\nAutoGPT SSTI Vulnerability Leading to Remote Code Execution (RCE) in significant-gravitas/autogpt\nValid\nReported on Dec 2nd 2024\nSummary\nAutoGPT, an open-source AI tool that automates task execution, is vulnerable to a Server-Side Template Injection (SSTI) that could lead to arbitrary command execution. The vulnerability arises from the improper handling of user-supplied format strings in the AgentOutputBlock implementation, where malicious input is passed to the Jinja2 templating engine without adequate security measures. Attackers can exploit this flaw to execute arbitrary commands on the host system.\nAffected Versions\nAutoGPT versions 0.3.4 and earlier.\nRoot Cause\nAutoGPT's AgentOutputBlock accepts user input a template format string, yet fail to filter out and block the malicious template injection.\nFrom the code, we can observe class AgentOutputBlock accepts user input format string and later bypasses it into jinja template object which was simply initialized with loader without enabling sandbox environment:\njinja = Environment(loader=BaseLoader())\nleaving the chances of malicious code injection and arbitrary command execution.\n# https://github.com/Significant-Gravitas/AutoGPT/blob/2121ffd06b26a438706bf642372cc46d81c94ddc/autogpt_platform/backend/backend/blocks/basic.py#L305-L309\n\n    def run(self, input_data: Input, **kwargs) -> BlockOutput:\n                ...\n        if input_data.format:\n            try:\n                fmt = re.sub(r\"(?<!{){[ a-zA-Z0-9_]+}\", r\"{\\g<0>}\", input_data.format)\n                template = jinja.from_string(fmt)\n                yield \"output\", template.render({input_data.name: input_data.value})\n                ...\nProof of Concept (PoC)\nAttacker can exploit this vulnerability to conduct arbitrary command execution attack by:\nCreate a Fill Text Template block\nSave the agent\nPut in SSTI Payload that can enumerating the desired os module and invoke the popen method with attacker's inputted command.\n{{ self._TemplateReference__context.cycler.__init__.__globals__.os.popen('id').read() }}\nOnce the created agent is saved and the attacker clicks the run button, the malicious template will be rendered and a id OS command will be executed.\nRecommended Mitigations\nIntroduce sandbox environment for template rendering:\nA SandboxedEnvironment in Jinja2 is a security feature that creates a restricted execution environment to prevent malicious template code from accessing dangerous Python functionality.\nfrom jinja2.sandbox import SandboxedEnvironment\n\n# At module level\njinja = SandboxedEnvironment(\n    loader=BaseLoader(),\n    autoescape=True\n)\nImpact\nImpact\nAn attacker could exploit this vulnerability to perform Remote Code Execution (RCE), potentially gaining unauthorized access to sensitive system data or control over the host machine. This can lead to:\nSystem Compromise: Execution of arbitrary commands on the host environment.\nData Exfiltration: Unauthorized access to sensitive files or data.\nService Disruption: Exploitation of this vulnerability could lead to service outages or performance degradation.\nEscalation of Privileges: When executed in a privileged environment, attackers might escalate privileges.\nOccurrences\nbasic.py L305-L309\nWe are processing your report and will contact thesignificant-gravitas/autogpt team within 24 hours.5 months ago\n2h0ng\ncommented5 months ago\nResearcher\nimage-20241202222625844 image-20241202222717304\nA significant-gravitas/autogpt maintainerhas acknowledged this report5 months ago\nThe scheduled publication date was automatically extended from 2nd Mar 2025  to 9th Mar 2025  due to the maintainers acknowledgement of the report5 months ago\nZamil Majdy\ncommented5 months ago\nMaintainer\nThank you for the report! I'm adding another layer of validation & filtering here: https://github.com/Significant-Gravitas/AutoGPT/pull/8891\nLet me know if this is enough.\n2h0ng\ncommented5 months ago\nResearcher\nHi Zamil. I believe sandbox enabled jinja environment will make class lookup impossbile, thus mitigates the SSTI risks. However, I also recommend adding expection catch statement for it, as the document said:\nThe sandbox alone is not a solution for perfect security. Keep these things in mind when using the sandbox.\n\nTemplates can still raise errors when compiled or rendered. Your code should attempt to catch errors instead of crashing.\n\nfrom jinja2.sandbox import SandboxedEnvironment\nenv = SandboxedEnvironment()\nfunc = lambda: \"Hello, Sandbox!\"\nenv.from_string(\"{{ func() }}\").render(func=func)\n'Hello, Sandbox!'\nenv.from_string(\"{{ func.__code__.co_code }}\").render(func=func)\nTraceback (most recent call last):\n  ...\nSecurityError: access to attribute '__code__' of 'function' object is unsafe.\n...\nhttps://jinja.palletsprojects.com/en/stable/sandbox/#security-considerations\nThis report has now been passed to internal triage and should be resolved within 14 days.4 months ago\nEthan Silvasmodified the Severity from Critical (9.9) to High (8.8)3 months ago\nThe researcher has received a minor penalty to their credibility for miscalculating the severity: -1\nEthan Silvas validated this vulnerability3 months ago\nMaintainer fixed and marking valid. Adjusted CVSS for scope unchanged as this is RCE on the host server.\nsuperboy-zjchas been awarded the disclosure bounty\nThe fix bounty is now up for grabs\nThe researcher's credibility has increased: +7\nCVE-2025-1040assigned to this report.3 months ago\nEthan Silvasmarked this as fixedin v0.4.0with commit6dba313 months ago\nZamil Majdyhas been awarded the fix bounty\nbasic.py#L305-L309 has been validated\nWe have notified the significant-gravitas/autogpt maintainers about this report in their weekly follow-up3 months ago\nWe have sent a warning to the significant-gravitas/autogpt team to inform them that this report will be published in 48 hours2 months ago\nThis vulnerability has now been published2 months ago\nCVE-2025-1040has now been published2 months ago\nSign in to join this conversation\nCVE\nCVE-2025-1040\n(Published)\nVulnerability Type\nCWE-77: Command Injection\nSeverity\nHigh (8.8)\nAttack vector\nNetwork\nAttack complexity\nLow\nPrivileges required\nLow\nUser interaction\nNone\nScope\nUnchanged\nConfidentiality\nHigh\nIntegrity\nHigh\nAvailability\nHigh\nOpen in visual CVSS calculator\nRegistry\nPypi\nAffected Version\nAutoGPT versions 0.3.4 and earlier.\nVisibility\nPublic\nStatus\nFixed\nFound by\nFixed by\nSupported by Protect AI and leading the way to MLSecOps and greater AI security.\n\u00a9 2024\nPrivacy Policy\nTerms of Service\nCode of Conduct\nCookie Preferences\nContact Us",
            "effective": true,
            "effective_reason": "The advisory provides a proof-of-concept payload for exploiting the vulnerability in the given software."
        }
    ],
    "cwe": [
        {
            "id": "CWE-77",
            "value": "CWE-77  Improper Neutralization of Special Elements used in a Command ('Command Injection')"
        }
    ],
    "dir_tree": ".\n\u251c\u2500\u2500 autogpt\n\u2502\u00a0\u00a0 \u251c\u2500\u2500 agent\n\u2502\u00a0\u00a0 \u251c\u2500\u2500 commands\n\u2502\u00a0\u00a0 \u251c\u2500\u2500 config\n\u2502\u00a0\u00a0 \u251c\u2500\u2500 js\n\u2502\u00a0\u00a0 \u251c\u2500\u2500 json_utils\n\u2502\u00a0\u00a0 \u251c\u2500\u2500 llm\n\u2502\u00a0\u00a0 \u2502\u00a0\u00a0 \u2514\u2500\u2500 providers\n\u2502\u00a0\u00a0 \u251c\u2500\u2500 log_cycle\n\u2502\u00a0\u00a0 \u251c\u2500\u2500 memory\n\u2502\u00a0\u00a0 \u251c\u2500\u2500 memory_management\n\u2502\u00a0\u00a0 \u251c\u2500\u2500 models\n\u2502\u00a0\u00a0 \u251c\u2500\u2500 processing\n\u2502\u00a0\u00a0 \u251c\u2500\u2500 prompts\n\u2502\u00a0\u00a0 \u251c\u2500\u2500 speech\n\u2502\u00a0\u00a0 \u251c\u2500\u2500 url_utils\n\u2502\u00a0\u00a0 \u2514\u2500\u2500 workspace\n\u251c\u2500\u2500 benchmark\n\u251c\u2500\u2500 data\n\u251c\u2500\u2500 docs\n\u2502\u00a0\u00a0 \u251c\u2500\u2500 challenges\n\u2502\u00a0\u00a0 \u2502\u00a0\u00a0 \u251c\u2500\u2500 information_retrieval\n\u2502\u00a0\u00a0 \u2502\u00a0\u00a0 \u2514\u2500\u2500 memory\n\u2502\u00a0\u00a0 \u251c\u2500\u2500 configuration\n\u2502\u00a0\u00a0 \u2514\u2500\u2500 imgs\n\u251c\u2500\u2500 plugins\n\u251c\u2500\u2500 scripts\n\u2514\u2500\u2500 tests\n    \u251c\u2500\u2500 integration\n    \u2502\u00a0\u00a0 \u251c\u2500\u2500 cassettes\n    \u2502\u00a0\u00a0 \u2502\u00a0\u00a0 \u251c\u2500\u2500 test_llm_utils\n    \u2502\u00a0\u00a0 \u2502\u00a0\u00a0 \u251c\u2500\u2500 test_local_cache\n    \u2502\u00a0\u00a0 \u2502\u00a0\u00a0 \u251c\u2500\u2500 test_memory_management\n    \u2502\u00a0\u00a0 \u2502\u00a0\u00a0 \u2514\u2500\u2500 test_setup\n    \u2502\u00a0\u00a0 \u251c\u2500\u2500 challenges\n    \u2502\u00a0\u00a0 \u2502\u00a0\u00a0 \u251c\u2500\u2500 information_retrieval\n    \u2502\u00a0\u00a0 \u2502\u00a0\u00a0 \u251c\u2500\u2500 kubernetes\n    \u2502\u00a0\u00a0 \u2502\u00a0\u00a0 \u2514\u2500\u2500 memory\n    \u2502\u00a0\u00a0 \u2502\u00a0\u00a0     \u2514\u2500\u2500 cassettes\n    \u2502\u00a0\u00a0 \u2502\u00a0\u00a0         \u251c\u2500\u2500 test_memory_challenge_a\n    \u2502\u00a0\u00a0 \u2502\u00a0\u00a0         \u251c\u2500\u2500 test_memory_challenge_b\n    \u2502\u00a0\u00a0 \u2502\u00a0\u00a0         \u2514\u2500\u2500 test_memory_challenge_c\n    \u2502\u00a0\u00a0 \u2514\u2500\u2500 goal_oriented\n    \u2502\u00a0\u00a0     \u2514\u2500\u2500 cassettes\n    \u2502\u00a0\u00a0         \u251c\u2500\u2500 test_browse_website\n    \u2502\u00a0\u00a0         \u2514\u2500\u2500 test_write_file\n    \u251c\u2500\u2500 mocks\n    \u251c\u2500\u2500 unit\n    \u2502\u00a0\u00a0 \u251c\u2500\u2500 data\n    \u2502\u00a0\u00a0 \u2502\u00a0\u00a0 \u2514\u2500\u2500 test_plugins\n    \u2502\u00a0\u00a0 \u2514\u2500\u2500 models\n    \u2514\u2500\u2500 vcr\n\n52 directories\n",
    "repo_path": "AutoGPT-0.3.1/"
}