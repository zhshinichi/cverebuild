# CVE Report for CVE-2024-50353

## Summary
CVE-2024-50353 pertains to a vulnerability in the `ICG.AspNetCore.Utilities.CloudStorage` library, specifically affecting version 6.0.0. The vulnerability is classified under CWE-284, which denotes improper access control. The issue arises when users set a duration for a Shared Access Signature (SAS) URI that differs from the default of 1 hour. This can lead to the generation of URLs with unintended durations, either longer or shorter than expected. Users who do not implement SAS URIs are not affected by this vulnerability. The issue has been resolved in version 8.0.0 of the library.

## Root Cause of the Vulnerability
The root cause of the vulnerability lies in the way the SAS URI expiration time is calculated in the code. In the affected version (6.0.0), the expiration time for the SAS URI is hardcoded to 1 hour:

```csharp
ExpiresOn = DateTimeOffset.UtcNow.AddHours(1)
```

This means that regardless of the user-defined duration, the expiration time will always be set to 1 hour, leading to potential misuse or unintended access to resources. The patch modifies this line to use the user-defined `tokenDuration` in minutes:

```csharp
ExpiresOn = DateTimeOffset.UtcNow.AddMinutes(tokenDuration)
```

This change allows the expiration time to reflect the intended duration set by the user, thus addressing the improper access control issue.

## Exploitation Details
To exploit this vulnerability, an attacker could potentially generate a SAS URI with a duration that does not align with the intended access period. For instance, if a user sets a duration of 2 hours, the generated SAS URI may still expire in 1 hour, allowing unauthorized access to the resource for a shorter duration than expected. 

While the security advisory does not provide explicit steps for exploitation, a potential exploit could involve:
1. Setting up a cloud storage container using the affected library version (6.0.0).
2. Generating a SAS URI with a specified duration.
3. Observing that the actual expiration time does not match the specified duration, leading to unintended access control.

## Environment Setup Requirements
- **Port**: Not explicitly mentioned in the advisory.
- **Target Endpoint**: Not explicitly mentioned in the advisory.
- **Explicit Configuration**: No specific startup flags or environment variables were mentioned in the advisory.

## Complete PoC Code
The advisory does not provide a complete proof-of-concept (PoC) code snippet. However, the relevant code change that addresses the vulnerability is as follows:

```csharp
public string CreateSASUrl(string container, string objectName, int tokenDuration)
{
    var tokenBuilder = new BlobSasBuilder
    {
        BlobContainerName = container,
        BlobName = objectName,
        Resource = "b",
        ExpiresOn = DateTimeOffset.UtcNow.AddMinutes(tokenDuration) // Updated line
    };
    tokenBuilder.SetPermissions(BlobSasPermissions.Read);
    return blobClient.GenerateSasUri(tokenBuilder).ToString();
}
```

This code snippet illustrates the modification made in the patch to ensure that the SAS URI expiration time is set according to the user-defined duration.