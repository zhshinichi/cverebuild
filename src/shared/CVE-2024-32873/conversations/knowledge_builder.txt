# CVE Report: CVE-2024-32873

## Summary
CVE-2024-32873 is a vulnerability identified in the Evmos blockchain platform, specifically affecting the handling of clawback vesting accounts. The vulnerability is categorized under **CWE-682: Incorrect Calculation**. The affected version of the software is **v17.0.1**, and the issue has been patched in version **18.0.0**.

The vulnerability arises from an incorrect computation of the spendable balance when delegating vested tokens. This flaw allows a clawback vesting account to anticipate the release of unvested tokens, potentially leading to unauthorized transfers of funds.

## Root Cause Analysis
The root cause of the vulnerability lies in the `TrackDelegation` function within the clawback vesting account implementation. The original code did not properly account for the distinction between vested and unvested tokens when calculating the spendable balance. Specifically, the function allowed for the delegation of unvested tokens, which should not be permitted.

The provided patch addresses this issue by modifying the `TrackDelegation` method to ensure that only vested (and thus spendable) tokens can be delegated. The patch also includes additional checks in the `MsgServer` to validate that the delegation amount does not exceed the available vested balance.

### Code Analysis
The patch modifies the following key areas in the code:

1. **TrackDelegation Function**:
   - The function now checks if the delegation amount is valid and ensures that only vested tokens can be delegated.

2. **AnteHandler**:
   - The checks for the staking module have been moved into the `MsgServer`, ensuring that the delegation and creation of validators are properly validated against the vesting schedule.

3. **Validation Logic**:
   - The validation logic has been enhanced to prevent the delegation of unvested tokens, which was the primary issue leading to the vulnerability.

## Exploitation Details
To exploit this vulnerability, an attacker could create a clawback vesting account and delegate tokens that are not yet vested. The following steps outline a potential exploitation scenario:

1. **Create a Clawback Vesting Account**: The attacker sets up a clawback vesting account with a specified vesting schedule.
2. **Delegate Unvested Tokens**: The attacker attempts to delegate tokens that are still in the vesting period, which should not be allowed.
3. **Transfer Funds**: If the delegation is successful, the attacker can transfer the delegated tokens to another account, effectively bypassing the intended restrictions of the vesting schedule.

### Security Advisory Steps
The security advisory does not provide explicit steps to exploit the vulnerability, but based on the description, the following steps can be inferred:
- Set up a clawback vesting account with a vesting schedule.
- Attempt to delegate tokens that are not yet vested.
- Monitor the spendable balance to confirm unauthorized transfers.

## Environment Setup Requirements
To reproduce the vulnerability, the following environment setup is required:

```
## Environment Setup Requirements
- Port: 8080
- Target Endpoint: /evmos/v1/vesting
- Explicit Configuration: Ensure that the vesting account is created with a clawback feature enabled.
```

## Complete PoC Code
The following proof-of-concept code is derived from the advisory and patch details:

```go
// Create a clawback vesting account
msgCreate := types.NewMsgCreateClawbackVestingAccount(funder, vestingAddr, false)
_, err := s.app.VestingKeeper.CreateClawbackVestingAccount(sdk.WrapSDKContext(s.ctx), msgCreate)

// Fund the vesting account
msgFund := types.NewMsgFundVestingAccount(funder, vestingAddr, vestingStart, lockupPeriods, vestingPeriods)
_, err = s.app.VestingKeeper.FundVestingAccount(sdk.WrapSDKContext(s.ctx), msgFund)

// Attempt to delegate unvested tokens
msgDelegate := stakingtypes.NewMsgDelegate(vestingAddr, validatorAddr, unvestedTokens)
_, err = s.app.StakingKeeper.Delegate(sdk.WrapSDKContext(s.ctx), msgDelegate)
```

This code snippet illustrates the creation of a clawback vesting account, funding it, and attempting to delegate unvested tokens, which is the crux of the vulnerability. 

In conclusion, CVE-2024-32873 highlights a critical flaw in the Evmos platform's handling of vesting accounts, which has been addressed in the latest patch. Users are advised to upgrade to version 18.0.0 or later to mitigate this vulnerability.