"# CVE-2025-25304 Detailed Report\n\n## Summary of the CVE\nCVE-2025-25304 is a cross-site scripting (XSS) vulnerability identified in the Vega visualization grammar library, specifically affecting version 5.25.0. The vulnerability arises from the `vlSelectionTuples` function, which allows for the execution of arbitrary JavaScript code due to improper handling of user input. This function can be manipulated by an attacker to call JavaScript functions with attacker-controlled arguments, leading to potential XSS attacks. The issue has been addressed in versions 5.26.0 of Vega and 5.4.2 of Vega-selections.\n\n### Vulnerability Type\n- **CWE-79**: Improper Neutralization of Input During Web Page Generation ('Cross-site Scripting')\n\n### Affected Version\n- **Vega**: v5.25.0\n\n## Root Cause of the Vulnerability\nThe root cause of the vulnerability lies in the `vlSelectionTuples` function, which allows for the execution of JavaScript functions based on user input. The function can be called with an array of objects, where one of the objects can contain an attacker-controlled argument. This is exemplified in the following function call:\n\n```javascript\nvlSelectionTuples([{datum:<argument>}], {fields:[{getter:<function>}]})\n```\n\nIn this context, the `getter` function can be manipulated to execute arbitrary JavaScript code. The vulnerability is exacerbated by the fact that the resulting function can be invoked through coercion methods like `toString` or `valueOf`, allowing an attacker to execute malicious scripts.\n\n### Code Analysis\nThe patch provided in the security advisory indicates that the vulnerability was addressed by modifying how the `getter` function is assigned and accessed. The changes made in the `selectionTuples.js` file are particularly relevant:\n\n```javascript\n// Original vulnerable code\nvalues: base.fields.map(f => (f.getter || (f.getter = field(f.field)))(x.datum))\n\n// Patched code\nvalues: base.fields.map(f => getter(f)(x.datum))\n```\n\nThe patch introduces a new `getter` function defined in `util.js`, which ensures that field accessors are registered in a way that protects against XSS attacks. The `getter` function checks if the `getter` property is already defined and if it has been marked to prevent XSS, thus preventing the execution of arbitrary JavaScript.\n\n## Exploitation Details\nThe security advisory provides a proof of concept (PoC) that demonstrates how the vulnerability can be exploited. The PoC is as follows:\n\n```json\n{\"$schema\":\"https://vega.github.io/schema/vega/v5.json\",\"signals\":[{\"name\":\"a\",\"init\":\"+{valueOf:vlSelectionTuples([{datum:'alert(1)'}],{fields:[{getter:[].at.constructor}]})[0].values[0]}\"}]}\n```\n\n### Steps to Exploit the Vulnerability\n1. **Craft a Vega JSON Specification**: An attacker can create a Vega JSON specification that includes a signal with an initialization that calls `vlSelectionTuples` with a malicious payload.\n2. **Inject Malicious Code**: The attacker can inject JavaScript code (e.g., `alert(1)`) as part of the `datum` argument in the `vlSelectionTuples` function.\n3. **Trigger the Execution**: When the Vega visualization is rendered, the malicious code will be executed in the context of the user's browser, leading to an XSS attack.\n\n### Example of Exploit\nAn example of how an attacker might structure their Vega specification to exploit the vulnerability is as follows:\n\n```json\n{\n  \"$schema\": \"https://vega.github.io/schema/vega/v5.json\",\n  \"signals\": [\n    {\n      \"name\": \"a\",\n      \"init\": \"+{valueOf:vlSelectionTuples([{datum:'alert(1)'}],{fields:[{getter:[].at.constructor}]})[0].values[0]}\"\n    }\n  ],\n  // Additional Vega specification details...\n}\n```\n\nIn this example, when the Vega visualization is rendered, the `alert(1)` will execute, demonstrating the XSS vulnerability.\n\n## Conclusion\nCVE-2025-25304 represents a significant security risk due to its potential for XSS attacks through the `vlSelectionTuples` function in Vega. The vulnerability has been effectively mitigated in the patched versions by ensuring that field accessors are properly registered and protected against arbitrary code execution. Users of affected versions are strongly advised to upgrade to the patched versions (5.26.0 for Vega and 5.4.2 for Vega-selections) to safeguard against this vulnerability."