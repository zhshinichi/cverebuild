{
    "overview": "Calibre's content server codebase (this repository) implements an HTTP content-server that exposes a full-text search endpoint. The CVE (CVE-2024-7009) is an SQL-injection in the FTS result formatting: user-controlled `highlight_start` and `highlight_end` values are interpolated directly into the SQL snippet/highlight expression in `src/calibre/db/fts/connect.py` and called from the content-server endpoint in `src/calibre/srv/fts.py`. Reproducing the issue requires running the vulnerable content-server (a release \u2264 7.15.0 or the matching vulnerable source tree) against a local Calibre library that has the FTS tables enabled so the `/fts/snippets/{book_ids}` endpoint is exercised.",
    "files": "Files and locations the next agent must inspect / have available (critical for reproducing CVE):\n\n- `src/calibre/srv/fts.py`  \n  - Why: defines the `/fts/snippets/{book_ids}` endpoint (where `highlight_start` / `highlight_end` originate). Confirm this endpoint is present and that request parameters are passed through to the DB layer.\n\n- `src/calibre/db/fts/connect.py`  \n  - Why: contains the FTS search implementation that constructs the `snippet(...)` / `highlight(...)` SQL expressions. The vulnerable f-string interpolation of `highlight_start` / `highlight_end` happens here (search for `snippet(`, `highlight(` and the f-string lines that embed those two parameters).\n\n- `src/calibre/db/fts/` (all files in this directory)  \n  - Why: other FTS backends or helper code (annotations/notes FTS backends are known to be similar) may contain the same pattern; search across these files for additional vulnerable string interpolations.\n\n- `setup/` and any top-level packaging files (e.g., `setup.py`, packaging metadata)  \n  - Why: to determine runtime dependencies and how the project expects to be launched from source (interpreter version, entrypoint scripts like `calibre-server`).\n\n- Any README(s) or runtime docs in `resources/content-server`, `manual/quick_start`, or `manual/templates`  \n  - Why: to find the recommended command(s) for launching the content server and default configuration (library path, default port, user DB location). If README paths or commands differ from actual source tree layout, correct them in the reproduction notes.\n\nChecks the next agent must perform (quick, targeted):\n- Grep the repo for `highlight_start`, `highlight_end`, `snippet(`, and `highlight(` to find all locations needing focus.\n- Verify the exact lines in `src/calibre/db/fts/connect.py` where `highlight_start`/`highlight_end` are interpolated (this is the primary reproduction point).",
    "services": "Services and runtime components required (only the essentials):\n\n- Content server (Calibre content-server) \u2014 required  \n  - What: the HTTP server process implemented by this source tree.  \n  - Correct configuration:\n    - Run from the vulnerable source or install a Calibre content-server binary/version known to be vulnerable (\u2264 7.15.0). If using source, launch the server via the project's documented entrypoint (check `setup/` or `src/calibre/srv` for the exact script).  \n    - Host: `localhost` (bind to loopback for safe testing).  \n    - Port: use a non-privileged port (e.g., `8080`) unless tests require otherwise.  \n    - Library path: point the server at a small test library directory containing at least one book (so `book_ids` like `1` are valid) and with FTS indices present/created. If the FTS tables are not present, run any indexing procedure the content-server uses (the README or server code will indicate how to initialize FTS).\n\n- SQLite (embedded) \u2014 required (no separate DB server)  \n  - What: the Python code uses SQLite via the standard library / `sqlite3`. No external DB service is required.  \n  - Correct configuration:\n    - Ensure the environment uses the same sqlite3 library shipped with the Python runtime used by the server. The vulnerability stems from how SQL strings are built, not SQLite configuration.\n    - Identify the location of the content-server user DB (used by server users management) \u2014 on Windows the CVE notes `%AppData%\\calibre\\server-users.sqlite`. On other OSes check server config / docs to find the actual path. The reproduction environment must have both the library DB (books FTS) and the server-user DB accessible to the server process.\n\nNotes / Non-required services:\n- No external services (no separate SQL server, no docker) are required. Do not spin up unrelated services.",
    "output": "What a successful setup/build should produce and how to interact with it:\n\n- Final state (successful setup):\n  - A running Calibre content-server process bound to localhost and serving HTTP endpoints.\n  - A test library with FTS indices available (so the `/fts/snippets/{book_ids}` endpoint returns data).\n  - The source files listed above available and matching the vulnerable code (or an installed Calibre release \u2264 7.15.0).\n\n- How to interact (for test orchestration / verification):\n  - Issue HTTP requests to the server's FTS snippet endpoint: `HTTP GET/POST /fts/snippets/{book_ids}` with the standard parameters the endpoint accepts (e.g., `library_id`, `query`, `query_id`, `use_stemming`, `highlight_start`, `highlight_end`, `snippet_size`, `restrict_to_book_ids`).  \n  - Expected benign behavior: the endpoint returns JSON rows containing snippet/highlight text for the requested book IDs (fields typically include book id, format and snippet text).  \n  - Expected difference when vulnerable code is present: because `highlight_start`/`highlight_end` are embedded into the SQL expression without parameter binding, specially crafted values can alter the constructed SQL expression and cause unintended SQL execution within the same SQLite connection (the repository CVE summary documents this class of impact). When the vulnerable code is patched (parameterized query), the same HTTP parameters should no longer be able to alter SQL syntax.\n\n- Success criteria for this reproduction setup:\n  1. The content-server starts and serves `/fts/snippets/{book_ids}` for at least one valid `book_id`.  \n  2. The `src/calibre/db/fts/connect.py` file in the environment contains the vulnerable interpolation code (for reproduce-as-vulnerable); or you have installed a package version known to be vulnerable.  \n  3. The test environment has accessible SQLite DB files for the library and the server user DB so that behavior differences (vulnerable vs patched) can be observed through responses from the FTS endpoint.\n\nSafety note (for the agent that will run the reproduction):\n- Configure the server to bind only to loopback and run in an isolated test environment. The CVE concerns remote data exposure via crafted inputs; do not run the vulnerable server on production or public networks."
}