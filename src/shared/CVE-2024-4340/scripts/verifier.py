#!/usr/bin/env python3
"""
CTF verifier for CVE-2024-4340 (sqlparse ≤ 0.4.4)

Structure
---------
1. Pre-setup        : (none required)
2. Exploit          : run the given exploit.py with a large depth argument
3. Post-exploit     : if the exploit terminates abnormally *and*
                      “RecursionError” appears in its output, print the flag
                      '3xploit66full'.

The script exits 0 on success and 1 otherwise.
"""
import os
import sys
import subprocess

FLAG = "3xploit66full"
EXPLOIT_FILE = os.path.join(os.path.dirname(__file__), "exploit.py")


def run_exploit(depth: int = 10000):
    """
    Run exploit.py with the chosen depth and return the completed
    subprocess object.
    """
    cmd = [sys.executable, EXPLOIT_FILE, str(depth)]
    return subprocess.run(cmd, capture_output=True, text=True)


def verify():
    # ---------------------------------------------------------------
    # 1. Pre-setup  (not required for this local DoS vulnerability)
    # ---------------------------------------------------------------

    # ---------------------------------------------------------------
    # 2. Exploit
    # ---------------------------------------------------------------
    res = run_exploit()

    # ---------------------------------------------------------------
    # 3. Post-exploit  – check the expected behaviour
    # ---------------------------------------------------------------
    combined_output = (res.stdout or "") + (res.stderr or "")
    success = res.returncode != 0 and "RecursionError" in combined_output

    if success:
        print(FLAG)
        return 0
    else:
        sys.stderr.write("Exploit verification failed – did not observe "
                         "expected RecursionError.\n")
        return 1


if __name__ == "__main__":
    sys.exit(verify())