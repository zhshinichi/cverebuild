# CVE Report for CVE-2024-21542

## Summary
CVE-2024-21542 is a vulnerability identified in versions of the package "luigi" prior to 3.6.0. The vulnerability is classified as an Arbitrary File Write via Archive Extraction, commonly referred to as Zip Slip (CWE-29). The affected version of the software is v3.5.2. This vulnerability arises from improper validation of destination file paths during the extraction of archive files, which can allow an attacker to write files to arbitrary locations on the filesystem.

## Root Cause of the Vulnerability
The root cause of the vulnerability lies in the `_extract_packages_archive` function within the `luigi/contrib/lsf_runner.py` and `luigi/contrib/sge_runner.py` files. The original implementation used the `tarfile` module to extract files from a tar archive without validating the paths of the files being extracted. This lack of validation allows an attacker to craft a malicious tar file that contains paths designed to escape the intended extraction directory, leading to arbitrary file writes on the system.

The provided patch addresses this issue by replacing the direct use of `tarfile` with a new class called `SafeExtractor`, which implements path validation. The `SafeExtractor` class ensures that any file being extracted is within the designated extraction directory, thus preventing path traversal attacks.

### Code Analysis
The original code:
```python
tar = tarfile.open(package_file)
for tarinfo in tar:
    tar.extract(tarinfo)
tar.close()
```
This code does not check the paths of the files being extracted, making it vulnerable to Zip Slip attacks.

The patched code:
```python
extractor = SafeExtractor(work_dir)
extractor.safe_extract(package_file)
```
This code utilizes the `SafeExtractor` class, which includes logic to validate file paths before extraction, effectively mitigating the vulnerability.

## Exploitation Details
To exploit this vulnerability, an attacker would need to create a malicious tar file that contains files with paths designed to escape the intended extraction directory. For example, the attacker could include files with paths like `../../etc/passwd` in the tar archive. When the vulnerable application extracts this archive, it could overwrite sensitive files on the system.

### Overview of Exploit Steps
1. Create a malicious tar file containing files with paths that traverse outside the intended extraction directory.
2. Use the vulnerable version of the "luigi" package to extract the tar file.
3. Monitor the filesystem to confirm that the files have been written to arbitrary locations.

## Environment Setup Requirements
- **Port**: Not explicitly mentioned in the advisory.
- **Target Endpoint**: Not explicitly mentioned in the advisory.
- **Explicit Configuration**: Not explicitly mentioned in the advisory.

## Complete PoC Code
The advisory does not provide a specific proof-of-concept (PoC) code snippet. However, the following code snippets from the patch illustrate the changes made to mitigate the vulnerability:

### Patch for `luigi/contrib/lsf_runner.py`
```python
from luigi.safe_extractor import SafeExtractor

def extract_packages_archive(work_dir):
    curdir = os.path.abspath(os.curdir)
    os.chdir(work_dir)
    extractor = SafeExtractor(work_dir)
    extractor.safe_extract(package_file)
```

### Patch for `luigi/contrib/sge_runner.py`
```python
from luigi.safe_extractor import SafeExtractor

def _extract_packages_archive(work_dir):
    curdir = os.path.abspath(os.curdir)
    os.chdir(work_dir)
    extractor = SafeExtractor(work_dir)
    extractor.safe_extract(package_file)
```

### SafeExtractor Class
```python
class SafeExtractor:
    def __init__(self, path="."):
        self.path = path

    @staticmethod
    def _is_within_directory(directory, target):
        abs_directory = os.path.abspath(directory)
        abs_target = os.path.abspath(target)
        prefix = os.path.commonprefix([abs_directory, abs_target])
        return prefix == abs_directory

    def safe_extract(self, tar_path, members=None, *, numeric_owner=False):
        with tarfile.open(tar_path, 'r') as tar:
            for member in tar.getmembers():
                member_path = os.path.join(self.path, member.name)
                if not self._is_within_directory(self.path, member_path):
                    raise RuntimeError("Attempted Path Traversal in Tar File")
            tar.extractall(self.path, members, numeric_owner=numeric_owner)
```

This report outlines the critical aspects of CVE-2024-21542, including its nature, root cause, potential exploitation methods, and the necessary code changes to mitigate the vulnerability.