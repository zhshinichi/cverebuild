{
    "CVE-2024-3504": {
        "published_date": "2024-06-06T17:53:40.589Z",
        "patch_commits": [
            {
                "url": "https://github.com/lunary-ai/lunary/commit/f7507f0949f6634f725ebb8da37c44f76542901f",
                "content": "fix: set user to owner (#183)\n\nFilename: packages/backend/src/api/v1/users.ts:\n```\n@@ -269,6 +269,9 @@\nusers.patch(\n \n     const { projects, role } = UpdateUserSchema.parse(ctx.request.body)\n \n+    if (role === \"owner\") {\n+      ctx.throw(403, \"You cannot modify the owner role\")\n+    }\n     const [currentUser] =\n       await sql`select * from account where id = ${currentUserId}`\n     if (![\"owner\", \"admin\"].includes(currentUser.role)) {\n```"
            }
        ],
        "sw_version": "v1.2.6",
        "sw_version_wget": "https://github.com/lunary-ai/lunary/archive/refs/tags/v1.2.6.zip",
        "description": "An improper access control vulnerability exists in lunary-ai/lunary versions up to and including 1.2.2, where an admin can update any organization user to the organization owner. This vulnerability allows the elevated user to delete projects within the organization. The issue is resolved in version 1.2.7.",
        "sec_adv": [
            {
                "url": "https://huntr.com/bounties/97958fe4-be21-4b63-966f-8337c72c8e28",
                "content": "Bounties\nPartners\nCommunity\nInfo\nSUBMIT REPORT\nImproper access control-allow update org user to org owner in lunary-ai/lunary\nValid\nReported on Apr 5th 2024\nDescription\nThere is a improper access control vulnerability allowing admin to update any org user to this org owner. As a result, user can delete projects in this org.\nDetails\nusers.patch(\n  \"/:userId\",\n  checkAccess(\"teamMembers\", \"update\"),\n  async (ctx: Context) => {\n    const UpdateUserSchema = z.object({\n      projects: z.array(z.string()).min(1),\n      role: z.enum(Object.keys(roles) as [string, ...string[]]),\n    })\n    const { userId } = ctx.params\n    const { userId: currentUserId } = ctx.state\n\n    const { projects, role } = UpdateUserSchema.parse(ctx.request.body)\n\n    const [currentUser] =\n      await sql`select * from account where id = ${currentUserId}`\n    if (![\"owner\", \"admin\"].includes(currentUser.role)) {\n      ctx.throw(403, \"You do not have permission to modify this user\")\n    }\n\n    const [userToModify] = await sql`select * from account where id = ${userId}`\n    if (!userToModify || userToModify.org_id !== currentUser.org_id) {\n      ctx.throw(404, \"User not found in your organization\")\n    }\n\n    await sql`update account set role = ${role} where id = ${userId}`\n\n    ...\n\n    ctx.status = 200\n    ctx.body = { message: \"User updated successfully\" }\n  },\n)\nProof of Concept\nPATCH /v1/users/f7834948-a3aa-411a-a4c8-fa9611db44ec HTTP/1.1\nHost: localhost:3333\n...\n\n{\"role\":\"owner\"(CHANGE HERE),\"projects\":[\"33015e2e-bdb0-4057-95ff-e0bfd1500481\"]}\nImpact\nVulnerability allowing admin to update any org user to this org owner. As a result, user can delete projects in this org\nOccurrences\nusers.ts L247-L304\nWe are processing your report and will contact thelunary-ai/lunary team within 24 hours.a year ago\nhuntr-helpermodified the Severity from Critical (9) to High (8.1)a year ago\nWe have contacted a member of thelunary-ai/lunary team and are waiting to hear backa year ago\nfewword modified the reporta year ago\nfewword\ncommenteda year ago\nResearcher\nHi Huntr Admin Team,\nI noticed that the vulnerability I reported has been fixed by the project team (which is awesome!), but the status on Huntr hasn't been updated yet. Could you please check this out? The patch is https://github.com/lunary-ai/lunary/pull/183/files. Just want to make sure everything is synced up and the community is informed.\nThanks a lot!\nThe researcher has received a minor penalty to their credibility for miscalculating the severity: -1\nHugues Chocart validated this vulnerabilitya year ago\nfewwordhas been awarded the disclosure bounty\nThe fix bounty is now up for grabs\nThe researcher's credibility has increased: +7\nCVE-2024-3504assigned to this report.a year ago\nHugues Chocartmarked this as fixedin 1.2.7with commitf7507fa year ago\nHugues Chocarthas been awarded the fix bounty\nusers.ts#L247-L304 has been validated\nfewword\ncommenteda year ago\nResearcher\nHi maintainer,\nThanks a bunch for addressing the vulnerability I reported! It feels great to contribute.\nBy the way, could you also take a peek at other reports I flagged?\nThanks a lot!\nHugues Chocart gave praisea year ago\nHi fewword, we are working on it. Thanks for you contribution\nThe researcher's credibility has slightly increased as a result of the maintainer's thanks: +1\nWe have sent a warning to the lunary-ai/lunary team to inform them that this report will be published in 48 hoursa year ago\nThis vulnerability has now been publisheda year ago\nCVE-2024-3504has now been publisheda year ago\nSign in to join this conversation\nCVE\nCVE-2024-3504\n(Published)\nVulnerability Type\nCWE-284: Improper Access Control\nSeverity\nHigh (8.1)\nAttack vector\nNetwork\nAttack complexity\nLow\nPrivileges required\nLow\nUser interaction\nNone\nScope\nUnchanged\nConfidentiality\nNone\nIntegrity\nHigh\nAvailability\nHigh\nOpen in visual CVSS calculator\nRegistry\nNpm\nAffected Version\n1.2.2\nVisibility\nPublic\nStatus\nFixed\nDisclosure Bounty\n$450\nFix Bounty\n$112.5\nFound by\nFixed by\nSupported by Protect AI and leading the way to MLSecOps and greater AI security.\nÂ© 2024\nPrivacy Policy\nTerms of Service\nCode of Conduct\nCookie Preferences\nContact Us",
                "effective": true,
                "effective_reason": "The advisory contains a specific HTTP PATCH request example demonstrating the vulnerability."
            }
        ],
        "cwe": [
            {
                "id": "CWE-284",
                "value": "CWE-284 Improper Access Control"
            }
        ]
    }
}