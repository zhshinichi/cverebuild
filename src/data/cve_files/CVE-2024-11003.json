{
    "CVE-2024-11003": {
        "published_date": "2024-11-19T17:36:36.682Z",
        "patch_commits": [
            {
                "url": "https://github.com/liske/needrestart/commit/0f80a348883f72279a859ee655f58da34babefb0",
                "content": "interp: drop usage of Module::ScanDeps to prevent LPE\n\nFilename: INSTALL.md:\n```\n@@ -5,7 +5,6 @@\nPerl\n ----\n \n - Module::Find\n-- Module::ScanDeps\n - Locale::TextDomain\n - Proc::ProcessTable\n - Sort::Naturally\n```\n\nFilename: README.Interp.md:\n```\n@@ -35,8 +35,13 @@\nNeedRestart::Interp::Perl\n Recognized binaries:\t/usr/(local/)?bin/perl\n Find source file by:\tcommand line interpretation\n \n-We are using `Module::ScanDeps` to find used packages. This should work on\n-any static loaded packages, dynamic stuff will fail.\n+The source file is scanned only for 'use' lines, other module loading\n+mechanisms will not be recognized.\n+\n+*This function used the Module::ScanDeps package to get the used Perl packages\n+until needrestart 3.7. Module::ScanDeps is not used any more as it seems not\n+to be designed to work with untrustworthy perl sources which would allow an\n+attacker to use needrestart for local privilege escalation.*\n \n \n NeedRestart::Interp::Python\n```\n\nFilename: perl/Makefile.PL:\n```\n@@ -6,7 +6,6 @@\nWriteMakefile(\n     'NAME'\t\t=> 'NeedRestart',\n     'PREREQ_PM'\t\t=> {\n \tModule::Find => 0,\n-\tModule::ScanDeps => 0,\n \tProc::ProcessTable => 0,\n \tSort::Naturally => 0,\n \tTerm::ReadKey => 0.\n```\n\nFilename: perl/lib/NeedRestart/Interp/Perl.pm:\n```\n@@ -32,7 +32,6 @@\nuse Cwd qw(abs_path getcwd);\n use Getopt::Std;\n use NeedRestart qw(:interp);\n use NeedRestart::Utils;\n-use Module::ScanDeps;\n \n my $LOGPREF = '[Perl]';\n\n@@ -48,6 +47,41 @@\nsub isa {\n     return 0;\n }\n \n+sub _scan($$$$$) {\n+    my $debug = shift;\n+    my $pid = shift;\n+    my $src = shift;\n+    my $files = shift;\n+    my $path = shift;\n+\n+    my $fh;\n+    open($fh, '<', $src) || return;\n+    # find used modules\n+    my %modules = map {\n+\t(/^\\s*use\\s+([a-zA-Z][\\w:]+)/ ? ($1 => 1) : ())\n+    } <$fh>;\n+    close($fh);\n+\n+    # track file\n+    $files->{$src}++;\n+\n+    # scan module files\n+    if(scalar keys %modules) {\n+\tforeach my $module (keys %modules) {\n+        # skip some well-known Perl pragmas\n+        next if ($module =~ /^(constant|strict|vars|v5(\\.\\d+)?|warnings)$/);\n+\n+\t    $module =~ s@::@/@g;\n+\t    $module .= '.pm';\n+\n+\t    foreach my $p (@$path) {\n+\t\tmy $fn = ($p ne '' ? \"$p/\" : '').$module;\n+\t\t&_scan($debug, $pid, $fn, $files, $path) if(!exists($files->{$fn}) && -r $fn && -f $fn);\n+\t    }\n+\t}\n+    }\n+}\n+\n sub source {\n     my $self = shift;\n     my $pid = shift;\n\n@@ -160,32 +194,28 @@\nsub files {\n     }\n \n     # prepare include path environment variable\n-    my %e = nr_parse_env($pid);\n+    my @path;\n     local %ENV;\n+\n+    # get include path from env\n+    my %e = nr_parse_env($pid);\n     if(exists($e{PERL5LIB})) {\n-\t$ENV{PERL5LIB} = $e{PERL5LIB};\n-    }\n-    elsif(exists($ENV{PERL5LIB})) {\n-\tdelete($ENV{PERL5LIB});\n+\t@path = map { \"/proc/$pid/root/$_\"; } split(':', $e{PERL5LIB});\n     }\n \n-    @Module::ScanDeps::IncludeLibs = (exists($opts{I}) ? ($opts{I}) : ());\n-    my $href;\n-    {\n-\t# Silence warnings of Module::ScanDeps for dynamic loaded modules (github issue #41)\n-\tlocal $SIG{__WARN__} = sub { };\n+    # get include path from @INC\n+    my $plread = nr_fork_pipe($self->{debug}, $ptable->{exec}, '-e', 'print(join(\"\\n\", @INC));');\n+    push(@path, map { \"/proc/$pid/root/$_\"; } <$plread>);\n+    close($plread);\n+    chomp(@path);\n \n-\t$href = scan_deps(\n-\t    files => [$src],\n-\t    recurse => 1,\n-            cache_file => $self->{conf}->{cache_file},\n-\t    );\n-    }\n+    my %files;\n+    _scan($self->{debug}, $pid, $src, \\%files, \\@path);\n \n     my %ret = map {\n-\tmy $stat = nr_stat(\"/proc/$pid/root/$href->{$_}->{file}\");\n-\t$href->{$_}->{file} => ( defined($stat) ? $stat->{ctime} : undef );\n-    } keys %$href;\n+\tmy $stat = nr_stat(\"/proc/$pid/root/$_\");\n+\t$_ => ( defined($stat) ? $stat->{ctime} : undef );\n+    } keys %files;\n \n     chdir($cwd);\n```"
            }
        ],
        "sw_version": "v3.7",
        "sw_version_wget": "https://github.com/liske/needrestart/archive/refs/tags/v3.7.zip",
        "description": "Qualys discovered that needrestart, before version 3.8, passes unsanitized data to a library (Modules::ScanDeps) which expects safe input. This could allow a local attacker to execute arbitrary shell commands. Please see the related CVE-2024-10224 in Modules::ScanDeps.",
        "sec_adv": [],
        "cwe": [
            {
                "id": "n/a",
                "value": "n/a"
            }
        ]
    }
}