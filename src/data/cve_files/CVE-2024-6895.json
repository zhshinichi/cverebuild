{
    "CVE-2024-6895": {
        "published_date": "2024-07-19T14:47:50.432Z",
        "patch_commits": [
            {
                "url": "https://github.com/yugabyte/yugabyte-db/commit/9687371d8777f876285b737a9d01995bc46bafa5",
                "content": "[BACKPORT 2.20][PLAT-10472] Insecure Account Profile Management\n\nSummary:\n  - Deprecate the API\n\n```\nPUT    /customers/:cUUID/users/:uUUID/change_password                          com.yugabyte.yw.controllers.UsersController.changePassword(cUUID: java.util.UUID, uUUID: java.util.UUID, request: Request)\n```\n\n  - The deprecated change_password  API would throw Forbidden response always. Also, it would suggest the user to use the new API for changing the password.\n\n  - The reason for deprecating this API is because the request body does not support a way to provide the current password. Also, we do not require the userUUID as part of the request as we only allow password change from the same user.\n\n  - The API\n```\nPUT    /customers/:cUUID/users/:uUUID/update_profile                           com.yugabyte.yw.controllers.UsersController.updateProfile(cUUID: java.util.UUID, uUUID: java.util.UUID, request: Request)\n```\n I would throw Forbidden response in case the request attempts to change the password. I would also make a change to disallow a user to change their own Role in the old RBAC way using the update_profile API.\n\n  - The new API PUT    /customers/:cUUID/reset_password is used to reset the password of the loggedin user only. The user is identified using the Auth/API token.\n\n```\n{\n    \"currentPassword\": \"oldPassword\",\n    \"newPassword\": \"newPassword\"\n}\n```\n\nOriginal commit: https://github.com/yugabyte/yugabyte-db/commit/db597f2daf1d44df8a62eb36bd534e9b2f785fb8\nOriginal diff: https://phorge.dev.yugabyte.com/D34049\n\nTest Plan:\nManual testing with old RBAC and new RBAC flows\nUTs\n\nReviewers: #yba-api-review, sneelakantan\n\nReviewed By: #yba-api-review, sneelakantan\n\nSubscribers: yugaware\n\nTags: #jenkins-ready\n\nDifferential Revision: https://phorge.dev.yugabyte.com/D34429\n\nFilename: managed/src/main/java/com/yugabyte/yw/common/RedactingService.java:\n```\n@@ -34,6 +34,8 @@\npublic class RedactingService {\n           .addAll(SECRET_PATHS_FOR_APIS)\n           .add(\"$..password\")\n           .add(\"$..confirmPassword\")\n+          .add(\"$..newPassword\")\n+          .add(\"$..currentPassword\")\n           .add(\"$..['config.AWS_ACCESS_KEY_ID']\")\n           .add(\"$..['config.AWS_SECRET_ACCESS_KEY']\")\n           // GCP private key\n```\n\nFilename: managed/src/main/java/com/yugabyte/yw/controllers/UsersController.java:\n```\n@@ -20,12 +20,14 @@\nimport com.yugabyte.yw.common.user.UserService;\n import com.yugabyte.yw.forms.PlatformResults;\n import com.yugabyte.yw.forms.PlatformResults.YBPSuccess;\n+import com.yugabyte.yw.forms.UserPasswordChangeFormData;\n import com.yugabyte.yw.forms.UserProfileFormData;\n import com.yugabyte.yw.forms.UserRegisterFormData;\n import com.yugabyte.yw.models.Audit;\n import com.yugabyte.yw.models.Customer;\n import com.yugabyte.yw.models.Users;\n import com.yugabyte.yw.models.Users.UserType;\n+import com.yugabyte.yw.models.common.YbaApi;\n import com.yugabyte.yw.models.extended.UserWithFeatures;\n import com.yugabyte.yw.models.rbac.ResourceGroup;\n import com.yugabyte.yw.models.rbac.Role;\n\n@@ -46,6 +48,7 @@\nimport java.util.*;\n import java.util.stream.Collectors;\n import javax.inject.Inject;\n+import lombok.extern.slf4j.Slf4j;\n import org.apache.commons.lang3.StringUtils;\n import org.slf4j.Logger;\n import org.slf4j.LoggerFactory;\n\n@@ -57,6 +60,7 @@\n@Api(\n     value = \"User management\",\n     authorizations = @Authorization(AbstractPlatformController.API_KEY_AUTH))\n+@Slf4j\n public class UsersController extends AuthenticatedController {\n \n   public static final Logger LOG = LoggerFactory.getLogger(UsersController.class);\n\n@@ -441,9 +445,8 @@\npublic Result changeRole(UUID customerUUID, UUID userUUID, String role, Http.Req\n    * @return JSON response on whether role change was successful or not.\n    */\n   @ApiOperation(\n-      value = \"Change a user's password\",\n-      nickname = \"updateUserPassword\",\n-      response = YBPSuccess.class)\n+      notes = \"<b style=\\\"color:#ff0000\\\">Deprecated since YBA version 2024.1.0.0.</b></p>\",\n+      value = \"Change password - deprecated\")\n   @ApiImplicitParams({\n     @ApiImplicitParam(\n         name = \"Users\",\n\n@@ -459,36 +462,64 @@\npublic Result changeRole(UUID customerUUID, UUID userUUID, String role, Http.Req\n                   resourceType = ResourceType.USER,\n                   action = Action.UPDATE_PROFILE),\n           resourceLocation = @Resource(path = Util.USERS, sourceType = SourceType.ENDPOINT)))\n+  @YbaApi(visibility = YbaApi.YbaApiVisibility.DEPRECATED, sinceYBAVersion = \"2.20.4.0\")\n+  @Deprecated\n   public Result changePassword(UUID customerUUID, UUID userUUID, Http.Request request) {\n-    Users user = Users.getOrBadRequest(customerUUID, userUUID);\n-    if (UserType.ldap == user.getUserType()) {\n-      throw new PlatformServiceException(BAD_REQUEST, \"Can't change password for LDAP user.\");\n-    }\n+    throw new PlatformServiceException(\n+        MOVED_PERMANENTLY, String.format(\"Moved to /customers/%s/reset_password\", customerUUID));\n+  }\n+\n+  /**\n+   * PUT endpoint for changing the password of an existing user.\n+   *\n+   * @return JSON response on whether role change was successful or not.\n+   */\n+  @ApiOperation(\n+      value = \"Reset the user's password\",\n+      nickname = \"resetUserPassword\",\n+      response = YBPSuccess.class)\n+  @ApiImplicitParams({\n+    @ApiImplicitParam(\n+        name = \"Users\",\n+        value = \"User data containing the current, new password\",\n+        required = true,\n+        dataType = \"com.yugabyte.yw.forms.UserPasswordChangeFormData\",\n+        paramType = \"body\")\n+  })\n+  @AuthzPath(\n+      @RequiredPermissionOnResource(\n+          requiredPermission =\n+              @PermissionAttribute(\n+                  resourceType = ResourceType.USER,\n+                  action = Action.UPDATE_PROFILE),\n+          resourceLocation = @Resource(path = Util.USERS, sourceType = SourceType.REQUEST_CONTEXT)))\n+  public Result resetPassword(UUID customerUUID, Http.Request request) {\n+    Users user = getLoggedInUser(request);\n+    Form<UserPasswordChangeFormData> form =\n+        formFactory.getFormDataOrBadRequest(request, UserPasswordChangeFormData.class);\n+    UserPasswordChangeFormData formData = form.get();\n \n-    if (!checkUpdateProfileAccessForPasswordChange(userUUID, request)) {\n+    if (user.getUserType() == UserType.ldap) {\n       throw new PlatformServiceException(\n-          BAD_REQUEST, \"Only the User can change his/her own password.\");\n+          BAD_REQUEST, \"Reset password not supported for LDAP users\");\n     }\n \n-    Form<UserRegisterFormData> form =\n-        formFactory.getFormDataOrBadRequest(request, UserRegisterFormData.class);\n-\n-    UserRegisterFormData formData = form.get();\n-    passwordPolicyService.checkPasswordPolicy(customerUUID, formData.getPassword());\n-    if (formData.getEmail().equals(user.getEmail())) {\n-      if (formData.getPassword().equals(formData.getConfirmPassword())) {\n-        user.setPassword(formData.getPassword());\n-        user.save();\n-        auditService()\n-            .createAuditEntry(\n-                request,\n-                Audit.TargetType.User,\n-                userUUID.toString(),\n-                Audit.ActionType.ChangeUserPassword);\n-        return YBPSuccess.empty();\n-      }\n+    user = Users.authWithPassword(user.getEmail(), formData.getCurrentPassword());\n+    if (user == null) {\n+      throw new PlatformServiceException(UNAUTHORIZED, \"Incorrect current password provided\");\n     }\n-    throw new PlatformServiceException(BAD_REQUEST, \"Invalid user credentials.\");\n+\n+    passwordPolicyService.checkPasswordPolicy(customerUUID, formData.getNewPassword());\n+    user.setPassword(formData.getNewPassword());\n+    user.save();\n+    auditService()\n+        .createAuditEntryWithReqBody(\n+            request,\n+            Audit.TargetType.User,\n+            user.getUuid().toString(),\n+            Audit.ActionType.ChangeUserPassword,\n+            Json.toJson(formData));\n+    return YBPSuccess.empty();\n   }\n \n   private Users getLoggedInUser(Http.Request request) {\n\n@@ -542,21 +573,11 @@\npublic Result updateProfile(UUID customerUUID, UUID userUUID, Http.Request reque\n \n     // Password validation for both old RBAC and new RBAC is same.\n     if (StringUtils.isNotEmpty(formData.getPassword())) {\n-      if (UserType.ldap == user.getUserType()) {\n-        throw new PlatformServiceException(BAD_REQUEST, \"Can't change password for LDAP user.\");\n-      }\n-\n-      if (!checkUpdateProfileAccessForPasswordChange(userUUID, request)) {\n-        throw new PlatformServiceException(\n-            BAD_REQUEST, \"Only the User can change his/her own password.\");\n-      }\n-\n-      passwordPolicyService.checkPasswordPolicy(customerUUID, formData.getPassword());\n-      if (!formData.getPassword().equals(formData.getConfirmPassword())) {\n-        throw new PlatformServiceException(\n-            BAD_REQUEST, \"Password and confirm password do not match.\");\n-      }\n-      user.setPassword(formData.getPassword());\n+      throw new PlatformServiceException(\n+          FORBIDDEN,\n+          String.format(\n+              \"API does not support password change. Use /customers/%s/reset_password\",\n+              customerUUID));\n     }\n \n     if (useNewAuthz) {\n\n@@ -606,6 +627,11 @@\npublic Result updateProfile(UUID customerUUID, UUID userUUID, Http.Request reque\n               BAD_REQUEST, \"Can't Assign the role of SuperAdmin to another user.\");\n         }\n \n+        if (loggedInUser.getUuid().equals(user.getUuid())) {\n+          throw new PlatformServiceException(\n+              FORBIDDEN, \"User cannot modify their own role privileges\");\n+        }\n+\n         if (user.getUserType() == UserType.ldap && user.isLdapSpecifiedRole() == true) {\n           throw new PlatformServiceException(BAD_REQUEST, \"Cannot change role for LDAP user.\");\n         }\n```\n\nFilename: managed/src/main/java/com/yugabyte/yw/forms/UserPasswordChangeFormData.java:\n```\n@@ -0,0 +1,20 @@\n+package com.yugabyte.yw.forms;\n+\n+import io.swagger.annotations.ApiModel;\n+import io.swagger.annotations.ApiModelProperty;\n+import lombok.Getter;\n+import lombok.Setter;\n+\n+@ApiModel(\n+    value = \"UserPasswordChangeFormData\",\n+    description = \"User registration data. The API and UI use this to validate form data.\")\n+@Getter\n+@Setter\n+public class UserPasswordChangeFormData {\n+\n+  @ApiModelProperty(value = \"Current Password\", example = \"Test@1234\")\n+  private String currentPassword;\n+\n+  @ApiModelProperty(value = \"New Password\", example = \"Test@1234\")\n+  private String newPassword;\n+}\n```\n\nFilename: managed/src/main/java/com/yugabyte/yw/rbac/enums/SourceType.java:\n```\n@@ -4,7 +4,8 @@\npublic enum SourceType {\n   ENDPOINT(\"endpoint\"),\n   REQUEST_BODY(\"requestBody\"),\n-  DB(\"db\");\n+  DB(\"db\"),\n+  REQUEST_CONTEXT(\"requestContext\");\n \n   private final String type;\n```\n\nFilename: managed/src/main/java/com/yugabyte/yw/rbac/handlers/AuthorizationHandler.java:\n```\n@@ -5,6 +5,7 @@\nimport com.fasterxml.jackson.databind.ObjectMapper;\n import com.google.inject.Inject;\n import com.typesafe.config.Config;\n+import com.yugabyte.yw.common.Util;\n import com.yugabyte.yw.common.config.GlobalConfKeys;\n import com.yugabyte.yw.common.config.RuntimeConfigCache;\n import com.yugabyte.yw.controllers.JWTVerifier;\n\n@@ -44,7 +45,6 @@\npublic class AuthorizationHandler extends Action<AuthzPath> {\n   public static final String API_TOKEN_HEADER = \"X-AUTH-YW-API-TOKEN\";\n   public static final String API_JWT_HEADER = \"X-AUTH-YW-API-JWT\";\n   public static final String COOKIE_PLAY_SESSION = \"PLAY_SESSION\";\n-  private static final String CUSTOMERS = \"customers\";\n \n   private final Config config;\n   private final RuntimeConfigCache runtimeConfigCache;\n\n@@ -81,12 +81,13 @@\npublic CompletionStage<Result> call(Http.Request request) {\n       return CompletableFuture.completedFuture(Results.unauthorized(\"Unable To authenticate User\"));\n     }\n     UserWithFeatures userWithFeatures = new UserWithFeatures().setUser(user);\n-    RequestContext.put(TokenAuthenticator.CUSTOMER, Customer.get(user.getCustomerUUID()));\n+    Customer customer = Customer.get(user.getCustomerUUID());\n+    RequestContext.put(TokenAuthenticator.CUSTOMER, customer);\n     RequestContext.put(TokenAuthenticator.USER, userWithFeatures);\n \n     String endpoint = request.uri();\n     UUID customerUUID = null;\n-    Pattern custPattern = Pattern.compile(String.format(\".*/%s/\" + UUID_PATTERN, CUSTOMERS));\n+    Pattern custPattern = Pattern.compile(String.format(\".*/%s/\" + UUID_PATTERN, Util.CUSTOMERS));\n     Matcher custMatcher = custPattern.matcher(endpoint);\n     if (custMatcher.find()) {\n       customerUUID = UUID.fromString(custMatcher.group(1));\n\n@@ -149,7 +150,7 @@\npublic CompletionStage<Result> call(Http.Request request) {\n             Matcher matcher = pattern.matcher(endpoint);\n             if (matcher.find()) {\n               resourceUUID = UUID.fromString(matcher.group(3));\n-            } else if (resource.path().equals(CUSTOMERS)) {\n+            } else if (resource.path().equals(Util.CUSTOMERS)) {\n               resourceUUID = user.getCustomerUUID();\n             }\n             isPermissionPresentOnResource =\n\n@@ -233,6 +234,46 @@\npublic CompletionStage<Result> call(Http.Request request) {\n             }\n             break;\n           }\n+        case REQUEST_CONTEXT:\n+          {\n+            switch (resource.path()) {\n+              case Util.USERS:\n+                {\n+                  isPermissionPresentOnResource =\n+                      checkResourcePermission(applicableRoleBindings, attribute, user.getUuid());\n+                  if (!isPermissionPresentOnResource) {\n+                    log.debug(\n+                        \"User {} does not have role bindings for the permission {}\",\n+                        user.getUuid(),\n+                        attribute);\n+                    return CompletableFuture.completedFuture(\n+                        Results.unauthorized(\"Unable to authorize user\"));\n+                  }\n+                  break;\n+                }\n+              case Util.CUSTOMERS:\n+                {\n+                  isPermissionPresentOnResource =\n+                      checkResourcePermission(\n+                          applicableRoleBindings, attribute, customer.getUuid());\n+                  if (!isPermissionPresentOnResource) {\n+                    log.debug(\n+                        \"User {} does not have role bindings for the permission {}\",\n+                        user.getUuid(),\n+                        attribute);\n+                    return CompletableFuture.completedFuture(\n+                        Results.unauthorized(\"Unable to authorize user\"));\n+                  }\n+                  break;\n+                }\n+              default:\n+                {\n+                  return CompletableFuture.completedFuture(\n+                      Results.unauthorized(\"Unable to authorize user\"));\n+                }\n+            }\n+            break;\n+          }\n         default:\n           {\n             log.debug(\"Authorization logic {} not supported\", resource.sourceType());\n```\n\nFilename: managed/src/main/resources/swagger-strict.json:\n```\n@@ -14087,6 +14087,22 @@\n},\n       \"type\" : \"object\"\n     },\n+    \"UserPasswordChangeFormData\" : {\n+      \"description\" : \"User registration data. The API and UI use this to validate form data.\",\n+      \"properties\" : {\n+        \"currentPassword\" : {\n+          \"description\" : \"Current Password\",\n+          \"example\" : \"Test@1234\",\n+          \"type\" : \"string\"\n+        },\n+        \"newPassword\" : {\n+          \"description\" : \"New Password\",\n+          \"example\" : \"Test@1234\",\n+          \"type\" : \"string\"\n+        }\n+      },\n+      \"type\" : \"object\"\n+    },\n     \"UserProfileData\" : {\n       \"description\" : \"User profile data. The API and UI use this to validate form data.\",\n       \"properties\" : {\n\n@@ -21668,6 +21684,52 @@\n\"tags\" : [ \"Release management\" ]\n       }\n     },\n+    \"/api/v1/customers/{cUUID}/reset_password\" : {\n+      \"put\" : {\n+        \"description\" : \"\",\n+        \"operationId\" : \"resetUserPassword\",\n+        \"parameters\" : [ {\n+          \"format\" : \"uuid\",\n+          \"in\" : \"path\",\n+          \"name\" : \"cUUID\",\n+          \"required\" : true,\n+          \"type\" : \"string\"\n+        }, {\n+          \"in\" : \"query\",\n+          \"name\" : \"request\",\n+          \"required\" : false\n+        }, {\n+          \"description\" : \"User data containing the current, new password\",\n+          \"in\" : \"body\",\n+          \"name\" : \"Users\",\n+          \"required\" : true,\n+          \"schema\" : {\n+            \"$ref\" : \"#/definitions/UserPasswordChangeFormData\"\n+          }\n+        } ],\n+        \"responses\" : {\n+          \"200\" : {\n+            \"description\" : \"successful operation\",\n+            \"schema\" : {\n+              \"$ref\" : \"#/definitions/YBPSuccess\"\n+            }\n+          }\n+        },\n+        \"responsesObject\" : {\n+          \"200\" : {\n+            \"description\" : \"successful operation\",\n+            \"schema\" : {\n+              \"$ref\" : \"#/definitions/YBPSuccess\"\n+            }\n+          }\n+        },\n+        \"security\" : [ {\n+          \"apiKeyAuth\" : [ ]\n+        } ],\n+        \"summary\" : \"Reset the user's password\",\n+        \"tags\" : [ \"User management\" ]\n+      }\n+    },\n     \"/api/v1/customers/{cUUID}/restore\" : {\n       \"post\" : {\n         \"description\" : \"\",\n\n@@ -26085,58 +26147,6 @@\n\"tags\" : [ \"Audit\" ]\n       }\n     },\n-    \"/api/v1/customers/{cUUID}/users/{uUUID}/change_password\" : {\n-      \"put\" : {\n-        \"description\" : \"\",\n-        \"operationId\" : \"updateUserPassword\",\n-        \"parameters\" : [ {\n-          \"format\" : \"uuid\",\n-          \"in\" : \"path\",\n-          \"name\" : \"cUUID\",\n-          \"required\" : true,\n-          \"type\" : \"string\"\n-        }, {\n-          \"format\" : \"uuid\",\n-          \"in\" : \"path\",\n-          \"name\" : \"uUUID\",\n-          \"required\" : true,\n-          \"type\" : \"string\"\n-        }, {\n-          \"in\" : \"query\",\n-          \"name\" : \"request\",\n-          \"required\" : false\n-        }, {\n-          \"description\" : \"User data containing the new password\",\n-          \"in\" : \"body\",\n-          \"name\" : \"Users\",\n-          \"required\" : true,\n-          \"schema\" : {\n-            \"$ref\" : \"#/definitions/UserRegistrationData\"\n-          }\n-        } ],\n-        \"responses\" : {\n-          \"200\" : {\n-            \"description\" : \"successful operation\",\n-            \"schema\" : {\n-              \"$ref\" : \"#/definitions/YBPSuccess\"\n-            }\n-          }\n-        },\n-        \"responsesObject\" : {\n-          \"200\" : {\n-            \"description\" : \"successful operation\",\n-            \"schema\" : {\n-              \"$ref\" : \"#/definitions/YBPSuccess\"\n-            }\n-          }\n-        },\n-        \"security\" : [ {\n-          \"apiKeyAuth\" : [ ]\n-        } ],\n-        \"summary\" : \"Change a user's password\",\n-        \"tags\" : [ \"User management\" ]\n-      }\n-    },\n     \"/api/v1/customers/{cUUID}/users/{uUUID}/oidc_auth_token\" : {\n       \"get\" : {\n         \"description\" : \"\",\n```\n\nFilename: managed/src/main/resources/swagger.json:\n```\n@@ -14205,6 +14205,22 @@\n},\n       \"type\" : \"object\"\n     },\n+    \"UserPasswordChangeFormData\" : {\n+      \"description\" : \"User registration data. The API and UI use this to validate form data.\",\n+      \"properties\" : {\n+        \"currentPassword\" : {\n+          \"description\" : \"Current Password\",\n+          \"example\" : \"Test@1234\",\n+          \"type\" : \"string\"\n+        },\n+        \"newPassword\" : {\n+          \"description\" : \"New Password\",\n+          \"example\" : \"Test@1234\",\n+          \"type\" : \"string\"\n+        }\n+      },\n+      \"type\" : \"object\"\n+    },\n     \"UserProfileData\" : {\n       \"description\" : \"User profile data. The API and UI use this to validate form data.\",\n       \"properties\" : {\n\n@@ -22463,6 +22479,52 @@\n\"tags\" : [ \"Release management\" ]\n       }\n     },\n+    \"/api/v1/customers/{cUUID}/reset_password\" : {\n+      \"put\" : {\n+        \"description\" : \"\",\n+        \"operationId\" : \"resetUserPassword\",\n+        \"parameters\" : [ {\n+          \"format\" : \"uuid\",\n+          \"in\" : \"path\",\n+          \"name\" : \"cUUID\",\n+          \"required\" : true,\n+          \"type\" : \"string\"\n+        }, {\n+          \"in\" : \"query\",\n+          \"name\" : \"request\",\n+          \"required\" : false\n+        }, {\n+          \"description\" : \"User data containing the current, new password\",\n+          \"in\" : \"body\",\n+          \"name\" : \"Users\",\n+          \"required\" : true,\n+          \"schema\" : {\n+            \"$ref\" : \"#/definitions/UserPasswordChangeFormData\"\n+          }\n+        } ],\n+        \"responses\" : {\n+          \"200\" : {\n+            \"description\" : \"successful operation\",\n+            \"schema\" : {\n+              \"$ref\" : \"#/definitions/YBPSuccess\"\n+            }\n+          }\n+        },\n+        \"responsesObject\" : {\n+          \"200\" : {\n+            \"description\" : \"successful operation\",\n+            \"schema\" : {\n+              \"$ref\" : \"#/definitions/YBPSuccess\"\n+            }\n+          }\n+        },\n+        \"security\" : [ {\n+          \"apiKeyAuth\" : [ ]\n+        } ],\n+        \"summary\" : \"Reset the user's password\",\n+        \"tags\" : [ \"User management\" ]\n+      }\n+    },\n     \"/api/v1/customers/{cUUID}/restore\" : {\n       \"post\" : {\n         \"description\" : \"\",\n\n@@ -27453,8 +27515,9 @@\n},\n     \"/api/v1/customers/{cUUID}/users/{uUUID}/change_password\" : {\n       \"put\" : {\n-        \"description\" : \"\",\n-        \"operationId\" : \"updateUserPassword\",\n+        \"deprecated\" : true,\n+        \"description\" : \"<b style=\\\"color:#ff0000\\\">Deprecated since YBA version 2024.1.0.0.</b></p>\",\n+        \"operationId\" : \"changePassword\",\n         \"parameters\" : [ {\n           \"format\" : \"uuid\",\n           \"in\" : \"path\",\n\n@@ -27481,25 +27544,19 @@\n}\n         } ],\n         \"responses\" : {\n-          \"200\" : {\n-            \"description\" : \"successful operation\",\n-            \"schema\" : {\n-              \"$ref\" : \"#/definitions/YBPSuccess\"\n-            }\n+          \"default\" : {\n+            \"description\" : \"successful operation\"\n           }\n         },\n         \"responsesObject\" : {\n-          \"200\" : {\n-            \"description\" : \"successful operation\",\n-            \"schema\" : {\n-              \"$ref\" : \"#/definitions/YBPSuccess\"\n-            }\n+          \"default\" : {\n+            \"description\" : \"successful operation\"\n           }\n         },\n         \"security\" : [ {\n           \"apiKeyAuth\" : [ ]\n         } ],\n-        \"summary\" : \"Change a user's password\",\n+        \"summary\" : \"Change password - deprecated\",\n         \"tags\" : [ \"User management\" ]\n       }\n     },\n```\n\nFilename: managed/src/main/resources/v1.routes:\n```\n@@ -480,6 +480,8 @@\nPUT    /customers/:cUUID/users/:uUUID                                          c\n PUT    /customers/:cUUID/users/:uUUID/change_password                          com.yugabyte.yw.controllers.UsersController.changePassword(cUUID: java.util.UUID, uUUID: java.util.UUID, request: Request)\n PUT    /customers/:cUUID/users/:uUUID/update_profile                           com.yugabyte.yw.controllers.UsersController.updateProfile(cUUID: java.util.UUID, uUUID: java.util.UUID, request: Request)\n DELETE /customers/:cUUID/users/:uUUID                                          com.yugabyte.yw.controllers.UsersController.delete(cUUID: java.util.UUID, uUUID: java.util.UUID, request: Request)\n+PUT    /customers/:cUUID/reset_password                                        com.yugabyte.yw.controllers.UsersController.resetPassword(cUUID: java.util.UUID, request: Request)\n+\n + forceAudit\n GET    /customers/:cUUID/users/:uUUID/oidc_auth_token                          com.yugabyte.yw.controllers.UsersController.retrieveOidcAuthToken(cUUID: java.util.UUID, uUUID: java.util.UUID, request: Request)\n```\n\nFilename: managed/src/test/java/com/yugabyte/yw/controllers/UsersControllerTest.java:\n```\n@@ -3,10 +3,13 @@\npackage com.yugabyte.yw.controllers;\n \n import static com.yugabyte.yw.common.AssertHelper.assertAuditEntry;\n+import static com.yugabyte.yw.common.AssertHelper.assertErrorResponse;\n+import static com.yugabyte.yw.common.AssertHelper.assertOk;\n import static com.yugabyte.yw.common.AssertHelper.assertPlatformException;\n import static com.yugabyte.yw.models.Users.Role;\n import static org.hamcrest.CoreMatchers.*;\n import static org.junit.Assert.*;\n+import static org.junit.Assert.assertNotNull;\n import static play.mvc.Http.Status.*;\n import static play.test.Helpers.contentAsString;\n import static play.test.Helpers.fakeRequest;\n\n@@ -20,11 +23,23 @@\nimport com.yugabyte.yw.common.ModelFactory;\n import com.yugabyte.yw.common.encryption.HashBuilder;\n import com.yugabyte.yw.common.encryption.bc.BcOpenBsdHasher;\n+import com.yugabyte.yw.common.rbac.Permission;\n+import com.yugabyte.yw.common.rbac.PermissionInfo.Action;\n+import com.yugabyte.yw.common.rbac.PermissionInfo.ResourceType;\n import com.yugabyte.yw.models.Customer;\n+import com.yugabyte.yw.models.RuntimeConfigEntry;\n import com.yugabyte.yw.models.Users;\n import com.yugabyte.yw.models.extended.UserWithFeatures;\n+import com.yugabyte.yw.models.rbac.ResourceGroup;\n+import com.yugabyte.yw.models.rbac.ResourceGroup.ResourceDefinition;\n+import com.yugabyte.yw.models.rbac.Role.RoleType;\n+import com.yugabyte.yw.models.rbac.RoleBinding;\n+import com.yugabyte.yw.models.rbac.RoleBinding.RoleBindingType;\n import java.io.IOException;\n+import java.util.Arrays;\n+import java.util.HashSet;\n import java.util.List;\n+import java.util.UUID;\n import org.junit.Before;\n import org.junit.Test;\n import play.libs.Json;\n\n@@ -37,13 +52,30 @@\npublic class UsersControllerTest extends FakeDBApplication {\n   private Customer customer1, customer2;\n   private Users user1;\n   private String authToken1;\n+  private com.yugabyte.yw.models.rbac.Role role;\n+  private ResourceDefinition rd1;\n   private HashBuilder hashBuilder = new BcOpenBsdHasher();\n \n+  Permission permission1 = new Permission(ResourceType.USER, Action.UPDATE_PROFILE);\n+\n   @Before\n   public void setUp() {\n     customer1 = ModelFactory.testCustomer(\"tc1\", \"Test Customer 1\");\n     customer2 = ModelFactory.testCustomer(\"tc2\", \"Test Customer 2\");\n     user1 = ModelFactory.testUser(customer1, \"tc1@test.com\");\n+    role =\n+        com.yugabyte.yw.models.rbac.Role.create(\n+            customer1.getUuid(),\n+            \"FakeRole1\",\n+            \"testDescription\",\n+            RoleType.Custom,\n+            new HashSet<>(Arrays.asList(permission1)));\n+    rd1 =\n+        ResourceDefinition.builder()\n+            .resourceType(ResourceType.USER)\n+            .resourceUUIDSet(new HashSet<>(Arrays.asList(user1.getUuid())))\n+            .build();\n+\n     authToken1 = user1.createAuthToken();\n   }\n\n@@ -247,44 +279,115 @@\npublic void testPasswordChangeValid() throws IOException {\n     params.put(\"confirmPassword\", \"new-Password1\");\n     params.put(\"role\", \"Admin\");\n     Http.Cookie validCookie = Http.Cookie.builder(\"authToken\", authTokenTest).build();\n+    Result result =\n+        assertPlatformException(\n+            () ->\n+                route(\n+                    fakeRequest(\n+                            \"PUT\",\n+                            String.format(\n+                                \"%s/%s/change_password\",\n+                                String.format(baseRoute, customer1.getUuid()), testUser1.getUuid()))\n+                        .cookie(validCookie)\n+                        .bodyJson(params)));\n+    assertEquals(result.status(), MOVED_PERMANENTLY);\n+    assertErrorResponse(\n+        result, String.format(\"Moved to /customers/%s/reset_password\", customer1.getUuid()));\n+  }\n+\n+  @Test\n+  public void testResetPassword() {\n+    Users testUser1 = ModelFactory.testUser(customer1, \"tc3@test.com\", Role.Admin);\n+    String authTokenTest = testUser1.createAuthToken();\n+    assertEquals(testUser1.getRole(), Role.Admin);\n+    ObjectNode params = Json.newObject();\n+    params.put(\"currentPassword\", \"password\");\n+    params.put(\"newPassword\", \"Password#123\");\n+    Http.Cookie validCookie = Http.Cookie.builder(\"authToken\", authTokenTest).build();\n     Result result =\n         route(\n             fakeRequest(\n-                    \"PUT\",\n-                    String.format(\n-                        \"%s/%s/change_password\",\n-                        String.format(baseRoute, customer1.getUuid()), testUser1.getUuid()))\n+                    \"PUT\", String.format(\"/api/customers/%s/reset_password\", customer1.getUuid()))\n                 .cookie(validCookie)\n                 .bodyJson(params));\n     testUser1 = Users.get(testUser1.getUuid());\n+    assertOk(result);\n+    assertAuditEntry(1, customer1.getUuid());\n+    Users returnUser = Users.authWithPassword(testUser1.getEmail(), \"Password#123\");\n+    assertNotNull(returnUser);\n+  }\n+\n+  @Test\n+  public void testResetPasswordForNonLocalUser() {\n+    Users testUser1 = ModelFactory.testUser(customer1, \"tc3@test.com\", Role.Admin);\n+    testUser1.setUserType(Users.UserType.ldap);\n+    testUser1.save();\n+    String authTokenTest = testUser1.createAuthToken();\n     assertEquals(testUser1.getRole(), Role.Admin);\n-    assertTrue(hashBuilder.isValid(\"new-Password1\", testUser1.getPasswordHash()));\n+    ObjectNode params = Json.newObject();\n+    params.put(\"currentPassword\", \"password\");\n+    params.put(\"newPassword\", \"Password#123\");\n+    Http.Cookie validCookie = Http.Cookie.builder(\"authToken\", authTokenTest).build();\n+    Result result =\n+        assertPlatformException(\n+            () ->\n+                route(\n+                    fakeRequest(\n+                            \"PUT\",\n+                            String.format(\"/api/customers/%s/reset_password\", customer1.getUuid()))\n+                        .cookie(validCookie)\n+                        .bodyJson(params)));\n+    assertEquals(result.status(), BAD_REQUEST);\n+    assertErrorResponse(result, \"Reset password not supported for LDAP users\");\n+  }\n+\n+  @Test\n+  public void testResetPasswordWithNewRbac() {\n+    RuntimeConfigEntry.upsertGlobal(\"yb.rbac.use_new_authz\", \"true\");\n+    ResourceGroup rG = new ResourceGroup(new HashSet<>(Arrays.asList(rd1)));\n+    RoleBinding.create(user1, RoleBindingType.Custom, role, rG);\n+    String authTokenTest = user1.createAuthToken();\n+    assertEquals(user1.getRole(), Role.Admin);\n+    ObjectNode params = Json.newObject();\n+    params.put(\"currentPassword\", \"password\");\n+    params.put(\"newPassword\", \"Password#123\");\n+    Http.Cookie validCookie = Http.Cookie.builder(\"authToken\", authTokenTest).build();\n+    Result result =\n+        route(\n+            fakeRequest(\n+                    \"PUT\", String.format(\"/api/customers/%s/reset_password\", customer1.getUuid()))\n+                .cookie(validCookie)\n+                .bodyJson(params));\n+    user1 = Users.get(user1.getUuid());\n+    assertOk(result);\n     assertAuditEntry(1, customer1.getUuid());\n+    Users returnUser = Users.authWithPassword(user1.getEmail(), \"Password#123\");\n+    assertNotNull(returnUser);\n   }\n \n   @Test\n-  public void testPasswordChangeInvalidPassword() throws IOException {\n+  public void testResetPasswordInvalidPassword() throws IOException {\n     Users testUser1 = ModelFactory.testUser(customer1, \"tc3@test.com\", Role.Admin);\n     String authTokenTest = testUser1.createAuthToken();\n     assertEquals(testUser1.getRole(), Role.Admin);\n     ObjectNode params = Json.newObject();\n-    params.put(\"email\", \"tc3@test.com\");\n-    params.put(\"password\", \"new-password\");\n-    params.put(\"confirmPassword\", \"new-password\");\n-    params.put(\"role\", \"Admin\");\n+    params.put(\"currentPassword\", \"password\");\n+    params.put(\"newPassword\", \"new-password\");\n     Http.Cookie validCookie = Http.Cookie.builder(\"authToken\", authTokenTest).build();\n     Result result =\n         assertPlatformException(\n             () ->\n                 route(\n                     fakeRequest(\n                             \"PUT\",\n-                            String.format(\n-                                \"%s/%s/change_password\",\n-                                String.format(baseRoute, customer1.getUuid()), testUser1.getUuid()))\n+                            String.format(\"/api/customers/%s/reset_password\", customer1.getUuid()))\n                         .cookie(validCookie)\n                         .bodyJson(params)));\n     assertEquals(result.status(), BAD_REQUEST);\n+    assertErrorResponse(\n+        result,\n+        \"Password should contain at least 1 upper case letters; Password should contain at least 1\"\n+            + \" digits\");\n   }\n \n   @Test\n\n@@ -315,10 +418,8 @@\npublic void testUpdateUserProfileValid() throws IOException {\n     assertEquals(testUser1.getRole(), Role.Admin);\n     ObjectNode params = Json.newObject();\n     params.put(\"email\", \"tc3@test.com\");\n-    params.put(\"password\", \"new-Password1!\");\n-    params.put(\"confirmPassword\", \"new-Password1!\");\n-    params.put(\"role\", \"ReadOnly\");\n     params.put(\"timezone\", testTimezone2);\n+    params.put(\"role\", \"Admin\");\n     Http.Cookie validCookie = Http.Cookie.builder(\"authToken\", authTokenTest).build();\n     Result result =\n         route(\n\n@@ -331,8 +432,6 @@\npublic void testUpdateUserProfileValid() throws IOException {\n                 .bodyJson(params));\n     testUser1 = Users.get(testUser1.getUuid());\n     assertEquals(testUser1.getTimezone(), testTimezone2);\n-    assertTrue(hashBuilder.isValid(\"new-Password1!\", testUser1.getPasswordHash()));\n-    assertEquals(testUser1.getRole(), Role.ReadOnly);\n     assertAuditEntry(1, customer1.getUuid());\n   }\n\n@@ -368,27 +467,25 @@\npublic void testUpdateUserProfileNullifyTimezone() throws IOException {\n     testUser1.setTimezone(testTimezone1);\n     String authTokenTest = testUser1.createAuthToken();\n     assertEquals(testUser1.getRole(), Role.Admin);\n+    UUID testUser1UUID = testUser1.getUuid();\n     ObjectNode params = Json.newObject();\n     params.put(\"email\", \"tc3@test.com\");\n-    params.put(\"password\", \"new-Password1!\");\n-    params.put(\"confirmPassword\", \"new-Password1!\");\n-    params.put(\"role\", \"ReadOnly\");\n     params.put(\"timezone\", \"\");\n+    params.put(\"role\", \"ReadOnly\");\n     Http.Cookie validCookie = Http.Cookie.builder(\"authToken\", authTokenTest).build();\n     Result result =\n-        route(\n-            fakeRequest(\n-                    \"PUT\",\n-                    String.format(\n-                        \"%s/%s/update_profile\",\n-                        String.format(baseRoute, customer1.getUuid()), testUser1.getUuid()))\n-                .cookie(validCookie)\n-                .bodyJson(params));\n-    testUser1 = Users.get(testUser1.getUuid());\n-    assertEquals(testUser1.getTimezone(), \"\");\n-    assertTrue(hashBuilder.isValid(\"new-Password1!\", testUser1.getPasswordHash()));\n-    assertEquals(testUser1.getRole(), Role.ReadOnly);\n-    assertAuditEntry(1, customer1.getUuid());\n+        assertPlatformException(\n+            () ->\n+                route(\n+                    fakeRequest(\n+                            \"PUT\",\n+                            String.format(\n+                                \"/api/customers/%s/users/%s/update_profile\",\n+                                customer1.getUuid(), testUser1UUID))\n+                        .cookie(validCookie)\n+                        .bodyJson(params)));\n+    assertEquals(result.status(), FORBIDDEN);\n+    assertErrorResponse(result, \"User cannot modify their own role privileges\");\n   }\n \n   @Test\n\n@@ -420,7 +517,7 @@\npublic void testUpdateUserProfileInvalid() throws IOException {\n     Users resultTestUser1 = Users.get(testUser1.getUuid());\n     assertEquals(resultTestUser1.getTimezone(), testTimezone1);\n     assertEquals(resultTestUser1.getRole(), Role.Admin);\n-    assertEquals(result.status(), BAD_REQUEST);\n+    assertEquals(result.status(), FORBIDDEN);\n   }\n \n   @Test\n\n@@ -437,16 +534,22 @@\npublic void testUpdateUserProfileValidOnlyPassword() throws IOException {\n     params.put(\"timezone\", testTimezone1);\n     Http.Cookie validCookie = Http.Cookie.builder(\"authToken\", authTokenTest).build();\n     Result result =\n-        route(\n-            fakeRequest(\n-                    \"PUT\",\n-                    String.format(\n-                        \"%s/%s/update_profile\",\n-                        String.format(baseRoute, customer1.getUuid()), testUser1.getUuid()))\n-                .cookie(validCookie)\n-                .bodyJson(params));\n-    testUser1 = Users.get(testUser1.getUuid());\n-    assertTrue(hashBuilder.isValid(\"new-Password1!\", testUser1.getPasswordHash()));\n+        assertPlatformException(\n+            () ->\n+                route(\n+                    fakeRequest(\n+                            \"PUT\",\n+                            String.format(\n+                                \"%s/%s/update_profile\",\n+                                String.format(baseRoute, customer1.getUuid()), testUser1.getUuid()))\n+                        .cookie(validCookie)\n+                        .bodyJson(params)));\n+    assertEquals(result.status(), FORBIDDEN);\n+    assertErrorResponse(\n+        result,\n+        String.format(\n+            \"API does not support password change. Use /customers/%s/reset_password\",\n+            customer1.getUuid()));\n   }\n \n   @Test\n\n@@ -474,7 +577,12 @@\npublic void testUpdateUserProfileInvalidPassword() throws IOException {\n                                 String.format(baseRoute, customer1.getUuid()), testUser1.getUuid()))\n                         .cookie(validCookie)\n                         .bodyJson(params)));\n-    assertEquals(result.status(), BAD_REQUEST);\n+    assertEquals(result.status(), FORBIDDEN);\n+    assertErrorResponse(\n+        result,\n+        String.format(\n+            \"API does not support password change. Use /customers/%s/reset_password\",\n+            customer1.getUuid()));\n   }\n \n   @Test\n\n@@ -518,17 +626,22 @@\npublic void testUpdateUserProfileReadOnlyUserPasswordChange() throws IOException\n     params.put(\"timezone\", testTimezone1);\n     Http.Cookie validCookie = Http.Cookie.builder(\"authToken\", authTokenTest).build();\n     Result result =\n-        route(\n-            fakeRequest(\n-                    \"PUT\",\n-                    String.format(\n-                        \"%s/%s/update_profile\",\n-                        String.format(baseRoute, customer1.getUuid()), testUser1.getUuid()))\n-                .cookie(validCookie)\n-                .bodyJson(params));\n-    testUser1 = Users.get(testUser1.getUuid());\n-    assertTrue(hashBuilder.isValid(\"new-Password1!\", testUser1.getPasswordHash()));\n-    assertAuditEntry(1, customer1.getUuid());\n+        assertPlatformException(\n+            () ->\n+                route(\n+                    fakeRequest(\n+                            \"PUT\",\n+                            String.format(\n+                                \"%s/%s/update_profile\",\n+                                String.format(baseRoute, customer1.getUuid()), testUser1.getUuid()))\n+                        .cookie(validCookie)\n+                        .bodyJson(params)));\n+    assertEquals(result.status(), FORBIDDEN);\n+    assertErrorResponse(\n+        result,\n+        String.format(\n+            \"API does not support password change. Use /customers/%s/reset_password\",\n+            customer1.getUuid()));\n   }\n \n   public void testUpdateUserProfileReadOnlyUserTZChange() throws IOException {\n```"
            }
        ],
        "sw_version": "v2.14.17.0",
        "sw_version_wget": "https://github.com/yugabyte/yugabyte-db/archive/refs/tags/v2.14.17.0.zip",
        "description": "Insufficient authentication in user account management in Yugabyte Platform allows local network attackers with a compromised user session to change critical security information without re-authentication. An attacker with user session and access to application can modify settings such as password and email without being prompted for the current password, enabling account takeover.",
        "sec_adv": [],
        "cwe": [
            {
                "id": "CWE-306",
                "value": "CWE-306 Missing Authentication for Critical Function"
            }
        ]
    }
}