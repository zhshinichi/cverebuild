{
    "CVE-2024-7474": {
        "published_date": "2024-10-29T12:46:34.965Z",
        "patch_commits": [
            {
                "url": "https://github.com/lunary-ai/lunary/commit/8f563c77d8614a72980113f530c7a9ec15a5f8d5",
                "content": "fix: vulnerabilities (#468)\n\nFilename: packages/backend/src/api/v1/datasets/index.ts:\n```\n@@ -107,8 +107,15 @@\ndatasets.patch(\n     }\n \n     const [dataset] = await sql`\n-    update dataset set slug = ${slug} where id = ${id} and project_id = ${projectId} returning *\n-  `\n+      update \n+        dataset \n+      set \n+        slug = ${slug} \n+      where \n+      id = ${id} \n+      and project_id = ${projectId} \n+      returning *\n+    `\n \n     ctx.body = dataset\n   },\n\n@@ -218,10 +225,25 @@\ndatasets.patch(\n   checkAccess(\"datasets\", \"update\"),\n   async (ctx: Context) => {\n     const { id } = ctx.params\n+    const { projectId } = ctx.state\n     const { messages } = ctx.request.body as {\n       messages: string\n     }\n \n+    const [dataset] = await sql`\n+      select \n+        d.id \n+      from \n+        dataset_prompt dp\n+        left join dataset d on dp.dataset_id = d.id\n+      where\n+        d.project_id = ${projectId}\n+    `\n+\n+    if (!dataset) {\n+      ctx.throw(403, \"Unauthorized\")\n+    }\n+\n     const [prompt] =\n       await sql`update dataset_prompt set messages = ${messages} where id = ${id} returning *`\n```\n\nFilename: packages/backend/src/api/v1/external-users.ts:\n```\n@@ -141,17 +141,32 @@\nusers.get(\"/runs/usage\", checkAccess(\"users\", \"read\"), async (ctx) => {\n \n users.get(\"/:id\", checkAccess(\"users\", \"read\"), async (ctx: Context) => {\n   const { id } = ctx.params\n+  const { projectId } = ctx.state\n+\n   const [row] = await sql`\n-    select * from external_user where id = ${id} limit 1\n+    select \n+      * \n+    from \n+      external_user \n+    where \n+      id = ${id} \n+      and project_id = ${projectId}\n   `\n \n   ctx.body = row\n })\n \n users.delete(\"/:id\", checkAccess(\"users\", \"delete\"), async (ctx: Context) => {\n   const { id } = ctx.params\n+  const { projectId } = ctx.state\n \n-  await sql`delete from external_user where id = ${id}`\n+  await sql`\n+    delete \n+    from external_user \n+    where \n+      id = ${id}\n+      and project_id = ${projectId}\n+    `\n \n   ctx.status = 204\n })\n```\n\nFilename: packages/backend/src/api/v1/templates.ts:\n```\n@@ -4,6 +4,7 @@\nimport { clearUndefined } from \"@/src/utils/ingest\"\n import Context from \"@/src/utils/koa\"\n import { unCamelObject } from \"@/src/utils/misc\"\n import Router from \"koa-router\"\n+import { z } from \"zod\"\n \n const templates = new Router({\n   prefix: \"/templates\",\n\n@@ -167,26 +168,44 @@\ntemplates.post(\n   \"/:id/versions\",\n   checkAccess(\"prompts\", \"update\"),\n   async (ctx: Context) => {\n-    const { content, extra, testValues, isDraft, notes } = ctx.request.body as {\n-      content: any[]\n-      extra: any\n-      testValues: any\n-      isDraft: boolean\n-      notes: string\n+    const paramsSchema = z.object({\n+      id: z.coerce.number(),\n+    })\n+    const bodySchema = z.object({\n+      content: z.array(z.any()),\n+      extra: z.any(),\n+      testValues: z.any(),\n+      isDraft: z.boolean(),\n+      notes: z.string().optional().nullable(),\n+    })\n+\n+    const { projectId } = ctx.state\n+    const { content, extra, testValues, isDraft, notes } = bodySchema.parse(\n+      ctx.request.body,\n+    )\n+    const { id: templateId } = paramsSchema.parse(ctx.params)\n+\n+    const [template] =\n+      await sql`select id from template where id = ${templateId} and project_id = ${projectId}\n+    `\n+\n+    if (!template) {\n+      ctx.throw(403, \"Unauthorized\")\n     }\n \n     const [templateVersion] = await sql`\n-    insert into template_version ${sql(\n-      clearUndefined({\n-        templateId: ctx.params.id,\n-        content: sql.json(content),\n-        extra: sql.json(unCamelObject(extra)),\n-        test_values: sql.json(testValues),\n-        isDraft,\n-        notes,\n-      }),\n-    )} returning *\n-  `\n+      insert into template_version ${sql(\n+        clearUndefined({\n+          templateId: ctx.params.id,\n+          content: sql.json(content),\n+          extra: sql.json(unCamelObject(extra)),\n+          test_values: sql.json(testValues),\n+          isDraft,\n+          notes,\n+        }),\n+      )} \n+      returning *\n+    `\n \n     ctx.body = templateVersion\n   },\n```"
            }
        ],
        "sw_version": "v1.3.4-alpha.1",
        "sw_version_wget": "https://github.com/lunary-ai/lunary/archive/refs/tags/v1.3.4-alpha.1.zip",
        "description": "In version 1.3.2 of lunary-ai/lunary, an Insecure Direct Object Reference (IDOR) vulnerability exists. A user can view or delete external users by manipulating the 'id' parameter in the request URL. The application does not perform adequate checks on the 'id' parameter, allowing unauthorized access to external user data.",
        "sec_adv": [
            {
                "url": "https://huntr.com/bounties/95d8b993-3347-4ef5-a2b3-1f57219b7871",
                "content": "Bounties\nPartners\nCommunity\nInfo\nSUBMIT REPORT\nIDOR allow view/delete external_user in lunary-ai/lunary\nValid\nReported on Jul 1st 2024\nDescription\nA lunary user can view/delete all internal users by changing an easily guessable \"id\" value controlled by the user. We can see that the code receives the id value without any checks.\nusers.get(\"/:id\", checkAccess(\"users\", \"read\"), async (ctx: Context) => {\n  const { id } = ctx.params\n  const [row] = await sql`\n    select * from external_user where id = ${id} limit 1\n  `\n\n  ctx.body = row\n})\n\nusers.delete(\"/:id\", checkAccess(\"users\", \"delete\"), async (ctx: Context) => {\n  const { id } = ctx.params\n\n  await sql`delete from external_user where id = ${id}`\n\n  ctx.status = 204\n})\nProof of Concept\nLogin into lunary dashboard.\nGo to task users.\nIntercept request in burp suite and edit ID.\nGET /v1/external-users/1(CHANGE HERE) HTTP/2\nHost: localhost:3333\nUser-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64; rv:127.0) Gecko/20100101 Firefox/127.0\nAccept: */*\nAccept-Language: en-US,en;q=0.5\nAccept-Encoding: gzip, deflate, br\nReferer: https://localhost:8080/\nAuthorization: Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJ1c2VySWQiOiI3NTg3NTk3Ny1lMjQzLTQwOWQtYjc2NC1kMDRjNTUyN2JhNzQiLCJlbWFpbCI6ImdyYXlkZW5pQGZ0aGNhcGl0YWwuY29tIiwib3JnSWQiOiI2NjIxNWI5Yi1hZjMxLTQyNjgtOGY3Ny0zODUwNGU3MWU1MDYiLCJleHAiOjE3MjI0MTA3MTYsImlhdCI6MTcxOTgxODcxNiwibmJmIjoxNzE5ODE4NzE2fQ.rNkirRCw8CJmPyjK6TvHSFNTqq-cZ8EMPpC3Y0CTXK8\nOrigin: https://localhost:8080/\nConnection: close\nImpact\nA user of any application can easily view/delete user_externals by sending a request and changing the value of an easily guessable id.\nWe are processing your report and will contact thelunary-ai/lunary team within 24 hours.a year ago\nhuntr-helper\ncommenteda year ago\nAdmin\nThis report was determined to not have enough information for the maintainer or the Huntr team to triage.\nPlease add more details in all sections of the report.\nAdditionally, at least one PoC (Proof of Concept), needs to be provided. We strongly prefer the PoC to be in any of the following formats:\nSequence of cURL commands\nA script in any programming language\nA Metasploit Module\nPlease note: while videos demonstrating exploitation are a welcomed addition to the report, they should not be used as a replacement for the PoC.\nhuntr-helpermodified the Severity from Critical (9.4) to Critical (9.1)a year ago\nChiencp modified the report10 months ago\nChiencp modified the report10 months ago\nWe have contacted a member of thelunary-ai/lunary team and are waiting to hear back10 months ago\nWe have sent a follow up to the lunary-ai/lunary team. We will try again in 4 days.10 months ago\nWe have sent a second follow up to the lunary-ai/lunary team. We will try again in 7 days.10 months ago\nWe have sent a third follow up to the lunary-ai/lunary team. We will try again in 14 days.10 months ago\nWe have sent a fourth follow up to the lunary-ai/lunary team. We will send a final notification 48 hours before report publication.10 months ago\nThis report has now been passed to internal triage and should be resolved within 14 days.10 months ago\nThe researcher has received a minor penalty to their credibility for miscalculating the severity: -1\nHugues Chocart validated this vulnerability9 months ago\nmeme-dmhas been awarded the disclosure bounty\nThe fix bounty is now up for grabs\nThe researcher's credibility has increased: +7\nCVE-2024-7474assigned to this report.9 months ago\nHugues Chocartmarked this as fixedin 1.3.4with commit8f563c9 months ago\nHugues Chocarthas been awarded the fix bounty\nWe have notified the lunary-ai/lunary maintainers about this report in their weekly follow-up8 months ago\nWe have sent a warning to the lunary-ai/lunary team to inform them that this report will be published in 48 hours8 months ago\nThis vulnerability has now been published8 months ago\nChiencp\ncommented7 months ago\nResearcher\nCan you make this cve public?\nSign in to join this conversation\nCVE\nCVE-2024-7474\n(Published)\nVulnerability Type\nCWE-639: Authorization Bypass Through User-Controlled Key\nSeverity\nCritical (9.1)\nAttack vector\nNetwork\nAttack complexity\nLow\nPrivileges required\nNone\nUser interaction\nNone\nScope\nUnchanged\nConfidentiality\nHigh\nIntegrity\nHigh\nAvailability\nNone\nOpen in visual CVSS calculator\nRegistry\nNpm\nAffected Version\n1.3.2\nVisibility\nPublic\nStatus\nFixed\nDisclosure Bounty\n$900\nFix Bounty\n$225\nFound by\nFixed by\nSupported by Protect AI and leading the way to MLSecOps and greater AI security.\nÂ© 2024\nPrivacy Policy\nTerms of Service\nCode of Conduct\nCookie Preferences\nContact Us",
                "effective": true,
                "effective_reason": "The advisory provides detailed steps on exploiting the vulnerability, including the use of specific tools to modify request parameters."
            }
        ],
        "cwe": [
            {
                "id": "CWE-284",
                "value": "CWE-284 Improper Access Control"
            }
        ]
    }
}