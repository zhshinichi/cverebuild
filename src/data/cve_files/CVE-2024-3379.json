{
    "CVE-2024-3379": {
        "published_date": "2024-11-14T17:34:26.930Z",
        "patch_commits": [
            {
                "url": "https://github.com/lunary-ai/lunary/commit/c57cd50fa0477fd2a2efe60810c0099eebd66f54",
                "content": "fix: security patches (#192)\n\nFilename: packages/backend/src/api/v1/evaluations/index.ts:\n```\n@@ -1,15 +1,14 @@\n-import Router from \"koa-router\"\n+import { runChecksOnRun } from \"@/src/checks/runChecks\"\n+import { checkAccess } from \"@/src/utils/authorization\"\n+import { calcRunCost } from \"@/src/utils/calcCost\"\n+import { getReadableDateTime } from \"@/src/utils/date\"\n import sql from \"@/src/utils/db\"\n import Context from \"@/src/utils/koa\"\n-import { getReadableDateTime } from \"@/src/utils/date\"\n-import { runEval } from \"./utils\"\n-import { getEvaluation } from \"./utils\"\n-import { calcRunCost } from \"@/src/utils/calcCost\"\n-import { runChecksOnRun } from \"@/src/checks/runChecks\"\n+import Router from \"koa-router\"\n+import { RunEvent } from \"lunary/types\"\n import PQueue from \"p-queue\"\n import { PassThrough } from \"stream\"\n-import { checkAccess } from \"@/src/utils/authorization\"\n-import { RunEvent } from \"lunary/types\"\n+import { runEval } from \"./utils\"\n \n const evaluations = new Router({ prefix: \"/evaluations\" })\n\n@@ -20,7 +19,7 @@\nevaluations.post(\n   checkAccess(\"evaluations\", \"create\"),\n   async (ctx: Context) => {\n     const { name, datasetId, checklistId, providers } = ctx.request.body as any\n-    const { userId, projectId } = ctx.state\n+    const { userId, projectId, orgId } = ctx.state\n \n     ctx.request.socket.setTimeout(0)\n     ctx.request.socket.setNoDelay(true)\n\n@@ -37,6 +36,12 @@\nevaluations.post(\n       timeout: 10000,\n     })\n \n+    const [{ plan }] =\n+      await sql`select plan, eval_allowance from org where id = ${orgId}`\n+    if (plan === \"free\") {\n+      ctx.throw(403, \"You can't create evaluations on the free plan.\")\n+    }\n+\n     // TODO: transactions, but not working with because of nesting\n     const evaluationToInsert = {\n       name: name ? name : `Evaluation of ${getReadableDateTime()}`,\n```\n\nFilename: packages/backend/src/api/v1/projects/index.ts:\n```\n@@ -121,7 +121,12 @@\nprojects.post(\n     const { projectId } = ctx.params\n     const { userId } = ctx.state\n \n-    // Define the schema for request body validation using Zod\n+    const [hasAccess] =\n+      await sql`select * from account_project where project_id = ${projectId} and account_id = ${userId}`\n+    if (!hasAccess) {\n+      ctx.throw(401, \"Not allowed\")\n+    }\n+\n     const requestBodySchema = z.object({\n       type: z.enum([\"private\", \"public\"]),\n     })\n```\n\nFilename: packages/backend/src/api/v1/radars.ts:\n```\n@@ -218,7 +218,7 @@\nradars.get(\"/:radarId/chart\", async (ctx) => {\n })\n \n radars.post(\"/\", checkAccess(\"radars\", \"create\"), async (ctx) => {\n-  const { projectId, userId } = ctx.state\n+  const { projectId, userId, orgId } = ctx.state\n   const { description, view, checks, alerts, negative } = ctx.request.body as {\n     description: string\n     view: any[]\n\n@@ -227,6 +227,12 @@\nradars.post(\"/\", checkAccess(\"radars\", \"create\"), async (ctx) => {\n     negative: boolean\n   }\n \n+  const [{ plan }] =\n+    await sql`select plan, eval_allowance from org where id = ${orgId}`\n+  if (plan === \"free\") {\n+    ctx.throw(403, \"You can't create evaluations on the free plan.\")\n+  }\n+\n   const [row] = await sql`\n     insert into radar ${sql({\n       description,\n```"
            }
        ],
        "sw_version": "v1.2.6",
        "sw_version_wget": "https://github.com/lunary-ai/lunary/archive/refs/tags/v1.2.6.zip",
        "description": "In lunary-ai/lunary versions 1.2.2 through 1.2.6, an incorrect authorization vulnerability allows unprivileged users to re-generate the private key for projects they do not have access to. Specifically, a user with a 'Member' role can issue a request to regenerate the private key of a project without having the necessary permissions or being assigned to that project. This issue was fixed in version 1.2.7.",
        "sec_adv": [
            {
                "url": "https://huntr.com/bounties/739df024-a112-47aa-b51d-988c3f855e92",
                "content": "Bounties\nPartners\nCommunity\nInfo\nSUBMIT REPORT\nunprivileged user can re-generate private key for project in lunary-ai/lunary\nValid\nReported on Apr 5th 2024\nBUG\nunprivileged user can re-generate private key for project\nSTEP TO REPRODUCE\n1. create a admin account called user-A in your instance .\n\n2. login into user-A account and add another user called user-B as \"Member\" role .\n\n3. Now create a project called Project-A from user-A account . Dont assign this project to user-B.\nSo, user-B should not access this project.\nLets assume project id is 134d3543-c619-4d2e-83ae-14dff7c59da4\n\n4. Now goto user-b account and here user-B cant see the above project .\nFinally user-B sent bellow request to re-grnerate the project key of above project\nPOST /v1/projects/134d3543-c619-4d2e-83ae-14dff7c59da4/regenerate-key HTTP/2\nHost: localhost:3333\nUser-Agent: Mozilla/5.0 (X11; Linux x86_64; rv:124.0) Gecko/20100101 Firefox/124.0\nAccept: */*\nAccept-Language: en-US,en;q=0.5\nAccept-Encoding: gzip, deflate, br\nReferer: http://localhost:3333\nContent-Type: application/json\nAuthorization: Bearer YOUR_TOKEN\nContent-Length: 18\nOrigin: http://localhost:3333\nAccount: TEST2\n\n{\"type\":\"private\"}\nhere in this request user-B need to change the project id where he does not have access and want to re-generate private key.\\\nImpact\nunprivileged user can re-generate private key for project\nWe are processing your report and will contact thelunary-ai/lunary team within 24 hours.a year ago\nHugues Chocart validated this vulnerabilitya year ago\nranjit-githas been awarded the disclosure bounty\nThe fix bounty is now up for grabs\nThe researcher's credibility has increased: +7\nCVE-2024-3379assigned to this report.a year ago\nHugues Chocartmarked this as fixedin 1.2.7with commitc57cd5a year ago\nHugues Chocarthas been awarded the fix bounty\nHugues Chocart gave praisea year ago\nThanks!\nThe researcher's credibility has slightly increased as a result of the maintainer's thanks: +1\nWe have notified the lunary-ai/lunary maintainers about this report in their weekly follow-up6 months ago\nThis vulnerability has now been published6 months ago\nCVE-2024-3379has now been published6 months ago\nSign in to join this conversation\nCVE\nCVE-2024-3379\n(Published)\nVulnerability Type\nCWE-863: Incorrect Authorization\nSeverity\nCritical (9.6)\nAttack vector\nNetwork\nAttack complexity\nLow\nPrivileges required\nLow\nUser interaction\nNone\nScope\nChanged\nConfidentiality\nHigh\nIntegrity\nHigh\nAvailability\nNone\nOpen in visual CVSS calculator\nRegistry\nPackagist\nAffected Version\n1.2.2\nVisibility\nPublic\nStatus\nFixed\nDisclosure Bounty\n$900\nFix Bounty\n$225\nFound by\nFixed by\nSupported by Protect AI and leading the way to MLSecOps and greater AI security.\nÂ© 2024\nPrivacy Policy\nTerms of Service\nCode of Conduct\nCookie Preferences\nContact Us",
                "effective": true,
                "effective_reason": "The advisory does provide a structured set of steps to reproduce the issue, demonstrating a detailed procedure to exploit the vulnerability."
            }
        ],
        "cwe": [
            {
                "id": "CWE-863",
                "value": "CWE-863 Incorrect Authorization"
            }
        ]
    }
}