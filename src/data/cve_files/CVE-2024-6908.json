{
    "CVE-2024-6908": {
        "published_date": "2024-07-19T14:57:00.607Z",
        "patch_commits": [
            {
                "url": "https://github.com/yugabyte/yugabyte-db/commit/03b193de40b79329439bb9968a7d27a1cc57d662",
                "content": "[Backport 2.18][PLAT-10470] Improper Authorization: Admin can escalate privileges to SuperAdmin using manual PUT Request. Admin can create a SuperAdmin\n\nSummary:\n  - Disable creation of SuperAdmin user\n  - Disable role change to SuperAdmin\n\nOriginal commit: https://github.com/yugabyte/yugabyte-db/commit/a48ce28a3c06f6c099533e31243f2403ca30e363\nOriginal PR: https://phorge.dev.yugabyte.com/D32853\n\nTest Plan:\n  - Manual testing\n  - UTs\n\nReviewers: dkumar, skurapati\n\nReviewed By: dkumar, skurapati\n\nSubscribers: yugaware\n\nTags: #jenkins-ready\n\nDifferential Revision: https://phorge.dev.yugabyte.com/D32934\n\nFilename: managed/src/main/java/com/yugabyte/yw/controllers/UsersController.java:\n```\n@@ -135,6 +135,11 @@\npublic Result create(UUID customerUUID, Http.Request request) {\n       formData.setPassword(generatedPassword); // Password is not used.\n     }\n \n+    if (formData.getRole() == Users.Role.SuperAdmin) {\n+      throw new PlatformServiceException(BAD_REQUEST, \"Cannot create an user as SuperAdmin\");\n+    }\n+\n+    // Validate password.\n     passwordPolicyService.checkPasswordPolicy(customerUUID, formData.getPassword());\n     Users user =\n         Users.create(\n\n@@ -232,7 +237,21 @@\npublic Result changeRole(UUID customerUUID, UUID userUUID, String role, Http.Req\n     if (Role.SuperAdmin == user.getRole()) {\n       throw new PlatformServiceException(BAD_REQUEST, \"Cannot change super admin role.\");\n     }\n-    user.setRole(Role.valueOf(role));\n+\n+    Users.Role userRole = null;\n+    try {\n+      userRole = Users.Role.valueOf(role);\n+    } catch (IllegalArgumentException ex) {\n+      throw new PlatformServiceException(BAD_REQUEST, \"Role name provided is not supported\");\n+    }\n+\n+    if (userRole == null) {\n+      throw new PlatformServiceException(BAD_REQUEST, \"Role name provided is not supported\");\n+    } else if (userRole == Users.Role.SuperAdmin) {\n+      throw new PlatformServiceException(BAD_REQUEST, \"Cannot edit the user role to SuperAdmin\");\n+    }\n+\n+    user.setRole(userRole);\n     user.save();\n     auditService()\n         .createAuditEntryWithReqBody(\n```\n\nFilename: managed/src/test/java/com/yugabyte/yw/controllers/UsersControllerTest.java:\n```\n@@ -114,6 +114,24 @@\npublic void testCreateUserWithValidToken() throws IOException {\n     assertAuditEntry(1, customer1.getUuid());\n   }\n \n+  @Test\n+  public void testCreateSuperAdminUserWithValidToken() throws IOException {\n+    Http.Cookie validCookie = Http.Cookie.builder(\"authToken\", authToken1).build();\n+    ObjectNode params = Json.newObject();\n+    params.put(\"email\", \"foo@bar.com\");\n+    params.put(\"password\", \"new-Password1\");\n+    params.put(\"confirmPassword\", \"new-Password1\");\n+    params.put(\"role\", \"SuperAdmin\");\n+    Result result =\n+        assertPlatformException(\n+            () ->\n+                route(\n+                    fakeRequest(\"POST\", String.format(baseRoute, customer1.getUuid()))\n+                        .cookie(validCookie)\n+                        .bodyJson(params)));\n+    assertEquals(BAD_REQUEST, result.status());\n+  }\n+\n   @Test\n   public void testDeleteUserWithValidToken() throws IOException {\n     Http.Cookie validCookie = Http.Cookie.builder(\"authToken\", authToken1).build();\n\n@@ -165,6 +183,24 @@\npublic void testRoleChangeSuperAdmin() throws IOException {\n     assertEquals(result.status(), BAD_REQUEST);\n   }\n \n+  @Test\n+  public void testRoleChangeToSuperAdmin() throws IOException {\n+    Users testUser1 = ModelFactory.testUser(customer1, \"tc3@test.com\", Role.Admin);\n+    assertEquals(testUser1.getRole(), Role.Admin);\n+    Http.Cookie validCookie = Http.Cookie.builder(\"authToken\", authToken1).build();\n+    Result result =\n+        assertPlatformException(\n+            () ->\n+                route(\n+                    fakeRequest(\n+                            \"PUT\",\n+                            String.format(\n+                                \"%s/%s?role=SuperAdmin\",\n+                                String.format(baseRoute, customer1.getUuid()), testUser1.getUuid()))\n+                        .cookie(validCookie)));\n+    assertEquals(result.status(), BAD_REQUEST);\n+  }\n+\n   @Test\n   public void testPasswordChangeInvalid() throws IOException {\n     Users testUser1 = ModelFactory.testUser(customer1, \"tc3@test.com\", Role.Admin);\n```"
            },
            {
                "url": "https://github.com/yugabyte/yugabyte-db/commit/68f01680c565be2a370cfb7734a1b3721d6778bb",
                "content": "[Backport 2.20][PLAT-10470] Improper Authorization: Admin can escalate privileges to SuperAdmin using manual PUT Request. Admin can create a SuperAdmin\n\nSummary:\n  - Disable creation of SuperAdmin user\n  - Disable role change to SuperAdmin\n\nTest Plan:\n  - Manual testing\n  - UTs\n\nReviewers: dkumar, skurapati, vbansal\n\nReviewed By: skurapati, vbansal\n\nSubscribers: yugaware\n\nTags: #jenkins-ready\n\nDifferential Revision: https://phorge.dev.yugabyte.com/D32869\n\nFilename: managed/src/main/java/com/yugabyte/yw/controllers/UsersController.java:\n```\n@@ -188,6 +188,10 @@\npublic Result create(UUID customerUUID, Http.Request request) {\n       formData.setPassword(generatedPassword); // Password is not used.\n     }\n \n+    if (formData.getRole() == Users.Role.SuperAdmin) {\n+      throw new PlatformServiceException(BAD_REQUEST, \"Cannot create an user as SuperAdmin\");\n+    }\n+\n     // Validate password.\n     passwordPolicyService.checkPasswordPolicy(customerUUID, formData.getPassword());\n\n@@ -385,7 +389,21 @@\npublic Result changeRole(UUID customerUUID, UUID userUUID, String role, Http.Req\n     if (Users.Role.SuperAdmin == user.getRole()) {\n       throw new PlatformServiceException(BAD_REQUEST, \"Cannot change super admin role.\");\n     }\n-    user.setRole(Users.Role.valueOf(role));\n+\n+    Users.Role userRole = null;\n+    try {\n+      userRole = Users.Role.valueOf(role);\n+    } catch (IllegalArgumentException ex) {\n+      throw new PlatformServiceException(BAD_REQUEST, \"Role name provided is not supported\");\n+    }\n+\n+    if (userRole == null) {\n+      throw new PlatformServiceException(BAD_REQUEST, \"Role name provided is not supported\");\n+    } else if (userRole == Users.Role.SuperAdmin) {\n+      throw new PlatformServiceException(BAD_REQUEST, \"Cannot edit the user role to SuperAdmin\");\n+    }\n+\n+    user.setRole(userRole);\n     user.save();\n \n     boolean useNewAuthz =\n```\n\nFilename: managed/src/main/java/com/yugabyte/yw/controllers/YbcController.java:\n```\n@@ -146,6 +146,7 @@\npublic Result install(\n    */\n   @YbaApi(visibility = YbaApiVisibility.INTERNAL, sinceYBAVersion = \"2.21.0.0\")\n   @ApiOperation(\n+      notes = \"YbaApi Internal.\",\n       value = \"YbaApi Internal. Upgrade YBC gflags on the universe nodes\",\n       nickname = \"upgradeYbcGflags\",\n       response = YBPTask.class)\n```\n\nFilename: managed/src/main/resources/swagger-strict.json:\n```\n@@ -25365,50 +25365,6 @@\n\"tags\" : [ \"Universe Upgrades Management\" ]\n       }\n     },\n-    \"/api/v1/customers/{cUUID}/universes/{uniUUID}/ybc/upgrade/gflags\" : {\n-      \"put\" : {\n-        \"description\" : \"\",\n-        \"operationId\" : \"upgradeYbcGflags\",\n-        \"parameters\" : [ {\n-          \"format\" : \"uuid\",\n-          \"in\" : \"path\",\n-          \"name\" : \"cUUID\",\n-          \"required\" : true,\n-          \"type\" : \"string\"\n-        }, {\n-          \"format\" : \"uuid\",\n-          \"in\" : \"path\",\n-          \"name\" : \"uniUUID\",\n-          \"required\" : true,\n-          \"type\" : \"string\"\n-        }, {\n-          \"in\" : \"query\",\n-          \"name\" : \"request\",\n-          \"required\" : false\n-        } ],\n-        \"responses\" : {\n-          \"200\" : {\n-            \"description\" : \"successful operation\",\n-            \"schema\" : {\n-              \"$ref\" : \"#/definitions/YBPTask\"\n-            }\n-          }\n-        },\n-        \"responsesObject\" : {\n-          \"200\" : {\n-            \"description\" : \"successful operation\",\n-            \"schema\" : {\n-              \"$ref\" : \"#/definitions/YBPTask\"\n-            }\n-          }\n-        },\n-        \"security\" : [ {\n-          \"apiKeyAuth\" : [ ]\n-        } ],\n-        \"summary\" : \"YbaApi Internal. Upgrade YBC gflags on the universe nodes\",\n-        \"tags\" : [ \"Ybc Management\" ]\n-      }\n-    },\n     \"/api/v1/customers/{cUUID}/universes/{uniUUID}/ybc_throttle_params\" : {\n       \"get\" : {\n         \"description\" : \"\",\n\n@@ -27334,8 +27290,6 @@\n\"name\" : \"UniverseClusterMutations\"\n   }, {\n     \"name\" : \"User management\"\n-  }, {\n-    \"name\" : \"Ybc Management\"\n   }, {\n     \"name\" : \"preview\"\n   } ]\n```\n\nFilename: managed/src/main/resources/swagger.json:\n```\n@@ -26672,50 +26672,6 @@\n\"tags\" : [ \"Universe Upgrades Management\" ]\n       }\n     },\n-    \"/api/v1/customers/{cUUID}/universes/{uniUUID}/ybc/upgrade/gflags\" : {\n-      \"put\" : {\n-        \"description\" : \"\",\n-        \"operationId\" : \"upgradeYbcGflags\",\n-        \"parameters\" : [ {\n-          \"format\" : \"uuid\",\n-          \"in\" : \"path\",\n-          \"name\" : \"cUUID\",\n-          \"required\" : true,\n-          \"type\" : \"string\"\n-        }, {\n-          \"format\" : \"uuid\",\n-          \"in\" : \"path\",\n-          \"name\" : \"uniUUID\",\n-          \"required\" : true,\n-          \"type\" : \"string\"\n-        }, {\n-          \"in\" : \"query\",\n-          \"name\" : \"request\",\n-          \"required\" : false\n-        } ],\n-        \"responses\" : {\n-          \"200\" : {\n-            \"description\" : \"successful operation\",\n-            \"schema\" : {\n-              \"$ref\" : \"#/definitions/YBPTask\"\n-            }\n-          }\n-        },\n-        \"responsesObject\" : {\n-          \"200\" : {\n-            \"description\" : \"successful operation\",\n-            \"schema\" : {\n-              \"$ref\" : \"#/definitions/YBPTask\"\n-            }\n-          }\n-        },\n-        \"security\" : [ {\n-          \"apiKeyAuth\" : [ ]\n-        } ],\n-        \"summary\" : \"YbaApi Internal. Upgrade YBC gflags on the universe nodes\",\n-        \"tags\" : [ \"Ybc Management\" ]\n-      }\n-    },\n     \"/api/v1/customers/{cUUID}/universes/{uniUUID}/ybc_throttle_params\" : {\n       \"get\" : {\n         \"description\" : \"\",\n\n@@ -28690,8 +28646,6 @@\n\"name\" : \"UniverseClusterMutations\"\n   }, {\n     \"name\" : \"User management\"\n-  }, {\n-    \"name\" : \"Ybc Management\"\n   }, {\n     \"name\" : \"preview\"\n   } ]\n```\n\nFilename: managed/src/test/java/com/yugabyte/yw/controllers/UsersControllerTest.java:\n```\n@@ -126,6 +126,24 @@\npublic void testCreateUserWithValidToken() throws IOException {\n     assertAuditEntry(1, customer1.getUuid());\n   }\n \n+  @Test\n+  public void testCreateSuperAdminUserWithValidToken() throws IOException {\n+    Http.Cookie validCookie = Http.Cookie.builder(\"authToken\", authToken1).build();\n+    ObjectNode params = Json.newObject();\n+    params.put(\"email\", \"foo@bar.com\");\n+    params.put(\"password\", \"new-Password1\");\n+    params.put(\"confirmPassword\", \"new-Password1\");\n+    params.put(\"role\", \"SuperAdmin\");\n+    Result result =\n+        assertPlatformException(\n+            () ->\n+                route(\n+                    fakeRequest(\"POST\", String.format(baseRoute, customer1.getUuid()))\n+                        .cookie(validCookie)\n+                        .bodyJson(params)));\n+    assertEquals(BAD_REQUEST, result.status());\n+  }\n+\n   @Test\n   public void testDeleteUserWithValidToken() throws IOException {\n     Http.Cookie validCookie = Http.Cookie.builder(\"authToken\", authToken1).build();\n\n@@ -177,6 +195,24 @@\npublic void testRoleChangeSuperAdmin() throws IOException {\n     assertEquals(result.status(), BAD_REQUEST);\n   }\n \n+  @Test\n+  public void testRoleChangeToSuperAdmin() throws IOException {\n+    Users testUser1 = ModelFactory.testUser(customer1, \"tc3@test.com\", Role.Admin);\n+    assertEquals(testUser1.getRole(), Role.Admin);\n+    Http.Cookie validCookie = Http.Cookie.builder(\"authToken\", authToken1).build();\n+    Result result =\n+        assertPlatformException(\n+            () ->\n+                route(\n+                    fakeRequest(\n+                            \"PUT\",\n+                            String.format(\n+                                \"%s/%s?role=SuperAdmin\",\n+                                String.format(baseRoute, customer1.getUuid()), testUser1.getUuid()))\n+                        .cookie(validCookie)));\n+    assertEquals(result.status(), BAD_REQUEST);\n+  }\n+\n   @Test\n   public void testPasswordChangeInvalid() throws IOException {\n     Users testUser1 = ModelFactory.testUser(customer1, \"tc3@test.com\", Role.Admin);\n```"
            }
        ],
        "sw_version": "v2.14.17.0",
        "sw_version_wget": "https://github.com/yugabyte/yugabyte-db/archive/refs/tags/v2.14.17.0.zip",
        "description": "Improper privilege management in Yugabyte Platform allows authenticated admin users to escalate privileges to SuperAdmin via a crafted PUT HTTP request, potentially leading to unauthorized access to sensitive system functions and data.",
        "sec_adv": [],
        "cwe": [
            {
                "id": "CWE-269",
                "value": "CWE-269 Improper Privilege Management"
            }
        ]
    }
}