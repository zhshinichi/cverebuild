{
    "CVE-2024-8249": {
        "published_date": "2025-03-20T10:09:41.740Z",
        "patch_commits": [
            {
                "url": "https://github.com/mintplex-labs/anything-llm/commit/548da9ade30368289c5beaf0a8ee2ed2b5c1d81c",
                "content": "Exception handler on embed chat middleware\n\nFilename: server/utils/middleware/embedMiddleware.js:\n```\n@@ -41,106 +41,121 @@\nasync function validEmbedConfigId(request, response, next) {\n }\n \n async function canRespond(request, response, next) {\n-  const embed = response.locals.embedConfig;\n-  if (!embed) {\n-    response.sendStatus(404).end();\n-    return;\n-  }\n-\n-  // Block if disabled by admin.\n-  if (!embed.enabled) {\n-    response.status(503).json({\n-      id: uuidv4(),\n-      type: \"abort\",\n-      textResponse: null,\n-      sources: [],\n-      close: true,\n-      error:\n-        \"This chat has been disabled by the administrator - try again later.\",\n-    });\n-    return;\n-  }\n-\n-  // Check if requester hostname is in the valid allowlist of domains.\n-  const host = request.headers.origin ?? \"\";\n-  const allowedHosts = EmbedConfig.parseAllowedHosts(embed);\n-  if (allowedHosts !== null && !allowedHosts.includes(host)) {\n-    response.status(401).json({\n-      id: uuidv4(),\n-      type: \"abort\",\n-      textResponse: null,\n-      sources: [],\n-      close: true,\n-      error: \"Invalid request.\",\n-    });\n-    return;\n-  }\n-\n-  const { sessionId, message } = reqBody(request);\n-\n-  if (!message?.length || !VALID_CHAT_MODE.includes(embed.chat_mode)) {\n-    response.status(400).json({\n-      id: uuidv4(),\n-      type: \"abort\",\n-      textResponse: null,\n-      sources: [],\n-      close: true,\n-      error: !message?.length\n-        ? \"Message is empty.\"\n-        : `${embed.chat_mode} is not a valid mode.`,\n-    });\n-    return;\n-  }\n-\n-  if (!isNaN(embed.max_chats_per_day) && Number(embed.max_chats_per_day) > 0) {\n-    const dailyChatCount = await EmbedChats.count({\n-      embed_id: embed.id,\n-      createdAt: {\n-        gte: new Date(new Date() - 24 * 60 * 60 * 1000),\n-      },\n-    });\n+  try {\n+    const embed = response.locals.embedConfig;\n+    if (!embed) {\n+      response.sendStatus(404).end();\n+      return;\n+    }\n \n-    if (dailyChatCount >= Number(embed.max_chats_per_day)) {\n-      response.status(429).json({\n+    // Block if disabled by admin.\n+    if (!embed.enabled) {\n+      response.status(503).json({\n         id: uuidv4(),\n         type: \"abort\",\n         textResponse: null,\n         sources: [],\n         close: true,\n         error:\n-          \"The quota for this chat has been reached. Try again later or contact the site owner.\",\n+          \"This chat has been disabled by the administrator - try again later.\",\n       });\n       return;\n     }\n-  }\n \n-  if (\n-    !isNaN(embed.max_chats_per_session) &&\n-    Number(embed.max_chats_per_session) > 0\n-  ) {\n-    const dailySessionCount = await EmbedChats.count({\n-      embed_id: embed.id,\n-      session_id: sessionId,\n-      createdAt: {\n-        gte: new Date(new Date() - 24 * 60 * 60 * 1000),\n-      },\n-    });\n+    // Check if requester hostname is in the valid allowlist of domains.\n+    const host = request.headers.origin ?? \"\";\n+    const allowedHosts = EmbedConfig.parseAllowedHosts(embed);\n+    if (allowedHosts !== null && !allowedHosts.includes(host)) {\n+      response.status(401).json({\n+        id: uuidv4(),\n+        type: \"abort\",\n+        textResponse: null,\n+        sources: [],\n+        close: true,\n+        error: \"Invalid request.\",\n+      });\n+      return;\n+    }\n \n-    if (dailySessionCount >= Number(embed.max_chats_per_session)) {\n-      response.status(429).json({\n+    const { sessionId, message } = reqBody(request);\n+\n+    if (!message?.length || !VALID_CHAT_MODE.includes(embed.chat_mode)) {\n+      response.status(400).json({\n         id: uuidv4(),\n         type: \"abort\",\n         textResponse: null,\n         sources: [],\n         close: true,\n-        error:\n-          \"Your quota for this chat has been reached. Try again later or contact the site owner.\",\n+        error: !message?.length\n+          ? \"Message is empty.\"\n+          : `${embed.chat_mode} is not a valid mode.`,\n       });\n       return;\n     }\n-  }\n \n-  next();\n+    if (\n+      !isNaN(embed.max_chats_per_day) &&\n+      Number(embed.max_chats_per_day) > 0\n+    ) {\n+      const dailyChatCount = await EmbedChats.count({\n+        embed_id: embed.id,\n+        createdAt: {\n+          gte: new Date(new Date() - 24 * 60 * 60 * 1000),\n+        },\n+      });\n+\n+      if (dailyChatCount >= Number(embed.max_chats_per_day)) {\n+        response.status(429).json({\n+          id: uuidv4(),\n+          type: \"abort\",\n+          textResponse: null,\n+          sources: [],\n+          close: true,\n+          error:\n+            \"The quota for this chat has been reached. Try again later or contact the site owner.\",\n+        });\n+        return;\n+      }\n+    }\n+\n+    if (\n+      !isNaN(embed.max_chats_per_session) &&\n+      Number(embed.max_chats_per_session) > 0\n+    ) {\n+      const dailySessionCount = await EmbedChats.count({\n+        embed_id: embed.id,\n+        session_id: sessionId,\n+        createdAt: {\n+          gte: new Date(new Date() - 24 * 60 * 60 * 1000),\n+        },\n+      });\n+\n+      if (dailySessionCount >= Number(embed.max_chats_per_session)) {\n+        response.status(429).json({\n+          id: uuidv4(),\n+          type: \"abort\",\n+          textResponse: null,\n+          sources: [],\n+          close: true,\n+          error:\n+            \"Your quota for this chat has been reached. Try again later or contact the site owner.\",\n+        });\n+        return;\n+      }\n+    }\n+\n+    next();\n+  } catch (e) {\n+    response.status(500).json({\n+      id: uuidv4(),\n+      type: \"abort\",\n+      textResponse: null,\n+      sources: [],\n+      close: true,\n+      error: \"Invalid request.\",\n+    });\n+    return;\n+  }\n }\n \n module.exports = {\n```"
            }
        ],
        "sw_version": "v1.2.1",
        "sw_version_wget": "https://github.com/mintplex-labs/anything-llm/archive/refs/tags/v1.2.1.zip",
        "description": "mintplex-labs/anything-llm version git 6dc3642 contains an unauthenticated Denial of Service (DoS) vulnerability in the API for the embeddable chat functionality. An attacker can exploit this vulnerability by sending a malformed JSON payload to the API endpoint, causing a server crash due to an uncaught exception. This issue is fixed in version 1.2.2.",
        "sec_adv": [
            {
                "url": "https://huntr.com/bounties/2fb0c93f-5bc1-4212-bdca-292db7c6951f",
                "content": "Bounties\nPartners\nCommunity\nInfo\nSUBMIT REPORT\nunauth DOS on embed chat in mintplex-labs/anything-llm\nValid\nReported on Aug 2nd 2024\nDescription\nAnything LLM have a functionality to share a workspace chat to be embedded in other HTML. There is a unauth DOS on the API of this functionality.\nProof of Concept\nFirst create a new workspace to chat normally. Then create a Embeddable Chat via web page , tools -> chat embeded. It will gives instructions on how to embed anything llm, like\n<!--\nPaste this script at the bottom of your HTML before the </body> tag.\nSee more style and config options on our docs\nhttps://github.com/Mintplex-Labs/anything-llm/tree/master/embed/README.md\n-->\n<script\n  data-embed-id=\"6737250d-13b2-4fb9-9836-fae509112785\"\n  data-base-api-url=\"http://localhost:3001/api/embed\"\n  src=\"http://localhost:3000/embed/anythingllm-chat-widget.min.js\">\n</script>\n<!-- AnythingLLM (https://anythingllm.com) -->\nIt contains the the data-embed-id and URL. If you embed this code on your website, then attacker can DOS anythingllm server with:\ncurl -X POST http://localhost:3001/api/embed/6737250d-13b2-4fb9-9836-fae509112785/stream-chat -d '{' -H \"Content-Type: text/plain;charset=UTF-8\"\nPlease change the HOST and data-embed-id to your ones.\nImpact\nThe server process will DOS.\n{\n\nSyntaxError: Expected property name or '}' in JSON at position 1\n    at JSON.parse (<anonymous>)\n    at reqBody (/home/oicu/Downloads/huntr/anything-llm/server/utils/http/index.js:11:12)\n    at canRespond (/home/oicu/Downloads/huntr/anything-llm/server/utils/middleware/embedMiddleware.js:79:34)\n    at Layer.handle [as handle_request] (/home/oicu/Downloads/huntr/anything-llm/server/node_modules/express/lib/router/layer.js:95:5)\n    at next (/home/oicu/Downloads/huntr/anything-llm/server/node_modules/express/lib/router/route.js:149:13)\n    at setConnectionMeta (/home/oicu/Downloads/huntr/anything-llm/server/utils/middleware/embedMiddleware.js:27:3)\n    at Layer.handle [as handle_request] (/home/oicu/Downloads/huntr/anything-llm/server/node_modules/express/lib/router/layer.js:95:5)\n    at next (/home/oicu/Downloads/huntr/anything-llm/server/node_modules/express/lib/router/route.js:149:13)\n    at validEmbedConfig (/home/oicu/Downloads/huntr/anything-llm/server/utils/middleware/embedMiddleware.js:19:3)\n\nNode.js v20.15.1\nerror Command failed with exit code 1.\ninfo Visit https://yarnpkg.com/en/docs/cli/run for documentation about this command.\nOccurrences\nembedMiddleware.js L43-L144\nmiddleware canRespond is not wrapped in try catch. The json parse inside the middleware can throw exception.\nWe are processing your report and will contact themintplex-labs/anything-llm team within 24 hours.9 months ago\nA GitHub Issue asking the maintainers to create a SECURITY.md exists9 months ago\nhuntr-helper\ncommented9 months ago\nAdmin\nThis report was determined to possibly be out of scope or have a high likelyhood of being marked as informative.\nPlease review your report and the Participation Guidelines.\nThese are the specific guidelines this report is in possible violation of:\nLack of rate limiting issues.\nExceptions triggered in local libraries without networking components\nhuntr-helper\ncommented9 months ago\nAdmin\nThis report was determined to not have enough information for the maintainer or the Huntr team to triage.\nPlease add more details in all sections of the report.\nAdditionally, at least one PoC (Proof of Concept), needs to be provided. We strongly prefer the PoC to be in any of the following formats:\nSequence of cURL commands\nA script in any programming language\nA Metasploit Module\nPlease note: while videos demonstrating exploitation are a welcomed addition to the report, they should not be used as a replacement for the PoC.\noicu0619\ncommented9 months ago\nResearcher\nthanks for the reply. it is not a ratelimiting thing, it is an authn web api, which will cause the server crash, when dealing with malformed input. the poc is just the single curl i provided on the top http://localhost:3001/api/embed/6737250d-13b2-4fb9-9836-fae509112785/stream-chat some set up have to be done(like creating the embedded cat) on tje server side.\noicu0619\ncommented9 months ago\nResearcher\nsorry , the curl poc iscurl -X POST http://localhost:3001/api/embed/6737250d-13b2-4fb9-9836-fae509112785/stream-chat -d '{' -H \"Content-Type: text/plain;charset=UTF-8\" i edit by cell phone made some pasting error on the previous reply.\nWe have contacted a member of themintplex-labs/anything-llm team and are waiting to hear back9 months ago\nWe have sent a follow up to the mintplex-labs/anything-llm team. We will try again in 4 days.9 months ago\nWe have sent a second follow up to the mintplex-labs/anything-llm team. We will try again in 7 days.9 months ago\nA mintplex-labs/anything-llm maintainerhas acknowledged this report9 months ago\nThe scheduled publication date was automatically extended from 31st Oct 2024  to 7th Nov 2024  due to the maintainers acknowledgement of the report9 months ago\nTimothy Carambat gave praise9 months ago\nThe researcher's credibility has slightly increased as a result of the maintainer's thanks: +1\nTimothy Carambat validated this vulnerability9 months ago\noicu0619has been awarded the disclosure bounty\nThe fix bounty is now up for grabs\nThe researcher's credibility has increased: +7\nCVE-2024-8249assigned to this report.9 months ago\nTimothy Carambatmarked this as fixedin 1.2.2with commit548da99 months ago\nTimothy Carambathas been awarded the fix bounty\nembedMiddleware.js#L43-L144 has been validated\nWe have notified the mintplex-labs/anything-llm maintainers about this report in their weekly follow-up6 months ago\nWe have sent a warning to the mintplex-labs/anything-llm team to inform them that this report will be published in 48 hours6 months ago\nThis vulnerability has now been published6 months ago\nCVE-2024-8249has now been published2 months ago\nSign in to join this conversation\nCVE\nCVE-2024-8249\n(Published)\nVulnerability Type\nCWE-248: Uncaught Exception\nSeverity\nHigh (7.5)\nAttack vector\nNetwork\nAttack complexity\nLow\nPrivileges required\nNone\nUser interaction\nNone\nScope\nUnchanged\nConfidentiality\nNone\nIntegrity\nNone\nAvailability\nHigh\nOpen in visual CVSS calculator\nRegistry\nNpm\nAffected Version\ngit 6dc3642\nVisibility\nPublic\nStatus\nFixed\nDisclosure Bounty\n$450\nFix Bounty\n$112.5\nFound by\nFixed by\nSupported by Protect AI and leading the way to MLSecOps and greater AI security.\nÂ© 2024\nPrivacy Policy\nTerms of Service\nCode of Conduct\nCookie Preferences\nContact Us",
                "effective": true,
                "effective_reason": "The advisory includes a specific command usable as a PoC to demonstrate the vulnerability."
            }
        ],
        "cwe": [
            {
                "id": "CWE-248",
                "value": "CWE-248 Uncaught Exception"
            }
        ]
    }
}