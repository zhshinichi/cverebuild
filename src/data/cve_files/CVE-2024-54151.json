{
    "CVE-2024-54151": {
        "published_date": "2024-12-09T20:57:28.365Z",
        "patch_commits": [
            {
                "url": "https://github.com/directus/directus/commit/ce0397d16cf767b5293cd57f626c5349b5732a21",
                "content": "Merge commit from fork (#24108)\n\n* set default accountability for all unauthenticated connections\r\n\r\n* Added changeset\n\nFilename: .changeset/healthy-crews-cover.md:\n```\n@@ -0,0 +1,5 @@\n+---\n+'@directus/api': patch\n+---\n+\n+Fixed unauthenticated data access on a public websocket\n```\n\nFilename: api/src/websocket/controllers/base.ts:\n```\n@@ -21,6 +21,7 @@\nimport type { AuthenticationState, UpgradeContext, WebSocketAuthentication, WebS\n import { getExpiresAtForToken } from '../utils/get-expires-at-for-token.js';\n import { getMessageType } from '../utils/message.js';\n import { waitForAnyMessage, waitForMessageType } from '../utils/wait-for-message.js';\n+import { createDefaultAccountability } from '../../permissions/utils/create-default-accountability.js';\n \n const TOKEN_CHECK_INTERVAL = 15 * 60 * 1000; // 15 minutes\n\n@@ -149,7 +150,7 @@\nexport default abstract class SocketController {\n \n \t\tthis.server.handleUpgrade(request, socket, head, async (ws) => {\n \t\t\tthis.catchInvalidMessages(ws);\n-\t\t\tconst state = { accountability: null, expires_at: null } as AuthenticationState;\n+\t\t\tconst state = { accountability: createDefaultAccountability(), expires_at: null } as AuthenticationState;\n \t\t\tthis.server.emit('connection', ws, state);\n \t\t});\n \t}\n```\n\nFilename: api/src/websocket/controllers/graphql.ts:\n```\n@@ -14,6 +14,7 @@\nimport type { AuthenticationState, GraphQLSocket, UpgradeContext, WebSocketClien\n import { getMessageType } from '../utils/message.js';\n import SocketController from './base.js';\n import { registerWebSocketEvents } from './hooks.js';\n+import { createDefaultAccountability } from '../../permissions/utils/create-default-accountability.js';\n \n const logger = useLogger();\n\n@@ -117,7 +118,7 @@\nexport class GraphQLSubscriptionController extends SocketController {\n \n \tprotected override async handleHandshakeUpgrade({ request, socket, head }: UpgradeContext) {\n \t\tthis.server.handleUpgrade(request, socket, head, async (ws) => {\n-\t\t\tthis.server.emit('connection', ws, { accountability: null, expires_at: null });\n+\t\t\tthis.server.emit('connection', ws, { accountability: createDefaultAccountability(), expires_at: null });\n \t\t\t// actual enforcement is handled by the setTokenExpireTimer function\n \t\t});\n \t}\n```"
            }
        ],
        "sw_version": "v11.0.0",
        "sw_version_wget": "https://github.com/directus/directus/archive/refs/tags/v11.0.0.zip",
        "description": "Directus is a real-time API and App dashboard for managing SQL database content. Starting in version 11.0.0 and prior to version 11.3.0, when setting `WEBSOCKETS_GRAPHQL_AUTH` or `WEBSOCKETS_REST_AUTH` to \"public\", an unauthenticated user is able to do any of the supported operations (CRUD, subscriptions) with full admin privileges. This impacts any Directus instance that has either `WEBSOCKETS_GRAPHQL_AUTH` or `WEBSOCKETS_REST_AUTH` set to `public` allowing unauthenticated users to subscribe for changes on any collection or do REST CRUD operations on user defined collections ignoring permissions. Version 11.3.0 fixes the issue.",
        "sec_adv": [
            {
                "url": "https://github.com/directus/directus/security/advisories/GHSA-849r-qrwj-8rv4",
                "content": "Skip to content\nNavigation Menu\nProduct\nSolutions\nResources\nOpen Source\nEnterprise\nPricing\nSearch or jump to...\nSign in\nSign up\nAppearance settings\nDismiss alert\ndirectus\n/\ndirectus\nPublic\nSponsor\nNotifications You must be signed in to change notification settings\nFork 4.2k\nStar 30.5k\nCode\nIssues\n305\nPull requests\n37\nDiscussions\nActions\nProjects\nSecurity\n35\nInsights\nAdditional navigation options\nUnauthenticated access to WebSocket events and operations\nHigh br41nslug published GHSA-849r-qrwj-8rv4 on Dec 9, 2024Dec 9, 2024\nPackage\nnpm directus\n(\nnpm\n)\nAffected versions\n>=11.0.0\nPatched versions\n11.3.0\nDescription\nSummary\nWhen setting WEBSOCKETS_GRAPHQL_AUTH or WEBSOCKETS_REST_AUTH to \"public\", an unauthenticated user is able to do any of the supported operations (CRUD, subscriptions) with full admin privileges.\nDetails\nAccountability for unauthenticated WebSocket requests is set to null, which used to be \"public permissions\" until the Permissions Policy update which now defaults that to system/admin level access. So instead of null we need to make use of createDefaultAccountability() to ensure public permissions are used for unauthenticated users.\nPoC\nStart directus with\nWEBSOCKETS_ENABLED=true\nWEBSOCKETS_GRAPHQL_AUTH=public\nWEBSOCKETS_REST_AUTH=public\nSubscribe using GQL or REST or do any CRUD operation on a user created collection (system tables are not reachable with crud)\nsubscription {\n    directus_users_mutated {\n        key\n        event\n        data {\n            id\n            email\n            first_name\n            last_name\n            password\n        }\n    }\n}\nor\n{\n   \"type\": \"items\",\n   \"action\": \"read\",\n   \"collection\": \"your_collection_name\"\n}\n3a. Open up the data studio as any user. Observe how the subscriber gets notified on each page navigation (because the users last_page gets updated, the password fields is properly redacted here)\n3b. Observe receiving all available items from the your_collection_name collection.\nImpact\nThis impacts any Directus instance that has either WEBSOCKETS_GRAPHQL_AUTH or WEBSOCKETS_REST_AUTH set to public allowing unauthenticated users to subscribe for changes on any collection or do REST CRUD operations on user defined collections ignoring permissions.\nSeverity\nHigh\n7.5\n/ 10\nCVSS v3 base metrics\nAttack vector\nNetwork\nAttack complexity\nLow\nPrivileges required\nNone\nUser interaction\nNone\nScope\nUnchanged\nConfidentiality\nHigh\nIntegrity\nNone\nAvailability\nNone\nLearn more about base metrics\nCVSS:3.1/AV:N/AC:L/PR:N/UI:N/S:U/C:H/I:N/A:N\nCVE ID\nCVE-2024-54151\nWeaknesses\nCWE-200\nCredits\nSeanDylanGoff\nReporter\nfishuke\nReporter\nFooter\nÂ© 2025 GitHub, Inc.\nFooter navigation\nTerms\nPrivacy\nSecurity\nStatus\nDocs\nContact\nManage cookies\nDo not share my personal information",
                "effective": true,
                "effective_reason": "The advisory includes sample configuration settings and operations to demonstrate the exploitation of the vulnerability."
            }
        ],
        "cwe": [
            {
                "id": "CWE-200",
                "value": "CWE-200: Exposure of Sensitive Information to an Unauthorized Actor"
            }
        ]
    }
}