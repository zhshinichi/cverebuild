{
    "CVE-2024-40624": {
        "published_date": "2024-07-15T19:28:35.905Z",
        "patch_commits": [
            {
                "url": "https://github.com/torrentpier/torrentpier/commit/ed37e6e522f345f2b46147c6f53c1ab6dec1db9e",
                "content": "Merge commit from fork\n\nFilename: library/includes/functions.php:\n```\n@@ -40,8 +40,6 @@\nfunction delete_avatar($user_id, $avatar_ext_id)\n \n function get_tracks($type)\n {\n-    static $pattern = '#^a:\\d+:{[i:;\\d]+}$#';\n-\n     switch ($type) {\n         case 'topic':\n             $c_name = COOKIE_TOPIC;\n\n@@ -55,7 +53,7 @@\nfunction get_tracks($type)\n         default:\n             trigger_error(__FUNCTION__ . \": invalid type '$type'\", E_USER_ERROR);\n     }\n-    $tracks = !empty($_COOKIE[$c_name]) ? @unserialize($_COOKIE[$c_name]) : false;\n+    $tracks = !empty($_COOKIE[$c_name]) ? json_decode($_COOKIE[$c_name], true) : false;\n     return $tracks ?: [];\n }\n\n@@ -113,7 +111,7 @@\nfunction set_tracks($cookie_name, &$tracking_ary, $tracks = null, $val = TIMENOW\n     }\n \n     if (array_diff($tracking_ary, $prev_tracking_ary)) {\n-        bb_setcookie($cookie_name, serialize($tracking_ary));\n+        bb_setcookie($cookie_name, json_encode($tracking_ary));\n     }\n }\n```\n\nFilename: src/Legacy/Common/User.php:\n```\n@@ -453,7 +453,7 @@\npublic function login(array $args, bool $mod_admin_login = false): array\n      */\n     public function get_sessiondata()\n     {\n-        $sd_resv = !empty($_COOKIE[COOKIE_DATA]) ? unserialize($_COOKIE[COOKIE_DATA], ['allowed_classes' => false]) : [];\n+        $sd_resv = !empty($_COOKIE[COOKIE_DATA]) ? json_decode($_COOKIE[COOKIE_DATA], true) : [];\n \n         // autologin_id\n         if (!empty($sd_resv['uk']) && verify_id($sd_resv['uk'], LOGIN_KEY_LENGTH)) {\n\n@@ -486,7 +486,7 @@\npublic function set_session_cookies($user_id)\n             }\n         } else {\n             $c_sdata_resv = !empty($_COOKIE[COOKIE_DATA]) ? $_COOKIE[COOKIE_DATA] : null;\n-            $c_sdata_curr = ($this->sessiondata) ? serialize($this->sessiondata) : '';\n+            $c_sdata_curr = ($this->sessiondata) ? json_encode($this->sessiondata) : '';\n \n             if ($c_sdata_curr !== $c_sdata_resv) {\n                 bb_setcookie(COOKIE_DATA, $c_sdata_curr, httponly: true);\n```"
            }
        ],
        "sw_version": "v2.4.3",
        "sw_version_wget": "https://github.com/torrentpier/torrentpier/archive/refs/tags/v2.4.3.zip",
        "description": "TorrentPier is an open source BitTorrent Public/Private tracker engine, written in php. In `torrentpier/library/includes/functions.php`, `get_tracks()` uses the unsafe native PHP serialization format to deserialize user-controlled cookies. One can use phpggc and the chain Guzzle/FW1 to write PHP code to an arbitrary file, and execute commands on the system. For instance, the cookie bb_t will be deserialized when browsing to viewforum.php. This issue has been addressed in commit `ed37e6e52` which is expected to be included in release version 2.4.4. Users are advised to upgrade as soon as the new release is available. There are no known workarounds for this vulnerability.",
        "sec_adv": [
            {
                "url": "https://github.com/torrentpier/torrentpier/security/advisories/GHSA-fg86-4c2r-7wxw",
                "content": "Skip to content\nNavigation Menu\nProduct\nSolutions\nResources\nOpen Source\nEnterprise\nPricing\nSearch or jump to...\nSign in\nSign up\nAppearance settings\nDismiss alert\ntorrentpier\n/\ntorrentpier\nPublic\nSponsor\nNotifications You must be signed in to change notification settings\nFork 84\nStar 310\nCode\nIssues\nPull requests\n7\nDiscussions\nActions\nProjects\nSecurity\n2\nInsights\nAdditional navigation options\nDeserialization of untrusted data in torrentpier/torrentpier\nCritical belomaxorka published GHSA-fg86-4c2r-7wxw on Jul 13, 2024Jul 13, 2024\nPackage\ncomposer torrentpier/torrentpier\n(\nComposer\n)\nAffected versions\n<= 2.4.3\nPatched versions\nv2.4.4\nDescription\nSummary\nIn torrentpier/library/includes/functions.php, get_tracks() uses the unsafe native PHP serialization format to deserialize user-controlled cookies:\ntorrentpier/library/includes/functions.php\nLines 41 to 60 in 84f6c9f\n function get_tracks($type) \n { \n     static $pattern = '#^a:\\d+:{[i:;\\d]+}$#'; \n        switch ($type) { \n         case 'topic': \n             $c_name = COOKIE_TOPIC; \n             break; \n         case 'forum': \n             $c_name = COOKIE_FORUM; \n             break; \n         case 'pm': \n             $c_name = COOKIE_PM; \n             break; \n         default: \n             trigger_error(__FUNCTION__ . \": invalid type '$type'\", E_USER_ERROR); \n     } \n     $tracks = !empty($_COOKIE[$c_name]) ? @unserialize($_COOKIE[$c_name]) : false; \n     return $tracks ?: []; \n } \nPoC\nOne can use phpggc and the chain Guzzle/FW1 to write PHP code to an arbitrary file, and execute commands on the system. For instance, the cookie bb_t will be deserialized when browsing to viewforum.php.\nMisc.\nNote that I also reported this issue by email on June 2nd, in \"Unsafe deserialization leading to Remote Code Execution in get_tracks()\".\nSeverity\nCritical\n9.8\n/ 10\nCVSS v3 base metrics\nAttack vector\nNetwork\nAttack complexity\nLow\nPrivileges required\nNone\nUser interaction\nNone\nScope\nUnchanged\nConfidentiality\nHigh\nIntegrity\nHigh\nAvailability\nHigh\nLearn more about base metrics\nCVSS:3.1/AV:N/AC:L/PR:N/UI:N/S:U/C:H/I:H/A:H\nCVE ID\nCVE-2024-40624\nWeaknesses\nCWE-502\nCredits\nswapgs\nReporter\nFooter\nÂ© 2025 GitHub, Inc.\nFooter navigation\nTerms\nPrivacy\nSecurity\nStatus\nDocs\nContact\nManage cookies\nDo not share my personal information",
                "effective": true,
                "effective_reason": "The advisory includes a PoC description that outlines using phpggc and a specific chain to demonstrate exploitation."
            }
        ],
        "cwe": [
            {
                "id": "CWE-502",
                "value": "CWE-502: Deserialization of Untrusted Data"
            }
        ]
    }
}