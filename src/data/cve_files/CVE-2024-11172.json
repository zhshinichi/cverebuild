{
    "CVE-2024-11172": {
        "published_date": "2025-03-20T10:10:06.689Z",
        "patch_commits": [
            {
                "url": "https://github.com/danny-avila/librechat/commit/976784c01fa4cce00d4c2941801d56aed375c21b",
                "content": "fix: add error handling and logging to checkBan middleware\n\nFilename: api/server/middleware/checkBan.js:\n```\n@@ -6,6 +6,7 @@\nconst keyvMongo = require('~/cache/keyvMongo');\n const denyRequest = require('./denyRequest');\n const { getLogStores } = require('~/cache');\n const { findUser } = require('~/models');\n+const { logger } = require('~/config');\n \n const banCache = new Keyv({ store: keyvMongo, namespace: ViolationTypes.BAN, ttl: 0 });\n const message = 'Your account has been temporarily banned due to violations of our service.';\n\n@@ -45,92 +46,96 @@\nconst banResponse = async (req, res) => {\n  * @returns {Promise<function|Object>} - Returns a Promise which when resolved calls next middleware if user or source IP is not banned. Otherwise calls `banResponse()` and sets ban details in `banCache`.\n  */\n const checkBan = async (req, res, next = () => {}) => {\n-  const { BAN_VIOLATIONS } = process.env ?? {};\n+  try {\n+    const { BAN_VIOLATIONS } = process.env ?? {};\n \n-  if (!isEnabled(BAN_VIOLATIONS)) {\n-    return next();\n-  }\n+    if (!isEnabled(BAN_VIOLATIONS)) {\n+      return next();\n+    }\n \n-  req.ip = removePorts(req);\n-  let userId = req.user?.id ?? req.user?._id ?? null;\n+    req.ip = removePorts(req);\n+    let userId = req.user?.id ?? req.user?._id ?? null;\n \n-  if (!userId && req?.body?.email) {\n-    const user = await findUser({ email: req.body.email }, '_id');\n-    userId = user?._id ? user._id.toString() : userId;\n-  }\n+    if (!userId && req?.body?.email) {\n+      const user = await findUser({ email: req.body.email }, '_id');\n+      userId = user?._id ? user._id.toString() : userId;\n+    }\n \n-  if (!userId && !req.ip) {\n-    return next();\n-  }\n+    if (!userId && !req.ip) {\n+      return next();\n+    }\n \n-  let cachedIPBan;\n-  let cachedUserBan;\n+    let cachedIPBan;\n+    let cachedUserBan;\n \n-  let ipKey = '';\n-  let userKey = '';\n+    let ipKey = '';\n+    let userKey = '';\n \n-  if (req.ip) {\n-    ipKey = isEnabled(process.env.USE_REDIS) ? `ban_cache:ip:${req.ip}` : req.ip;\n-    cachedIPBan = await banCache.get(ipKey);\n-  }\n+    if (req.ip) {\n+      ipKey = isEnabled(process.env.USE_REDIS) ? `ban_cache:ip:${req.ip}` : req.ip;\n+      cachedIPBan = await banCache.get(ipKey);\n+    }\n \n-  if (userId) {\n-    userKey = isEnabled(process.env.USE_REDIS) ? `ban_cache:user:${userId}` : userId;\n-    cachedUserBan = await banCache.get(userKey);\n-  }\n+    if (userId) {\n+      userKey = isEnabled(process.env.USE_REDIS) ? `ban_cache:user:${userId}` : userId;\n+      cachedUserBan = await banCache.get(userKey);\n+    }\n \n-  const cachedBan = cachedIPBan || cachedUserBan;\n+    const cachedBan = cachedIPBan || cachedUserBan;\n \n-  if (cachedBan) {\n-    req.banned = true;\n-    return await banResponse(req, res);\n-  }\n+    if (cachedBan) {\n+      req.banned = true;\n+      return await banResponse(req, res);\n+    }\n \n-  const banLogs = getLogStores(ViolationTypes.BAN);\n-  const duration = banLogs.opts.ttl;\n+    const banLogs = getLogStores(ViolationTypes.BAN);\n+    const duration = banLogs.opts.ttl;\n \n-  if (duration <= 0) {\n-    return next();\n-  }\n+    if (duration <= 0) {\n+      return next();\n+    }\n \n-  let ipBan;\n-  let userBan;\n+    let ipBan;\n+    let userBan;\n \n-  if (req.ip) {\n-    ipBan = await banLogs.get(req.ip);\n-  }\n+    if (req.ip) {\n+      ipBan = await banLogs.get(req.ip);\n+    }\n \n-  if (userId) {\n-    userBan = await banLogs.get(userId);\n-  }\n+    if (userId) {\n+      userBan = await banLogs.get(userId);\n+    }\n \n-  const isBanned = !!(ipBan || userBan);\n+    const isBanned = !!(ipBan || userBan);\n \n-  if (!isBanned) {\n-    return next();\n-  }\n+    if (!isBanned) {\n+      return next();\n+    }\n \n-  const timeLeft = Number(isBanned.expiresAt) - Date.now();\n+    const timeLeft = Number(isBanned.expiresAt) - Date.now();\n \n-  if (timeLeft <= 0 && ipKey) {\n-    await banLogs.delete(ipKey);\n-  }\n+    if (timeLeft <= 0 && ipKey) {\n+      await banLogs.delete(ipKey);\n+    }\n \n-  if (timeLeft <= 0 && userKey) {\n-    await banLogs.delete(userKey);\n-    return next();\n-  }\n+    if (timeLeft <= 0 && userKey) {\n+      await banLogs.delete(userKey);\n+      return next();\n+    }\n \n-  if (ipKey) {\n-    banCache.set(ipKey, isBanned, timeLeft);\n-  }\n+    if (ipKey) {\n+      banCache.set(ipKey, isBanned, timeLeft);\n+    }\n \n-  if (userKey) {\n-    banCache.set(userKey, isBanned, timeLeft);\n-  }\n+    if (userKey) {\n+      banCache.set(userKey, isBanned, timeLeft);\n+    }\n \n-  req.banned = true;\n-  return await banResponse(req, res);\n+    req.banned = true;\n+    return await banResponse(req, res);\n+  } catch (error) {\n+    logger.error('Error in checkBan middleware:', error);\n+  }\n };\n \n module.exports = checkBan;\n```"
            }
        ],
        "sw_version": "v0.7.6-rc1",
        "sw_version_wget": "https://github.com/danny-avila/librechat/archive/refs/tags/v0.7.6-rc1.zip",
        "description": "A vulnerability in danny-avila/librechat version git a1647d7 allows an unauthenticated attacker to cause a denial of service by sending a crafted payload to the server. The middleware `checkBan` is not surrounded by a try-catch block, and an unhandled exception will cause the server to crash. This issue is fixed in version 0.7.6.",
        "sec_adv": [
            {
                "url": "https://huntr.com/bounties/c76a7ee3-2e26-45a0-8940-21c749592105",
                "content": "Bounties\nPartners\nCommunity\nInfo\nSUBMIT REPORT\nDenial of service cause by unhandled exception in danny-avila/librechat\nValid\nReported on Oct 28th 2024\nDescription\nIn javascript express, if async router handler throw an exception, the whole server will crash. In librechat, middleware checkBan is not surrounded by try catch block. This middleware, under some crafted payload, will throw exception and cause server crash. This poc can be exploited by unauth attacker.\nProof of Concept\nSend this to the server:\ncurl -X POST http://127.0.0.1:3080/api/auth/login \\\n-H \"Content-Type: application/json\" \\\n-H \"sec-ch-ua-mobile: ?0\" \\\n-d '{\"email\":{\"toString\":1},\"password\":\"xxxxxx\"}'\nThe server will crash. console log gives:\n2024-10-28 15:38:27 info: Server listening at http://localhost:3080\n2024-10-28 15:38:32 error: There was an uncaught error: Cast to string failed for value \"{ toString: 1 }\" (type Object) at path \"email\" for model \"User\"\noicu@oicu-virtual-machine /t/LibreChat (main) [1]>\nImpact\nServer crash, thus complete denial of service.\nOccurrences\ncheckBan.js L48-L58\nWe are processing your report and will contact thedanny-avila/librechat team within 24 hours.7 months ago\nhuntr-helper\ncommented7 months ago\nAdmin\nThis report was determined to possibly be out of scope or have a high likelyhood of being marked as informative.\nPlease review your report and the Participation Guidelines.\nThese are the specific guidelines this report is in possible violation of:\nExceptions triggered in local libraries without networking components\noicu0619\ncommented7 months ago\nResearcher\nThis is a network denial of service. One request will cause server crash.\nDanny Avila validated this vulnerability6 months ago\noicu0619has been awarded the disclosure bounty\nThe fix bounty is now up for grabs\nThe researcher's credibility has increased: +7\nCVE-2024-11172assigned to this report.6 months ago\nDanny Avilamarked this as fixedin 0.7.6with commit9767846 months ago\nDanny Avilahas been awarded the fix bounty\ncheckBan.js#L48-L58 has been validated\nWe have sent a warning to the danny-avila/librechat team to inform them that this report will be published in 48 hours4 months ago\nThis vulnerability has now been published4 months ago\nCVE-2024-11172has now been published2 months ago\nSign in to join this conversation\nCVE\nCVE-2024-11172\n(Published)\nVulnerability Type\nCWE-400: Denial of Service\nSeverity\nHigh (7.5)\nAttack vector\nNetwork\nAttack complexity\nLow\nPrivileges required\nNone\nUser interaction\nNone\nScope\nUnchanged\nConfidentiality\nNone\nIntegrity\nNone\nAvailability\nHigh\nOpen in visual CVSS calculator\nRegistry\nNpm\nAffected Version\ngit a1647d7\nVisibility\nPublic\nStatus\nFixed\nDisclosure Bounty\n$450\nFix Bounty\n$112.5\nFound by\nFixed by\nSupported by Protect AI and leading the way to MLSecOps and greater AI security.\nÂ© 2024\nPrivacy Policy\nTerms of Service\nCode of Conduct\nCookie Preferences\nContact Us",
                "effective": true,
                "effective_reason": "The advisory includes a curl command payload that results in the described denial of service."
            }
        ],
        "cwe": [
            {
                "id": "CWE-400",
                "value": "CWE-400 Uncontrolled Resource Consumption"
            }
        ]
    }
}