{
    "CVE-2024-7008": {
        "published_date": "2024-08-06T03:40:01.147Z",
        "patch_commits": [
            {
                "url": "https://github.com/kovidgoyal/calibre/commit/863abac24e7bc3e5ca0b3307362ff1953ba53fe0",
                "content": "Fix #2075130 [Private bug](https://bugs.launchpad.net/calibre/+bug/2075130)\n\nFilename: src/calibre/srv/legacy.py:\n```\n@@ -256,7 +256,7 @@\ndef browse(ctx, rd, rest):\n     if rest.startswith('book/'):\n         # implementation of https://bugs.launchpad.net/calibre/+bug/1698411\n         # redirect old server book URLs to new URLs\n-        redirect = ctx.url_for(None) + '#book_id=' + rest[5:] + \"&amp;panel=book_details\"\n+        redirect = ctx.url_for(None) + '#book_id=' + int(rest[5:]) + \"&amp;panel=book_details\"\n         from lxml import etree as ET\n         return html(ctx, rd, endpoint,\n                  E.html(E.head(\n```"
            }
        ],
        "sw_version": "v7.15.0",
        "sw_version_wget": "https://github.com/kovidgoyal/calibre/archive/refs/tags/v7.15.0.zip",
        "description": "Unsanitized user-input in Calibre <= 7.15.0 allow attackers to perform reflected cross-site scripting.",
        "sec_adv": [
            {
                "url": "https://starlabs.sg/advisories/24/24-7008/",
                "content": "Home\nAbout\nAdvisories\nBlog\nAchievements\nPublications\nSearch\nHome\n » \nAdvisories\n(CVE-2024-7008) Calibre Reflected Cross-Site Scripting (XSS)\nJuly 31, 2024\n · 3 min · Devesh Logendran\nTable of Contents\nSummary\nProduct Calibre\nVendor Calibre\nSeverity Medium\nAffected Versions <= 7.15.0 (latest version as of writing)\nTested Versions 7.15.0\nCVE Identifier CVE-2024-7008\nCWE Classification(s) CWE-79 Improper Neutralization of Input During Web Page Generation (XSS or ‘Cross-site Scripting’)\nCAPEC Classification(s) CAPEC-591 Reflected XSS\nCVSS3.1 Scoring System\nBase Score: 5.4 (Medium) Vector String: CVSS:3.1/AV:N/AC:L/PR:N/UI:R/S:U/C:L/I:L/A:N\nMetric Value\nAttack Vector (AV) Network\nAttack Complexity (AC) Low\nPrivileges Required (PR) None\nUser Interaction (UI) Required\nScope (S) Unchanged\nConfidentiality (C) Low\nIntegrity (I) Low\nAvailability (A) None\nProduct Overview\nCalibre is a cross-platform free and open-source suite of e-book software. Calibre supports organizing existing e-books into virtual libraries, displaying, editing, creating and converting e-books, as well as syncing e-books with a variety of e-readers. Editing books is supported for EPUB and AZW3 formats. Books in other formats like MOBI must first be converted to those formats, if they are to be edited. Calibre also has a large collection of community contributed plugins.\nCalibre also offers a powerful content server feature. This allows users to share their Calibre libraries over the internet, making it easy to access your e-book collection from anywhere, at any time.\nVulnerability Summary\nIt is possible to inject arbitrary JavaScript code into the /browse endpoint of the Calibre content server, allowing an attacker to craft a URL that when clicked by a victim, will execute the attacker’s JavaScript code in the context of the victim’s browser. If the Calibre server is running with authentication enabled and the victim is logged in at the time, this can be used to cause the victim to perform actions on the Calibre server on behalf of the attacker.\nVulnerability Details\nIn src/calibre/srv/legacy.py, the browse endpoint is defined as follows:\n@endpoint('/browse/{+rest=\"\"}')\ndef browse(ctx, rd, rest):\n    if rest.startswith('book/'):\n        # implementation of https://bugs.launchpad.net/calibre/+bug/1698411\n        # redirect old server book URLs to new URLs\n        redirect = ctx.url_for(None) + '#book_id=' + rest[5:] + \"&amp;panel=book_details\"\n        from lxml import etree as ET\n        return html(ctx, rd, endpoint,\n                 E.html(E.head(\n                     ET.XML('<meta http-equiv=\"refresh\" content=\"0;url=' + redirect + '\"/>'), # [1]\n                     ET.XML('<script language=\"javascript\">' +\n                         'window.location.href = \"' + redirect + '\"' + # [2]\n                         '</script>'\n                         ))))\n    else:\n        raise HTTPRedirect(ctx.url_for(None))\nAs can be seen from the code, if a user navigates to a URL of the form /browse/book/123, the server will insert the content after book/ straight into a variable redirect, followed by directly concatenating this variable into a meta refresh tag at [1] and a JavaScript redirect at [2] through the use of lxml’s etree.XML() function, without performing any sanitisation. The injection at [1] was not found to be exploitable as most attempts would result in malformed XML that would cause etree to raise an exception. However, the injection at [2] was found to be exploitable, due to lxml’s behaviour of expanding the &quot; entity into \" before serialising the XML tree into a string.\n>>> from lxml import etree\n>>> etree.tostring(etree.XML(\"<script>&quot;</script>\"))\nb'<script>\"</script>'\nThus, we can use &quot; to escape the string assignment and inject arbitrary JavaScript code into the page. This can be used to perform a reflected cross-site scripting attack.\nProof-of-Concept\nBrowse to the following URL, where CALIBRE_SERVER is the address of the Calibre server:\nhttp://CALIBRE_SERVER/browse/book/TEST&quot;;window.stop();alert(document.location);%2f%2f\nNote that the alert is executed in the context of the Calibre server’s origin:\nThe resulting HTML shows that the &quot; entity was expanded into \", thus enabling the injection:\n<!DOCTYPE html>\n<html><head>\n<meta http-equiv=\"refresh\" content='0;url=/#book_id=TEST\";window.stop();alert(document.location);//&amp;panel=book_details'>\n<script language=\"javascript\">window.location.href = \"/#book_id=TEST\";window.stop();alert(document.location);//&panel=book_details\"</script>\n</head></html>\nSuggested Mitigations\nEnsure that user input is safe before being used in the generation of HTML content. In this case, it appears that book IDs can only be digits, so it should suffice to ensure that the input is a digit before using it to generate the HTML.\nCredits\nDevesh Logendran of STAR Labs SG Pte. Ltd. (@starlabs_sg)\n« PREV\n(CVE-2024-6782) Calibre Remote Code Execution\nNEXT »\n(CVE-2024-7009) Calibre SQLite Injection\n© 2025 STAR Labs Powered by Hugo & PaperMod",
                "effective": true,
                "effective_reason": "This advisory includes a specific example URL that demonstrates the vulnerability."
            }
        ],
        "cwe": [
            {
                "id": "CWE-79",
                "value": "CWE-79 Improper Neutralization of Input During Web Page Generation (XSS or 'Cross-site Scripting')"
            }
        ]
    }
}