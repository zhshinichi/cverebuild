{
    "CVE-2024-8999": {
        "published_date": "2025-03-20T10:08:51.051Z",
        "patch_commits": [
            {
                "url": "https://github.com/lunary-ai/lunary/commit/aa0fd22952d1d84a717ae563eb1ab564d94a9e2b",
                "content": "fix: data warehouse connector access control (#563)\n\nFilename: packages/backend/src/api/v1/data-warehouse/index.ts:\n```\n@@ -3,6 +3,7 @@\nimport Router from \"koa-router\";\n import { z } from \"zod\";\n import { createNewDatastream } from \"./utils\";\n import sql from \"@/src/utils/db\";\n+import config from \"@/src/utils/config\";\n \n const dataWarehouse = new Router({\n   prefix: \"/data-warehouse\",\n\n@@ -21,12 +22,13 @@\ndataWarehouse.post(\"/bigquery\", async (ctx: Context) => {\n   const bodySchema = z.object({\n     apiKey: z.string().transform((apiKey) => JSON.parse(apiKey)),\n   });\n-\n-  // TODO: validate apiKey first with Zod\n-\n   const { apiKey } = bodySchema.parse(ctx.request.body);\n \n-  await createNewDatastream(apiKey, process.env.DATABASE_URL!, ctx);\n+  if (config.DATA_WAREHOUSE_EXPORTS_ALLOWED) {\n+    await createNewDatastream(apiKey, process.env.DATABASE_URL!, ctx);\n+  } else {\n+    ctx.throw(403, \"Forbidden\");\n+  }\n \n   ctx.body = {};\n });\n```\n\nFilename: packages/backend/src/utils/config.ts:\n```\n@@ -12,6 +12,7 @@\nconst config = {\n   SMTP_PORT: Number.parseInt(process.env.SMTP_PORT || \"465\"),\n   SMTP_USER: process.env.SMTP_USER,\n   SMTP_PASSWORD: process.env.SMTP_PASSWORD,\n+  DATA_WAREHOUSE_EXPORTS_ALLOWED: process.env.ALLOW_DATA_WAREHOUSE_EXPORTS, // WARNING: this should only enabled for deployments with one organization, because all the database will be exported\n };\n \n export default config;\n```\n\nFilename: packages/frontend/components/layout/Sidebar.tsx:\n```\n@@ -383,8 +383,6 @@\nexport default function Sidebar() {\n       </Combobox.Option>\n     ));\n \n-  console.log(APP_MENU);\n-\n   return (\n     <Flex\n       justify=\"space-between\"\n```\n\nFilename: packages/frontend/components/settings/data-warehouse.tsx:\n```\n@@ -54,8 +54,8 @@\nexport default function DataWarehouseCard() {\n         plan: \"enterprise\",\n         list: [\"Synchronize your data with a data warehouse provider\"],\n         enabled: config.IS_SELF_HOSTED\n-          ? org.license.dataWarehouseEnabled\n-          : org.dataWarehouseEnabled,\n+          ? !org.license.dataWarehouseEnabled\n+          : !org.dataWarehouseEnabled,\n       }}\n     >\n       <Text mb=\"lg\">Synchronize your data with a data warehouse provider</Text>\n```"
            }
        ],
        "sw_version": "v1.4.25",
        "sw_version_wget": "https://github.com/lunary-ai/lunary/archive/refs/tags/v1.4.25.zip",
        "description": "lunary-ai/lunary version v1.4.25 contains an improper access control vulnerability in the POST /api/v1/data-warehouse/bigquery endpoint. This vulnerability allows any user to export the entire database data by creating a stream to Google BigQuery without proper authentication or authorization. The issue is fixed in version 1.4.26.",
        "sec_adv": [
            {
                "url": "https://huntr.com/bounties/d42b7a44-0dcb-4ef0-b15c-d0e558da65c6",
                "content": "Bounties\nPartners\nCommunity\nInfo\nSUBMIT REPORT\nUnauthorized database export to Google BigQuery in lunary-ai/lunary\nValid\nReported on Sep 18th 2024\nDescription\nThe POST /api/v1/data-warehouse/bigquery endpoint allows any user to export the entire database data using by creating a stream to Google BigQuery.\nThis oversight enables someone to create a DataStream (sync between the Postgres database and Google BigQuery) for the entire database, exporting the entire content of the database.\nProof of Concept\nGo on Google Cloud, enable all the BigQuery related APIs, and generate a new service account\nOpen the lunary dashboard as any user, inspect a request, and copy the access token.\ncurl -X POST https://localhost:8080/api/v1/data-warehouse/bigquery \\\n  -H \"Content-Type: application/json\" \\\n -H \"Authorization: Bearer YourToken\"\n  -d '{\n    \"apiKey\": \"valid google cloud service account here\"\n  }'\nImpact\nA malicious user can access and export the entire data of all organizations. This could lead to major privacy violations, intellectual property theft, and exposure of sensitive business information.\nWe are processing your report and will contact thelunary-ai/lunary team within 24 hours.8 months ago\nhuntr-helpermodified the Severity from Critical (9.9) to Critical (9.8)8 months ago\nThe researcher has received a minor penalty to their credibility for miscalculating the severity: -1\nHugues Chocart validated this vulnerability8 months ago\nantonin36330has been awarded the disclosure bounty\nThe fix bounty is now up for grabs\nThe researcher's credibility has increased: +7\nCVE-2024-8999assigned to this report.8 months ago\nHugues Chocartmarked this as fixedin 1.4.26with commitaa0fd28 months ago\nHugues Chocarthas been awarded the fix bounty\nHugues Chocart gave praise8 months ago\nThanks for reporting\nThe researcher's credibility has slightly increased as a result of the maintainer's thanks: +1\nWe have sent a warning to the lunary-ai/lunary team to inform them that this report will be published in 48 hours5 months ago\nWe have notified the lunary-ai/lunary maintainers about this report in their weekly follow-up5 months ago\nThis vulnerability has now been published5 months ago\nCVE-2024-8999has now been published2 months ago\nSign in to join this conversation\nCVE\nCVE-2024-8999\n(Published)\nVulnerability Type\nCWE-284: Improper Access Control\nSeverity\nCritical (9.8)\nAttack vector\nNetwork\nAttack complexity\nLow\nPrivileges required\nNone\nUser interaction\nNone\nScope\nUnchanged\nConfidentiality\nHigh\nIntegrity\nHigh\nAvailability\nHigh\nOpen in visual CVSS calculator\nRegistry\nNpm\nAffected Version\nv1.4.25\nVisibility\nPublic\nStatus\nFixed\nDisclosure Bounty\n$900\nFix Bounty\n$225\nFound by\nantonin36330\n@antonin36330\nLIGHTWEIGHT\nFixed by\nSupported by Protect AI and leading the way to MLSecOps and greater AI security.\nÂ© 2024\nPrivacy Policy\nTerms of Service\nCode of Conduct\nCookie Preferences\nContact Us",
                "effective": true,
                "effective_reason": "The provided security advisory includes a detailed proof of concept."
            }
        ],
        "cwe": [
            {
                "id": "CWE-284",
                "value": "CWE-284 Improper Access Control"
            }
        ]
    }
}