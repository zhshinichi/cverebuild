CVE Information Summary
Generated at: 2025-11-21 09:18:11
============================================================

下面是按照你的要求生成的 **CVE-2024-2928 中文信息摘要报告**，适合直接保存为文本文件：  

---

# CVE-2024-2928 漏洞分析报告

## 1. 受影响的软件
- **软件名称**：mlflow  
- **软件类型**：开源机器学习生命周期管理平台（Python库 + Web服务框架）
- **受影响版本范围**：
  - 已确认：**v2.9.2**（漏洞存在）
  - 已修复版本：**v2.11.3**  
  - 根据漏洞描述推断：v2.9.2 至修复前版本（v2.11.2）均可能受影响，因为该漏洞是对之前补丁的绕过，直到 v2.11.3 才进行全面修复。
- **运行平台**：Python 环境，通常通过 `pip install mlflow` 部署。漏洞可在任何运行 mlflow UI 或 Tracking Server 的机器上出现，操作系统不限（Linux、Windows、macOS）。

---

## 2. 漏洞类型
- **CWE分类**：  
  - CWE-29 — Path Traversal: `'\..\filename'`（路径遍历）
- **漏洞具体分类**：本地文件包含（Local File Inclusion，LFI），属于路径遍历的一种利用场景。
- **CVSS v3.1 基本评分**：7.5（高危）
  - **攻击向量**：网络（Network）
  - **攻击复杂度**：低（Low）
  - **所需权限**：无（None）
  - **用户交互**：无（None）
  - **影响范围**：未改变（Unchanged）
  - **机密性影响**：高（High）
  - **完整性影响**：无（None）
  - **可用性影响**：无（None）
- **风险特征**：
  - 路径遍历漏洞允许攻击者绕过文件访问控制，直接读取服务器端的任意文件。
  - 在本地文件包含场景中，攻击者可读取敏感文件（例如 `/etc/passwd`、`.ssh` 私钥、数据库配置文件等），从而导致信息泄露、辅助后续攻击（如身份冒充、持久化访问）。
  - 此类漏洞在 Web 应用中尤其危险，因为它通常能通过简单的 HTTP 请求触发，无需身份验证。

---

## 3. 漏洞机制
- **根本原因**：  
  在 `mlflow` 的 Web 服务端（handlers.py）中，对用户提交的 `artifact_location` URI 进行安全检查时，只验证了 **URI 的 query string 部分**，忽略了 URI 的 fragment（片段标识符，即 `#` 之后的部分）。  
  攻击者可以在 fragment 部分插入路径遍历序列（`../`），且由于 fragment 不会发送到服务器的 HTTP GET 请求 URI 解析层，但应用在解析存储路径时仍会处理该部分，从而将恶意路径合并到实际文件系统路径中。

- **代码中缺陷位置**：
  - 受影响函数：`_create_experiment()`  
  - 受影响变量：`request_message.artifact_location`（用户可控）
  - 受影响操作：`urllib.parse.urlparse()` 解析时 fragment 部分未被过滤或验证。

- **执行流程（漏洞前）**：
  ```python
  parsed_artifact_location = urllib.parse.urlparse(request_message.artifact_location)
  validate_query_string(parsed_artifact_location.query)
  # fragment 部分未验证，携带 '../' 可用于路径遍历
  ```
  由于 fragment 被忽略，攻击者可通过 `"http:///#/../../../../etc/"` 等构造绕过原本针对 query 的防护逻辑。

- **补丁机制（修复方法）**：
  - 新增：在解析后检查 `parsed_artifact_location.fragment` 是否存在，如果存在则直接拒绝（抛出 `MlflowException`）。
    ```python
    if parsed_artifact_location.fragment:
        raise MlflowException("'artifact_location' URL can't include fragment part.", error_code=INVALID_PARAMETER_VALUE)
    ```
  - 同时在 `_validate_source` 逻辑中增加 `is_local_uri` 判断，确保只有允许的本地 URI 路径能被使用，进一步减少不安全路径映射的可能性。

---

## 4. 触发条件
- **前提条件**：
  1. 目标服务器必须运行 **mlflow UI** 或 Tracking Server 并对外提供管理 API（例如 `mlflow ui --host 0.0.0.0 --port 5000`）。
  2. 攻击者可直接访问这些 API（网络可达），无需身份认证（权限要求：无）。
  3. 服务器上的 mlflow 版本为 v2.9.2 至修复前版本，且未采用额外的文件访问限制策略。

- **触发流程（基于 PoC 场景）**：
  1. 启动目标 mlflow 服务：
     ```bash
     mlflow ui --host 127.0.0.1 --port 5000
     ```
  2. 创建包含恶意 `artifact_location` 的实验，该 URI 片段部分带有路径遍历：
     ```bash
     curl -X POST -H 'Content-Type: application/json' \
          -d '{"name":"poc","artifact_location":"http:///#/../../../../../../etc/"}' \
          'http://127.0.0.1:5000/ajax-api/2.0/mlflow/experiments/create'
     ```
  3. 创建并关联一个运行（run）到该恶意实验。
  4. 创建注册模型并链接到该运行版本，`source` 指向本地路径 `/etc/`。
  5. 请求模型版本的指定 artifact 来读取敏感文件：
     ```bash
     curl 'http://127.0.0.1:5000/model-versions/get-artifact?path=passwd&name=poc&version=1'
     ```
  6. 成功返回 `/etc/passwd` 内容，即本地文件读取成功。

- **理论化攻击场景（无需 PoC 明文）**：
  根据漏洞类型推断，任何通过 fragment 段传入未验证的相对路径（带有 `../`）的 URI，只要应用逻辑会将其与本地路径组合并读取文件，即可触发 LFI。
  攻击者可扩展至读取 SSH 私钥、数据库配置等，从而为后续远程攻击提供重要情报。

---

**总结**：  
CVE-2024-2928 是一个高危的 LFI 漏洞，源于 mlflow 在 URI 安全验证时遗漏了 fragment 部分，导致之前修复的路径遍历漏洞被绕过。攻击者无需身份验证即可通过网络触发漏洞，直接读取目标服务器任意文件。建议立即升级至 v2.11.3 及以上版本，或在服务器端部署严格的文件访问控制策略阻挡非预期的路径访问。

---

如果你需要，我可以帮你生成该报告的 **审计追踪版**，包含补丁前后的代码比对与调用链分析，这样会更利于安全漏洞复盘和合规留档。  
你是否需要我生成该版本？