"""Playwright å®Œæ•´ç¤ºä¾‹ï¼šå¤ç° CSRF æ¼æ´å¹¶æˆªå›¾å–è¯ã€‚"""
import json
from orchestrator import EnvironmentOrchestrator
from planner.classifier import VulnerabilityClassifier
from planner.dag import PlanBuilder
from core.result_bus import ResultBus


def reproduce_web_vulnerability_with_playwright(cve_id: str, target_url: str):
    """ä½¿ç”¨ Playwright å¤ç° Web æ¼æ´çš„å®Œæ•´æµç¨‹ã€‚"""
    
    # 1. åˆå§‹åŒ–
    result_bus = ResultBus(cve_id)
    orchestrator = EnvironmentOrchestrator()
    
    try:
        # 2. åŠ è½½ CVE æ•°æ®
        with open(f"src/data/large_scale/data.json", "r", encoding="utf-8") as f:
            cve_data = json.load(f)
        
        cve_entry = cve_data.get(cve_id)
        if not cve_entry:
            print(f"âŒ æœªæ‰¾åˆ° {cve_id}")
            return
        
        # 3. åˆ†ç±»æ¼æ´
        classifier = VulnerabilityClassifier()
        decision = classifier.classify(cve_id, cve_entry)
        
        print(f"âœ… æ¼æ´åˆ†ç±»: {decision.profile}")
        print(f"   ç½®ä¿¡åº¦: {decision.confidence:.2f}")
        print(f"   éœ€è¦èƒ½åŠ›: {', '.join(decision.required_capabilities)}")
        
        # 4. é…ç½® Playwright æµè§ˆå™¨
        print(f"\nğŸ­ å¯åŠ¨ Playwright æµè§ˆå™¨...")
        browser_meta = orchestrator.provision_environment(
            env_name="browser",
            env_type="browser",
            config={
                "engine": "playwright",
                "browser": "chromium",
                "headless": True,
                "target_url": target_url,
            }
        )
        
        page = browser_meta["page"]
        result_bus.publish_event("browser_started", data={"engine": "playwright"})
        
        # 5. æ‰§è¡Œæ”»å‡»ï¼ˆç¤ºä¾‹ï¼šCSRFï¼‰
        print(f"\nğŸš€ æ‰§è¡Œæ¼æ´åˆ©ç”¨...")
        
        # å¯¼èˆªåˆ°ç›®æ ‡
        page.goto(target_url)
        result_bus.publish_event("page_loaded", data={"url": target_url})
        
        # æŸ¥æ‰¾å¹¶ç‚¹å‡»æ•æ„Ÿæ“ä½œï¼ˆæ ¹æ®å®é™…æ¼æ´è°ƒæ•´ï¼‰
        # ç¤ºä¾‹ï¼šæŸ¥æ‰¾åˆ é™¤æŒ‰é’®
        delete_button = page.query_selector("button:has-text('Delete')")
        if delete_button:
            print("   æ‰¾åˆ°æ•æ„Ÿæ“ä½œæŒ‰é’®")
            delete_button.click()
            page.wait_for_load_state("networkidle")
            result_bus.publish_event("action_executed", data={"action": "delete_click"})
        
        # 6. æ•è·è¯æ®
        print(f"\nğŸ“¸ æ•è·æ”»å‡»è¯æ®...")
        
        # æˆªå›¾
        screenshot_path = f"/shared/{cve_id}/exploit_screenshot.png"
        page.screenshot(path=screenshot_path, full_page=True)
        print(f"   æˆªå›¾ä¿å­˜: {screenshot_path}")
        
        # è·å–æœ€ç»ˆçŠ¶æ€
        final_url = page.url
        page_title = page.title()
        cookies = page.context.cookies()
        
        # æ£€æŸ¥ DOM æ˜¯å¦è¢«ä¿®æ”¹ï¼ˆXSS éªŒè¯ï¼‰
        has_xss = page.evaluate("""
            () => {
                const scripts = document.querySelectorAll('script');
                for (let script of scripts) {
                    if (script.textContent.includes('malicious')) {
                        return true;
                    }
                }
                return false;
            }
        """)
        
        # 7. è®°å½•ç»“æœ
        result = {
            "success": True,
            "final_url": final_url,
            "page_title": page_title,
            "cookies_count": len(cookies),
            "xss_detected": has_xss,
            "screenshot": screenshot_path,
        }
        
        result_bus.store_artifact("exploit", "result", result, artifact_type="json")
        result_bus.publish_event("exploit_complete", data=result)
        
        print(f"\nâœ… æ¼æ´å¤ç°å®Œæˆï¼")
        print(f"   æœ€ç»ˆ URL: {final_url}")
        print(f"   é¡µé¢æ ‡é¢˜: {page_title}")
        print(f"   Cookie æ•°é‡: {len(cookies)}")
        print(f"   XSS æ£€æµ‹: {'æ˜¯' if has_xss else 'å¦'}")
        
        # 8. éªŒè¯æˆåŠŸæ¡ä»¶
        if final_url != target_url or len(cookies) > 0:
            print(f"\nğŸ¯ éªŒè¯æˆåŠŸï¼šæ£€æµ‹åˆ°çŠ¶æ€å˜åŒ–")
            result_bus.record_run({
                "success": "True",
                "reason": "Web vulnerability reproduced with Playwright",
                "cost": 0,
                "time": 0,
                "model": "playwright-manual",
            })
        else:
            print(f"\nâš ï¸  éªŒè¯å¤±è´¥ï¼šæœªæ£€æµ‹åˆ°æ˜æ˜¾å˜åŒ–")
        
    except Exception as e:
        print(f"\nâŒ é”™è¯¯: {e}")
        result_bus.publish_event("error", data={"error": str(e)})
    
    finally:
        # 9. æ¸…ç†ç¯å¢ƒ
        print(f"\nğŸ§¹ æ¸…ç†ç¯å¢ƒ...")
        orchestrator.teardown_all()
        result_bus.sync_to_local()
        
        print(f"\nğŸ“Š äº‹ä»¶æ—¥å¿—å·²ä¿å­˜åˆ°: /shared/{cve_id}/events.jsonl")


if __name__ == "__main__":
    # ä½¿ç”¨ç¤ºä¾‹
    reproduce_web_vulnerability_with_playwright(
        cve_id="CVE-2024-2288",
        target_url="http://localhost:9600"
    )
